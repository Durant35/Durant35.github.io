<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Tarantula-7" />



<meta name="description" content="涉及的内容
Presents the traditionally distinct fields of software and hardware design in a new unified approach（以新的统一方法呈现传统上不同的软硬件领域）
OS for embedded computing: Linux
“HW/SW bridges”: boot loader, device">
<meta property="og:type" content="website">
<meta property="og:title" content="ZYBO">
<meta property="og:url" content="http://durant35.github.io/ZYBO/index.html">
<meta property="og:site_name" content="Tarantula-7's Blog">
<meta property="og:description" content="涉及的内容
Presents the traditionally distinct fields of software and hardware design in a new unified approach（以新的统一方法呈现传统上不同的软硬件领域）
OS for embedded computing: Linux
“HW/SW bridges”: boot loader, device">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/ZynqLinuxSoftwareStack.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/Zynq_PS&PL.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/Zynq7000.jpg">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/Which_license_should_I_use.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/Structure4GCC.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/GCC_execution.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/Structure4Compiler.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/GNU_auto_tool.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/autoconf.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01//automake.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/make_variables.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day01/ZYBO.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Zynq_block_diagram.jpg">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Zynq_PS.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Vivado.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/hardware_software_co-design.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/DesignFlow.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/SystemDesign_Vivado.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Zynq7000_BlockDiagram.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Cortex-A9_Processor.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/ProcessingSystem_Interconnect.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/MemoryMap.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/IO_Peripherals.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/MIO.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/EMIO.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/PS-PL_Interfaces.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/Clocking_the_PL.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/AMBA.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/AMBA_family.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day02/AXI5channels.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/Vivado_SystemDesign.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/CreateNewProject.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/SelectZynqXC7Z010.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/CreateBlockDiagram.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/AddZYNQProcessingSystem.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/Zybo_config.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/ImportXPS_settings.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/Add_AXI_GPIO.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/GPIO_DualChannel.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/RunAutomation.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/Add_constrain.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/CreateWrapper.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/GenerateBitstream.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/Export2SDK.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/NewAppsProject.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/modify_helloworld.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/ZYBO_pin.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/ZYBO_pin_description.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/ProgramFPGA.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/STDIO_Connection.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/RegisterSpace.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/ProgrammingSequence.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/AddressEditor.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/zybo_led.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_1/pin_constraints.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/CreateZynqBootImage.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/fsbl_as_bootloader.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/bitstream_as_datafile.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/Uboot_as_datafile.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/CreateImage.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_2/Add_case1.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab2_5/ZRobot_webpage.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_1/module_linked2kernel.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_1/module_read&write.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/CreateandPackageIP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Welcome2CreateIP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/PeripheralDetails.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/AddInterfaces.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/CreatePeripheral.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Open&CreateIP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/top_module.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/top_module_modifying1.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/top_module_modifying2.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/instModifying_top.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/instModifying1.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/AddSources.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/AddDesignSource.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/ChooseCreateFile.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Set_name_as_motor.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Finish.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/IO_Port_Definitions.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/instModifying2.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/motor_v.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/MergeChanges_IPFiles.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/MergeChanges_IPPorts.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Check_IPGUI.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Re-Package_IP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Add_IP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Search_PWM_IP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/AutoConnectwithPWM.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/MakeExternal.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/Modifying_constraints.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/RecreateHDL_wrapper.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/RegenerateOutputProducts.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_3/GenerateBitstream.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/PWM_IP_in_IP_Catalog.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/Edit_IP_Packager.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/PWM_IP_open.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/Modify_the_code.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/MergeChanges_Parameters.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/MergeChanges_Port.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/Lab3_4/RepackageIP.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day04/Git_distributed_model.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day04/Git_snapshots.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day04/Git_three_areas.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day04/Git_file_lifecycle.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day04/Git_commands.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/reviewing/BootProcess4Linux.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/reviewing/Vivado+SDK.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/reviewing/EmbeddedSystemDesignFlow.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/SW_HW_Co-design_NOKIA.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/ImplementationAlternatives.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/platform_1.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/platform_2.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/platform_3.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/FPGA_Processing.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/Intergrated_HWSW_platform.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/AcceleratingProcessor.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/platform_Xilinx.jpg">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/GSM_systems.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/GSM_SOC.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/project_flow_traditional.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/Verification_backend.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/project_timeline_Refined.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/ConcurrentDesign.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/HW&SW_Co-design_before_prototype.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/Hardware&Software_Co-design.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/SystemDesign.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/SystemLevelLanguage.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/SystemLevelLanguage_C&C++.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/LanguageUse.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/DSE_overview.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/DSE_mapping.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/DSE_Xilinx.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/VivadoHLS.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/VivadoHLS_overview.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Co-design/ControlExtraction.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/OpenCV/TI_DSP.jpg">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/OpenCV/Virtex-II.jpg">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/GNU_Radio/GNU_Radio_Components.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/GNU_Radio/GNU_Radio_HardwareSchematic.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/SDN/NetworkSystem.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/SDN/NIDs.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/SDN/Flow_table_entry.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/SDN/SDN_overal_architecture.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/SDN/OpenFlowSwitching.png">
<meta property="og:image" content="http://durant35.github.io/../img/ZYBO/day05/Self-evaluation_Calc.png">
<meta property="og:updated_time" content="2017-02-16T14:34:37.206Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZYBO">
<meta name="twitter:description" content="涉及的内容
Presents the traditionally distinct fields of software and hardware design in a new unified approach（以新的统一方法呈现传统上不同的软硬件领域）
OS for embedded computing: Linux
“HW/SW bridges”: boot loader, device">
<meta name="twitter:image" content="http://durant35.github.io/../img/ZYBO/day01/ZynqLinuxSoftwareStack.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Tarantula-7&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>ZYBO | Tarantula-7&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->






</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Tarantula-7</a></h1>
        </hgroup>

        
        <p class="header-subtitle">My Body Knows It&#39;s Time to Say GoodBye... ---- Dear Basketball</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">Home</a></li>
                        
                            <li><a href="/tags">All-tags</a></li>
                        
                            <li><a href="/archives">All-lists</a></li>
                        
                            <li><a href="/Shengjie">Contact</a></li>
                        
                            <li><a href="/about">About</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa 新浪微博" href="http://weibo.com/u/2911566017/home?topnav=1&wvr=6" title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/Durant35" title="GitHub"></a>
                            
                                <a class="fa OSChina" href="https://my.oschina.net/love7zx/" title="OSChina"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMD/">CMD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMake/">CMake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CV/">CV</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DLL/">DLL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSP/">JSP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Key-words/">Key-words</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/">MFC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NotePad/">NotePad++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCL/">OpenCL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenGL/">OpenGL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PCB/">PCB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt/">Qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROS/">ROS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STM32/">STM32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socket/">Socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VS2013/">VS2013</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dumpbin/">dumpbin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini/">ini</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pcap/">pcap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件操作/">文件操作</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/漫威电影/">漫威电影</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编码/">编码</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://github.com/">GitHub</a>
                    
                    </div>
                </section>
                

                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Tarantula-7</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Tarantula-7</a></h1>
            </hgroup>
            
            <p class="header-subtitle">My Body Knows It&#39;s Time to Say GoodBye... ---- Dear Basketball</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">Home</a></li>
                
                    <li><a href="/tags">All-tags</a></li>
                
                    <li><a href="/archives">All-lists</a></li>
                
                    <li><a href="/Shengjie">Contact</a></li>
                
                    <li><a href="/about">About</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/u/2911566017/home?topnav=1&wvr=6" title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/Durant35" title="GitHub"></a>
                            
                                <a class="fa OSChina" target="_blank" href="https://my.oschina.net/love7zx/" title="OSChina"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/ZYBO/index.html" class="article-date">
      <time datetime="2017-02-16T14:16:48.000Z" itemprop="datePublished">2017-02-16</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ZYBO
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <style>
    .article-meta { display: none; }
    #container .article .article-title { padding-right: 0; }
    .article-header {
        padding: 0;
        padding-top: 26px;
        border-left: none;
        text-align: center;
    }
    .article-header:hover { border-left: none; }
    .article-title { font-size: 1.6em }
    .article-entry hr { margin: 0;}
    .article-meta,
    #container .article-info-post.article-info { display: none;}
    #container .article .article-title { padding: 0; }
</style>

<!-- 匹配页面 -->

          
        <center><img src="../img/ZYBO/day01/ZynqLinuxSoftwareStack.png" width="800px"/></center>

<h3 id="涉及的内容"><a href="#涉及的内容" class="headerlink" title="涉及的内容"></a>涉及的内容</h3><ul>
<li>Presents the traditionally distinct fields of software and hardware design in a new unified approach（以新的统一方法呈现传统上不同的软硬件领域）</li>
<li>OS for embedded computing: Linux</li>
<li>“HW/SW bridges”: boot loader, device driver,  IP</li>
</ul>
<h3 id="Course-Objectives"><a href="#Course-Objectives" class="headerlink" title="Course Objectives"></a>Course Objectives</h3><ul>
<li>After this course, you will be able to design an embedded system based on Xilinx ZYNQ</li>
<li>You will be able to <strong>add customized IP</strong> in ZYNQ</li>
<li>You will be able to <strong>develop device driver</strong> for customized IP</li>
<li>You will be able to <strong>develop boot loader</strong> for Linux</li>
<li>You will be able to <strong>develop applications on ZED board</strong></li>
<li>Understand <strong>SW/HW Co-design</strong> and <strong>HLS</strong></li>
</ul>
<h3 id="Course-outline"><a href="#Course-outline" class="headerlink" title="Course outline"></a>Course outline</h3><ol>
<li>Overview and GNU Tool Chain<ul>
<li>Next Decade: All Programmable perspective</li>
<li>Course Overview</li>
<li>FPGA and ZYNQ Overview</li>
<li>GNU Tool Chain</li>
<li>Lab1-1 Ubuntu setup and ZED demo</li>
<li>Lab1-2 hello world and GNU Tool Chain</li>
<li>Lab1-3 Explore Zybo Linux</li>
<li>Lab1-4 Cross Compile </li>
</ul>
</li>
<li>User space topic<ul>
<li>Process and thread</li>
<li>Special files and Shell</li>
<li>Busybox and Package</li>
<li>Library and System Call</li>
<li>Cross compile</li>
<li>Lab2-1  UART read/write in two process</li>
<li>Lab2-2  multi thread ZED LED flashing</li>
<li>Lab2-3  Define your project </li>
</ul>
</li>
<li>Device driver<ul>
<li>Device driver overview</li>
<li>Sysfs </li>
<li>Interrupts</li>
<li>Lab3-1  ZedBoard LED hello world</li>
<li>Lab3-2  Cross compile xt.c then test it </li>
<li>Lab3-3  Recompile your own kernel</li>
<li>Lab3-4  Hack ZED LED device driver</li>
<li>Lab3-5  Insert PWM kernel module</li>
</ul>
</li>
<li>Drive the Customized  IP<ul>
<li>ZYNQ Architecture</li>
<li>EDK Overview</li>
<li>ARM Instruction Set Overview</li>
<li>ARM Instruction Set</li>
<li>Lab4-1  ZYNQ PS C Hello World </li>
<li>Lab4-2  ZYNQ IP and Stand alone C</li>
<li>Lab4-3  SDK Debug</li>
<li>Lab4-4  Assembly and BSP library</li>
</ul>
</li>
<li>Bootloader<ul>
<li>Bootloader Overview</li>
<li>U-boot and Ramfs</li>
<li>Linux Device Tree</li>
<li>ZYNQ Boot Sequence</li>
<li>Lab5-1  Build your U-boot </li>
<li>Lab5-2  Create your FSBL </li>
<li>Lab5-3  Ramfs for ZRobot</li>
<li>Lab5-4  Post init</li>
</ul>
</li>
<li>HW/SW Co-design &amp; Project Show<ul>
<li>HW/SW Co-design overview</li>
<li>OpenCV case study</li>
<li>GNU Radio case study</li>
<li>Software Defined Network </li>
<li>Final Examination </li>
<li>Lab6-1  Final project OpenHW.org submit</li>
<li>Lab6-2  Project presentation</li>
</ul>
</li>
</ol>
<h3 id="Day01"><a href="#Day01" class="headerlink" title="Day01"></a>Day01</h3><h4 id="FPGA-and-ZYNQ-Overview"><a href="#FPGA-and-ZYNQ-Overview" class="headerlink" title="FPGA and ZYNQ Overview"></a>FPGA and ZYNQ Overview</h4><ul>
<li><p>Embedded system: any device that includes a programmable computer but is not itself a general-purpose computer.</p>
</li>
<li><p>嵌入式计算的三大技术特点：</p>
<ul>
<li>数字信号处理（Digital Signal Processing）<ul>
<li>Transforming data</li>
</ul>
</li>
<li>联网能力（Packet Processing）<ul>
<li>Transporting data</li>
</ul>
</li>
<li>不亚于桌面系统的CPU处理能力（Tera Computing）<ul>
<li>Analyzing data</li>
</ul>
</li>
</ul>
</li>
<li><p>双核ARM Cortex-A9 SOC + FPGA </p>
<center><img src="../img/ZYBO/day01/Zynq_PS&PL.png" width="800px"/></center>

<ul>
<li>处理系统PS（Processor System）</li>
<li>可编程逻辑PL（Programmable Logic）</li>
</ul>
<center><img src="../img/ZYBO/day01/Zynq7000.jpg" width="640px"/></center>

<blockquote>
<p>From：<a href="http://www.guyuehome.com/275">古月居～ROS探索总结（十六）——HRMRP机器人的设计</a></p>
<p>Zynq 由处理系统（Processor System， PS）与可编程逻辑（Programmable Logic， PL）两部分组成。其中 PS 基于 ARM Cortex-A9 双核处理器构建，包含常用的外设接口，例如网络、 USB、内存控制器等。而 PL 由 Xilinx 的 7 系列 FPGA 构成，支持动 态重配置，可以使用 Verilog 语言编程使用。在HRMRP （Hybrid Real-time Mobile Robot Platform，混合实时移动机器人平台）中，PS通过操作系统控制所有功能正常有序的实现，而 PL作为协处理器一方面可以对复杂的运算并行加速处理， 另一方面可以进行 I/O 接口扩展，为多传感器和执行器设计统一的接口，提高系统硬 件配置的灵活性。</p>
</blockquote>
</li>
</ul>
<h4 id="GNU-Tool-Chain"><a href="#GNU-Tool-Chain" class="headerlink" title="GNU Tool Chain"></a>GNU Tool Chain</h4><ul>
<li><p>Which license I should use ? </p>
<blockquote>
<p><a href="http://www.ruanyifeng.com/blog/2011/05/how_to_choose_free_software_licenses.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io">阮一峰的网络日志~如何选择开源许可证？</a></p>
</blockquote>
<center><img src="../img/ZYBO/day01/Which_license_should_I_use.png" width="720px"/></center>
</li>
<li><p>GCC Options</p>
<ul>
<li>-E: preprocessor output</li>
<li>-g: debug information</li>
<li>-O0~-O1: optimization level.<ul>
<li>default is -O1</li>
</ul>
</li>
<li>-x language: input file’s language.<ul>
<li>Ex: gcc -x java test.java</li>
</ul>
</li>
<li>-S: output assembly</li>
</ul>
</li>
<li><p>The <strong>GNU Compiler Collection (GCC)</strong> is the most important piece of open source software in the world. Virtually all other open software is based on it at some level or another. Even other languages, such as Perl and Python, are written in C, which is compiled by the GNU compiler.</p>
<center><img src="../img/ZYBO/day01/Structure4GCC.png" width="420px"/></center>
</li>
<li><p>Tool Chain</p>
<center><img src="../img/ZYBO/day01/GCC_execution.png" width="420px"/></center>

<ul>
<li><p>Compiler</p>
<ul>
<li><p>Convert source code to object modules</p>
</li>
<li><p>The Structure of Compiler</p>
<center><img src="../img/ZYBO/day01/Structure4Compiler.png" width="420px"/></center>
</li>
<li><p>.o: external references not yet resolved</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ nm *.o</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Linker</p>
<ul>
<li><p>Combine .o and .so into single a.out executable module</p>
</li>
<li><p>see “dl”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ldd a.out</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Advanced Topic（<strong>Binutils</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ gcc –o test.o test.c</div><div class="line">$ gcc -v -o test.o test.c</div><div class="line">$ gcc -nostdlib -o test.o test.c</div><div class="line">$ ldd test.o</div><div class="line"># Binutils</div><div class="line"># Lists the symbols defined in an object file. </div><div class="line">$ nm test.o</div><div class="line"># The GNU debugger, which can be used to examine the values andactions inside a program while it is running</div><div class="line">$ gdb test.o</div><div class="line"># Displays several different kinds of information stored inside one or more object file. </div><div class="line">$ objdump</div><div class="line"># Displays information from an ELF formatted object file</div><div class="line">$ readelf</div><div class="line"># Removes the symbol table, along with any other information required for debugging</div><div class="line">$ strip</div></pre></td></tr></table></figure>
<ul>
<li><p>GDB（GNU Project debugger）</p>
<ul>
<li><p>run command-line-arguments </p>
<p>Begin execution of your program with arguments</p>
</li>
<li><p>break place </p>
<p>place can be the name of a function or a line number</p>
<p>For example: break main will stop execution at the first instruction of your program </p>
</li>
<li><p>delete N<br>Removes breakpoints, where N is the number of the breakpoint</p>
</li>
<li><p>step<br>Executes current instruction and stops on the next one</p>
</li>
<li><p>next<br>Same as step except this doesn’t step into functions</p>
</li>
<li><p>print E </p>
<p>Prints the value of any variable in your program when you are at a breakpoint, where E is the name of the variable you want to print</p>
</li>
<li><p>help command<br>Gives you more information about any command or all if you leave out command</p>
</li>
<li><p>quit<br>Exit gdb</p>
</li>
</ul>
</li>
<li><p>Core Dump</p>
<ul>
<li>A program dumps a core memory image into a file called “core” and then exits when it receives certain signals:<ul>
<li>Segmentation fault：accessed memory it does not own often due to a bad pointer  or dereferenced a 0 pointer</li>
<li>Bus error – when malformed instruction is interpreted (often due to a corrupted stack, bad variable alignment, etc.) </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>GNU Auto Tools</p>
<center><img src="../img/ZYBO/day01/GNU_auto_tool.png" width="580px"/></center>

<ul>
<li><p>GNU Auto Tools是上个世纪90年代开始发展起来的一系列辅助开发、打安装包的自动化工具</p>
</li>
<li><p>各种工具分别开发，但是协同工作的很好。比如autoconf, automake, libtool等等</p>
</li>
<li><p>autoconf</p>
<center><img src="../img/ZYBO/day01/autoconf.png" width="480px"/></center>

<ul>
<li>根据用户提供的configure.in文件，生成一个名为configure的脚本。该脚本可以搜集有关移植性的平台相关信息，这些信息被用来生成Makefiles，配置头文件和其它平台相关的文件。</li>
<li><strong>configure.in</strong><ul>
<li>是configure脚本的输入文件，为了解决在不同unix变种之间移植程序的问题：库名可能不同，应用程序名可能不同，结构和常量的定义可能不同</li>
<li>configure脚本完成autoconf与automake的初始化工作，为不同的平台定义相应的宏，检测并指定适当的程序名、库名、结构和常量名等等，指定要为哪些目录输出Makefile文件。总之，为编译程序做好一切准备工作。</li>
</ul>
</li>
</ul>
</li>
<li><p>automake</p>
<center><img src="../img/ZYBO/day01//automake.png" width="480px"/></center>

<ul>
<li>根据用户提供的一个高层次的生成规则Makefile.am，生成Makefile文件的模板Makefile.in。Automake生成的Makefiles符合GNU的Makefile标准，用户无需再手工编写Makefile文件。</li>
<li><strong>Makefile.am</strong><ul>
<li>一种比Makefile更高层次的规则。只指定要生成什么目标，它由什么源文件生成，要安装到什么目录。</li>
</ul>
</li>
<li>configure脚本生成的<strong>Makefile</strong>中已经带了很多常用的目标如：check, all, install, uninstall, clean, dist, distcheck, distclean, tags, maintainerclean.</li>
</ul>
</li>
<li><p>libtool</p>
<ul>
<li><p>生成各种程序库的方便工具。</p>
</li>
<li><p>提供一个统一的接口，程序员不用关心各种烦人的底层细节：不同的平台的库可能要求不同的后缀，不同平台对库的安装方法不同，有些平台不支持动态库等等。</p>
</li>
<li><p>生成高层次的库，称为libtool library，后缀是.la。用它连接时，默认产生动态连接库，也可以用-static参数指定生成静态连接库。</p>
</li>
<li><p>既可单独使用又可与automake和autoconf一起使用更加强大、方便。</p>
</li>
<li><p>在<strong>configure.in</strong>文件中加上AC_PROG_LIBTOOL宏，如果原来有AC_PROG_RANLIB宏，删去它。</p>
</li>
<li><p>在<strong>Makefile.am</strong>文件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lib_LTLIBRARIES = libshell.la</div><div class="line">libshell_la_SOURCES = object.c subr.c symbol.c</div></pre></td></tr></table></figure>
<p>与原来的写法非常相似！</p>
</li>
<li><p>.la库只能连入.lo(使用libtool生成的目标文件)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">libshell_la_LDADD = xmalloc.lo @LTLIBOBJS@</div></pre></td></tr></table></figure>
</li>
<li><p>传入库的版本号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">libshell_la_LDFLAGS = -version-info 1:0:1</div></pre></td></tr></table></figure>
</li>
<li><p>与其它目标文件连接时用LDFLAGS指定连接的方式(默认是动态方式）：-static, –all-static指定静态连接。</p>
</li>
</ul>
</li>
<li><p>make</p>
<p><img src="../img/ZYBO/day01/make_variables.png" width="480px"/></p>
</li>
</ul>
</li>
</ul>
<h4 id="LAB1"><a href="#LAB1" class="headerlink" title="LAB1"></a>LAB1</h4><h5 id="LAB1-1-Ubuntu-setup-and-ZyboRobot"><a href="#LAB1-1-Ubuntu-setup-and-ZyboRobot" class="headerlink" title="LAB1-1 Ubuntu setup and ZyboRobot"></a>LAB1-1 Ubuntu setup and ZyboRobot</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ls -al </div><div class="line">$ env</div><div class="line">$ echo $PATH</div><div class="line">$ which gcc</div><div class="line">$ whereis  </div><div class="line">$ find</div><div class="line">$ ps -ef</div><div class="line">$ cat</div></pre></td></tr></table></figure>
<h5 id="LAB1-2-hello-world-and-GNU-Tool-Chain"><a href="#LAB1-2-hello-world-and-GNU-Tool-Chain" class="headerlink" title="LAB1-2 hello world and GNU Tool Chain"></a>LAB1-2 hello world and GNU Tool Chain</h5><ul>
<li><p>Task-1</p>
<blockquote>
<ul>
<li><p>Write hello world</p>
</li>
<li><p>Compile and use all GNU tools you know to check</p>
</li>
<li><p>Where is crt0 ?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;   $ nm /usr/lib/crt1.o</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>  “crt” stands for “C runtime”, and the zero stands for “the very beginning”.</p>
<ul>
<li><p>With 1 function call</p>
</li>
<li><p>Dived by 0 in order to create a core dump</p>
</li>
<li><p>Use GDB Trace back the call stack in core dump</p>
<p>From：<a href="http://www.cnblogs.com/hazir/p/linxu_core_dump.html">菜鸟程序员的成长历程~Linux Core Dump</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt;   # 打开 core dump 功能</div><div class="line">&gt;   1. 在终端中输入命令 ulimit -c ，输出的结果为 0，说明默认是关闭 core dump 的，即当程序异常终止时，也不会生成 core dump 文件</div><div class="line">&gt;   2. 我们可以使用命令 ulimit -c unlimited 来开启 core dump 功能，并且不限制 core dump 文件的大小； 如果需要限制文件的大小，将 unlimited 改成你想生成 core 文件最大的大小，注意单位为 blocks（KB）</div><div class="line">&gt;</div><div class="line">&gt;   # 使用 gdb 调试 Core 文件</div><div class="line">&gt;   $ gcc core_demo.c -o core_demo -g</div><div class="line">&gt;   $ ./core_demo</div><div class="line">&gt;   $ gdb core_demo core_demo.core.24816</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
</li>
<li><p>Task-2</p>
<blockquote>
<ul>
<li><p>Write Makefile</p>
</li>
<li><p>Hello1.c  Hello2.c  </p>
</li>
<li><p>Say two hello</p>
<p>Hello world 1 !</p>
<p>Hello world 2 ! </p>
</li>
</ul>
</blockquote>
<p>Solution: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Hello1.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_Hello1</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Hello world 1 !\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Hello2.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_Hello2</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Hello world 2 !\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// hello.c</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</div><div class="line">  print_Hello1();</div><div class="line">  print_Hello2();</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Makefile</span></div><div class="line">TARGET = hello</div><div class="line">all: $(TARGET)</div><div class="line">clean:</div><div class="line">  rm -f *.o $(TARGET) </div><div class="line"></div><div class="line">hello.o: hello.c</div><div class="line">Hello1.o: Hello1.c</div><div class="line">Hello2.o: Hello2.c</div><div class="line"></div><div class="line">OBJ = hello.o Hello1.o Hello2.o</div><div class="line">$(TARGET): $(OBJ)</div><div class="line">  $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJ)</div></pre></td></tr></table></figure>
</li>
<li><p>Task-3：fopen</p>
<blockquote>
<ul>
<li><p>Open a file</p>
</li>
<li><p>Write into this file</p>
<p>Hello world 1 !</p>
<p>Hello world 2 ! </p>
</li>
</ul>
</blockquote>
<p>Solution: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fopen.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>	<span class="comment">// for exit()</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</div><div class="line">  FILE *fp;</div><div class="line">   	<span class="keyword">if</span>((fp=fopen(<span class="string">"./result"</span>,<span class="string">"w+"</span>)) == <span class="literal">NULL</span>)&#123;</div><div class="line">   		<span class="built_in">printf</span>(<span class="string">"Connot open file!\n"</span>);</div><div class="line">  		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">   	&#125;</div><div class="line"></div><div class="line">  <span class="keyword">char</span> str1[]=<span class="string">"Hello world 1 !"</span>;</div><div class="line">  <span class="keyword">char</span> str2[]=<span class="string">"Hello world 2 !"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// -1 for '\0'</span></div><div class="line">  fwrite(str1, <span class="keyword">sizeof</span>(str1)<span class="number">-1</span>, <span class="number">1</span>, fp);</div><div class="line">  fwrite(<span class="string">"\n"</span>, <span class="number">1</span>, <span class="number">1</span>, fp);</div><div class="line">  fwrite(str2, <span class="keyword">sizeof</span>(str2)<span class="number">-1</span>, <span class="number">1</span>, fp);</div><div class="line">  fwrite(<span class="string">"\n"</span>, <span class="number">1</span>, <span class="number">1</span>, fp);</div><div class="line"></div><div class="line">   	fclose(fp);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Makefile</span></div><div class="line">TARGET = fopen</div><div class="line">all: $(TARGET)</div><div class="line">clean:</div><div class="line">  rm -f $(TARGET) </div><div class="line"></div><div class="line">OBJ = fopen.c</div><div class="line">$(TARGET): $(OBJ)</div><div class="line">  $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJ)</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="LAB1-3-Explore-Embedded-Linux"><a href="#LAB1-3-Explore-Embedded-Linux" class="headerlink" title="LAB1-3 Explore Embedded Linux"></a>LAB1-3 Explore Embedded Linux</h5><center><img src="../img/ZYBO/day01/ZYBO.png" width="720px"/></center>

<ul>
<li><p>SD卡文件系统：<strong>FAT32</strong></p>
</li>
<li><p>SD卡文件内容：<strong>./LAB1/ZYBO_SD/*</strong></p>
</li>
<li><p>通过串口putty到ZYBO</p>
<blockquote>
<ul>
<li><p>Win10（个人感觉体验更好）</p>
<ul>
<li>直接双击putty.exe</li>
<li>COM6</li>
<li>115200</li>
</ul>
</li>
<li><p>Ubuntu16.04</p>
<ul>
<li><p>安装并启动putty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;     $ sudo apt-get install putty</div><div class="line">&gt;     $ sudo putty</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>&gt;</p>
<blockquote>
<ul>
<li><p>check dmesg log to see the device node</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt;     $ dmesg</div><div class="line">&gt;     [11777.556719] usb 1-2: new high-speed USB device number 13 using xhci_hcd</div><div class="line">&gt;     [11777.746450] usb 1-2: New USB device found, idVendor=0403, idProduct=6010</div><div class="line">&gt;     [11777.746459] usb 1-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3</div><div class="line">&gt;     [11777.746464] usb 1-2: Product: Digilent Adept USB Device</div><div class="line">&gt;     [11777.746468] usb 1-2: Manufacturer: Digilent</div><div class="line">&gt;     [11777.746472] usb 1-2: SerialNumber: 210279572881</div><div class="line">&gt;     [11777.749891] ftdi_sio 1-2:1.0: FTDI USB Serial Device converter detected</div><div class="line">&gt;     [11777.750002] usb 1-2: Detected FT2232H</div><div class="line">&gt;     [11777.750223] usb 1-2: FTDI USB Serial Device converter now attached to ttyUSB0</div><div class="line">&gt;     [11777.753247] ftdi_sio 1-2:1.1: FTDI USB Serial Device converter detected</div><div class="line">&gt;     [11777.753371] usb 1-2: Detected FT2232H</div><div class="line">&gt;     [11777.753616] usb 1-2: FTDI USB Serial Device converter now attached to ttyUSB1</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<p>&gt;</p>
<blockquote>
<ul>
<li><p>ttyUSB1</p>
</li>
<li><p>115200</p>
</li>
</ul>
</blockquote>
</li>
<li><p>挂载/解挂SD卡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ fdisk -l</div><div class="line">$ cd ~ &amp;&amp; mkdir sd</div><div class="line">$ cd sd</div><div class="line">$ mount /dev/mmcblk0p1 sd/</div><div class="line">$ umount -l sd/</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="LAB1-4-Cross-Compile"><a href="#LAB1-4-Cross-Compile" class="headerlink" title="LAB1-4 Cross Compile"></a>LAB1-4 Cross Compile</h5><ul>
<li><p>How to install?</p>
<blockquote>
<p>Reference：</p>
<ul>
<li><a href="http://www.voidcn.com/blog/flyingforever_wl/article/p-2845212.html">zynq交叉编译环境搭建</a></li>
<li><a href="http://xilinx.wikidot.com/zynq-tools">Xilinx~ARM GNU Tools</a></li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># From my xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</div><div class="line">$ chmod a+x xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</div><div class="line"># 此步就是将dash改成bash，安装交叉编译工具链的时候，需要改成bash才行</div><div class="line"># Select &lt;No&gt;</div><div class="line">$ sudo dpkg-reconfigure -plow dash</div><div class="line">$ ./xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</div><div class="line">$ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">$ export PATH=~/CodeSourcery/Sourcery_CodeBench_Lite_for_Xilinx_GNU_Linux/bin:$PATH</div><div class="line">$ export ARCH=arm</div><div class="line"></div><div class="line"># Directly from SDK：https://www.xilinx.com/support/download.html</div><div class="line"># installing in ~/Xilinx </div><div class="line">$ ./Xilinx_SDK_2016.4_0124_1_Lin64.bin</div><div class="line">$ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">$ export PATH=~/Xilinx/SDK/2016.4/gnu/arm/lin/bin:$PATH</div><div class="line">$ export ARCH=arm</div></pre></td></tr></table></figure>
</li>
<li><p>Task-4：</p>
<ul>
<li><p>native-compile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ gcc -o helloworld helloworld.c</div><div class="line">$ ./helloworld</div></pre></td></tr></table></figure>
</li>
<li><p>cross-compile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ $&#123;CROSS_COMPILE&#125;gcc -o helloworld helloworld.c</div><div class="line">$ ./helloworld</div><div class="line">bash: ./helloworld: cannot execute binary file: Exec format error</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Makefile</span></div><div class="line">TARGET = helloworld</div><div class="line">all: $(TARGET)</div><div class="line">clean:</div><div class="line">  rm -f $(TARGET) </div><div class="line"></div><div class="line">OBJ = helloworld.c</div><div class="line">$(TARGET): $(OBJ)</div><div class="line">  $&#123;CROSS_COMPILE&#125;gcc -o $@ $(OBJ)</div></pre></td></tr></table></figure>
</li>
<li><p>Run on Zybo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ make</div><div class="line"># Copy helloworld to SD card</div><div class="line"># Putty</div><div class="line">root@zynq:&lt;sub&gt;# cd &lt;/sub&gt; &amp;&amp; mkdir sd</div><div class="line"># root@zynq:~# fdisk -l</div><div class="line">root@zynq:~# mount /dev/mmcblk0p1 sd/</div><div class="line">root@zynq:~# cd sd/Task-4</div><div class="line">root@zynq:~/sd/Task-4# ls</div><div class="line">Makefile      helloworld    helloworld.c</div><div class="line">root@zynq:~/sd/Task-4# ./helloworld</div><div class="line">hello world!</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h5 id="LAB1-5-Kernel-Compile"><a href="#LAB1-5-Kernel-Compile" class="headerlink" title="LAB1-5 Kernel Compile"></a>LAB1-5 Kernel Compile</h5><ul>
<li><p>Task-5</p>
<blockquote>
<ol>
<li><p>extract kernel zip, linux-xlnx-xilinx-v2013.4.zip</p>
</li>
<li><p>cross compile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">&gt;    # kernel_compile.sh</div><div class="line">&gt;    #!/bin/bash</div><div class="line">&gt;</div><div class="line">&gt;    export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">&gt;    export PATH=~/Xilinx/SDK/2016.4/gnu/arm/lin/bin:$PATH</div><div class="line">&gt;    export ARCH=arm</div><div class="line">&gt;</div><div class="line">&gt;    cd linux-xlnx-xilinx-v2013.4</div><div class="line">&gt;    # make config</div><div class="line">&gt;    $ make ARCH=arm xilinx_zynq_defconfig</div><div class="line">&gt;      HOSTCC  scripts/basic/fixdep</div><div class="line">&gt;      HOSTCC  scripts/kconfig/conf.o</div><div class="line">&gt;      HOSTCC  scripts/kconfig/zconf.tab.o</div><div class="line">&gt;    In file included from scripts/kconfig/zconf.tab.c:2537:0:</div><div class="line">&gt;    scripts/kconfig/menu.c: In function ‘get_symbol_str’:</div><div class="line">&gt;    scripts/kconfig/menu.c:586:18: warning: ‘jump’ may be used uninitialized in this function [-Wmaybe-uninitialized]</div><div class="line">&gt;         jump-&gt;offset = r-&gt;len - 1;</div><div class="line">&gt;                      ^</div><div class="line">&gt;    scripts/kconfig/menu.c:547:19: note: ‘jump’ was declared here</div><div class="line">&gt;      struct jump_key *jump;</div><div class="line">&gt;                       ^</div><div class="line">&gt;      HOSTLD  scripts/kconfig/conf</div><div class="line">&gt;    #</div><div class="line">&gt;    # configuration written to .config</div><div class="line">&gt;    #</div><div class="line">&gt;</div><div class="line">&gt;    # make, about 10 minutes</div><div class="line">&gt;    $ make ARCH=arm UIMAGE_LOADADDR=0x8000 uImage</div><div class="line">&gt;    &quot;mkimage&quot; command not found - U-Boot images will not be built</div><div class="line">&gt;    /home/gary/Workspace/git_ws/Courses/ZYBO/LAB1/Task-5/linux-xlnx-xilinx-v2013.4/arch/arm/boot/Makefile:79: recipe for target &apos;arch/arm/boot/uImage&apos; failed</div><div class="line">&gt;    make[1]: *** [arch/arm/boot/uImage] Error 1</div><div class="line">&gt;    /home/gary/Workspace/git_ws/Courses/ZYBO/LAB1/Task-5/linux-xlnx-xilinx-v2013.4/arch/arm/Makefile:305: recipe for target &apos;uImage&apos; failed</div><div class="line">&gt;    make: *** [uImage] Error 2</div><div class="line">&gt;</div><div class="line">&gt;    $ sudo apt install u-boot-tools</div><div class="line">&gt;    $ make ARCH=arm UIMAGE_LOADADDR=0x8000 uImage</div><div class="line">&gt;      CHK     include/config/kernel.release</div><div class="line">&gt;      CHK     include/generated/uapi/linux/version.h</div><div class="line">&gt;      CHK     include/generated/utsrelease.h</div><div class="line">&gt;    make[1]: &apos;include/generated/mach-types.h&apos; is up to date.</div><div class="line">&gt;      CALL    scripts/checksyscalls.sh</div><div class="line">&gt;      CHK     include/generated/compile.h</div><div class="line">&gt;      CHK     kernel/config_data.h</div><div class="line">&gt;      Kernel: arch/arm/boot/Image is ready</div><div class="line">&gt;      Kernel: arch/arm/boot/zImage is ready</div><div class="line">&gt;      UIMAGE  arch/arm/boot/uImage</div><div class="line">&gt;    Image Name:   Linux-3.12.0-xilinx</div><div class="line">&gt;    Created:      Tue Feb  7 11:52:16 2017</div><div class="line">&gt;    Image Type:   ARM Linux Kernel Image (uncompressed)</div><div class="line">&gt;    Data Size:    3055152 Bytes = 2983.55 kB = 2.91 MB</div><div class="line">&gt;    Load Address: 00008000</div><div class="line">&gt;    Entry Point:  00008000</div><div class="line">&gt;      Image arch/arm/boot/uImage is ready</div><div class="line">&gt;</div><div class="line">&gt;    # hack the kernel</div><div class="line">&gt;    $ sublime_text_3 ./arch/arm/kernel/setup.c</div><div class="line">&gt;    # The first sentence is “Booting Linux on physical CPU“</div><div class="line">&gt;    # Find the first sentence in setup.c, add your name in.</div><div class="line">&gt;    $ make ARCH=arm UIMAGE_LOADADDR=0x8000 uImage</div><div class="line">&gt;      CHK     include/config/kernel.release</div><div class="line">&gt;      CHK     include/generated/uapi/linux/version.h</div><div class="line">&gt;      CHK     include/generated/utsrelease.h</div><div class="line">&gt;    make[1]: &apos;include/generated/mach-types.h&apos; is up to date.</div><div class="line">&gt;      CALL    scripts/checksyscalls.sh</div><div class="line">&gt;      CHK     include/generated/compile.h</div><div class="line">&gt;      CC      arch/arm/kernel/setup.o</div><div class="line">&gt;      LD      arch/arm/kernel/built-in.o</div><div class="line">&gt;      CHK     kernel/config_data.h</div><div class="line">&gt;      LINK    vmlinux</div><div class="line">&gt;      LD      vmlinux.o</div><div class="line">&gt;      MODPOST vmlinux.o</div><div class="line">&gt;      GEN     .version</div><div class="line">&gt;      CHK     include/generated/compile.h</div><div class="line">&gt;      UPD     include/generated/compile.h</div><div class="line">&gt;      CC      init/version.o</div><div class="line">&gt;      LD      init/built-in.o</div><div class="line">&gt;      KSYM    .tmp_kallsyms1.o</div><div class="line">&gt;      KSYM    .tmp_kallsyms2.o</div><div class="line">&gt;      LD      vmlinux</div><div class="line">&gt;      SORTEX  vmlinux</div><div class="line">&gt;      SYSMAP  System.map</div><div class="line">&gt;      OBJCOPY arch/arm/boot/Image</div><div class="line">&gt;      Kernel: arch/arm/boot/Image is ready</div><div class="line">&gt;      GZIP    arch/arm/boot/compressed/piggy.gzip</div><div class="line">&gt;      AS      arch/arm/boot/compressed/piggy.gzip.o</div><div class="line">&gt;      LD      arch/arm/boot/compressed/vmlinux</div><div class="line">&gt;      OBJCOPY arch/arm/boot/zImage</div><div class="line">&gt;      Kernel: arch/arm/boot/zImage is ready</div><div class="line">&gt;      UIMAGE  arch/arm/boot/uImage</div><div class="line">&gt;    Image Name:   Linux-3.12.0-xilinx</div><div class="line">&gt;    Created:      Tue Feb  7 11:54:49 2017</div><div class="line">&gt;    Image Type:   ARM Linux Kernel Image (uncompressed)</div><div class="line">&gt;    Data Size:    3055088 Bytes = 2983.48 kB = 2.91 MB</div><div class="line">&gt;    Load Address: 00008000</div><div class="line">&gt;    Entry Point:  00008000</div><div class="line">&gt;      Image arch/arm/boot/uImage is ready</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<p>&gt;</p>
<blockquote>
<ol>
<li><p>test on zybo</p>
<ul>
<li><p>Copy uImage to SD card</p>
</li>
<li><p>Find hacked print info</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&gt;      root@zynq:~# dmesg | head -n 20</div><div class="line">&gt;      Durant35: Booting Linux on physical CPU 0x0</div><div class="line">&gt;      Linux version 3.12.0-xilinx (gary@gary-ThinkPad-T460) (gcc version 4.9.2 (Sourcery CodeBench Lite 2015.05-17) ) #2 SMP PREEMPT Tue Feb 7 11:54:46 CST 2017</div><div class="line">&gt;      CPU: ARMv7 Processor [413fc090] revision 0 (ARMv7), cr=18c5387d</div><div class="line">&gt;      CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache</div><div class="line">&gt;      Machine: Xilinx Zynq Platform, model: Xilinx Zynq Platform</div><div class="line">&gt;      bootconsole [earlycon0] enabled</div><div class="line">&gt;      Memory policy: Data cache writealloc</div><div class="line">&gt;      On node 0 totalpages: 131072</div><div class="line">&gt;      free_area_init_node: node 0, pgdat c05c3e40, node_mem_map c05fb000</div><div class="line">&gt;        Normal zone: 1024 pages used for memmap</div><div class="line">&gt;        Normal zone: 0 pages reserved</div><div class="line">&gt;        Normal zone: 131072 pages, LIFO batch:31</div><div class="line">&gt;      PERCPU: Embedded 8 pages/cpu @c0a02000 s8384 r8192 d16192 u32768</div><div class="line">&gt;      pcpu-alloc: s8384 r8192 d16192 u32768 alloc=8*4096</div><div class="line">&gt;      pcpu-alloc: [0] 0 [0] 1</div><div class="line">&gt;      Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 130048</div><div class="line">&gt;      Kernel command line: console=ttyPS0,115200 root=/dev/ram rw earlyprintk</div><div class="line">&gt;      PID hash table entries: 2048 (order: 1, 8192 bytes)</div><div class="line">&gt;      Dentry cache hash table entries: 65536 (order: 6, 262144 bytes)</div><div class="line">&gt;      Inode-cache hash table entries: 32768 (order: 5, 131072 bytes)</div><div class="line">&gt;      root@zynq:~#</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
</blockquote>
</li>
</ul>
<h3 id="Day02"><a href="#Day02" class="headerlink" title="Day02"></a>Day02</h3><h4 id="Process-and-User-Space"><a href="#Process-and-User-Space" class="headerlink" title="Process and User Space"></a>Process and User Space</h4><ul>
<li>Object File Format<ul>
<li>a.out Object File Format</li>
<li>elf Object File Format<ul>
<li>Linux “Executable” ELF files</li>
<li>​</li>
</ul>
</li>
</ul>
</li>
<li>Static Library &amp; Dynamic Shared Library<ul>
<li>Static Library</li>
<li>Dynamic Shared Library  </li>
</ul>
</li>
<li>Inter Process Communication</li>
<li>Shells<ul>
<li>Bourne shell (sh)</li>
<li>C Shell (csh)</li>
<li>Korn shell (ksh)</li>
<li>Bash Shell (bash)</li>
<li>Other Shells<ul>
<li>rc – replacement for sh on Plan 9</li>
<li>ash, Almquist shell, A Shell – clone for BSD of much of Bourne shell</li>
<li>dash – Debian Almquist shell, faster then bash, but no extensions (no “bashisms”)</li>
<li>esh – Easy Shell, Lisp based</li>
<li>scsh – Scheme shell</li>
<li>sash – Standalone shell, no reliance on external libraries</li>
<li>zsh – Z Shell extension of Bourne shell</li>
</ul>
</li>
</ul>
</li>
<li>The Common Gateway Interface </li>
<li>Linux发行版的派系<ul>
<li>​</li>
</ul>
</li>
<li>/proc<ul>
<li>​</li>
</ul>
</li>
<li>strace  显示任何由用户空间发出的系统调用</li>
<li>POSIX API<ul>
<li>Frequently needed functions<ul>
<li>int open( char *fname, int flags, … )</li>
<li>int read( int fd, char *buf, int count ) </li>
<li>Serial Port Programming</li>
<li>Unix Serial Devices and Communication</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Introduction-to-Embedded-System-Design-using-Zynq"><a href="#Introduction-to-Embedded-System-Design-using-Zynq" class="headerlink" title="Introduction to Embedded System Design using Zynq"></a>Introduction to Embedded System Design using Zynq</h4><ul>
<li>Objectives<ul>
<li>Define a Zynq All Programmable SoC (AP SoC) processor component</li>
<li>Enumerate（列举） the key aspects of the Zynq AP SoC processing system</li>
<li>Describe the embedded design flow</li>
<li>Understand the function of the IP Integrator tool（IP集成器工具）</li>
<li>Indicate（指出） how the hardware design is linked to the software development environment</li>
</ul>
</li>
</ul>
<ul>
<li><p>Embedded Processor Component</p>
<ul>
<li><p>Embedded design with Zynq is based on:</p>
<ul>
<li>Processor and peripherals<ul>
<li>Dual ARM® Cortex™ -A9 processors of Zynq-7000 AP SoC</li>
<li>AXI interconnect（互联总线）</li>
<li>AXI component peripherals（外设组件）</li>
<li>Reset, clocking, debug ports</li>
</ul>
</li>
<li>Software platform for processing system<ul>
<li>Bare Metal Applications or OS’s (e.g. Linux, FreeRTOS) （裸机应用程序/操作系统）</li>
<li>C language support</li>
<li>Processor services</li>
<li>C drivers for hardware</li>
</ul>
</li>
<li>User application<ul>
<li>Interrupt service routines (optional)（中断服务程序）</li>
</ul>
</li>
</ul>
<center><img src="../img/ZYBO/day02/Zynq_block_diagram.jpg" width="720px"/></center>
</li>
<li><p>The Zynq-7000 AP SoC architecture consists of two major sections</p>
<ul>
<li><p>PS: Processing System</p>
<ul>
<li>Dual ARM Cortex-A9 processor based</li>
<li>Multiple peripherals</li>
<li>Hard silicon core</li>
</ul>
<center><img src="../img/ZYBO/day02/Zynq_PS.png" width="720px"/></center>

<ul>
<li>The Zynq AP SoC processing system consists of the following blocks：<ul>
<li>Application processing unit (APU)</li>
<li>I/O peripherals (IOP)<ul>
<li>Multiplexed I/O (MIO), extended multiplexed I/O (EMIO)</li>
</ul>
</li>
<li>Memory interfaces</li>
<li>PS interconnect</li>
<li>DMA</li>
<li>Timers<ul>
<li>Public and private</li>
</ul>
</li>
<li>General interrupt controller (GIC)</li>
<li>On-chip memory (OCM): ROM and RAM</li>
<li>Debug controller: CoreSight</li>
</ul>
</li>
</ul>
</li>
<li><p>PL: Programmable Logic</p>
<ul>
<li>Uses the same 7 series programmable logic：<ul>
<li>Artix™-based devices: Z-7010, Z-7015 and Z-7020 (high-range I/O banks only)</li>
<li>Kintex™-based devices: Z-7030, Z-7045, and Z-7100 (mix of high-range and high-performance I/O banks)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Overview of Vivado for Embedded Design</p>
<center><img src="../img/ZYBO/day02/Vivado.png" width="800px"/></center>

<ul>
<li><p>What are Vivado, IP Integrator and SDK?</p>
<ul>
<li>Vivado is the tool suite for Xilinx FPGA design and includes capability for embedded system design</li>
<li>IP Integrator, is part of Vivado and allows block level design of the hardware part of an Embedded system<ul>
<li>Integrated into Vivado</li>
</ul>
</li>
<li>Vivado includes all the tools, IP, and documentation that are required for designing systems with the Zynq-7000 AP SoC hard core and/or Xilinx MicroBlaze soft core processor</li>
<li><strong>Vivado+IPI</strong> replaces <strong>ISE/EDK</strong></li>
<li>SDK is an Eclipse-based software design environment<ul>
<li>Enables the integration of hardware and software components</li>
<li>Links from Vivado</li>
</ul>
</li>
</ul>
</li>
<li><p>Hardware Design</p>
<center><img src="../img/ZYBO/day02/hardware_software_co-design.png" width="640px"/></center>

<ul>
<li>Hardware development tools<ul>
<li>IP Integrator</li>
<li>IP Packager </li>
<li>Hardware netlist generation </li>
<li>Simulation model generation</li>
<li>Xilinx Microprocessor Debugger (XMD)</li>
<li>Hardware debugging using Vivado analyzer </li>
<li>Vivado/IP Integrator<ul>
<li>Design environment for configuration of PS, and hardware design for PL</li>
<li>Hardware Platform (xml)</li>
<li>Platform, software, and peripheral simulation</li>
<li>Vivado logic analyzer integration</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Software Design</p>
<ul>
<li>Software Development Kit (SDK)<ul>
<li>Project workspace </li>
<li>Hardware platform definition</li>
<li>Board Support Package (BSP)</li>
<li>Software application</li>
<li>Software debugging</li>
</ul>
</li>
<li>Eclipse IDE-based Software Development Kit (SDK)<ul>
<li>Board support package creation </li>
<li>GNU software development tools</li>
<li>C/C++ compiler for the MicroBlaze and ARM Cortex-A9 processors (gcc)</li>
<li>Debugger for the MicroBlaze and ARM Cortex-A9 processors (gdb)</li>
<li>TCF framework – multicore debug</li>
</ul>
</li>
<li>Board support packages (BSPs)<ul>
<li>Stand-alone BSP<ul>
<li>Free basic device drivers and utilities from Xilinx</li>
<li>NOT an RTOS</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Embedded System Development Flow</p>
<center><img src="../img/ZYBO/day02/DesignFlow.png" width="720px"/></center>

<center><img src="../img/ZYBO/day02/SystemDesign_Vivado.png" width="640px"/></center>


</li>
</ul>
<ul>
<li>Add IP Integrator Block Diagram</li>
<li><p>Configuring Hardware in IP Integrator </p>
<ul>
<li>Exporting to SDK</li>
<li>Software Development Flow</li>
<li>Configuring FPGA and Downloading Application</li>
</ul>
</li>
<li><p>Hardware Platform Creation</p>
<ul>
<li>Provides a graphical view of the PS to configure<ul>
<li>ARM cores</li>
<li>I/O peripherals</li>
<li>DDR controller</li>
<li>Memory systems</li>
</ul>
</li>
<li>Clock Configuration<ul>
<li>Input frequency can be set<ul>
<li>Processor, DDR</li>
</ul>
</li>
<li>All IOP clock frequencies can be set</li>
<li>Clock  to PL configuration</li>
<li>Set Timers</li>
</ul>
</li>
</ul>
</li>
<li><p>SDK Software Platform</p>
<pre><code>&lt;center&gt;&lt;img src=&quot;../img/ZYBO/day02/SDK_Workbench.png&quot; width=&quot;640px&quot;/&gt;&lt;/center&gt;
</code></pre></li>
<li><p>Summary</p>
<ul>
<li>Vivado includes all the tools, documentation, and IP necessary for building embedded systems</li>
<li><strong>IPI</strong> is a System Level design tool that increases productivity, allowing designs to be completed faster</li>
<li>An embedded processing system component is built with IP provided in the IP Catalog. Designers can also add their own custom IP to this catalog</li>
<li>The PS Configuration wizard permits access to several configurable features of PS</li>
<li>The <strong>Software Development Kit (SDK)</strong> is a comprehensive software development environment for software applications</li>
</ul>
</li>
</ul>
<h4 id="Zynq-Architecture"><a href="#Zynq-Architecture" class="headerlink" title="Zynq Architecture"></a>Zynq Architecture</h4><ul>
<li>Objectives<ul>
<li>Identify the basic building blocks of the Zynq™ architecture processing system (PS) </li>
<li>Describe the usage of the Cortex-A9 processor memory space</li>
<li>Connect the PS to the programmable logic (PL) through the AXI ports</li>
<li>Generate clocking sources for the PL peripherals（<strong>PL</strong>外设）</li>
<li>List the various AXI-based system architectural models（基于<strong>AXI</strong>）</li>
<li>Name the five AXI channels（<strong>AXI</strong>通道）</li>
<li>Describe the operation of the AXI streaming protocol（<strong>AXI</strong>流协议）</li>
</ul>
</li>
</ul>
<ul>
<li><p>Zynq All Programmable SoC (AP SoC)</p>
<center><img src="../img/ZYBO/day02/Zynq7000_BlockDiagram.png" width="720px"/></center>
</li>
<li><p>Zynq AP SoC Processing System (PS)</p>
<ul>
<li><p>ARM Cortex-A9 Processor Micro-Architecture</p>
<center><img src="../img/ZYBO/day02/Cortex-A9_Processor.png" width="640px"/></center>
</li>
<li><p>PS Components</p>
<ul>
<li>Application processing unit (APU)</li>
<li>I/O peripherals (IOP)<ul>
<li>Multiplexed I/O (MIO), extended multiplexed I/O (EMIO)</li>
</ul>
</li>
<li>Memory interfaces</li>
<li>PS interconnect</li>
<li>DMA</li>
<li>Timers <ul>
<li>Public and private</li>
</ul>
</li>
<li>General interrupt controller (GIC)</li>
<li>On-chip memory (OCM): RAM</li>
<li>Debug controller: CoreSight</li>
</ul>
</li>
<li><p>Processing System Interconnect</p>
<center><img src="../img/ZYBO/day02/ProcessingSystem_Interconnect.png" width="540px"/></center>

<ul>
<li><strong>Programmable Logic</strong> to memory<ul>
<li>Two ports to DDR</li>
<li>One port to OCM SRAM</li>
</ul>
</li>
<li>Central interconnect<ul>
<li>Enables other interconnects to communicate</li>
</ul>
</li>
<li>Peripheral master<ul>
<li>USB, GigE, SDIO connects to DDR and PL via the central interconnect</li>
</ul>
</li>
<li>Peripheral slave<ul>
<li>CPU, DMA, and PL access to IOP peripherals</li>
</ul>
</li>
<li>Processing System master<ul>
<li>Two ports from the Processing System to Programmable Logic</li>
<li>Connects the CPU block  to common peripherals through the central interconnect</li>
</ul>
</li>
<li>Processing System slave<ul>
<li>Two ports from Programmable Logic to the Processing System</li>
</ul>
</li>
</ul>
</li>
<li><p>Memory Map</p>
<center><img src="../img/ZYBO/day02/MemoryMap.png" width="420px"/></center>

<ul>
<li>The Cortex-A9 processor uses 32-bit addressing</li>
<li>All PS peripherals and PL peripherals are memory mapped to the Cortex-A9 processor cores</li>
<li>All slave PL peripherals will be located between <strong>4000_0000</strong> and <strong>7FFF_FFFF</strong> (connected to GP0) and <strong>8000_0000</strong> and <strong>BFFF_FFFF</strong> (connected to GP1)</li>
</ul>
</li>
<li><p>Memory Resources</p>
<ul>
<li>On-chip memory (OCM)<ul>
<li>RAM</li>
<li>Boot ROM</li>
</ul>
</li>
<li>DDRx dynamic memory controller<ul>
<li>Supports LPDDR2, DDR2, DDR3</li>
</ul>
</li>
<li>Flash/static, memory controller<ul>
<li>Supports SRAM, QSPI, NAND/NOR FLASH</li>
</ul>
</li>
</ul>
</li>
<li><p>PS Boots First</p>
<ul>
<li>CPU0 boots from OCM ROM; CPU1 goes into a sleep state</li>
<li>On-chip boot loader in OCM ROM (Stage 0 boot)</li>
<li>Processor loads <strong>First Stage Boot Loader (FSBL)</strong> from external flash memory<ul>
<li>NOR</li>
<li>NAND</li>
<li>Quad-SPI</li>
<li><strong>SD Card</strong></li>
<li>JTAG; not a memory device—used for development/debug only</li>
<li>Boot source selected via package bootstrapping pins</li>
</ul>
</li>
<li>Optional secure boot mode allows the loading of encrypted software from the flash boot memory</li>
</ul>
</li>
<li><p>Configuring the PL</p>
<ul>
<li>The <strong>Programmable Logic</strong> is configured after the PS boots</li>
<li>Performed by application software accessing the hardware device configuration unit<ul>
<li>Bitstream image transferred</li>
<li>100-MHz, 32-bit PCAP stream interface</li>
<li>Decryption/authentication hardware option for encrypted bitstreams</li>
<li>In secure boot mode, this option can be used for software memory load</li>
<li>Built-in DMA allows simultaneous PL configuration and OS memory loading</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Processor Peripherals</p>
<ul>
<li><p>Input/Output Peripherals</p>
<center><img src="../img/ZYBO/day02/IO_Peripherals.png" width="640px"/></center>

<ul>
<li>Two GigE</li>
<li>Two USB</li>
<li>Two SPI</li>
<li>Two SD/SDIO</li>
<li>Two CAN</li>
<li>Two I2C</li>
<li>Two UART</li>
<li>Four 32-bit GPIOs</li>
<li>Static memories<ul>
<li>NAND, NOR/SRAM, Quad SPI</li>
</ul>
</li>
<li>Trace ports</li>
</ul>
</li>
<li><p>Multiplexed I/O (MIO)</p>
<center><img src="../img/ZYBO/day02/MIO.png" width="240px"/></center>

<ul>
<li>54 dedicated package pins available</li>
<li>Software configurable<ul>
<li>Automatically added to bootloader by tools</li>
</ul>
</li>
<li>Not available for all peripheral ports<ul>
<li>Some ports can only use EMIO</li>
</ul>
</li>
</ul>
</li>
<li><p>Extended Multiplexed I/O (EMIO)</p>
<center><img src="../img/ZYBO/day02/EMIO.png" width="200px"/></center>

<ul>
<li>EMIO: Peripheral port to Programmable Logic</li>
<li>Alternative to using MIO</li>
<li>Mandatory（必需） for some peripheral ports</li>
<li>Facilitates（便利）<ul>
<li>Connection to peripheral in programmable logic</li>
<li>Use of general I/O pins to supplement MIO pin usage</li>
<li>Alleviates competition（缓解竞争） for MIO pin usage</li>
</ul>
</li>
</ul>
</li>
<li><p>PS-PL Interfaces</p>
<center><img src="../img/ZYBO/day02/PS-PL_Interfaces.png" width="480px"/></center>

<ul>
<li>AXI high-performance slave ports (HP0-HP3)<ul>
<li>Configurable 32-bit or 64-bit data width</li>
<li>Access to OCM and DDR only</li>
<li>Conversion to processing system clock domain</li>
<li>AXI FIFO Interface (AFI) are FIFOs (1KB) to smooth large data transfers</li>
</ul>
</li>
<li>AXI general-purpose ports (GP0-GP1)<ul>
<li>Two masters from PS to PL</li>
<li>Two slaves from PL to PS</li>
<li>32-bit data width</li>
<li>Conversation and sync to processing system clock domain</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Clock, Reset, and Debug Features</p>
<center><img src="../img/ZYBO/day02/Clocking_the_PL.png" width="640px"/></center>
</li>
<li><p>AXI Interfaces</p>
<ul>
<li><p>AXI is Part of ARM’s AMBA</p>
<center><img src="../img/ZYBO/day02/AMBA.png" width="640px"/></center>

<center><img src="../img/ZYBO/day02/AMBA_family.png" width="640px"/></center>
</li>
<li><p>AXI</p>
<ul>
<li>Basic AXI Signaling – 5 Channels</li>
</ul>
<center><img src="../img/ZYBO/day02/AXI5channels.png" width="640px"/></center>

<ul>
<li>The AXI Interface—AX4-Lite </li>
<li>The AXI Interface—AXI4</li>
<li>The AXI Interface—AXI4-Stream</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="LAB2"><a href="#LAB2" class="headerlink" title="LAB2"></a>LAB2</h4><h5 id="Lab2-1Create-an-Embedded-System"><a href="#Lab2-1Create-an-Embedded-System" class="headerlink" title="Lab2-1Create an Embedded System"></a>Lab2-1Create an Embedded System</h5><ul>
<li><p>How to install <strong>Xilinx Vivado with SDK</strong>？</p>
<ul>
<li><p>写在前头的总结</p>
<ul>
<li>下面几个步骤是在Ubuntu16.04上搭建开发环境，过程还算简单，不过会出现设备识别不了的问题。<code>2016.4</code>更是因为安装包本身的bug，在<strong>SDK</strong>中无法<strong>Run on Hardware</strong>；即使是换成<code>2016.1</code>（目前还没发现<code>2016.4</code>的bug），也会出现串口无法正常操作，导致<strong>helloworld</strong>范例无法正常运行（应该是安装包对Linux兼容不好，没有考虑有关串口的权限问题）。</li>
<li>最后，建议直接在Windows上搭建开发环境，从<a href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vivado-design-tools/2016-1.html">官网</a>下载<code>Xilinx_Vivado_SDK_2016.1_0409_1_Win64.exe</code> ，双击即可安装（最新的<code>2016.4</code>的Windows版本同样有bug，后来发现，<code>2014.4</code>就行了，太新很多源码都不支持了）。</li>
<li>我的开发环境：Vmware装了Win10虚拟机，host是Ubuntu16.04，配置了交叉编译环境</li>
</ul>
</li>
<li><p>从<a href="https://www.xilinx.com/support/download.html">官网下载</a>，获取到 <code>Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</code>，下载前需要注册账号。</p>
</li>
<li><p>安装（这一步比较耗时，差不多一个钟）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ chmod a+x Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</div><div class="line"># 建议通过sudo方式安装，安装默认路径是/opt/Xilinx</div><div class="line">$ sudo ./Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</div></pre></td></tr></table></figure>
</li>
<li><p>You may need to install the digilent cable drivers</p>
<blockquote>
<p>From：<a href="http://www.googoolia.com/wp/2016/05/27/vivado-2016-1-on-ubuntu-16-04-64bits/">Vivado 2016.1 and 2016.2 on Ubuntu 16.04 64Bits</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 确保已经拔掉ZYBO</div><div class="line">cd /opt/Xilinx/Vivado/2016.4/data/xicom/cable_drivers/lin64/install_script/install_drivers</div><div class="line">sudo ./install_drivers</div><div class="line">reboot</div></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<blockquote>
<p>Reference: <a href="http://mboers.github.io/zynq-notes/3-running-vivado/">Running Vivado on Linux (Ubuntu)</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 通过echo &quot;source /opt/Xilinx/Vivado/2016.4/settings64.sh&quot; &gt;&gt; ~/.bashrc，将变成bash默认环境</div><div class="line">$ source /opt/Xilinx/Vivado/2016.4/settings64.sh</div><div class="line">$ vivado &amp;</div><div class="line">****** Vivado v2016.4 (64-bit)</div><div class="line">  **** SW Build 1756540 on Mon Jan 23 19:11:19 MST 2017</div><div class="line">  **** IP Build 1755317 on Mon Jan 23 20:30:07 MST 2017</div><div class="line">    ** Copyright 1986-2016 Xilinx, Inc. All Rights Reserved.</div><div class="line"></div><div class="line">start_gui</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Step by step（Hardware）</p>
<center><img src="../img/ZYBO/Lab2_1/Vivado_SystemDesign.png" width="720px"/></center>

<ul>
<li><p>Create New Project</p>
<ul>
<li>Click next ……     6 times</li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/CreateNewProject.png" width="720px"/></center>
</li>
<li><p>Select  Zynq-7000</p>
<ul>
<li>Click next, then … finish</li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/SelectZynqXC7Z010.png" width="640px"/></center>
</li>
<li><p>Create Block Diagram <strong>design_1</strong></p>
<center><img src="../img/ZYBO/Lab2_1/CreateBlockDiagram.png" width="480px"/></center>
</li>
<li><p>Add IP： <strong>ZYNQ7 Processing System</strong></p>
<center><img src="../img/ZYBO/Lab2_1/AddZYNQProcessingSystem.png" width="640px"/></center>
</li>
<li><p>Zybo config（双击<strong>processing_system7_0</strong>）</p>
<center><img src="../img/ZYBO/Lab2_1/Zybo_config.png" width="720px"/></center>
</li>
<li><p>Import XPS settings，<strong>./LAB2/Task-1/ZYBO_zynq_def.xml</strong>，OK</p>
<center><img src="../img/ZYBO/Lab2_1/ImportXPS_settings.png" width="640px"/></center>
</li>
<li><p>Run Block Automation 完成PS接口</p>
</li>
<li><p>Add IP:  AXI_GPIO</p>
<center><img src="../img/ZYBO/Lab2_1/Add_AXI_GPIO.png" width="720px"/></center>
</li>
<li><p>GPIO as Dual Channel, 4 bit</p>
<ul>
<li><p>双击 <strong>axi_gpio_0</strong></p>
<ul>
<li>Enable Dual Channel</li>
<li>GPIO Width：4</li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/GPIO_DualChannel.png" width="540px"/></center>
</li>
</ul>
</li>
<li><p>Run Connection Automation for all，然后通过<strong>Regenerate Layout</strong>自动调整模块布局，通过<strong>Validate Design</strong>进行初步验证。</p>
<center><img src="../img/ZYBO/Lab2_1/RunAutomation.png" width="720px"/></center>
</li>
<li><p>Add constrain，<strong>./LAB2/Task-1/ZYBO_Master.xdc</strong>，Finish</p>
<ul>
<li>Add Sources-&gt;Add or create constraints</li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/Add_constrain.png" width="640px"/></center>
</li>
<li><p>Create HDL Wrapper</p>
<center><img src="../img/ZYBO/Lab2_1/CreateWrapper.png" width="640px"/></center>
</li>
<li><p>Generate Bitstream，</p>
<center><img src="../img/ZYBO/Lab2_1/GenerateBitstream.png" width="480px"/></center>

<ul>
<li>10 minutes later ……</li>
<li><code>&lt;project-name&gt;/&lt;project-name&gt;.runs/impl_1</code><ul>
<li><strong>design_1_wrapper.bit</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Step by step（Software）</p>
<ul>
<li><p>How to Install Xilinx SDK</p>
<ul>
<li><p>没错，Linux下还需要额外配置才能正常启动<strong>SDK</strong>，Windows则一步自动到位。</p>
</li>
<li><p>Install JRE for eclipse</p>
<blockquote>
<p>From: <a href="https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-get-on-ubuntu-16-04">How To Install Java with Apt-Get on Ubuntu 16.04</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install default-jre</div></pre></td></tr></table></figure>
</li>
<li><p>配置环境</p>
<blockquote>
<p>From: <a href="http://coldnew.github.io/zybo-board/xilinx_sdk_note/">Xilinx SDK 在 Linux 的一些注意事項</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># echo &quot;source /opt/Xilinx/SDK/2016.4/settings64.sh&quot; &gt;&gt; ~/.bashrc</div><div class="line">$ source /opt/Xilinx/SDK/2016.4/settings64.sh</div><div class="line"># echo &quot;export SWT_GTK3=0&quot; &gt;&gt; ~/.bashrc</div><div class="line"># 没有这一步，无法在Vivado中Launch SDK</div><div class="line">$ export SWT_GTK3=0</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Export to SDK</p>
<ul>
<li>启动 <strong>Vivado</strong>，在其中 <strong>File-&gt;Launch SDK</strong></li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/Export2SDK.png" width="800px"/></center>
</li>
<li><p>New application project</p>
<ul>
<li>File-&gt;Application Project-&gt;Next-&gt;Hello World<ul>
<li>Hardware platform：从Vivado导出的hw_platform（default）</li>
<li>Processor platform：ps7_contexa9_0（default）</li>
<li>OS platform：standalone</li>
</ul>
</li>
</ul>
<center><img src="../img/ZYBO/Lab2_1/NewAppsProject.png" width="800px"/></center>
</li>
<li><p>Modify helloworld.c , add your name</p>
  <center><img src="../img/ZYBO/Lab2_1/modify_helloworld.png" width="720px"/></center>
</li>
<li><p>How to connect？</p>
  <center><img src="../img/ZYBO/Lab2_1/ZYBO_pin.png" width="640px"/></center>

  <center><img src="../img/ZYBO/Lab2_1/ZYBO_pin_description.png" width="640px"/></center>


</li>
</ul>
</li>
</ul>
<pre><code>+ 21 Programming Mode Jumper：FPGA模式
+ 18 板上电源指示灯
+ 19 PL配置完成指示灯，Program FPGA正常的话，指示灯会亮
+ Vivado-&gt;Flow-&gt;Hardware Manager验证设备成功连接
  + Detect **xc_7z010**
</code></pre><ul>
<li><p>配置FPGA：<code>Xilinx Tools</code>-&gt;<code>Program FPGA</code></p>
<center><img src="../img/ZYBO/Lab2_1/ProgramFPGA.png" width="720px"/></center>
</li>
<li><p>Run it</p>
<pre><code>&lt;center&gt;&lt;img src=&quot;../img/ZYBO/Lab2_1/run_it.png&quot; width=&quot;480px&quot;/&gt;&lt;/center&gt;
</code></pre></li>
</ul>
<ul>
<li><p>下面是我使用的<code>helloworld.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</div><div class="line">* helloworld.c: simple test application</div><div class="line">*</div><div class="line">* This application configures UART 16550 to baud rate 9600.</div><div class="line">* PS7 UART (Zynq) is not initialized by this application, since</div><div class="line">* bootrom/bsp configures it to baud rate 115200</div><div class="line">*</div><div class="line">* ------------------------------------------------</div><div class="line">* | UART TYPE   BAUD RATE                        |</div><div class="line">* ------------------------------------------------</div><div class="line">*   uartns550   9600</div><div class="line">*   uartlite    Configurable only in HW design</div><div class="line">*   ps7_uart    115200 (configured by bootrom/bsp)</div><div class="line">*/</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"platform.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"xil_printf.h"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></div><div class="line"></span>&#123;</div><div class="line">  init_platform();</div><div class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</div><div class="line">  	print(<span class="string">"Hello World\n\r"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  cleanup_platform();</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>正常使用的应该是USB转串口，即<code>PS7 UART (Zynq)</code>，应该是在硬件设计过程中通过<code>Import XPS Settings</code>对PS上的串口进行了配置。</p>
<center><img src="../img/ZYBO/Lab2_1/STDIO_Connection.png" width="540px"/></center>
</li>
<li><p>一切正常，SDK的Console会一直打印<code>Hello World</code>，<code>ZYBO</code>板上的串口状态指示灯<code>Rx</code>会常亮。</p>
</li>
</ul>
</li>
<li><p>Read IP document </p>
<ul>
<li><p>IP documentation</p>
<center><img src="../img/ZYBO/Lab2_1/RegisterSpace.png" width="640px"/></center>
</li>
<li><p>Programming</p>
<center><img src="../img/ZYBO/Lab2_1/ProgrammingSequence.png" width="580px"/></center>
</li>
<li><p>Figure out the address，<code>axi_gpio_0</code> 基地址为：<strong>0x41200000</strong></p>
<center><img src="../img/ZYBO/Lab2_1/AddressEditor.png" width="720px"/></center>
</li>
<li><p>GPIO programing without BSP</p>
<ul>
<li><p><code>ZYBO</code>LED和Switch管脚原理图如下。</p>
<center><img src="../img/ZYBO/Lab2_1/zybo_led.png" width="640px"/></center>
</li>
<li><p>关于LED和Switch的管脚设计及约束文件如下图。</p>
<center><img src="../img/ZYBO/Lab2_1/pin_constraints.png" width="720px"/></center>
</li>
<li><p>Switches control LEDs lighting up</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"platform.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"xil_printf.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DELAY 1000000</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></div><div class="line"></span>&#123;</div><div class="line">  init_platform();</div><div class="line"></div><div class="line">  <span class="comment">// Switches</span></div><div class="line">  <span class="keyword">int</span>* gpio_chn0_base_ptr = (<span class="keyword">int</span>*)<span class="number">0x41200000</span>;</div><div class="line">  <span class="keyword">int</span>* gpio_chn0_tri_mode_ptr = gpio_chn0_base_ptr + <span class="number">1</span>;</div><div class="line">  <span class="comment">// LEDs</span></div><div class="line">  <span class="keyword">int</span>* gpio_chn1_base_ptr = gpio_chn0_base_ptr + <span class="number">2</span>;</div><div class="line">  <span class="keyword">int</span>* gpio_chn1_tri_mode_ptr = gpio_chn0_base_ptr + <span class="number">3</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Switches as input ports</span></div><div class="line">  *gpio_chn0_tri_mode_ptr = <span class="number">0xF</span>;</div><div class="line">  <span class="comment">// LEDs as output ports</span></div><div class="line">  *gpio_chn1_tri_mode_ptr = <span class="number">0x0</span>;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Switches Control LEDs Lighting Up\n\r"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> val, delay;</div><div class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</div><div class="line">    val = *gpio_chn0_base_ptr;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Switch is %x\n"</span>, val);</div><div class="line"></div><div class="line">    *gpio_chn1_base_ptr = val;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"LED is %x\n"</span>,val);</div><div class="line">    <span class="keyword">for</span>(delay=<span class="number">0</span>;delay&lt;DELAY;delay++);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  cleanup_platform();</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><code>Xilinx Tools</code>-&gt;<code>Program FPGA</code> </p>
</li>
<li><p><code>Run As</code>-&gt;<code>Launch on Hardware(GDB)</code></p>
</li>
</ul>
</li>
<li><p>强烈建议在Windows下进行上述开发（本人在Ubuntu16.04下面弄了4天，连个hello world都出现许多问题，最终选择放弃）</p>
<ul>
<li>直接开发 FPGA（PL）：<a href="http://coldnew.github.io/zybo-board/pl_led/">zybo board 開發記錄: 透過可程式邏輯控制 LED 閃爍</a><ul>
<li>Vivado开发生成 <strong>.bit</strong> FPGA配置文件</li>
<li>Hardware Manager -&gt; Program device</li>
</ul>
</li>
<li>软硬件协同开发（配置 PL 后，PS 通过 AXI 控制 PL）：<a href="http://coldnew.github.io/zybo-board/zynq_led_flash/">zybo board 開發記錄: Zynq 與 LED 閃爍控制</a><ul>
<li>Vivado开发生成 <strong>.bit</strong> FPGA配置文件</li>
<li>Export Hardware <strong>.bit</strong> to SDK</li>
<li>Launch SDK，基于上述开发的硬件平台开发Application</li>
<li>Program FPGA（<strong>.bit</strong>）</li>
<li>Run Application（<strong>.elf</strong>）on Hardware</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Lab2-2-Bootloader"><a href="#Lab2-2-Bootloader" class="headerlink" title="Lab2-2 Bootloader"></a>Lab2-2 Bootloader</h5><ul>
<li><p>Create Boot Image</p>
<center><img src="../img/ZYBO/Lab2_2/CreateZynqBootImage.png" width="540px"/></center>

<ul>
<li><p>What files needed？</p>
<ul>
<li><p><code>Output BIF file path</code> &amp; <code>Output path</code> for <strong>BOOT.bin</strong></p>
</li>
<li><p><code>Boot image partitions</code>-&gt;<code>Add</code></p>
<ul>
<li><p>Add <strong>./LAB2/Task-2/fsbl.elf</strong> as <code>bootloader</code></p>
<center><img src="../img/ZYBO/Lab2_2/fsbl_as_bootloader.png" width="640px"/></center>
</li>
<li><p>Add bitstream <strong>*.bit</strong>（generated in Lab2_1） as datafile</p>
<center><img src="../img/ZYBO/Lab2_2/bitstream_as_datafile.png" width="640px"/></center>
</li>
<li><p>Add U-boot（<strong>./LAB2/Task-2/u-boot.elf</strong>） as data file</p>
<center><img src="../img/ZYBO/Lab2_2/Uboot_as_datafile.png" width="540px"/></center>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Create Image</p>
<center><img src="../img/ZYBO/Lab2_2/CreateImage.png" width="540px"/></center>
</li>
<li><p>Copy BOOT.bin to SD card</p>
<ul>
<li>Programming Mode Jumper：SD卡模式</li>
<li>格式化你的SD卡</li>
<li>将创建的<strong>BOOT.bin</strong>拷贝到SD卡</li>
</ul>
</li>
<li><p>Test the GPIO bitstream works</p>
<ul>
<li><p>putty</p>
</li>
<li><p>help for <strong>u-boot command</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">zynq-uboot&gt; help</div><div class="line">?       - alias for &apos;help&apos;</div><div class="line">base    - print or set address offset</div><div class="line">bdinfo  - print Board Info structure</div><div class="line">boot    - boot default, i.e., run &apos;bootcmd&apos;</div><div class="line">bootd   - boot default, i.e., run &apos;bootcmd&apos;</div><div class="line">bootelf - Boot from an ELF image in memory</div><div class="line">bootm   - boot application image from memory</div><div class="line">bootp   - boot image via network using BOOTP/TFTP protocol</div><div class="line">bootvx  - Boot vxWorks from an ELF image</div><div class="line">bootz   - boot Linux zImage image from memory</div><div class="line">clk     - CLK sub-system</div><div class="line">cmp     - memory compare</div><div class="line">coninfo - print console devices and information</div><div class="line">cp      - memory copy</div><div class="line">crc32   - checksum calculation</div><div class="line">dcache  - enable or disable data cache</div><div class="line">echo    - echo args to console</div><div class="line">editenv - edit environment variable</div><div class="line">env     - environment handling commands</div><div class="line">exit    - exit script</div><div class="line">ext2load- load binary file from a Ext2 filesystem</div><div class="line">ext2ls  - list files in a directory (default /)</div><div class="line">false   - do nothing, unsuccessfully</div><div class="line">fatinfo - print information about filesystem</div><div class="line">fatload - load binary file from a dos filesystem</div><div class="line">fatls   - list files in a directory (default /)</div><div class="line">fdt     - flattened device tree utility commands</div><div class="line">fpga    - loadable FPGA image support</div><div class="line">go      - start application at address &apos;addr&apos;</div><div class="line">help    - print command description/usage</div><div class="line">icache  - enable or disable instruction cache</div><div class="line">iminfo  - print header information for application image</div><div class="line">imxtract- extract a part of a multi-image</div><div class="line">itest   - return true/false on integer compare</div><div class="line">loadb   - load binary file over serial line (kermit mode)</div><div class="line">loads   - load S-Record file over serial line</div><div class="line">loadx   - load binary file over serial line (xmodem mode)</div><div class="line">loady   - load binary file over serial line (ymodem mode)</div><div class="line">loop    - infinite loop on address range</div><div class="line">md      - memory display</div><div class="line">mdio    - MDIO utility commands</div><div class="line">mii     - MII utility commands</div><div class="line">mm      - memory modify (auto-incrementing address)</div><div class="line">mmc     - MMC sub system</div><div class="line">mmcinfo - display MMC info</div><div class="line">mw      - memory write (fill)</div><div class="line">nfs     - boot image via network using NFS protocol</div><div class="line">nm      - memory modify (constant address)</div><div class="line">ping    - send ICMP ECHO_REQUEST to network host</div><div class="line">printenv- print environment variables</div><div class="line">reset   - Perform RESET of the CPU</div><div class="line">run     - run commands in an environment variable</div><div class="line">saveenv - save environment variables to persistent storage</div><div class="line">setenv  - set environment variables</div><div class="line">sf      - SPI flash sub-system</div><div class="line">showvar - print local hushshell variables</div><div class="line">sleep   - delay execution for some time</div><div class="line">source  - run script from memory</div><div class="line">sspi    - SPI utility command</div><div class="line">test    - minimal test like /bin/sh</div><div class="line">tftpboot- boot image via network using TFTP protocol</div><div class="line">true    - do nothing, successfully</div><div class="line">version - print monitor, compiler and linker version</div><div class="line">zynq-uboot&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>LED test</p>
<ul>
<li><p>Switches address：0x41200000</p>
<p>LEDs address：0x41200008</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">zynq-uboot&gt; md 41200000</div><div class="line"># switches_base_ptr switches_tri_mode_ptr leds_base_ptr leds_tri_mode_ptr</div><div class="line"># 		41200000 			41200004 		41200008 		4120000c</div><div class="line">41200000: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200010: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200020: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200030: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200040: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200050: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200060: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200070: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200080: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">41200090: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000a0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000b0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000c0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000d0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000e0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">412000f0: 00000008 0000000f 00000008 0000000f    ................</div><div class="line">zynq-uboot&gt;</div></pre></td></tr></table></figure>
<ul>
<li>从上面可以看出，所有gpio默认都是输入</li>
</ul>
</li>
</ul>
</li>
<li><p>通过指令点亮LED</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">zynq-uboot&gt; nm 4120000c</div><div class="line"># 将led对应的gpio设置为输出</div><div class="line">4120000c: 0000000f ? 0</div><div class="line">4120000c: 00000000 ? q</div><div class="line"># 操作值寄存器，控制leds</div><div class="line">zynq-uboot&gt; nm 41200008</div><div class="line">41200008: 00000000 ? 1</div><div class="line">41200008: 00000001 ? 2</div><div class="line">41200008: 00000002 ? 3</div><div class="line">41200008: 00000003 ? 4</div><div class="line">41200008: 00000004 ? 5</div><div class="line">41200008: 00000005 ? f</div><div class="line">41200008: 0000000f ? q</div><div class="line">zynq-uboot&gt;</div></pre></td></tr></table></figure>
<ul>
<li>地址4个字节对齐，<strong>nm</strong>指令地址不符合对齐条件，系统会自动重启</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Build your U-boot</p>
<ul>
<li><p>Step by step</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</div><div class="line">$ source /opt/Xilinx/SDK/2016.1/settings64.sh</div><div class="line">$ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">$ export ARCH=arm</div><div class="line"># Extract ./LAB2/Task-3/u-boot-Digilent-Dev-master.zip</div><div class="line">$ unzip u-boot-Digilent-Dev-master.zip -d .</div><div class="line">$ cd u-boot-Digilent-Dev-master/</div><div class="line">$ make zynq_zybo_config</div><div class="line">$ make</div><div class="line"># modify common/main.c</div><div class="line"># Modify printf(“Hit any key to YOU NAME stop autoboot: %2d”, bootdelay);</div><div class="line">$ vim common/main.c</div><div class="line">$ make</div><div class="line"># just rename operation</div><div class="line">$ cp ./u-boot u-boot.elf</div></pre></td></tr></table></figure>
</li>
<li><p>Create Zynq Boot Image</p>
<ul>
<li>Use the above <strong>u-boot.elf</strong> with your name</li>
</ul>
</li>
<li><p>Copy BOOT.bin to SD card</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">zynq-uboot&gt; nm 1</div><div class="line">00000001:data abort</div><div class="line"></div><div class="line">MAYBE you should read doc/README.arm-unaligned-accesses</div><div class="line"></div><div class="line">pc : [&lt;1ff7c684&gt;]          lr : [&lt;1ff7c674&gt;]</div><div class="line">sp : 1fb54e18  ip : 00000030     fp : 1fb59fb8</div><div class="line">r10: 00000000  r9 : 1ffaf464     r8 : 1fb54f48</div><div class="line">r7 : 1ffaf468  r6 : 00000000     r5 : 00000004  r4 : 00000001</div><div class="line">r3 : e0001000  r2 : 00000802     r1 : 00000001  r0 : 1ffa6767</div><div class="line">Flags: nZCv  IRQs off  FIQs off  Mode SVC_32</div><div class="line">Resetting CPU ...</div><div class="line"></div><div class="line">resetting ...</div><div class="line">U-Boot 2013.10 (Feb 10 2017 - 15:36:21)</div><div class="line">Memory: ECC disabled</div><div class="line">DRAM:  512 MiB</div><div class="line">MMC:   zynq_sdhci: 0</div><div class="line">SF: Detected S25FL128S_64K with page size 256 Bytes, erase size 64 KiB, total 16 MiB</div><div class="line">*** Warning - bad CRC, using default environment</div><div class="line"></div><div class="line">In:    serial</div><div class="line">Out:   serial</div><div class="line">Err:   serial</div><div class="line">Net:   Gem.e000b000</div><div class="line">Warning: failed to set MAC address</div><div class="line"># Here!!!!</div><div class="line">Hit any key to Durant35 stop autoboot:  0</div><div class="line">Device: zynq_sdhci</div><div class="line">Manufacturer ID: 3</div><div class="line">OEM: 5344</div><div class="line">Name: SL08G</div><div class="line">Tran Speed: 50000000</div><div class="line">Rd Block Len: 512</div><div class="line">SD version 3.0</div><div class="line">High Capacity: Yes</div><div class="line">Capacity: 7.4 GiB</div><div class="line">Bus Width: 4-bit</div><div class="line">reading uEnv.txt</div><div class="line">** Unable to read file uEnv.txt **</div><div class="line">Copying Linux from SD to RAM...</div><div class="line">reading uImage</div><div class="line">** Unable to read file uImage **</div><div class="line">zynq-uboot&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Hack U-boot</p>
<ul>
<li><p>Hack <code>./common/cmd_fpga.c</code>, add case 1: </p>
<center><img src="../img/ZYBO/Lab2_2/Add_case1.png" width="480px"/></center>
</li>
<li><p>GPIO programing without BSP</p>
<ul>
<li><p>Initialization</p>
</li>
<li><p>Config  in and out</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_fpga</span><span class="params">(<span class="keyword">cmd_tbl_t</span> *cmdtp, <span class="keyword">int</span> flag, <span class="keyword">int</span> argc, <span class="keyword">char</span> *<span class="keyword">const</span> argv[])</span></div><div class="line"></span>&#123;</div><div class="line">  <span class="keyword">int</span> op, dev = FPGA_INVALID_DEVICE;</div><div class="line">  <span class="keyword">size_t</span> data_size = <span class="number">0</span>;</div><div class="line">  <span class="keyword">void</span> *fpga_data = <span class="literal">NULL</span>;</div><div class="line">  <span class="keyword">char</span> *devstr = getenv(<span class="string">"fpga"</span>);</div><div class="line">  <span class="keyword">char</span> *datastr = getenv(<span class="string">"fpgadata"</span>);</div><div class="line">  <span class="keyword">int</span> rc = FPGA_FAIL;</div><div class="line">  <span class="keyword">int</span> wrong_parms = <span class="number">0</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_FIT)</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fit_uname = <span class="literal">NULL</span>;</div><div class="line">  ulong fit_addr;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="comment">/* initialization */</span></div><div class="line">  <span class="meta">#<span class="meta-keyword">define</span> DELAY 100000000</span></div><div class="line">  <span class="comment">// Switches</span></div><div class="line">  <span class="keyword">int</span>* gpio_chn0_base_ptr = (<span class="keyword">int</span>*)<span class="number">0x41200000</span>;</div><div class="line">  <span class="keyword">int</span>* gpio_chn0_tri_mode_ptr = gpio_chn0_base_ptr + <span class="number">1</span>;</div><div class="line">  <span class="comment">// LEDs</span></div><div class="line">  <span class="keyword">int</span>* gpio_chn1_base_ptr = gpio_chn0_base_ptr + <span class="number">2</span>;</div><div class="line">  <span class="keyword">int</span>* gpio_chn1_tri_mode_ptr = gpio_chn0_base_ptr + <span class="number">3</span>;</div><div class="line">  <span class="comment">/* Config in and out */</span></div><div class="line">  <span class="comment">// Switches as input ports</span></div><div class="line">  *gpio_chn0_tri_mode_ptr = <span class="number">0xF</span>;</div><div class="line">  <span class="comment">// LEDs as output ports</span></div><div class="line">  *gpio_chn1_tri_mode_ptr = <span class="number">0x0</span>;</div><div class="line">  <span class="keyword">int</span> val, delay;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (devstr)</div><div class="line">      ......</div></pre></td></tr></table></figure>
</li>
<li><p>Read 8 switchs </p>
</li>
<li><p>LED light up</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="number">2</span>:		<span class="comment">/* fpga &lt;op&gt; */</span></div><div class="line"> 		op = (<span class="keyword">int</span>)fpga_get_op(argv[<span class="number">1</span>]);</div><div class="line"> 		<span class="keyword">break</span>;</div><div class="line"></div><div class="line"> 	<span class="keyword">case</span> <span class="number">1</span>:		<span class="comment">/* hack U-boot */</span> </div><div class="line"> 		<span class="built_in">printf</span>(<span class="string">"hacked U-boot\n\r"</span>);  </div><div class="line"></div><div class="line"> 		<span class="comment">/* Read switches */</span></div><div class="line"> 		val = *gpio_chn0_base_ptr;</div><div class="line"> 	    <span class="built_in">printf</span>(<span class="string">"switch is %x\n"</span>, val);</div><div class="line"> 	    <span class="keyword">for</span>(delay=<span class="number">0</span>;delay&lt;DELAY;delay++); </div><div class="line"></div><div class="line"> 		<span class="comment">/* LEDs light up */</span></div><div class="line"> 	    val = <span class="number">0x55</span>;</div><div class="line"> 	    *gpio_chn1_base_ptr = val;</div><div class="line"> 	    <span class="built_in">printf</span>(<span class="string">"LED is %x\n"</span>, val);</div><div class="line"> 	    <span class="keyword">for</span>(delay=<span class="number">0</span>;delay&lt;DELAY;delay++);</div><div class="line"></div><div class="line"> 	    val = <span class="number">0xaa</span>;</div><div class="line"> 	    *gpio_chn1_base_ptr = val;</div><div class="line"> 	    <span class="built_in">printf</span>(<span class="string">"LED is %x\n"</span>, val);</div><div class="line"> 	    <span class="keyword">for</span>(delay=<span class="number">0</span>;delay&lt;DELAY;delay++);</div><div class="line"></div><div class="line"> 		<span class="keyword">break</span>;</div><div class="line"></div><div class="line"> 	<span class="keyword">default</span>:</div><div class="line"> 		debug(<span class="string">"%s: Too many or too few args (%d)\n"</span>, __func__, argc);</div><div class="line"> 		op = FPGA_NONE;	<span class="comment">/* force usage display */</span></div><div class="line"> 		<span class="keyword">break</span>;</div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Make</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ make</div><div class="line">$ cp ./u-boot u-boot.elf</div></pre></td></tr></table></figure>
</li>
<li><p>Create Zynq Boot Image</p>
</li>
<li><p>Copy <code>./LAB2/Task-4/BOOT.bin</code> to SD card</p>
</li>
<li><p>Test it by type in fpga</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">zynq-uboot&gt; fpga</div><div class="line">hacked U-boot</div><div class="line">switch is f</div><div class="line">LED is 55</div><div class="line">LED is aa</div><div class="line">FPGA device not specified</div><div class="line">fpga - loadable FPGA image support</div><div class="line"></div><div class="line">Usage:</div><div class="line">fpga [operation type] [device number] [image address] [image size]</div><div class="line">fpga operations:</div><div class="line">  dump  [dev]                   Load device to memory buffer</div><div class="line">  info  [dev]                   list known device information</div><div class="line">  load  [dev] [address] [size]  Load device from memory buffer</div><div class="line">  loadb [dev] [address] [size]  Load device from bitstream buffer (Xilinx only)</div><div class="line">  loadmk [dev] [address]        Load device generated with mkimage</div><div class="line">        For loadmk operating on FIT format uImage address must include</div><div class="line">        subimage unit name in the form of addr:&lt;subimg_uname&gt;</div><div class="line">zynq-uboot&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h5 id="Lab2-3-Using-device-driver"><a href="#Lab2-3-Using-device-driver" class="headerlink" title="Lab2-3 Using device driver"></a>Lab2-3 Using device driver</h5><ul>
<li><p>Copy <code>/LAB2/Task-5/*</code> to SD card</p>
<ul>
<li>SD image with AXI_GPIO，4 LED，4 Switch</li>
</ul>
</li>
<li><p>LED device test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">zynq&gt; cd sys/class/gpio</div><div class="line">zynq&gt; ls</div><div class="line">export       gpiochip0    gpiochip248  gpiochip252  unexport</div><div class="line">zynq&gt; echo 252 &gt; export</div><div class="line">zynq&gt; ls</div><div class="line">export       gpio252      gpiochip0    gpiochip248  gpiochip252  unexport</div><div class="line"># LED-0为输出管脚</div><div class="line">zynq&gt; echo out &gt; gpio252/direction</div><div class="line"># 点亮LED-0</div><div class="line">zynq&gt; echo 1 &gt; gpio252/value</div><div class="line"># 灭掉LED-0</div><div class="line">zynq&gt; echo 0 &gt; gpio252/value</div><div class="line"># 253&lt;sub&gt;255对应于LED-1&lt;/sub&gt;LED-3</div></pre></td></tr></table></figure>
</li>
<li><p>Switch test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">zynq&gt; echo 248 &gt; export</div><div class="line">zynq&gt; echo in &gt; gpio248/direction</div><div class="line"># SW-0上拨</div><div class="line">zynq&gt; cat  ./gpio248/value</div><div class="line">1</div><div class="line"># SW-0下拨</div><div class="line">zynq&gt; cat  ./gpio248/value</div><div class="line">0</div><div class="line"># 249&lt;sub&gt;251对应于SW-1&lt;/sub&gt;SW-3</div></pre></td></tr></table></figure>
</li>
<li><p>使用脚本实现跑马灯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">zynq&gt; for io_num in $(seq 252 255)</div><div class="line">&gt; do</div><div class="line">&gt; echo $io_num &gt; export</div><div class="line">&gt; echo out &gt; gpio$io_num/direction</div><div class="line">&gt; done;</div><div class="line">zynq&gt; for k in $(seq 1 1000)</div><div class="line">&gt; do</div><div class="line">&gt; for io_num in $(seq 252 255)</div><div class="line">&gt; do</div><div class="line">&gt; echo 1 &gt; gpio$io_num/value</div><div class="line">&gt; sleep 10ms</div><div class="line">&gt; echo 0 &gt; gpio$io_num/value</div><div class="line">&gt; done</div><div class="line">&gt; done;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Lab2-4-Make-SD-Card"><a href="#Lab2-4-Make-SD-Card" class="headerlink" title="Lab2-4 Make SD Card"></a>Lab2-4 Make SD Card</h5><ul>
<li><p>Refer to <a href="https://github.com/Durant35/Courses/tree/master/ZYBO/BootingLinux">Booting Linux on the ZYBO</a></p>
</li>
<li><p>新建分区与格式化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ mkfs -t vfat /dev/sdb1</div><div class="line">$ sudo dosfslabel /dev/sdb1 boot</div><div class="line"></div><div class="line">$ mkfs.ext4 /dev/sdb2</div><div class="line">$ e2label /dev/sdb2 fs</div></pre></td></tr></table></figure>
</li>
<li><p>Copy image to partitions</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ tar -zxf ./LAB2/Task-6/zr_boot.8_11.tar.gz</div><div class="line">$ rsync -a zr_boot/* /media/gary/boot</div><div class="line">$ sync</div><div class="line"></div><div class="line">$ sudo tar -zxf ./LAB2/Task-6/zr_fs.8_11.tar.gz</div><div class="line">$ sudo rsync -a zr_fs/* /media/gary/fs</div><div class="line">$ sync</div></pre></td></tr></table></figure>
</li>
<li><p>可能需要设置U-boot环境参数，让 U-boot 完成 Kernel 初始化后去加载SD卡中第二个分区（<code>fs</code>）中的文件系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 虽然host将SD卡识别为/dev/sdb，但是在ZYBO仍使用/dev/mmcblk0</div><div class="line">zynq-uboot&gt; setenv bootargs &apos;console=ttyPS0,115200 root=/dev/mmcblk0p2 rw earlyprintk rootfstype=ext4 rootwait devtmpfs.mount=0&apos;</div><div class="line">zynq-uboot&gt; setenv sdboot &apos;echo Copying Linux from SD to RAM... &amp;&amp; mmcinfo &amp;&amp; fatload mmc 0 0x3000000 $&#123;kernel_image&#125; &amp;&amp; fatload mmc 0 0x2A00000 $&#123;devicetree_image&#125; &amp;&amp; bootm 0x3000000 - 0x2A00000&apos;</div><div class="line">zynq-uboot&gt; saveenv</div><div class="line">Saving Environment to SPI Flash...</div><div class="line">SF: Detected S25FL128S_64K with page size 256 Bytes, erase size 64 KiB, total 16 MiB</div><div class="line">Erasing SPI flash...Writing to SPI flash...done</div><div class="line">zynq-uboot&gt; boot</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Lab2-5-Hack-CGI-Scripts"><a href="#Lab2-5-Hack-CGI-Scripts" class="headerlink" title="Lab2-5 Hack CGI Scripts"></a>Lab2-5 Hack CGI Scripts</h5><ul>
<li><p>Test Smart Car</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~/# cd /root/boa-master/src</div><div class="line">root@xup-VirtualBox:~/boa-master/src# ls</div><div class="line">Makefile       cgi.c                defines.h    log.c         select.c</div><div class="line">Makefile.in    cgi.o                escape.c     log.o         select.o</div><div class="line">acconfig.h     cgi_header.c         escape.h     mmap_cache.c  signals.c</div><div class="line">aclocal.m4     cgi_header.o         escape.o     mmap_cache.o  signals.o</div><div class="line">alias.c        check_struct_for.m4  get.c        parse.h       sublog.c</div><div class="line">alias.o        compat.h             get.o        pipe.c        sublog.o</div><div class="line">boa            config.c             globals.h    pipe.o        test.c</div><div class="line">boa.c          config.cache         hash.c       queue.c       timestamp.c</div><div class="line">boa.h          config.h             hash.o       queue.o       timestamp.o</div><div class="line">boa.o          config.h.in          index_dir.c  read.c        util.c</div><div class="line">boa_grammar.y  config.log           index_dir.o  read.o        util.o</div><div class="line">boa_indexer    config.o             ip.c         request.c     webindex.pl</div><div class="line">boa_lexer.l    config.status        ip.o         request.o     y.tab.c</div><div class="line">buffer.c       configure            lex.yy.c     response.c    y.tab.h</div><div class="line">buffer.o       configure.in         lex.yy.o     response.o    y.tab.o</div><div class="line">root@xup-VirtualBox:~/boa-master/src# ./boa</div><div class="line">root@xup-VirtualBox:~/boa-master/src# ifconfig</div></pre></td></tr></table></figure>
<ul>
<li><p>Default ip for ZYBO board is <code>192.168.1.99</code></p>
</li>
<li><p>用网线直连 <em>host</em> 和 <em>ZYBO board</em>，手动设置 <em>host</em> 的ip到同一个网段，比如<code>192.168.1.110</code></p>
</li>
<li><p>浏览网页</p>
<center><img src="../img/ZYBO/Lab2_5/ZRobot_webpage.png" width="640px"/></center>
</li>
<li><p><a href="https://github.com/xupsh/boa">Boa Webserver</a></p>
</li>
</ul>
</li>
<li><p>Modify CGI Scripts</p>
<ul>
<li><p>源码位于<code>/var/www/cgi-bin/smart_car_CGI</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# cd /var/www/cgi-bin/smart_car_CGI</div><div class="line">root@xup-VirtualBox:/var/www/cgi-bin/smart_car_CGI# vim smart_car_left.c</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/time.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;sys/stat.h&gt;</div><div class="line">#include &quot;smart_car_move.h&quot;</div><div class="line">static int fd;</div><div class="line"></div><div class="line">int main(void)</div><div class="line">&#123;</div><div class="line"></div><div class="line">    smart_car_set(-90,60 );</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h5 id="Lab2-6-Mmap-Control-Wheels"><a href="#Lab2-6-Mmap-Control-Wheels" class="headerlink" title="Lab2-6 Mmap Control Wheels"></a>Lab2-6 Mmap Control Wheels</h5><blockquote>
<p>查看 <em>Lab2-5</em> 中远程控制小车的 <em>cgi</em> 程序（<strong>.cgi</strong>）对应的源码（<strong>.c</strong>），其实现就是通过内存映射（memory map）的方式，借助<strong>AXI</strong>，从 PS 端控制 PL 端的 PWM模块</p>
</blockquote>
<ul>
<li><p>Power On Smart Car</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# ls</div><div class="line">bak         boa-pzl     mjpeg_face_leaf_detection  openhwcar</div><div class="line">boa-master  go_wlan.sh  opencv-2.4.9               pwm_app</div><div class="line">root@xup-VirtualBox:~# mkdir pwm_xil_io</div><div class="line">root@xup-VirtualBox:~# cd pwm_xil_io/</div><div class="line">root@xup-VirtualBox:~/pwm_xil_io#</div></pre></td></tr></table></figure>
</li>
<li><p>Add <em>xil_io.h</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~/pwm_xil_io<span class="meta"># vim xil_io.h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE  ((size_t)getpagesize())</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_MASK ((uint64_t) (long)~(PAGE_SIZE - 1))</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Xil_Out32</span><span class="params">(<span class="keyword">uint64_t</span> phyaddr, <span class="keyword">uint32_t</span> val)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> fd;</div><div class="line">  <span class="keyword">volatile</span> <span class="keyword">uint8_t</span> *map_base;</div><div class="line">  <span class="keyword">uint64_t</span> base = phyaddr &amp; PAGE_MASK;</div><div class="line">  <span class="keyword">uint64_t</span> pgoffset = phyaddr &amp; (~PAGE_MASK);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>((fd = open(<span class="string">"/dev/mem"</span>, O_RDWR | O_SYNC)) == <span class="number">-1</span>) &#123;</div><div class="line">    perror(<span class="string">"open /dev/mem:"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  map_base = mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED,</div><div class="line">      fd, base);</div><div class="line">  <span class="keyword">if</span>(map_base == MAP_FAILED) &#123;</div><div class="line">    perror(<span class="string">"mmap:"</span>);</div><div class="line">  &#125;</div><div class="line">  *(<span class="keyword">volatile</span> <span class="keyword">uint32_t</span> *)(map_base + pgoffset) = val; </div><div class="line">  close(fd);</div><div class="line">  munmap((<span class="keyword">void</span> *)map_base, PAGE_SIZE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">Xil_In32</span><span class="params">(<span class="keyword">uint64_t</span> phyaddr)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> fd;</div><div class="line">  <span class="keyword">uint32_t</span> val;</div><div class="line">  <span class="keyword">volatile</span> <span class="keyword">uint8_t</span> *map_base;</div><div class="line">  <span class="keyword">uint64_t</span> base = phyaddr &amp; PAGE_MASK;</div><div class="line">  <span class="keyword">uint64_t</span> pgoffset = phyaddr &amp; (~PAGE_MASK);</div><div class="line">  <span class="comment">//open /dev/mem</span></div><div class="line">  <span class="keyword">if</span>((fd = open(<span class="string">"/dev/mem"</span>, O_RDWR | O_SYNC)) == <span class="number">-1</span>) &#123;</div><div class="line">    perror(<span class="string">"open /dev/mem:"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//mmap</span></div><div class="line">  map_base = mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, base);</div><div class="line">  <span class="keyword">if</span>(map_base == MAP_FAILED) &#123;</div><div class="line">    perror(<span class="string">"mmap:"</span>);</div><div class="line">  &#125;</div><div class="line">  val = *(<span class="keyword">volatile</span> <span class="keyword">uint32_t</span> *)(map_base + pgoffset);</div><div class="line">  close(fd);</div><div class="line">  munmap((<span class="keyword">void</span> *)map_base, PAGE_SIZE);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> val;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Add <em>pwm_app.c</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~/pwm_xil_io<span class="meta"># vim pwm_app.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> pwm_fd;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="comment">// open device</span></div><div class="line">    pwm_fd = open(<span class="string">"/dev/pwm_mod"</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (pwm_fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        perror(<span class="string">"open device pwm_mod error!\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</div><div class="line">        ioctl(pwm_fd,<span class="number">5</span>,<span class="number">1</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">1</span>,<span class="number">10000</span>);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">        ioctl(pwm_fd,<span class="number">5</span>,<span class="number">0</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">1</span>,<span class="number">10000</span>);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">        ioctl(pwm_fd,<span class="number">4</span>,<span class="number">1</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">3</span>,<span class="number">10000</span>);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">3</span>,<span class="number">0</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">        ioctl(pwm_fd,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">3</span>,<span class="number">10000</span>);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line">        ioctl(pwm_fd,<span class="number">3</span>,<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Add Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~/pwm_xil_io# vim Makefile</div><div class="line">CC=gcc</div><div class="line">CFLAGS=-o3</div><div class="line"></div><div class="line">all:</div><div class="line">  $(CC) $(CFLAGS) pwm_app.c -o test_pwm</div><div class="line"></div><div class="line">clean:</div><div class="line">  rm *.o test_pwm</div></pre></td></tr></table></figure>
</li>
<li><p>Make and test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~/pwm_xil_io# make</div><div class="line">gcc -o3 pwm_app.c -o test_pwm</div><div class="line">root@xup-VirtualBox:~/pwm_xil_io# ls</div><div class="line">Makefile  pwm_app.c  test_pwm  xil_io.h</div><div class="line">root@xup-VirtualBox:~/pwm_xil_io# ./test_pwm</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Day03"><a href="#Day03" class="headerlink" title="Day03"></a>Day03</h3><h4 id="Device-Driver-Overview"><a href="#Device-Driver-Overview" class="headerlink" title="Device Driver Overview"></a>Device Driver Overview</h4><ul>
<li>Classes of devices and modules<ul>
<li>Character devices<ul>
<li>Can accesses as stream of bytes</li>
<li><code>/dev/console</code>, <code>/dev/ttyS0</code></li>
<li>Accessed by means of filesystem nodes <code>tty1</code>, <code>lp0</code></li>
</ul>
</li>
<li>Block devices<ul>
<li>Something that can host a filesystem (e.g. disk)</li>
<li>Can accesses ONLY as multiples of a block (e.g. 1K)</li>
<li>Different with char device is transparent to user under Linux（在Linux下对用户是透明的）.</li>
<li><code>/dev/mmcblk0p1</code></li>
</ul>
</li>
<li>Network interfaces (<code>eth0</code>, <code>eth1</code>)</li>
<li>USB, Firewire, SCSI …</li>
</ul>
</li>
<li>Coding Etiquette（编码礼仪）<ul>
<li>Written with concurrency in mind</li>
<li>Must be reentrant（可重入）</li>
<li>Provide adequate controls for device operation that affect global resources or other users</li>
<li>Only functions exported by kernel can call（只有内核导出的函数才能调用） – there is no libraries to link to.</li>
<li>Avoid introducing security bugs </li>
<li>Avoid namespace pollution（命名空间污染） – many functions and global variables whose names aren’t distinguished </li>
</ul>
</li>
<li>LKM(Loadable Kernel Module) Utilities（实用程序） cmd<ul>
<li>insmod<br>Insert an LKM into the kernel.</li>
<li>rmmod<br>Remove an LKM from the kernel.</li>
<li>depmod<br>Determine interdependencies（相互依赖） between LKMs.</li>
<li>kerneld<br>Kerneld daemon program（守护程序）</li>
<li>ksyms<br>Display symbols that are exported by the kernel for use by new LKMs.</li>
<li>lsmod<br>List currently loaded LKMs.</li>
<li>modinfo<br>Display contents of .modinfo section in an LKM object file.</li>
<li>modprobe<br>Insert or remove an LKM or set of LKMs <strong>intelligently</strong>. For example, if you must load A before loading B, Modprobe will automatically load A when you tell it to load B. </li>
</ul>
</li>
</ul>
<ul>
<li><p>Linux Module Hello World</p>
<ul>
<li><p>Prepare the kernel（内核版本必须与 <em>Lab2-4 Make SD Card</em> 中使用的 <strong>uImage</strong> 版本一致，从<a href="https://github.com/Digilent/linux-digilent/releases/tag/v3.6-digilent-13.01">这里</a>获取对应的内核版本源码）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ cd ./LAB3/Task-1</div><div class="line">$ unzip linux-digilent-3.6-digilent-13.01.zip -d .</div><div class="line">$ cd linux-digilent-3.6-digilent-13.01/</div><div class="line"></div><div class="line"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</div><div class="line">$ export ARCH=arm</div><div class="line">$ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">$ source /opt/Xilinx/SDK/2016.1/settings64.sh</div><div class="line"></div><div class="line"># build the kernel</div><div class="line">$ make digilent_zed_defconfig</div><div class="line">$ make UIMAGE_LOADADDR=0x8000 uImage</div><div class="line">Image Name:   Linux-3.18.0-xilinx</div><div class="line">Created:      Sat Feb 11 17:16:11 2017</div><div class="line">Image Type:   ARM Linux Kernel Image (uncompressed)</div><div class="line">Data Size:    3447976 Bytes = 3367.16 kB = 3.29 MB</div><div class="line">Load Address: 00008000</div><div class="line">Entry Point:  00008000</div><div class="line">  Image arch/arm/boot/uImage is ready</div><div class="line"> </div><div class="line"># prepare the &quot;hello world&quot; module files</div><div class="line">$ cd ..</div><div class="line">$ mkdir drivers</div><div class="line">$ ls</div><div class="line">drivers  linux-digilent-3.6-digilent-13.01  linux-digilent-3.6-digilent-13.01.zip</div><div class="line">$ cd drivers/</div><div class="line">$ touch hello.c Makefile</div></pre></td></tr></table></figure>
<ul>
<li><p>由于上述源码比较久远（Jan 8,2013），内核编译时会出现下面的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Can&apos;t use &apos;defined(@array)&apos; (Maybe you should just omit the defined()?) at kernel/timeconst.pl line 373.</div><div class="line">/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/kernel/Makefile:133: recipe for target &apos;kernel/timeconst.h&apos; failed</div><div class="line">make[1]: *** [kernel/timeconst.h] Error 255</div><div class="line">Makefile:775: recipe for target &apos;kernel&apos; failed</div><div class="line">make: *** [kernel] Error 2</div></pre></td></tr></table></figure>
<p>这是跟 <strong>perl</strong> 版本有关系，<code>&gt;=5.22</code> 的 <strong>perl</strong> 会报这个错误，因此需要对<code>linux-digilent-3.6-digilent-13.01/kernel/timeconst.pl</code>做如下的修改：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># line:365</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  $hz += <span class="number">0</span>;			<span class="comment"># Force to number</span></div><div class="line">  <span class="keyword">if</span> ($hz &lt; <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">die</span> <span class="string">"Usage: $0 HZ\n"</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">#@val = @&#123;$canned_values&#123;$hz&#125;&#125;;</span></div><div class="line">  <span class="comment">#if (!defined(@val)) &#123;</span></div><div class="line">  <span class="comment">#	@val = compute_values($hz);</span></div><div class="line">  <span class="comment">#&#125;</span></div><div class="line">  $cv = $canned_values&#123;$hz&#125;;</div><div class="line">  @val = <span class="keyword">defined</span>($cv) ? @$cv : compute_values($hz);</div><div class="line">  </div><div class="line">  output($hz, @val);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>hello.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; </div><div class="line">  printk(<span class="string">"Hello world!\n"</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">hello_cleanup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">  printk(<span class="string">"Cleaning up module.\n"</span>); </div><div class="line">&#125;</div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_cleanup);</div></pre></td></tr></table></figure>
</li>
<li><p>Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">obj-m = hello.o </div><div class="line">all:</div><div class="line">  # make -C /your_kernel_directory M=/your_current_dirctory modules</div><div class="line">  make -C ../linux-digilent-3.6-digilent-13.01 M=$(PWD) modules</div><div class="line">clean:</div><div class="line">  make -C ../linux-digilent-3.6-digilent-13.01  M=$(PWD) clean</div><div class="line">  rm -f *.o *.ko *.mod.c *.order *.symvers *~</div></pre></td></tr></table></figure>
</li>
<li><p>What happened in the Makefile ? </p>
<ul>
<li><p>Building by Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ make clean</div><div class="line">$ make –d [|more]</div></pre></td></tr></table></figure>
</li>
<li><p>The real compile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$ ls –al</div><div class="line">total 84</div><div class="line">drwxrwxr-x 3 gary gary  4096 2月  14 12:13 .</div><div class="line">drwxrwxr-x 4 gary gary  4096 2月  14 12:06 ..</div><div class="line">-rw-rw-r-- 1 gary gary   261 2月  14 12:07 hello.c</div><div class="line">-rw-rw-r-- 1 gary gary  3282 2月  14 12:13 hello.ko</div><div class="line">-rw-rw-r-- 1 gary gary   431 2月  14 12:13 .hello.ko.cmd</div><div class="line">-rw-rw-r-- 1 gary gary   786 2月  14 12:13 hello.mod.c</div><div class="line">-rw-rw-r-- 1 gary gary  1940 2月  14 12:13 hello.mod.o</div><div class="line">-rw-rw-r-- 1 gary gary 20185 2月  14 12:13 .hello.mod.o.cmd</div><div class="line">-rw-rw-r-- 1 gary gary  1960 2月  14 12:13 hello.o</div><div class="line">-rw-rw-r-- 1 gary gary 20082 2月  14 12:13 .hello.o.cmd</div><div class="line">-rw-rw-r-- 1 gary gary   259 2月  14 12:10 Makefile</div><div class="line">-rw-rw-r-- 1 gary gary    92 2月  14 12:13 modules.order</div><div class="line">-rw-rw-r-- 1 gary gary     0 2月  14 12:13 Module.symvers</div><div class="line">drwxrwxr-x 2 gary gary  4096 2月  14 12:13 .tmp_versions</div><div class="line">$ cat .hello.o.cmd | more</div><div class="line">cmd_/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.o := arm-</div><div class="line">xilinx-linux-gnueabi-gcc -Wp,-MD,/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/T</div><div class="line">ask-1/drivers/.hello.o.d  -nostdinc -isystem /opt/Xilinx/SDK/2016.1/gnu/arm/lin/</div><div class="line">bin/../lib/gcc/arm-xilinx-linux-gnueabi/4.9.2/include -I/home/gary/Workspace/git</div><div class="line">_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/arch/arm/include </div><div class="line">-Iarch/arm/include/generated -Iinclude  -include /home/gary/Workspace/git_ws/Cou</div><div class="line">rses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/include/linux/kconfig.h </div><div class="line">-D__KERNEL__ -mlittle-endian -Iarch/arm/mach-zynq/include -Wall -Wundef -Wstrict</div><div class="line">-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -Werror-implicit-fun</div><div class="line">ction-declaration -Wno-format-security -fno-delete-null-pointer-checks -Os -marm</div><div class="line"> -fno-dwarf2-cfi-asm -mabi=aapcs-linux -mno-thumb-interwork -funwind-tables -D__</div><div class="line">LINUX_ARM_ARCH__=7 -march=armv7-a -msoft-float -Uarm -Wframe-larger-than=1024 -f</div><div class="line">no-stack-protector -Wno-unused-but-set-variable -fomit-frame-pointer -Wdeclarati</div><div class="line">on-after-statement -Wno-pointer-sign -fno-strict-overflow -fconserve-stack -DCC_</div><div class="line">HAVE_ASM_GOTO  -DMODULE  -D&quot;KBUILD_STR(s)=\#s&quot; -D&quot;KBUILD_BASENAME=KBUILD_STR(hel</div><div class="line">lo)&quot;  -D&quot;KBUILD_MODNAME=KBUILD_STR(hello)&quot; -c -o /home/gary/Workspace/git_ws/Cou</div><div class="line">rses/ZYBO/LAB3/Task-1/drivers/.tmp_hello.o /home/gary/Workspace/git_ws/Courses/Z</div><div class="line">YBO/LAB3/Task-1/drivers/hello.c</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p>The real link</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cat .hello.ko.cmd </div><div class="line">cmd_/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko := arm-xilinx-linux-gnueabi-ld -EL -r  -T /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/scripts/module-common.lds --build-id  -o /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.o /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.mod.o</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"># check module kernel version is 3.6.0-digilent-13.01</div><div class="line">$ modinfo ./LAB3/Task-1/drivers/hello.ko</div><div class="line">filename:       /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko</div><div class="line">depends:        </div><div class="line">vermagic:       3.6.0-digilent-13.01 SMP preempt mod_unload modversions ARMv7</div><div class="line"></div><div class="line"># 1. Copy ./LAB3/Task-1/drivers/hello.ko to your SD card</div><div class="line">$ sudo rm /media/gary/root/hello.ko</div><div class="line">$ sudo cp ./LAB3/Task-1/drivers/hello.ko /media/gary/root/</div><div class="line"></div><div class="line"># 2. Boot your ZED board</div><div class="line"></div><div class="line"># 3. Mount SD card to /mnt</div><div class="line">root@xup-VirtualBox:~# mount /dev/mmcblk0p2 /mnt/</div><div class="line">root@xup-VirtualBox:~# cd /mnt/</div><div class="line">root@xup-VirtualBox:/mnt# ls</div><div class="line">Card_Recog  etc       lost+found  proc          sbin     test      var</div><div class="line">bin         hello.ko  media       pwmdriver.ko  selinux  test.jpg</div><div class="line">boot        home      mnt         root          srv      tmp</div><div class="line">dev         lib       opt         run           sys      usr</div><div class="line"></div><div class="line"># 4. Insert hello module and check some status information</div><div class="line">root@xup-VirtualBox:/mnt# insmod ./hello.ko</div><div class="line">root@xup-VirtualBox:/mnt# lsmod</div><div class="line">Module                  Size  Used by</div><div class="line">hello                    689  0</div><div class="line">root@xup-VirtualBox:/mnt# cat /proc/modules</div><div class="line">hello 689 0 - Live 0xbf000000 (PO)</div><div class="line">root@xup-VirtualBox:/mnt# dmesg</div><div class="line">[  130.320000] hello: module license &apos;unspecified&apos; taints kernel.</div><div class="line">[  130.320000] Disabling lock debugging due to kernel taint</div><div class="line">[  130.320000] Hello world!</div><div class="line"></div><div class="line"># 5. Remove hello module</div><div class="line">root@xup-VirtualBox:/mnt# rmmod ./hello</div><div class="line">root@xup-VirtualBox:/mnt# dmesg</div><div class="line">[  130.320000] hello: module license &apos;unspecified&apos; taints kernel.</div><div class="line">[  130.320000] Disabling lock debugging due to kernel taint</div><div class="line">[  130.320000] Hello world!</div><div class="line">[  306.810000] Cleaning up module.</div></pre></td></tr></table></figure>
</li>
<li><p>编译模块的内核版本必须与系统内核版本一致，否则会出现以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:/mnt# insmod ./hello.ko</div><div class="line">insmod: error inserting &apos;./hello.ko&apos;: -1 Invalid module format</div><div class="line">root@xup-VirtualBox:/mnt# dmesg | grep hello</div><div class="line">[   95.770000] hello: disagrees about version of symbol module_layout</div></pre></td></tr></table></figure>
<p>查看 <em>hello world</em> 模块内核版本信息为<code>3.3.0-digilent-12.07-zed-beta</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:/mnt# modinfo ./hello.ko</div><div class="line">depends:        </div><div class="line">vermagic:       3.3.0-digilent-12.07-zed-beta SMP preempt mod_unload modversions ARMv7</div></pre></td></tr></table></figure>
<p>而 <strong>ZYBO</strong> 上的系统内核却是<code>3.6.0-digilent-13.01</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# uname -a</div><div class="line">Linux xup-VirtualBox 3.6.0-digilent-13.01-g06b3889 #45 SMP PREEMPT Wed Aug 6 12:39:14 CST 2014 armv7l armv7l armv7l GNU/Linux</div></pre></td></tr></table></figure>
</li>
<li><p>Linking a module to the kernel</p>
<p>从上面的<code>hello world</code>模块的例子，我们可以总结出以下的模块运行流程</p>
<center><img src="../img/ZYBO/Lab3_1/module_linked2kernel.png" width="540px"/></center>
</li>
</ul>
</li>
<li><p>Character Device Driver（字符设备驱动）</p>
<ul>
<li><p>Major and Minor Numbers</p>
<ul>
<li><p>Special files under <code>/dev</code> “c” for char &amp; “b” for block</p>
</li>
<li><p>Major number identifies driver use at open time</p>
<ul>
<li><p>Adding a new driver at module initialization</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_chrdev</span><span class="params">(</div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">struct</span> file_operations *fops)</span></span>;</div></pre></td></tr></table></figure>
</li>
<li><p>If <strong>major</strong> is 0, the <code>register_chrdev</code> return a free number</p>
</li>
</ul>
</li>
<li><p>Minor number is used only by driver to control several devices</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ ls -l /dev/</div><div class="line">total 0</div><div class="line">#					Major number,Minor number					</div><div class="line">crw-------  1 root root     10, 235 2月  14 10:07 autofs</div><div class="line">drwxr-xr-x  2 root root         600 2月  14 16:18 block</div><div class="line">drwxr-xr-x  2 root root          60 2月  14 16:18 bsg</div><div class="line">crw-------  1 root root     10, 234 2月  14 10:07 btrfs-control</div><div class="line">drwxr-xr-x  3 root root          60 2月  14 10:07 bus</div><div class="line">drwxr-xr-x  2 root root        4180 2月  14 16:18 char</div><div class="line">crw-------  1 root root      5,   1 2月  14 10:08 console</div><div class="line">brw-rw----  1 root disk      8,   0 2月  14 10:07 sda</div><div class="line">brw-rw----  1 root disk      8,   1 2月  14 10:08 sda1</div><div class="line">brw-rw----  1 root disk      8,   2 2月  14 10:07 sda2</div><div class="line">brw-rw----  1 root disk      8,   3 2月  14 10:07 sda3</div><div class="line">crw-rw----  1 root disk     21,   0 2月  14 10:07 sg0</div><div class="line">drwxrwxrwt  2 root root         260 2月  14 17:10 shm</div><div class="line">crw-------  1 root root     10, 231 2月  14 10:07 snapshot</div><div class="line">drwxr-xr-x  3 root root         260 2月  14 10:08 snd</div><div class="line">lrwxrwxrwx  1 root root          15 2月  14 10:07 stderr -&gt; /proc/self/fd/2</div><div class="line">lrwxrwxrwx  1 root root          15 2月  14 10:07 stdin -&gt; /proc/self/fd/0</div><div class="line">lrwxrwxrwx  1 root root          15 2月  14 10:07 stdout -&gt; /proc/self/fd/1</div></pre></td></tr></table></figure>
<p><code>sda1</code>，<code>sda2</code>，<code>sda3</code>都由<code>driver 8</code> 管理</p>
</li>
<li><p>通过 <code>mknod</code> 创建设备节点</p>
<ul>
<li><p>在<code>/dev</code>目录下创建相应的设备只是为应用程序去使用它提供了途径，它们之间可以通过设备号联系在一起。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# mount /dev/mmcblk0p2 /mnt/</div><div class="line">root@xup-VirtualBox:~# cd /mnt/</div><div class="line">root@xup-VirtualBox:/mnt# ls</div><div class="line">Card_Recog  dev       home        media  proc  sbin     sys       tmp</div><div class="line">bin         etc       lib         mnt    root  selinux  test      usr</div><div class="line">boot        hello.ko  lost+found  opt    run   srv      test.jpg  var</div><div class="line">root@xup-VirtualBox:/mnt# insmod ./hello.ko</div><div class="line">root@xup-VirtualBox:/mnt# ls -l /dev/ | grep hello</div><div class="line">root@xup-VirtualBox:/mnt# mknod /dev/hello c 38 0</div><div class="line">root@xup-VirtualBox:/mnt# ls -l /dev/ | grep hello</div><div class="line">crw-r--r-- 1 root root  38,   0 Jan  1 00:18 hello</div><div class="line">root@xup-VirtualBox:/mnt#</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Device in ZYBO board</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# ls -al /dev/</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>From module to driver（将模块按照驱动定义的接口进行实现）</p>
<ul>
<li><p>Implementation（实现流程）</p>
<ul>
<li>Assuming that your device name is Xxx</li>
<li>Xxx_init()， initialize the device when OS is booted</li>
<li>Xxx_open()，open a device </li>
<li>Xxx_read()，read from kernel memory </li>
<li>Xxx_write()，write </li>
<li>Xxx_release() ，clean-up (close)</li>
<li>init_module()</li>
<li>cleanup_module()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations hello_fops = &#123;</div><div class="line">  owner:	THIS_MODULE,</div><div class="line">  read:		hello_read,</div><div class="line">  write:	hello_write,</div><div class="line">  open:		hello_open,</div><div class="line">  release:	hello_release,</div><div class="line">&#125;;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> storage;<span class="comment">//just for demo</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (register_chrdev(<span class="number">38</span>, <span class="string">"hello"</span>, &amp;hello_fops)) </div><div class="line">    <span class="keyword">return</span> -EBUSY;</div><div class="line">  storage=<span class="number">0</span>;    <span class="comment">//just for demo</span></div><div class="line">  <span class="keyword">return</span>  <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">  unregister_chrdev(<span class="number">38</span>, <span class="string">"hello"</span>)</div><div class="line">&#125; </div><div class="line"></div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_exit);</div></pre></td></tr></table></figure>
</li>
<li><p>Read and Write</p>
<center><img src="../img/ZYBO/Lab3_1/module_read&write.png" width="640px"/></center>

<ul>
<li><p>Copying data from and to application code（API 接口）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">struct</span> file *filp, <span class="keyword">char</span> *buff, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *offp);</div><div class="line"><span class="keyword">ssize_t</span> write(<span class="keyword">struct</span> file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buff, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *offp);</div></pre></td></tr></table></figure>
</li>
<li><p>In your module</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span>	<span class="comment">// for copy_to_user and copy_from_user</span></span></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_read</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span> </span>&#123;</div><div class="line">    copy_to_user(buf, &amp;storage, <span class="keyword">sizeof</span>(storage));		   </div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_write</span><span class="params">(<span class="keyword">struct</span> file* file,<span class="keyword">const</span> <span class="keyword">char</span>* buf,<span class="keyword">size_t</span> count,<span class="keyword">loff_t</span>* ppos)</span></span>&#123;</div><div class="line">     copy_from_user(&amp;storage, buf, <span class="keyword">sizeof</span>(storage));</div><div class="line">     <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>User land <code>test.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//test.c</span></div><div class="line"><span class="keyword">int</span> test = <span class="number">0</span>;</div><div class="line">fd = open(<span class="string">"/dev/hello"</span>, O_RDWR);</div><div class="line">read(fd, &amp;test, <span class="keyword">sizeof</span>(test));</div><div class="line"><span class="built_in">printf</span>(<span class="string">"%d test\n"</span>);</div><div class="line">test++; </div><div class="line">write(fd, &amp;test, <span class="keyword">sizeof</span>(test));</div><div class="line">close(fd);</div></pre></td></tr></table></figure>
</li>
<li><p>Compile and test（详见 <code>Lab3-1 Character Device Driver</code>）</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Some kernel functions can be used</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">// arch/arm/include/asm/io.h</div><div class="line">// /linux/kernel.h</div><div class="line">add_timer() </div><div class="line">  Causes a function to be executed when a given amount of time has passed </div><div class="line">cli() </div><div class="line">  Prevents interrupts from being acknowledged </div><div class="line">end_request() </div><div class="line">  Called when a request has been satisfied or aborted </div><div class="line">free_irq() </div><div class="line">  Frees an IRQ previously acquired with request_irq() or irqaction() </div><div class="line">get_user*() </div><div class="line">  Allows a driver to access data in user space, a memory area distinct from the kernel </div><div class="line">inb(), inb_p() </div><div class="line">  Reads a byte from a port. Here, inb() goes as fast as it can, while inb_p() pauses before returning. </div><div class="line">irqaction() </div><div class="line">  Registers an interrupt like a signal. </div><div class="line">IS_*(inode) </div><div class="line">  Tests if inode is on a file system mounted with the corresponding flag. </div><div class="line">kfree*() </div><div class="line">  Frees memory previously allocated with kmalloc() </div><div class="line">kmalloc() </div><div class="line">  Allocates a chu nk of memory no larger than 4096 bytes. </div><div class="line">MAJOR() </div><div class="line">  Reports the major device number for a device. </div><div class="line">MINOR() </div><div class="line">  Reports the minor device number for a device. </div><div class="line">memcpy_*fs() </div><div class="line">  Copies chunks of memory between user space and kernel space </div><div class="line">outb(), outb_p() , outl </div><div class="line">  Writes a byte to a port. Here, outb() goes as fast as it can, while outb_p() pauses before returning. </div><div class="line">printk() </div><div class="line">  A version of printf() for the kernel. </div><div class="line">put_user*() </div><div class="line">  Allows a driver to write data in user space. </div><div class="line">register_*dev() </div><div class="line">  Registers a device with the kernel. </div><div class="line">request_irq() </div><div class="line">  Requests an IRQ from the kernel, and, if successful, installs an IRQ interrupt handler. </div><div class="line">select_wait() </div><div class="line">  Adds a process to the proper select_wait queue. </div><div class="line">*sleep_on() </div><div class="line">  Sleeps on an event, puts a wait_queue entry in the list so that the process can be awakened on that event. </div><div class="line">sti() </div><div class="line">  Allows interrupts to be acknowledged. </div><div class="line">sys_get*() </div><div class="line">  System calls used to get information regarding the process, user, or group. </div><div class="line">wake_up*() </div><div class="line">  Wakes up a process that has been put to sleep by the matching *sleep_on() function.</div></pre></td></tr></table></figure>
</li>
<li><p>Debugging Techniques</p>
<ul>
<li>printk</li>
<li>Using the /proc Filesystem</li>
<li>ioctl</li>
<li>Using gdb</li>
<li>The kdb Kernel Debugger</li>
</ul>
</li>
<li><p>其他考虑的地方</p>
<ul>
<li>Concurrency and race condition <ul>
<li>Semaphores and Mutexes</li>
</ul>
</li>
<li>Communicating  with hardware<ul>
<li>Using I/O Ports</li>
<li>Manipulating（操作） I/O ports</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Sysfs-Virtual-File-System"><a href="#Sysfs-Virtual-File-System" class="headerlink" title="Sysfs Virtual File System"></a>Sysfs Virtual File System</h4><ul>
<li><p>Unified Device Model（统一设备模型）</p>
<ul>
<li>Kernels previous to 2.5 had no single data structure to store information on how system is put together</li>
<li>Demands of newer systems with more complicated topologies and power management motivated construction of the Linux Unified Device Model</li>
<li>Device Model Functionality<ul>
<li>Power management and system shutdown<ul>
<li>Knowing the ordering of when to shut down components.</li>
<li>E.g., shut down USB mouse before USB controller</li>
</ul>
</li>
<li>Communication with user space<ul>
<li>Sysfs virtual file system tightly tied into device model and exposes structure and device tuning（设备调谐）</li>
</ul>
</li>
<li>Hotpluggable devices（设备热插拔）<ul>
<li>Used to handle and communicate the plugging and unplugging of devices</li>
</ul>
</li>
<li>Device classes<ul>
<li>Allows system to discover types of devices that are related</li>
</ul>
</li>
<li>Other<ul>
<li>Common facilities such as reference counting</li>
<li>Capability to enumerate all devices and status</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>sysfs overview</p>
<ul>
<li>In-memory virtual file system</li>
<li>Provides view of the <strong>kobject</strong> hierarchy</li>
<li>Enables users to view device topology of system</li>
<li><strong>kobjects</strong> can export files that enable kernel variables to be read and written<ul>
<li>Sound a lot like /proc?</li>
</ul>
</li>
</ul>
</li>
<li><p>sysfs Directories</p>
<ul>
<li>类型<ul>
<li>block<ul>
<li>Contains one directory for each of the registered block devices on the system</li>
<li>Contains subdirectories for partitions on the device</li>
</ul>
</li>
<li>bus</li>
<li>class<ul>
<li>Organized by high-level function</li>
</ul>
</li>
<li>dev<ul>
<li>Registered device nodes</li>
</ul>
</li>
<li>devices<ul>
<li>Gives view of topology of devices in system</li>
</ul>
</li>
<li>firmware<ul>
<li>System-specific tree of low-level subsystems</li>
<li>ACPI, EDD, EFI</li>
</ul>
</li>
<li>fs</li>
<li>kernel<ul>
<li>Kernel configuration options and status info</li>
</ul>
</li>
<li>modules</li>
<li>power</li>
</ul>
</li>
<li>devices is most important directory – exports device model</li>
<li>Much of the data in other directories is alternative organization of data in devices </li>
<li>Neat to see interconnections（看出整齐的互联关系）<ul>
<li>High-level concepts in class</li>
<li>Low-level physical devices in devices </li>
<li>Actual drivers in bus</li>
</ul>
</li>
</ul>
</li>
<li><p>PWM Sysfs Example</p>
<ul>
<li><p>PWM driver overview</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module_init(pwm_driver_module_init);</div><div class="line">module_exit(pwm_driver_module_exit);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations pwm_driver_fops = &#123;</div><div class="line">  owner = THIS_MODULE,</div><div class="line">  	<span class="comment">/* no read  write here  */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>pwm_driver_module_init</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">pwm_driver_major = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;pwm_driver_fops);</div><div class="line">pwm_driver_class = class_create(THIS_MODULE, <span class="string">"pwm_driver"</span>);</div><div class="line">pwm_driver_device = device_create(pwm_driver_class, <span class="literal">NULL</span>, MKDEV(pwm_driver_major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"pwm_device"</span>);</div><div class="line"></div><div class="line">device_create_file(pwm_driver_device,&amp;dev_attr_pwm_frequency);</div><div class="line">device_create_file(pwm_driver_device, &amp;dev_attr_pwm_duty);</div><div class="line"></div><div class="line">pwm_fre_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ioremap(PWM_MOUDLE_PHY_ADDR, <span class="keyword">sizeof</span>(u32));</div><div class="line">pwm_duty_addr = pwm_fre_addr+<span class="number">4</span>;</div></pre></td></tr></table></figure>
<p>其中，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">device_create_file(pwm_driver_device,&amp;dev_attr_pwm_frequency);</div><div class="line">device_create_file(pwm_driver_device, &amp;dev_attr_pwm_duty);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_frequency, S_IWUSR, <span class="literal">NULL</span>,sys_pwm_frequency_set)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_duty,S_IWUSR, <span class="literal">NULL</span>, sys_pwm_duty_set)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_duty_set</span><span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</div><div class="line">  <span class="comment">// Covert ASCII to binary and frequency</span></div><div class="line">  	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; count<span class="number">-1</span>; i++) &#123;</div><div class="line">        value *= <span class="number">10</span>;</div><div class="line">        value += buf[i] - <span class="string">'0'</span>;</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">if</span>(value &gt; <span class="number">100</span>)</div><div class="line">    	value = <span class="number">100</span>;</div><div class="line">  </div><div class="line">  value = <span class="number">100000000</span>/frequency*value/<span class="number">100</span>;</div><div class="line">  </div><div class="line">  	outl(value, pwm_duty_addr);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="LAB3"><a href="#LAB3" class="headerlink" title="LAB3"></a>LAB3</h4><h5 id="Lab3-1-Character-Device-Driver"><a href="#Lab3-1-Character-Device-Driver" class="headerlink" title="Lab3-1 Character Device Driver"></a>Lab3-1 Character Device Driver</h5><ul>
<li><p><code>./LAB3/Task-2/hello.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></div><div class="line"><span class="comment">//#include &lt;asm/uaccess.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> driver_major;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_read</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span> </span>&#123;</div><div class="line">    printk(<span class="string">"read hello \n"</span>); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations hello_fops = &#123;</div><div class="line">  owner:		THIS_MODULE,</div><div class="line">  read:		hello_read,</div><div class="line">  <span class="comment">//write:		hello_write,</span></div><div class="line">  <span class="comment">//open:		hello_open,</span></div><div class="line">  <span class="comment">//release:	hello_release,</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    driver_major = register_chrdev(<span class="number">0</span>, <span class="string">"hello"</span>, &amp;hello_fops);</div><div class="line">    <span class="keyword">if</span> (driver_major &lt; <span class="number">0</span>) &#123;</div><div class="line">        printk(<span class="string">"failed to register device.\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    printk(<span class="string">"init hello module v2 major is %d\n"</span>, driver_major); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">hello_cleanup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; </div><div class="line">  unregister_chrdev(driver_major, <span class="string">"hello"</span>);</div><div class="line">  printk(<span class="string">"Cleaning up module %d\n"</span>, driver_major); </div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_cleanup);</div></pre></td></tr></table></figure>
</li>
<li><p><code>./LAB3/Task-2/Makefile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">obj-m = hello.o </div><div class="line">all:</div><div class="line">  # make -C /your_kernel_directory M=/your_current_dirctory modules</div><div class="line">  make -C ../Task-1/linux-digilent-3.6-digilent-13.01 M=$(PWD) modules</div><div class="line">clean:</div><div class="line">  make -C ../Task-1/linux-digilent-3.6-digilent-13.01 M=$(PWD) clean</div><div class="line">  rm -f *.o *.ko *.mod.c *.order *.symvers *~</div></pre></td></tr></table></figure>
</li>
<li><p><code>./LAB3/Task-2/test.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> test=<span class="number">0</span>;</div><div class="line">  <span class="keyword">int</span> fd;</div><div class="line"></div><div class="line">  fd = open(<span class="string">"/dev/hello"</span>, O_RDWR);</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"open /dev/hello fail\n"</span>);</div><div class="line">    <span class="built_in">exit</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  read(fd, &amp;test, <span class="keyword">sizeof</span>(test));</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"%d test\n"</span>,test);</div><div class="line"></div><div class="line">  test++; </div><div class="line">  write(fd, &amp;test, <span class="keyword">sizeof</span>(test));</div><div class="line"></div><div class="line">  close(fd);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Cross-compile module on Host</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ cd ./LAB3/Task-2</div><div class="line"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</div><div class="line">$ export ARCH=arm</div><div class="line">$ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">$ source /opt/Xilinx/SDK/2016.1/settings64.sh</div><div class="line">$ make</div><div class="line"># make -C /your_kernel_directory M=/your_current_dirctory modules</div><div class="line">make -C ../Task-1/linux-digilent-3.6-digilent-13.01 M=/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2 modules</div><div class="line">make[1]: Entering directory &apos;/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01&apos;</div><div class="line">  CC [M]  /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2/hello.o</div><div class="line">  Building modules, stage 2.</div><div class="line">  MODPOST 1 modules</div><div class="line">  LD [M]  /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2/hello.ko</div><div class="line">make[1]: Leaving directory &apos;/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01&apos;</div></pre></td></tr></table></figure>
</li>
<li><p>Compile and Test on ZYBO board</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"># Copy to ZYBO using USB</div><div class="line">root@xup-VirtualBox:~# lsblk</div><div class="line">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</div><div class="line">sda           8:0    1   7.3G  0 disk</div><div class="line">`-sda4        8:4    1   7.3G  0 part</div><div class="line">mmcblk0     179:0    0   7.4G  0 disk</div><div class="line">|-mmcblk0p1 179:1    0    50M  0 part</div><div class="line">`-mmcblk0p2 179:2    0   7.4G  0 part /</div><div class="line">root@xup-VirtualBox:~# mount /dev/sda4 /mnt/</div><div class="line">root@xup-VirtualBox:~# cd /mnt/</div><div class="line">root@xup-VirtualBox:~# cd Task-2/</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# insmod ./hello.ko</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# dmesg | tail</div><div class="line">[  158.000000] hello: module license &apos;unspecified&apos; taints kernel.</div><div class="line">[  158.000000] Disabling lock debugging due to kernel taint</div><div class="line">[  158.000000] init hello module v2 major is 249</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# lsmod</div><div class="line">Module                  Size  Used by</div><div class="line">hello                   1119  0</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# gcc –o test test.c</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">open /dev/hello fail</div><div class="line">0 test</div><div class="line"># Major number should be the same as above info, 249</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# mknod /dev/hello c 249 0</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">0 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">0 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">0 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# rmmod hello</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# lsmod</div><div class="line">Module                  Size  Used by</div></pre></td></tr></table></figure>
<ul>
<li>The number should  not increase since our driver don’t have memory</li>
</ul>
</li>
<li><p>Keep some memory in driver</p>
<ul>
<li><p>A modified <code>./LAB3/Task-2/hello.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">int</span> driver_major;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> storage;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_read</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span> </span>&#123;</div><div class="line">    printk(<span class="string">"read hello \n"</span>); </div><div class="line">    copy_to_user(buf, &amp;storage, <span class="keyword">sizeof</span>(storage));		   </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_write</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span> </span>&#123;</div><div class="line">    printk(<span class="string">"write hello \n"</span>); </div><div class="line">    copy_from_user(&amp;storage, buf, <span class="keyword">sizeof</span>(storage));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_open</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span></div><div class="line"></span>&#123;</div><div class="line">    printk(<span class="string">"open hello \n"</span>); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">hello_release</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* ppos)</span></div><div class="line"></span>&#123;</div><div class="line">    printk(<span class="string">"release hello \n"</span>); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations hello_fops = &#123;</div><div class="line">  owner:		THIS_MODULE,</div><div class="line">  read:		hello_read,</div><div class="line">  write:		hello_write,</div><div class="line">  open:		hello_open,</div><div class="line">  release:	hello_release,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    driver_major = register_chrdev(<span class="number">0</span>, <span class="string">"hello"</span>, &amp;hello_fops);</div><div class="line">    <span class="keyword">if</span> (driver_major &lt; <span class="number">0</span>) &#123;</div><div class="line">        printk(<span class="string">"failed to register device.\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    printk(<span class="string">"init hello module v3 major is %d\n"</span>, driver_major); </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">hello_cleanup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; </div><div class="line">  unregister_chrdev(driver_major, <span class="string">"hello"</span>);</div><div class="line">  printk(<span class="string">"Cleaning up module %d\n"</span>, driver_major); </div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_cleanup);</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Compile and Test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# mount /dev/sda4 /mnt/</div><div class="line">root@xup-VirtualBox:~# cd /mnt/</div><div class="line">root@xup-VirtualBox:/mnt# cd Task-2_v2/</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# insmod ./hello.ko</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# lsmod</div><div class="line">Module                  Size  Used by</div><div class="line">hello                   1362  0</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# dmesg | tail</div><div class="line">[    4.140000] sd 0:0:0:0: [sda] No Caching mode page present</div><div class="line">[    4.140000] sd 0:0:0:0: [sda] Assuming drive cache: write through</div><div class="line">[    4.170000]  sda: sda4</div><div class="line">[    4.180000] sd 0:0:0:0: [sda] No Caching mode page present</div><div class="line">[    4.180000] sd 0:0:0:0: [sda] Assuming drive cache: write through</div><div class="line">[    4.190000] sd 0:0:0:0: [sda] Attached SCSI removable disk</div><div class="line">[   13.210000] init: plymouth-stop pre-start process (1371) terminated with status 1</div><div class="line">[  290.630000] hello: module license &apos;unspecified&apos; taints kernel.</div><div class="line">[  290.630000] Disabling lock debugging due to kernel taint</div><div class="line">[  290.640000] init hello module v3 major is 249</div><div class="line"># Major number should be the same as above info, 249</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# mknod /dev/hello c 249 0</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# gcc -o test test.c</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# ./test</div><div class="line">0 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">1 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# ./test</div><div class="line">2 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2# rmmod hello</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# ./test</div><div class="line">open /dev/hello fail</div><div class="line">0 test</div><div class="line">root@xup-VirtualBox:/mnt/Task-2_v2# lsmod</div><div class="line">Module                  Size  Used by</div></pre></td></tr></table></figure>
<ul>
<li>The number should increase each time you run it</li>
</ul>
</li>
</ul>
<h5 id="Lab3-2-Create-PWM-IP"><a href="#Lab3-2-Create-PWM-IP" class="headerlink" title="Lab3-2 Create PWM IP"></a>Lab3-2 Create PWM IP</h5><blockquote>
<p><strong>IP</strong> 是 <strong>Intellectual Property</strong> 的缩写，在嵌入式 <strong>FPGA</strong> 设计中，指的是某些设计好的模块，分为软件模块和硬件模块。这些模块，一般都是已经测试好，所有功能完善的，由一些用户自己设计的。有些模块是免费的，也有收费的模块。所有用户都可以将这些 <strong>IP</strong> 核 <strong>(IP Core)</strong> 导入到自己的工程中，同样，所有用户也都可以定制自己的 <strong>IP</strong> 核。</p>
</blockquote>
<ul>
<li><p>Hardware design</p>
<ul>
<li><p>Open the <code>hello world</code> Vivado project</p>
</li>
<li><p>Click Tools Create and Package IP…</p>
<center><img src="../img/ZYBO/Lab3_3/CreateandPackageIP.png" width="480px"/></center>
</li>
<li><p>Next</p>
<center><img src="../img/ZYBO/Lab3_3/Welcome2CreateIP.png" width="540px"/></center>
</li>
<li><p>IP details</p>
<center><img src="../img/ZYBO/Lab3_3/PeripheralDetails.png" width="640px"/></center>
</li>
<li><p>IP settings</p>
<center><img src="../img/ZYBO/Lab3_3/AddInterfaces.png" width="540px"/></center>
</li>
<li><p>Create IP and open in another project</p>
<center><img src="../img/ZYBO/Lab3_3/CreatePeripheral.png" width="540px"/></center>
</li>
<li><p>Motor IP created</p>
<center><img src="../img/ZYBO/Lab3_3/Open&CreateIP.png" width="800px"/></center>
</li>
<li><p>Double click top module</p>
<center><img src="../img/ZYBO/Lab3_3/top_module.png" width="720px"/></center>

<ul>
<li><p>Add following lines</p>
<center><img src="../img/ZYBO/Lab3_3/top_module_modifying1.png" width="720px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Users to add ports here</span></div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_dir1,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_dir2,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_pwm1,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_pwm2,</div><div class="line"><span class="comment">// User ports ends</span></div></pre></td></tr></table></figure>
<center><img src="../img/ZYBO/Lab3_3/top_module_modifying2.png" width="640px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">) motor_v1_0_S00_AXI_inst (</div><div class="line">  <span class="variable">.motor_dir1</span>(motor_dir1),</div><div class="line">  <span class="variable">.motor_dir2</span>(motor_dir2),</div><div class="line">  <span class="variable">.motor_pwm1</span>(motor_pwm1),</div><div class="line">  <span class="variable">.motor_pwm2</span>(motor_pwm2),</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Double click motor_v1_0_…</p>
<center><img src="../img/ZYBO/Lab3_3/instModifying_top.png" width="480px"/></center>

<ul>
<li><p>Add following lines</p>
<center><img src="../img/ZYBO/Lab3_3/instModifying1.png" width="720px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Users to add ports here</span></div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_dir1,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_dir2,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_pwm1,</div><div class="line"><span class="keyword">output</span> <span class="keyword">wire</span> motor_pwm2,</div><div class="line"><span class="comment">// User ports ends</span></div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Click Add Sources</p>
<center><img src="../img/ZYBO/Lab3_3/AddSources.png" width="320px"/></center>
</li>
<li><p>Add design source</p>
<center><img src="../img/ZYBO/Lab3_3/AddDesignSource.png" width="640px"/></center>
</li>
<li><p>Choose Create File</p>
<center><img src="../img/ZYBO/Lab3_3/ChooseCreateFile.png" width="640px"/></center>
</li>
<li><p>Set name as motor，存放位置位于 IP的 <code>/ip_repo/motor_1.0/hdl</code>处</p>
<center><img src="../img/ZYBO/Lab3_3/Set_name_as_motor.png" width="480px"/></center>
</li>
<li><p>OK–&gt;Finish</p>
<center><img src="../img/ZYBO/Lab3_3/Finish.png" width="720px"/></center>
</li>
<li><p>IP IO Port Definitions</p>
<center><img src="../img/ZYBO/Lab3_3/IO_Port_Definitions.png" width="640px"/></center>
</li>
<li><p>Add following lines</p>
<center><img src="../img/ZYBO/Lab3_3/instModifying2.png" width="800px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Add user logic here</span></div><div class="line">motor car_motor1(</div><div class="line">  <span class="variable">.clk</span>(S_AXI_ACLK),</div><div class="line">  <span class="variable">.rstn</span>(S_AXI_ARESEIN),</div><div class="line">  <span class="variable">.dir</span>(slv_reg1[<span class="number">0</span>]),</div><div class="line">  <span class="variable">.pwm_dutty</span>(slv_reg0[<span class="number">13</span>:<span class="number">0</span>]),</div><div class="line">  <span class="variable">.motor_dir</span>(motor_dir1),</div><div class="line">  <span class="variable">.pwm_out</span>(motor_pwm1)</div><div class="line">);</div><div class="line"></div><div class="line">motor car_motor2(</div><div class="line">  <span class="variable">.clk</span>(S_AXI_ACLK),</div><div class="line">  <span class="variable">.rstn</span>(S_AXI_ARESEIN),</div><div class="line">  <span class="variable">.dir</span>(slv_reg3[<span class="number">0</span>]),</div><div class="line">  <span class="variable">.pwm_dutty</span>(slv_reg2[<span class="number">13</span>:<span class="number">0</span>]),</div><div class="line">  <span class="variable">.motor_dir</span>(motor_dir2),</div><div class="line">  <span class="variable">.pwm_out</span>(motor_pwm2)</div><div class="line">);</div><div class="line"><span class="comment">// User logic ends</span></div></pre></td></tr></table></figure>
</li>
<li><p>Modify <code>motor</code> IP module</p>
<center><img src="../img/ZYBO/Lab3_3/motor_v.png" width="800px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">module</span> motor(</div><div class="line">    <span class="keyword">input</span> clk,</div><div class="line">    <span class="keyword">input</span> rstn,</div><div class="line">    <span class="keyword">input</span> dir,</div><div class="line">    <span class="keyword">input</span> [<span class="number">13</span>:<span class="number">0</span>] pwm_dutty,</div><div class="line">    <span class="keyword">input</span> motor_dir,</div><div class="line">    <span class="keyword">input</span> pwm_out</div><div class="line">    );</div><div class="line">    </div><div class="line">    <span class="keyword">reg</span> [<span class="number">13</span>:<span class="number">0</span>] pwm_cnt;</div><div class="line">  </div><div class="line">  <span class="keyword">always</span>@(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></div><div class="line">    <span class="keyword">if</span>((pwm_cnt == <span class="number">9999</span>) || ~rstn)</div><div class="line">      pwm_cnt &lt;= <span class="number">0</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">      pwm_cnt &lt;= pwm_cnt + <span class="number">1</span>;</div><div class="line">  <span class="keyword">end</span></div><div class="line">  </div><div class="line">  <span class="keyword">assign</span> pwm_out = pwm_dutty &gt; pwm_cnt ? <span class="number">1'b1</span> : <span class="number">1'b0</span>;</div><div class="line">  <span class="keyword">assign</span> motor_dir = dir;</div><div class="line">    </div><div class="line"><span class="keyword">endmodule</span></div></pre></td></tr></table></figure>
</li>
<li><p>Change to Package IP tab-&gt;Click Merge changes</p>
<center><img src="../img/ZYBO/Lab3_3/MergeChanges_IPFiles.png" width="720px"/></center>

<center><img src="../img/ZYBO/Lab3_3/MergeChanges_IPPorts.png" width="720px"/></center>
</li>
<li><p>Check IP GUI</p>
<center><img src="../img/ZYBO/Lab3_3/Check_IPGUI.png" width="720px"/></center>
</li>
<li><p>Re-Package IP（用于编辑 IP 的临时工程会自动关闭）</p>
<center><img src="../img/ZYBO/Lab3_3/Re-Package_IP.png" width="720px"/></center>
</li>
</ul>
</li>
<li><p>Using designed PWM IP in <code>hello world</code> project</p>
<ul>
<li><p>In <code>hello world</code> project Block Design, Add pwm IP</p>
<center><img src="../img/ZYBO/Lab3_3/Add_IP.png" width="720px"/></center>

<ul>
<li><p>Search pwm</p>
<center><img src="../img/ZYBO/Lab3_3/Search_PWM_IP.png" width="720px"/></center>
</li>
<li><p>Auto connect</p>
<center><img src="../img/ZYBO/Lab3_3/AutoConnectwithPWM.png" width="720px"/></center>
</li>
<li><p>选中 PWM 模块的 4 个输出引脚，右键 <code>Make External</code>创建外部管脚</p>
<center><img src="../img/ZYBO/Lab3_3/MakeExternal.png" width="720px"/></center>
</li>
</ul>
</li>
<li><p>Modified constraints，添加以下管脚约束（引脚对应）</p>
<center><img src="../img/ZYBO/Lab3_3/Modifying_constraints.png" width="720px"/></center>

<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">##****************************** Motor on JD ******************************</div><div class="line">## JD3_N</div><div class="line">set_property PACKAGE_PIN U15 [get_ports &#123;motor_dir1&#125;]</div><div class="line">set_property IOSTANDARD LVCMOS33 [get_ports &#123;motor_dir1&#125;]</div><div class="line"></div><div class="line">## JD1_N</div><div class="line">set_property PACKAGE_PIN T15 [get_ports &#123;motor_pwm1&#125;]</div><div class="line">set_property IOSTANDARD LVCMOS33 [get_ports &#123;motor_pwm1&#125;]</div><div class="line"></div><div class="line">## JD1_P</div><div class="line">set_property PACKAGE_PIN T14 [get_ports &#123;motor_dir2&#125;]</div><div class="line">set_property IOSTANDARD LVCMOS33 [get_ports &#123;motor_dir2&#125;]</div><div class="line"></div><div class="line">## JD3_P</div><div class="line">set_property PACKAGE_PIN U14 [get_ports &#123;motor_pwm2&#125;]</div><div class="line">set_property IOSTANDARD LVCMOS33 [get_ports &#123;motor_pwm2&#125;]</div></pre></td></tr></table></figure>
</li>
<li><p>Recreate HDL wapper</p>
<center><img src="../img/ZYBO/Lab3_3/RecreateHDL_wrapper.png" width="480px"/></center>
</li>
<li><p>Regenerate Output Products</p>
<center><img src="../img/ZYBO/Lab3_3/RegenerateOutputProducts.png" width="480px"/></center>
</li>
<li><p>Generate Bitstream</p>
<center><img src="../img/ZYBO/Lab3_3/GenerateBitstream.png" width="360px"/></center>
</li>
</ul>
</li>
<li><p>Software Design</p>
</li>
</ul>
<h5 id="Lab3-3-PWM-IP-Modify"><a href="#Lab3-3-PWM-IP-Modify" class="headerlink" title="Lab3-3 PWM IP Modify"></a>Lab3-3 PWM IP Modify</h5><ul>
<li><p>Using Vivado to open the hardware system（原始的教程是使用该工程，如果遇到问题，可以使用上面已经添加了<code>motor</code>模块的<code>hello world</code>工程）</p>
<blockquote>
<p>From：<a href="https://github.com/xupsh/zrobot_v1">https://github.com/xupsh/zrobot_v1</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 可惜人家是Vivado2014.4，我用Vivado2016.1搞不定</div><div class="line"># 通过tcl恢复包含PWM的硬件工程</div><div class="line"># 进入Vivado的TCL-console</div><div class="line">cd &apos;your path&apos;/hardware_prj</div><div class="line">source ./system_pro.tcl</div><div class="line"># 等待bit生成完毕</div></pre></td></tr></table></figure>
</li>
<li><p>Open PWM IP in IP Catalog</p>
<ul>
<li><p><code>Window</code>-&gt;<code>IP Catalog</code></p>
<center><img src="../img/ZYBO/Lab3_4/PWM_IP_in_IP_Catalog.png" width="800px"/></center>
</li>
</ul>
</li>
<li><p>Change Edition Number</p>
<center><img src="../img/ZYBO/Lab3_4/Edit_IP_Packager.png" width="480px"/></center>
</li>
<li><p>PWM IP Open</p>
<center><img src="../img/ZYBO/Lab3_4/PWM_IP_open.png" width="720px"/></center>
</li>
<li><p>Modify the code</p>
<center><img src="../img/ZYBO/Lab3_4/Modify_the_code.png" width="800px"/></center>
</li>
<li><p>In Package IP Tab, Merge Changes</p>
<center><img src="../img/ZYBO/Lab3_4/MergeChanges_Parameters.png" width="640px"/></center>

<center><img src="../img/ZYBO/Lab3_4/MergeChanges_Port.png" width="640px"/></center>
</li>
<li><p>Repackage IP</p>
<center><img src="../img/ZYBO/Lab3_4/RepackageIP.png" width="640px"/></center>

</li>
</ul>
<h5 id="Lab3-4-Sysfs-PWM-kernel-module"><a href="#Lab3-4-Sysfs-PWM-kernel-module" class="headerlink" title="Lab3-4 Sysfs PWM kernel module"></a>Lab3-4 Sysfs PWM kernel module</h5><ul>
<li><p><code>./LAB3/Task-3/pwm_driver.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">"pwm_device"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MYPWM_PHY_ADDR 0x43c01000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MYGPIO_PHY_ADDR 0x41200000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> WHEEL_OFFSET 0x1000</span></div><div class="line"></div><div class="line">MODULE_AUTHOR(<span class="string">"Durant35"</span>);</div><div class="line">MODULE_DESCRIPTION(<span class="string">"pwm"</span>);</div><div class="line">MODULE_VERSION(<span class="string">"v2.0"</span>);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> pwm_major;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="keyword">class</span>* pwm_class = <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> device* pwm_device = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> mypwm_addr = <span class="number">0</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> mygpio_addr = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</div><div class="line">* set the speed of pwn+x</div><div class="line">* if bit[31]=0 stop</div><div class="line">* else go</div><div class="line">*/</span></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_left_speed_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></div><div class="line"></span>&#123;</div><div class="line">   	u32 num = <span class="number">0</span>;</div><div class="line">  printk(<span class="string">"debug: at pwm left speed main!\n"</span>);</div><div class="line">  <span class="built_in">sscanf</span>(buf, <span class="string">"%d"</span>, &amp;num);</div><div class="line">  printk(<span class="string">"debug: get num:%d\n"</span>, num);</div><div class="line">  printk(<span class="string">"debug: addr = :0x%x\n"</span>, mypwm_addr);</div><div class="line">   	iowrite32(num == <span class="number">0</span> ? <span class="number">0</span> : (num | <span class="number">0x80000000</span>), mypwm_addr);</div><div class="line">   	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_left_dir_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></div><div class="line"></span>&#123;</div><div class="line">  	u32 num = <span class="number">0</span>;</div><div class="line">  <span class="built_in">sscanf</span>(buf, <span class="string">"%d"</span>, &amp;num);</div><div class="line">  	iowrite32(num, mypwm_addr + <span class="number">4</span>);</div><div class="line">  <span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_right_speed_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></div><div class="line"></span>&#123;</div><div class="line">  u32 num = <span class="number">0</span>;</div><div class="line">  	<span class="built_in">sscanf</span>(buf, <span class="string">"%d"</span>, &amp;num);</div><div class="line">  	iowrite32(num == <span class="number">0</span> ? <span class="number">0</span> : (num | <span class="number">0x80000000</span>), mypwm_addr + <span class="number">8</span>);</div><div class="line">  <span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_right_dir_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></div><div class="line"></span>&#123;</div><div class="line">  	u32 num = <span class="number">0</span>;</div><div class="line">  	<span class="built_in">sscanf</span>(buf, <span class="string">"%d"</span>, &amp;num);</div><div class="line">    iowrite32(num, mypwm_addr + <span class="number">12</span>);</div><div class="line">  	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//pwm speed</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_left_speed, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_left_speed_set)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_right_speed, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_right_speed_set)</span></span>;</div><div class="line"><span class="comment">//pwm direction</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_left_dir, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_left_dir_set)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_right_dir, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_right_dir_set)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations pwm_fops = &#123;</div><div class="line">  	.owner = THIS_MODULE,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">mydriver_module_init</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    pwm_major = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;pwm_fops);</div><div class="line">    <span class="keyword">if</span> (pwm_major &lt; <span class="number">0</span>)&#123;</div><div class="line">        printk(<span class="string">"failed to register device.\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pwm_class = class_create(THIS_MODULE, <span class="string">"pwm_class"</span>);</div><div class="line">    <span class="keyword">if</span> (IS_ERR(pwm_class))&#123;</div><div class="line">        printk(<span class="string">"failed to create device class.\n"</span>);</div><div class="line">        unregister_chrdev(pwm_major, DEVICE_NAME);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    pwm_device = device_create(pwm_class, <span class="literal">NULL</span>, MKDEV(pwm_major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"pwm_device"</span>);</div><div class="line">    <span class="keyword">if</span> (IS_ERR(pwm_device))&#123;</div><div class="line">        printk(<span class="string">"failed to create device .\n"</span>);</div><div class="line">        unregister_chrdev(pwm_major, DEVICE_NAME);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  	<span class="comment">//pwm</span></div><div class="line">  	ret = device_create_file(pwm_device, &amp;dev_attr_pwm_left_speed);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        printk(<span class="string">"failed to create /sys endpoint"</span>);</div><div class="line"></div><div class="line">    ret = device_create_file(pwm_device, &amp;dev_attr_pwm_right_speed);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        printk(<span class="string">"failed to create /sys endpoint"</span>);</div><div class="line"></div><div class="line">    ret = device_create_file(pwm_device, &amp;dev_attr_pwm_left_dir);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        printk(<span class="string">"failed to create /sys endpoint"</span>);</div><div class="line"></div><div class="line">    ret = device_create_file(pwm_device, &amp;dev_attr_pwm_right_dir);</div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">        printk(<span class="string">"failed to create /sys endpoint"</span>);</div><div class="line"></div><div class="line">    mypwm_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ioremap(MYPWM_PHY_ADDR, <span class="keyword">sizeof</span>(u32));</div><div class="line"></div><div class="line">    printk(<span class="string">"my pwm driver initial successfully!\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">mydriver_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line"></span>&#123;</div><div class="line">  	device_remove_file(pwm_device, &amp;dev_attr_pwm_left_speed);</div><div class="line">    device_remove_file(pwm_device, &amp;dev_attr_pwm_right_speed);</div><div class="line">    device_remove_file(pwm_device, &amp;dev_attr_pwm_left_dir);</div><div class="line">    device_remove_file(pwm_device, &amp;dev_attr_pwm_right_dir);</div><div class="line">    device_destroy(pwm_class, MKDEV(pwm_major, <span class="number">0</span>));</div><div class="line">    class_unregister(pwm_class);</div><div class="line">    class_destroy(pwm_class);</div><div class="line">    unregister_chrdev(pwm_major, DEVICE_NAME);</div><div class="line">    printk(<span class="string">"pwm module exit.\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(mydriver_module_init);</div><div class="line">module_exit(mydriver_module_exit);</div></pre></td></tr></table></figure>
</li>
<li><p><code>./LAB3/Task-3/Makefile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ifneq ($(KERNELRELEASE),)</div><div class="line">obj-m := pwm_driver.o</div><div class="line">else</div><div class="line">#KERNEL_DIR := &lt;YOUR_DIR&gt;/ZedBoard/Kernel/Digilent-linux-3.3-digilent-7f8e908</div><div class="line">KERNEL_DIR := ../Task-1/linux-digilent-3.6-digilent-13.01</div><div class="line">PWD := $(shell pwd)</div><div class="line">all:</div><div class="line">$(MAKE) -C $(KERNEL_DIR) SUBDIRS=$(PWD) modules ARCH=arm</div><div class="line">clean:</div><div class="line">rm *.o *.ko *.mod.c</div><div class="line">endif</div></pre></td></tr></table></figure>
</li>
<li><p>PWM driver as module </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">  $ cd ./LAB3/Task-3</div><div class="line">  # 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</div><div class="line">  $ export ARCH=arm</div><div class="line">  $ export CROSS_COMPILE=arm-xilinx-linux-gnueabi-</div><div class="line">  $ source /opt/Xilinx/SDK/2016.1/settings64.sh</div><div class="line">  $ make</div><div class="line">  $ modinfo ./pwm_driver.ko </div><div class="line">  filename:       /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-3/./pwm_driver.ko</div><div class="line">  license:        GPL</div><div class="line">  version:        v2.0</div><div class="line">  description:    pwm</div><div class="line">  author:         Durant35</div><div class="line">  srcversion:     632D3D00D0727423CF51FB5</div><div class="line">  depends:        </div><div class="line">  vermagic:       3.6.0-digilent-13.01 SMP preempt mod_unload modversions ARMv7</div><div class="line">  # Copy pwm_driver.ko to ZYBO using USB</div><div class="line">  root@xup-VirtualBox:~# mount /dev/sda4 /mnt/</div><div class="line">  root@xup-VirtualBox:~# cd /mnt/</div><div class="line">  root@xup-VirtualBox:~# cd Task-3/</div><div class="line">  root@xup-VirtualBox:/mnt# cd Task-3/</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# ls</div><div class="line">  Makefile        modules.order  pwm_driver.ko     pwm_driver.mod.o</div><div class="line">  Module.symvers  pwm_driver.c   pwm_driver.mod.c  pwm_driver.o</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# insmod ./pwm_driver.ko</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# insmod ./pwm_driver.ko</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# lsmod</div><div class="line">  Module                  Size  Used by</div><div class="line">  pwm_driver              2477  0</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# rmmod pwm_driver</div><div class="line">  root@xup-VirtualBox:/mnt/Task-3# dmesg | tail</div><div class="line">[    4.280000] sd 0:0:0:0: [sda] No Caching mode page present</div><div class="line">[    4.280000] sd 0:0:0:0: [sda] Assuming drive cache: write through</div><div class="line">[    4.280000] sd 0:0:0:0: [sda] Attached SCSI removable disk</div><div class="line">[    4.650000] init: failsafe main process (1200) killed by TERM signal</div><div class="line">[    4.720000] init: udev-fallback-graphics main process (1235) terminated with status 1</div><div class="line">[    4.790000] init: plymouth main process (633) killed by SEGV signal</div><div class="line">[    4.790000] init: plymouth-splash main process (1244) terminated with status 2</div><div class="line">[   14.810000] init: plymouth-stop pre-start process (1367) terminated with status 1</div><div class="line">[   91.250000] my pwm driver initial successfully!</div><div class="line">[  120.990000] pwm module exit.</div><div class="line">root@xup-VirtualBox:/mnt/Task-3# cd /sys/class/pwm_class/pwm_device</div><div class="line">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device# ls</div><div class="line">dev    pwm_left_dir    pwm_right_dir    subsystem</div><div class="line">power  pwm_left_speed  pwm_right_speed  uevent</div><div class="line">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device# echo 1 &gt; pwm_left_dir</div><div class="line">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device# echo 5000 &gt; pwm_left_speed</div><div class="line"># Use scope to measure JA1 wave form</div><div class="line"># Add your own printk in the course code to debug</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Lab3-5-I-O-Access"><a href="#Lab3-5-I-O-Access" class="headerlink" title="Lab3-5 I/O Access"></a>Lab3-5 I/O Access</h5><ul>
<li><p>The {in,out}[bwl] macros are for emulating x86-style PCI/ISA IO space.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></div><div class="line">outl(value, virtual_address);</div><div class="line">value = inl(virtual_address);</div></pre></td></tr></table></figure>
</li>
<li><p>Another version of <code>pwm_driver.c</code>（Using I/O Access to configure PWM IP’s frequency and duty cycle）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">"PWM_MOUDLE"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PWM_MOUDLE_PHY_ADDR 0x6CA00000		<span class="comment">//This Address is based XPS</span></span></div><div class="line"></div><div class="line">MODULE_AUTHOR(<span class="string">"Xilinx XUP"</span>);</div><div class="line">MODULE_DESCRIPTION(<span class="string">"PWM moudle dirver"</span>);</div><div class="line">MODULE_VERSION(<span class="string">"v1.0"</span>);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> pwm_driver_major;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="keyword">class</span>* pwm_driver_class = <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> device* pwm_driver_device = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="comment">// pwm_fre_addr&amp;pwm_duty_addr init in pwm_driver_module_init()</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pwm_fre_addr = <span class="number">0</span>;				<span class="comment">//pwm moulde's frequency visual address</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pwm_duty_addr = <span class="number">0</span>;			<span class="comment">//pwm moulde's duty visual address</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">long</span> frequency = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations pwm_driver_fops = &#123;</div><div class="line">  	.owner = THIS_MODULE,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_frequency_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">long</span> value = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    frequency = <span class="number">0</span>;</div><div class="line">    outl(value, pwm_fre_addr);				<span class="comment">//close pwm moudle before we modfiy the frequency</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; count<span class="number">-1</span>; i++) &#123;</div><div class="line">      	frequency *= <span class="number">10</span>;</div><div class="line">      	frequency += buf[i] - <span class="string">'0'</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(value &gt; <span class="number">100000000</span>) </div><div class="line">      	value=<span class="number">100000000</span>;</div><div class="line">    value = <span class="number">100000000</span>/frequency;			<span class="comment">// 100Mhz/frequency 100Mhz is set by XPS</span></div><div class="line"></div><div class="line">    outl(value, pwm_fre_addr);</div><div class="line">    <span class="keyword">return</span> count;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">sys_pwm_duty_set</span> <span class="params">(<span class="keyword">struct</span> device* dev, <span class="keyword">struct</span> device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span> 							<span class="comment">//duty cycle </span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">long</span> value = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"> 	outl(value, pwm_duty_addr); 			<span class="comment">//close pwm moudle before we modfiy the duty cycle</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; count<span class="number">-1</span>; i++) &#123;</div><div class="line">      	value *= <span class="number">10</span>;</div><div class="line">      	value += buf[i] - <span class="string">'0'</span>;</div><div class="line">    &#125;</div><div class="line"> 	<span class="keyword">if</span> (value&gt;<span class="number">100</span>) </div><div class="line">      	value = <span class="number">100</span>;</div><div class="line"> 	value = <span class="number">100000000</span>/frequency*value/<span class="number">100</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (value != <span class="number">0</span>)</div><div class="line">      	value = value | <span class="number">0x80000000</span>;</div><div class="line">    outl(value, pwm_duty_addr);</div><div class="line"></div><div class="line">  	<span class="keyword">return</span> count;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_frequency, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_frequency_set)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(pwm_duty, S_IWUSR, <span class="literal">NULL</span>, sys_pwm_duty_set)</span></span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">pwm_driver_module_init</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line"></span>&#123;</div><div class="line">  	<span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">  	pwm_driver_major = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;pwm_driver_fops);</div><div class="line">  	<span class="keyword">if</span>(pwm_driver_major &lt; <span class="number">0</span>) &#123;</div><div class="line">      	printk(<span class="string">"failed to register device.\n"</span>);</div><div class="line">      	<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">  	&#125;</div><div class="line"></div><div class="line">  	pwm_driver_class = class_create(THIS_MODULE, <span class="string">"pwm_driver"</span>);</div><div class="line">  	<span class="keyword">if</span>(IS_ERR(pwm_driver_class)) &#123;</div><div class="line">        printk(<span class="string">"failed to create pwm moudle class.\n"</span>);</div><div class="line">        unregister_chrdev(pwm_driver_major, DEVICE_NAME);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">  	pwm_driver_device = device_create(pwm_driver_class, <span class="literal">NULL</span>, MKDEV(pwm_driver_major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"pwm_device"</span>);</div><div class="line">    <span class="keyword">if</span>(IS_ERR(pwm_driver_device)) &#123;</div><div class="line">      	printk(<span class="string">"failed to create device .\n"</span>);</div><div class="line">      	unregister_chrdev(pwm_driver_major, DEVICE_NAME);</div><div class="line">      	<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  	ret = device_create_file(pwm_driver_device, &amp;dev_attr_pwm_frequency);</div><div class="line">  	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</div><div class="line">      	printk(<span class="string">"failed to create pwm_frequency endpoint\n"</span>);</div><div class="line"></div><div class="line">  	ret = device_create_file(pwm_driver_device, &amp;dev_attr_pwm_duty);</div><div class="line">  	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</div><div class="line">      	printk(<span class="string">"failed to create pwm_duty endpoint\n"</span>);</div><div class="line">   </div><div class="line"> 	<span class="comment">//To get Custom IP--PWM moudle's virtual address</span></div><div class="line">  	pwm_fre_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ioremap(PWM_MOUDLE_PHY_ADDR, <span class="keyword">sizeof</span>(u32));</div><div class="line">   	pwm_duty_addr = pwm_fre_addr + <span class="number">4</span>;</div><div class="line">   </div><div class="line">  	printk(<span class="string">" pwm driver initial successfully!\n"</span>);</div><div class="line">   	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">pwm_driver_module_exit</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line"></span>&#123;</div><div class="line">    device_remove_file(pwm_driver_device, &amp;dev_attr_pwm_frequency);</div><div class="line">    device_remove_file(pwm_driver_device, &amp;dev_attr_pwm_duty);</div><div class="line">    device_destroy(pwm_driver_class, MKDEV(pwm_driver_major, <span class="number">0</span>));</div><div class="line">    class_unregister(pwm_driver_class);</div><div class="line">    class_destroy(pwm_driver_class);</div><div class="line">    unregister_chrdev(pwm_driver_major, DEVICE_NAME);</div><div class="line">    printk(<span class="string">"pwm module exit.\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(pwm_driver_module_init);</div><div class="line">module_exit(pwm_driver_module_exit);</div></pre></td></tr></table></figure>
</li>
<li><p>Add <strong>I/O access</strong> to your <code>hello.c</code> driver</p>
<ul>
<li>对 <strong>Lab2-4 Make SD Card</strong> 中使用的系统进行 <strong>Lab2-2 Bootloader</strong> 中的<code>LED Test</code> 发现二者的 LED 和 SW 的硬件地址是一样的。<ul>
<li>Switches address：0x41200000</li>
<li>LEDs address：0x41200008</li>
</ul>
</li>
<li>Task-4：Try to access the LED address,  turn LED on and off in Open</li>
<li>Task-5：Turn LED on and off when read and write</li>
</ul>
</li>
</ul>
<h3 id="Day04"><a href="#Day04" class="headerlink" title="Day04"></a>Day04</h3><h4 id="Version-Control-with-Git"><a href="#Version-Control-with-Git" class="headerlink" title="Version Control with Git"></a>Version Control with Git</h4><ul>
<li><p>Basic Intro to Git</p>
<ul>
<li>Discuss how Git differs from Subversion</li>
<li>Discuss the basic Git model</li>
<li>Pull/clone files from a  repository on github</li>
<li>Edit files in your own local Git repo</li>
<li>Push files to a repo on github</li>
</ul>
</li>
<li><p>Git History</p>
<ul>
<li>Came out of Linux development community </li>
<li>Linus Torvalds, 2005</li>
<li>Initial goals:<ul>
<li>Speed</li>
<li>Support for <strong>non-linear development</strong> (thousands of parallel branches)</li>
<li>Fully <strong>distributed</strong></li>
<li>Able to handle large projects like Linux efficiently</li>
</ul>
</li>
</ul>
</li>
<li><p>Basic Git model</p>
<ul>
<li><p>Git uses a distributed model</p>
<center><img src="../img/ZYBO/day04/Git_distributed_model.png" width="540px"/></center>
</li>
<li><p>Git takes snapshots</p>
<center><img src="../img/ZYBO/day04/Git_snapshots.png" width="600px"/></center>
</li>
<li><p>Git uses checksums</p>
<ul>
<li>In <strong>Subversion</strong> each modification to the central repo <strong>incremented the  version #</strong> of the overall repo.</li>
<li>How will this numbering scheme work when each user has their own copy of the repo, and commits changes to their local copy of the repo before pushing to the central server?????</li>
<li>Instead,  <strong>Git</strong> generates a <strong>unique SHA-1 hash</strong> – 40 character string of hex digits, for every commit.  Refer to commits by this ID rather than a version number. <strong>Often we only see the first 7 characters</strong>:<ul>
<li><code>1677b2d</code> Edited first line of readme</li>
<li><code>258efa7</code> Added line to readme</li>
<li><code>0e52da7</code> Initial commit</li>
</ul>
</li>
</ul>
</li>
<li><p>A Local Git project has three areas（Staged Files：暂存文件）</p>
<center><img src="../img/ZYBO/day04/Git_three_areas.png" width="480px"/></center>
</li>
<li><p>Git file lifecycle</p>
<center><img src="../img/ZYBO/day04/Git_file_lifecycle.png" width="540px"/></center>
</li>
</ul>
</li>
<li><p>Basic Git Workflow</p>
<ul>
<li><strong>Modify</strong> files in your working directory.</li>
<li>Stage files, <strong>adding</strong> snapshots of them to your staging area（暂存区）.</li>
<li>Do  a <strong>commit</strong>, which takes the files as they are in the staging area and stores that snapshot permanently to your Git directory.</li>
<li>Notes:<ul>
<li>If a particular version of a file is in the git directory, it’s considered <strong>committed</strong>. </li>
<li>If it’s modified but has been added to the staging area, it is <strong>staged</strong>. </li>
<li>If it was changed since it was checked out but has not been staged, it is <strong>modified</strong>.</li>
</ul>
</li>
</ul>
</li>
<li><p>Aside（此外）: So what is github?</p>
<ul>
<li><p><code>GitHub.com</code> is a site for online storage of Git repositories.  </p>
</li>
<li><p>Many open source projects use it, such as the Linux kernel.  </p>
</li>
<li><p>You can get free space for open source projects or you can pay for private projects.</p>
</li>
<li><p><strong>Question</strong>: Do I have to use github to use Git?</p>
<p>Answer: No! </p>
<ul>
<li>you can use Git <strong>completely locally</strong> for your own purposes, or </li>
<li>you or someone else could <strong>set up a server</strong> to share files, or </li>
<li>you could share a repo with users on <strong>the same file system</strong> (as long everyone has the needed file permissions).</li>
</ul>
</li>
</ul>
</li>
<li><p>Get ready to use Git!</p>
<ul>
<li><p>Set the name and email for Git to use when you commit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --global user.name “Bugs Bunny”</div><div class="line">$ git config --global user.email bugs@gmail.com</div></pre></td></tr></table></figure>
<ul>
<li><p>You can call git config –list to verify these are set.</p>
</li>
<li><p>These will be set <strong>globally for all Git projects you work with</strong>.</p>
</li>
<li><p>You can also set variables on a project-only basis by not using the <code>--global</code> flag</p>
</li>
<li><p>You can also set the editor that is used for writing commit messages：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --global core.editor emacs</div><div class="line"># (it is vim by default)</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Create a local copy of a repo</p>
<p><strong>1.</strong>Two common scenarios (only do one of these):</p>
<ul>
<li><p>To clone an already existing repo to your current directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git clone &lt;url&gt; [local dir name]</div></pre></td></tr></table></figure>
<p>This will create a directory named <code>local dir name</code>, containing  a working copy of the files from the repo, and a <code>.git</code> directory (<strong>used to hold the staging area and your actual repo</strong>)</p>
</li>
<li><p>To create a Git repo in your current directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git init</div></pre></td></tr></table></figure>
<p>This will create a <code>.git</code> directory in your current directory.</p>
</li>
</ul>
<p><strong>2.</strong>Then you can commit files in that directory into the repo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git add file1.java</div><div class="line">$ git commit –m &quot;initial project version&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>Git commands</p>
<center><img src="../img/ZYBO/day04/Git_commands.png" width="640px"/></center>
</li>
<li><p>Committing files</p>
<ul>
<li><p>The first time we ask a file to be tracked, and every time before we commit a file we must add it to the staging area:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git add README.txt hello.java</div></pre></td></tr></table></figure>
<p>This takes a snapshot of these files at this point in time and adds it to the staging area.</p>
</li>
<li><p>To move staged changes into the repo we commit:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git commit -m &quot;Fixing bug #22&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>To unstage a change on a file before you have committed it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git reset HEAD -- filename</div></pre></td></tr></table></figure>
</li>
<li><p>To unmodify a modified file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout -- filename</div></pre></td></tr></table></figure>
</li>
<li><p><strong>Note！！！</strong>: These commands are just acting on your local version of repo.</p>
</li>
</ul>
</li>
<li><p>Status and Diff</p>
<ul>
<li><p>To view the status of your files in the working directory and staging area:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git status</div><div class="line"># -s shows a short one line version similar to svn</div><div class="line">$ git status -s</div></pre></td></tr></table></figure>
</li>
<li><p>To see what is modified but unstaged:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git diff</div></pre></td></tr></table></figure>
</li>
<li><p>To see staged changes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git diff --cached</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>After editing a file…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[rea@attu1 superstar]$ emacs rea.txt</div><div class="line">[rea@attu1 superstar]$ git status</div><div class="line"># On branch master</div><div class="line"># Changes not staged for commit:</div><div class="line">#   (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">#   (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line">#</div><div class="line">#       modified:   rea.txt</div><div class="line">#</div><div class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</div><div class="line">[rea@attu1 superstar]$ git status -s</div><div class="line">M rea.txt						#Note: M is in second column = &quot;working tree&quot;</div><div class="line">[rea@attu1 superstar]$ git diff			</div><div class="line">                #Note: Shows modifications that have not been staged.</div><div class="line">diff --git a/rea.txt b/rea.txt</div><div class="line">index 66b293d..90b65fd 100644</div><div class="line">--- a/rea.txt</div><div class="line">+++ b/rea.txt</div><div class="line">@@ -1,2 +1,4 @@</div><div class="line">Here is rea&apos;s file.</div><div class="line">+</div><div class="line">+One new line added.</div><div class="line">[rea@attu1 superstar]$ git diff --cached</div><div class="line">                #Note: Shows nothing, no modifications have been staged yet.</div><div class="line">[rea@attu1 superstar]$</div></pre></td></tr></table></figure>
</li>
<li><p>After adding file to staging area…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[rea@attu1 superstar]$ git add rea.txt</div><div class="line">[rea@attu1 superstar]$ git status</div><div class="line"># On branch master</div><div class="line"># Changes to be committed:</div><div class="line">#   (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)</div><div class="line">#</div><div class="line">#       modified:   rea.txt</div><div class="line">#</div><div class="line">[rea@attu1 superstar]$ git status -s</div><div class="line">M  rea.txt					#Note: M is in first column = &quot;staging area&quot;</div><div class="line">[rea@attu1 superstar]$ git diff	</div><div class="line">              #Note: Shows nothing, no modifications that have not been staged.</div><div class="line">[rea@attu1 superstar]$ git diff --cached</div><div class="line">              #Note: Shows staged modifications.</div><div class="line">diff --git a/rea.txt b/rea.txt</div><div class="line">index 66b293d..90b65fd 100644</div><div class="line">--- a/rea.txt</div><div class="line">+++ b/rea.txt</div><div class="line">@@ -1,2 +1,4 @@</div><div class="line">Here is rea&apos;s file.</div><div class="line">+</div><div class="line">+One new line added.</div></pre></td></tr></table></figure>
</li>
<li><p>Viewing logs</p>
<ul>
<li><p>To see a log of all changes in your local repo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ git log</div><div class="line">1677b2d Edited first line of readme</div><div class="line">...</div><div class="line">258efa7 Added line to readme</div><div class="line">...</div><div class="line">0e52da7 Initial commit</div><div class="line">...</div><div class="line"># to show a shorter version</div><div class="line">$ git log --oneline</div><div class="line"># to show only the 5 most recent updates</div><div class="line">$ git log -5</div></pre></td></tr></table></figure>
</li>
<li><p><strong>Note！！！</strong>: </p>
<ul>
<li>changes will be listed by <code>commitID #</code>, (SHA-1 hash)</li>
<li>changes made to the remote repo before the last time you cloned/pulled from it will also be included here </li>
</ul>
</li>
</ul>
</li>
<li><p>Pulling and Pushing</p>
<ul>
<li><p>Good practice: </p>
<ul>
<li>Add and Commit your changes to your local repo</li>
<li>Pull from remote repo to get most recent changes (fix conflicts if necessary, add and commit them to your local repo)</li>
<li>Push your changes to the remote repo</li>
</ul>
</li>
<li><p>To fetch the most recent updates from the remote repo into your local repo, and put them into your working directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git pull origin master</div></pre></td></tr></table></figure>
</li>
<li><p>To push your changes from your local repo to the remote repo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git push origin master</div></pre></td></tr></table></figure>
</li>
<li><p><strong>Note！！！</strong>: </p>
<ul>
<li><code>origin</code> = an alias for the URL you cloned from</li>
<li><code>master</code> = the remote branch you are pulling from/pushing to</li>
<li>the local branch you are pulling to/pushing from is your current branch</li>
</ul>
</li>
</ul>
</li>
<li><p>Branching</p>
<ul>
<li><p>To create a branch called experimental:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git branch experimental</div></pre></td></tr></table></figure>
</li>
<li><p>To list all branches: (<code>*</code> shows which one you are currently on)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git branch</div></pre></td></tr></table></figure>
</li>
<li><p>To switch to the experimental branch:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout experimental</div></pre></td></tr></table></figure>
</li>
<li><p>Later on, changes between the two branches differ, to <strong>merge changes</strong> from experimental into the master:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git checkout master</div><div class="line">$ git merge experimental</div></pre></td></tr></table></figure>
</li>
<li><p><strong>Note！！！</strong>: <code>git log --graph</code> can be useful for showing branches.</p>
</li>
<li><p><strong>Note！！！</strong>: These branches are in your local repo!</p>
</li>
</ul>
</li>
<li><p><strong>SVN</strong> vs. <strong>Git</strong></p>
<ul>
<li>SVN:<ul>
<li><strong>central repository approach</strong> – the main repository is the only “true” source, <strong>only the main repository has the complete file history</strong></li>
<li>Users check out local copies of the current version</li>
</ul>
</li>
<li>Git:<ul>
<li><strong>Distributed repository approach</strong> – every checkout of the repository is a full fledged repository（完整的存储库）, complete with history</li>
<li>Greater redundancy and speed</li>
<li>Branching and merging repositories is more heavily used as a result</li>
</ul>
</li>
</ul>
</li>
<li><p>Do this（Github simple use）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ git config --global user.name &quot;Your Name&quot;</div><div class="line">$ git config --global user.email youremail@whatever.com</div><div class="line">$ git clone https://github.com/rea2000/santalist.git</div><div class="line"># Then try:</div><div class="line">$ git log</div><div class="line">$ git log --oneline</div><div class="line"># Create a file named userID.txt (e.g. rea.txt)</div><div class="line">$ git status</div><div class="line">$ git status -s</div><div class="line"># Add the file: </div><div class="line">$ git add userID.txt</div><div class="line">$ git status</div><div class="line">$ git status -s</div><div class="line"># Commit the file to your local repo:</div><div class="line">$ git commit –m &quot;added rea.txt file&quot;</div><div class="line">$ git status</div><div class="line">$ git status -s</div><div class="line">$ git log --oneline</div><div class="line"># *WAIT, DO NOT GO ON TO THE NEXT STEPS UNTIL YOU ARE TOLD TO!!</div><div class="line"># Pull from remote repo: </div><div class="line">$ git pull origin master</div><div class="line"># Push to remote repo: </div><div class="line">$ git push origin master</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="LAB4"><a href="#LAB4" class="headerlink" title="LAB4"></a>LAB4</h4><h5 id="Lab4-1-PWM-ioctl-app"><a href="#Lab4-1-PWM-ioctl-app" class="headerlink" title="Lab4-1 PWM ioctl app"></a>Lab4-1 PWM ioctl app</h5><ul>
<li><p><code>./LAB4/Task-1/pwm_driver.c</code>，insert following code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">pwm_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></div><div class="line"></span>&#123;</div><div class="line">  u32 status = <span class="number">0xff</span>;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">  printk(<span class="string">"debug : in ioctl!!"</span>);</div><div class="line">    <span class="keyword">switch</span>(cmd)&#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">      <span class="comment">//1. pwm left speed</span></div><div class="line">      printk(<span class="string">"left speed\n"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">5</span>:</div><div class="line">      <span class="comment">//2. pwm left direction</span></div><div class="line">      printk(<span class="string">"left dir\n"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">      <span class="comment">//3. pwm right speed</span></div><div class="line">        	printk(<span class="string">"right speed\n"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> <span class="number">4</span>:</div><div class="line">      <span class="comment">//4. pwm right direction</span></div><div class="line">        	printk(<span class="string">"right dir\n"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      printk(<span class="string">"default cmd=%d\n"</span>,cmd);</div><div class="line">      <span class="keyword">return</span> -EINVAL;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> file_operations pwm_fops = &#123;</div><div class="line">    .owner = THIS_MODULE,</div><div class="line">  .unlocked_ioctl = pwm_ioctl,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>PWM driver as module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># Modify the Makefile, KENEL_DIR point to your Digilent_linux….</div><div class="line"># Make </div><div class="line"># Copy pwm_driver.ko to ZYBO board</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# ls</div><div class="line">Makefile        modules.order  pwm_driver.c   pwm_driver.mod.c  pwm_driver.o</div><div class="line">Module.symvers  pwm_app.c      pwm_driver.ko  pwm_driver.mod.o</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# insmod ./pwm_driver.ko</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# lsmod</div><div class="line">Module                  Size  Used by</div><div class="line">pwm_driver              2803  0</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# rmmod pwm_driver</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# dmesg | tail</div><div class="line">[    4.210000] sd 0:0:0:0: [sda] No Caching mode page present</div><div class="line">[    4.220000] sd 0:0:0:0: [sda] Assuming drive cache: write through</div><div class="line">[    4.240000] sd 0:0:0:0: [sda] Attached SCSI removable disk</div><div class="line">[    4.680000] init: udev-fallback-graphics main process (1217) terminated with status 1</div><div class="line">[    4.740000] init: failsafe main process (1195) killed by TERM signal</div><div class="line">[    4.780000] init: plymouth main process (632) killed by SEGV signal</div><div class="line">[    4.780000] init: plymouth-splash main process (1227) terminated with status 2</div><div class="line">[   14.490000] init: plymouth-stop pre-start process (1363) terminated with status 1</div><div class="line">[  127.000000] my pwm driver initial successfully!</div><div class="line">[  208.200000] pwm module exit.</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# insmod ./pwm_driver.ko</div></pre></td></tr></table></figure>
</li>
<li><p>Create app，<code>./LAB4/Task-1/pwm_app.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> pwm_fd;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="comment">// open device</span></div><div class="line">    pwm_fd = open(<span class="string">"/dev/pwm_device"</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span>(pwm_fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        perror(<span class="string">"open device pwm_device error!\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</div><div class="line">      ioctl(pwm_fd,<span class="number">5</span>,<span class="number">1</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">1</span>,<span class="number">10000</span>);</div><div class="line">      sleep(<span class="number">10</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">      sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">      ioctl(pwm_fd,<span class="number">5</span>,<span class="number">0</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">1</span>,<span class="number">10000</span>);</div><div class="line">      sleep(<span class="number">10</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">      sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">      ioctl(pwm_fd,<span class="number">4</span>,<span class="number">1</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">3</span>,<span class="number">10000</span>);</div><div class="line">      sleep(<span class="number">10</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">3</span>,<span class="number">0</span>);</div><div class="line">      sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">      ioctl(pwm_fd,<span class="number">4</span>,<span class="number">0</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">3</span>,<span class="number">10000</span>);</div><div class="line">      sleep(<span class="number">10</span>);</div><div class="line">      ioctl(pwm_fd,<span class="number">3</span>,<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;   	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Compile &amp; run app</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:/mnt/Task-1# gcc -o pwm_app pwm_app.c</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# ./pwm_app</div><div class="line">^C</div><div class="line">root@xup-VirtualBox:/mnt/Task-1# dmesg | tail</div><div class="line">[  600.570000] debug : in ioctl!!right dir</div><div class="line">[  600.570000] debug : in ioctl!!right speed</div><div class="line">[  610.570000] debug : in ioctl!!right speed</div><div class="line">[  611.570000] debug : in ioctl!!right dir</div><div class="line">[  611.570000] debug : in ioctl!!right speed</div><div class="line">[  621.570000] debug : in ioctl!!right speed</div><div class="line">[  621.570000] debug : in ioctl!!left dir</div><div class="line">[  621.570000] debug : in ioctl!!left speed</div><div class="line">[  668.590000] debug : in ioctl!!left dir</div><div class="line">[  668.590000] debug : in ioctl!!left speed</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Lab4-2-V4L-Streaming"><a href="#Lab4-2-V4L-Streaming" class="headerlink" title="Lab4-2 V4L Streaming"></a>Lab4-2 V4L Streaming</h5><ul>
<li><p>scripts（You need a USB camera）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">root@xup-VirtualBox:~# cd /root/mjpeg_face_leaf_detection/mjpg-streamer</div><div class="line">root@xup-VirtualBox:~/mjpeg_face_leaf_detection/mjpg-streamer# export LD_LIBRARY_PATH=/root/mjpeg_face_leaf_detection/mjpg-streamer</div><div class="line">root@xup-VirtualBox:~/mjpeg_face_leaf_detection/mjpg-streamer# ./mjpg_streamer -i &quot;input_uvc.so -y -f 24 -r 640*480 -q 60&quot; &quot;output_http.so -p 8080 -w /var/www&quot;</div><div class="line">MJPG Streamer Version: svn rev: exported</div><div class="line"> i: Using V4L2 device.: /dev/video0</div><div class="line"> i: Desired Resolution: 640 x 480</div><div class="line"> i: Frames Per Second.: 24</div><div class="line"> i: Format............: YUV</div><div class="line"> i: JPEG Quality......: 60</div><div class="line">ERROR opening V4L interface: No such file or directory</div><div class="line"> Init v4L2 failed !! exit fatal</div><div class="line"> i: init_VideoIn failed</div></pre></td></tr></table></figure>
</li>
<li><p>Then，you can access the website to see the camera video</p>
</li>
</ul>
<h3 id="Day05"><a href="#Day05" class="headerlink" title="Day05"></a>Day05</h3><h4 id="Review-for-missing"><a href="#Review-for-missing" class="headerlink" title="Review for missing"></a>Review for missing</h4><ul>
<li><p>ZYBO Boot Process for Linux</p>
<center><img src="../img/ZYBO/day05/reviewing/BootProcess4Linux.png" width="720px"/></center>


</li>
</ul>
<ul>
<li><p>Vivado + SDK</p>
<center><img src="../img/ZYBO/day05/reviewing/Vivado+SDK.png" width="480px"/></center>

<ul>
<li>Xilinx Platform Studio (<strong>XPS</strong>)<ul>
<li>Design environment for processing system</li>
<li>Xilinx Microprocessor Project (<strong>XMP</strong>) file</li>
<li>Microprocessor Hardware Specification (<strong>MHS</strong>) file</li>
<li>Platform, software, and peripheral simulation</li>
<li>ChipScope Pro logic analyzer integration</li>
</ul>
</li>
<li>Software Development Kit (SDK)<ul>
<li>Project workspace </li>
<li>Hardware platform definition</li>
<li>Board Support Package (<strong>BSP</strong>)</li>
<li>Software application</li>
<li>Software debugging</li>
</ul>
</li>
</ul>
</li>
<li><p>Embedded System Design Flow for Zynq-7000 AP SoC</p>
<center><img src="../img/ZYBO/day05/reviewing/EmbeddedSystemDesignFlow.png" width="800px"/></center>

</li>
</ul>
<h4 id="HW-SW-Co-design-Overview"><a href="#HW-SW-Co-design-Overview" class="headerlink" title="HW/SW Co-design Overview"></a>HW/SW Co-design Overview</h4><center><img src="../img/ZYBO/day05/Co-design/SW_HW_Co-design_NOKIA.png" width="540px"/></center>

<ul>
<li><p>软硬件协同设计理论体系</p>
<ul>
<li>系统任务描述 (System Task Description )</li>
<li>软硬件划分 (Hardware/Software Partition)</li>
<li>软硬件协同综合 (Hardware/Software Co-synthesis )</li>
<li>软硬件协同仿真 (Hardware/Software Co-simulation )</li>
<li>设计空间探索  (Design space exploration )</li>
<li>与系统设计相关的低压低功耗设计，可测性设计等等。</li>
</ul>
</li>
<li><p>Implementation Alternatives（硬件平台的演变）</p>
<center><img src="../img/ZYBO/day05/Co-design/ImplementationAlternatives.png" width="540px"/></center>

<ul>
<li><p>Trade-off</p>
<center><img src="../img/ZYBO/day05/Co-design/platform_1.png" width="540px"/></center>

<center><img src="../img/ZYBO/day05/Co-design/platform_2.png" width="540px"/></center>

<center><img src="../img/ZYBO/day05/Co-design/platform_3.png" width="640px"/></center>
</li>
<li><p>FPGA Processing: Use Models</p>
<center><img src="../img/ZYBO/day05/Co-design/FPGA_Processing.png" width="720px"/></center>
</li>
<li><p>Integrated HW/SW platform for Embedded SOC</p>
<center><img src="../img/ZYBO/day05/Co-design/Intergrated_HWSW_platform.png" width="720px"/></center>
</li>
<li><p>Accelerating Processor Options</p>
<center><img src="../img/ZYBO/day05/Co-design/AcceleratingProcessor.png" width="720px"/></center>
</li>
<li><p>Xilinx puts ARM core into its FPGA（ssupper convergence）</p>
<center><img src="../img/ZYBO/day05/Co-design/platform_Xilinx.jpg" width="420px"/></center>
</li>
<li><p>System-on-Chip</p>
<ul>
<li><p>Algorithms in a GSM transmitter and receiver and their mapping on to conventional target technologies consisting of ASIC, FPGA and DSP</p>
 <center><img src="../img/ZYBO/day05/Co-design/GSM_systems.png" width="640px"/></center>
</li>
<li><p>A system-on-chip solution</p>
<center><img src="../img/ZYBO/day05/Co-design/GSM_SOC.png" width="480px"/></center>



</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Project flow changing</p>
<ul>
<li><p>Traditional project flow</p>
<center><img src="../img/ZYBO/day05/Co-design/project_flow_traditional.png" width="640px"/></center>

<ul>
<li>Late integration and bug detection</li>
<li>Redesign cycle with possible re-spin（可能推倒重来）</li>
</ul>
</li>
<li><p>Verification at the Backend</p>
<center><img src="../img/ZYBO/day05/Co-design/Verification_backend.png" width="640px"/></center>
</li>
<li><p>Refined project timeline</p>
<p><center><img src="../img/ZYBO/day05/Co-design/project_timeline_Refined.png" width="800px"/></center></p>
<ul>
<li>Coordinated feature release</li>
<li>Iterative integration and debug</li>
<li>Reuse wherever feasible</li>
<li>Centralized version control</li>
</ul>
</li>
<li><p>Concurrent design（并行设计）</p>
<center><img src="../img/ZYBO/day05/Co-design/ConcurrentDesign.png" width="540px"/></center>
</li>
<li><p>Integrating software and hardware before the prototypes are built</p>
<center><img src="../img/ZYBO/day05/Co-design/HW&SW_Co-design_before_prototype.png" width="780px"/></center>
</li>
<li><p>Hardware &amp; Software Co-design</p>
<center><img src="../img/ZYBO/day05/Co-design/Hardware&Software_Co-design.png" width="780px"/></center>

<ul>
<li><p>System Design</p>
<center><img src="../img/ZYBO/day05/Co-design/SystemDesign.png" width="540px"/></center>
</li>
<li><p>System Level Language</p>
<center><img src="../img/ZYBO/day05/Co-design/SystemLevelLanguage.png" width="540px"/></center>

<center><img src="../img/ZYBO/day05/Co-design/SystemLevelLanguage_C&C++.png" width="480px"/></center>

<center><img src="../img/ZYBO/day05/Co-design/LanguageUse.png" width="480px"/></center>
</li>
<li><p>Design Space Exploration</p>
<center><img src="../img/ZYBO/day05/Co-design/DSE_overview.png" width="480px"/></center>

<ul>
<li><p>考虑的问题</p>
<ul>
<li>Area</li>
<li>Critical path delays</li>
<li>Testability</li>
<li>Power dissipation（功耗）</li>
</ul>
<center><img src="../img/ZYBO/day05/Co-design/DSE_mapping.png" width="480px"/></center>
</li>
<li><p>对人来说，太复杂了，交给机器做,   <strong>Vivado-HLS</strong> 工具，C转换为优化的硬件实现</p>
<center><img src="../img/ZYBO/day05/Co-design/DSE_Xilinx.png" width="600px"/></center>

<center><img src="../img/ZYBO/day05/Co-design/VivadoHLS.png" width="540px"/></center>
</li>
</ul>
</li>
</ul>
</li>
<li><p>High-Level Synthesis: HLS</p>
<center><img src="../img/ZYBO/day05/Co-design/VivadoHLS_overview.png" width="400px"/></center><br>+ Overview<br><br>  + High-Level Synthesis<br>    + Creates an RTL implementation from C level source code（C转RTL）<br>    + Extracts control and dataflow from the source code（提取控制和数据流）<br>    + Implements the design based on defaults and user applied directives（不同优化的转化）<br>  + Many implementation are possible from the same source description<br>    + Smaller designs, faster designs, optimal designs<br>    + Enables design exploration<br><br>+ Introduction to High-Level Synthesis<br><br>  + How is hardware extracted from C code?<br>    + Control and datapath can be extracted from C code at the top level<br>    + The same principles used in the example can be applied to sub-functions<br>      + At some point in the top-level control flow, control is passed to a sub-function<br>      + Sub-function may be implemented to execute concurrently with the top-level and or other sub-functions<br>  + How is this control and dataflow turned into a hardware design?<br>  + Vivado HLS maps this to hardware through scheduling and binding processes<br>  + How is my design created?<br>    + How functions, loops, arrays and IO ports are mapped?<br><br>+ HLS: Control Extraction<br><br>  <center><img src="../img/ZYBO/day05/Co-design/ControlExtraction.png" width="800px"/></center>

<ul>
<li><p>Vivado HLS Benefits</p>
<ul>
<li><p>Productivity（生产率）</p>
<ul>
<li>Verification</li>
<li>Functional</li>
<li>Architectural</li>
<li>Abstraction</li>
<li>Datatypes</li>
<li>Interface</li>
<li>Classes</li>
<li>Automation</li>
</ul>
<p>Block level specification AND verification significantly reduced</p>
</li>
<li><p>Permutability（可变性）</p>
<ul>
<li>Architecture Exploration</li>
<li>Timing<ul>
<li>Parallelization</li>
<li>Pipelining</li>
</ul>
</li>
<li>Resources<ul>
<li>Sharing</li>
</ul>
</li>
<li>Better QoR</li>
</ul>
<p>Rapid design exploration delivers QoR rivaling hand-coded RTL（QoR比人更高）</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Creative-Suggestion"><a href="#Creative-Suggestion" class="headerlink" title="Creative Suggestion"></a>Creative Suggestion</h4><ul>
<li>OpenCV 寻线 <ul>
<li>SD卡系统<code>/root/openhwcar</code></li>
</ul>
</li>
<li>小车加声音<ul>
<li><a href="https://github.com/xupsh/zrobot_v1">zrobot_v1-master.zip</a>/sw/app/music_demo_arm</li>
</ul>
</li>
<li>闭环(读取小车实时速度，实现反馈）<ul>
<li><code>LAB5/close-loop/*</code></li>
</ul>
</li>
<li>超声波（循迹）<ul>
<li><a href="https://github.com/xupsh/zrobot_v1">zrobot_v1-master.zip</a>/sw/driver/ultrasonic</li>
</ul>
</li>
<li>安卓应用(手机上视频展示和手柄控制）<ul>
<li><a href="https://github.com/xupsh/zrobot_v1">zrobot_v1-master.zip</a>/Android</li>
</ul>
</li>
</ul>
<h4 id="OpenCV-Case-Study"><a href="#OpenCV-Case-Study" class="headerlink" title="OpenCV Case Study"></a>OpenCV Case Study</h4><ul>
<li><p>人脸识别</p>
<ul>
<li>In 2001, P.Viola presented a new face detection algorithm using boosted cascade of HAAR features in his paper [1]. Afterwards, </li>
<li>Intel realized the Adaboost face detection algorithm in its OpenCV library [2]. </li>
<li>The optimized code for x86 architecture can detect accurately on an image of 384*288 at speed of 10fps with 2GHz P4 processor.  </li>
<li>However, performance of the algorithm is much poorer on embedded platform than on desktop platform. Under condition of the same image size and detection accuracy</li>
<li>it takes 5 seconds for a 200MHz ARM9 processor to finish the detection.</li>
<li>OpenCV: Open Source Computer Vision Library,  BSD license </li>
</ul>
</li>
<li><p>Accelerated face detection</p>
<ul>
<li><p>Start from software + XUP board</p>
</li>
<li><p>Implemented entirely in  hardware on a Xilinx Spartan 3A 1800 DSP</p>
</li>
<li><p>50MHz, 15~25 FPS</p>
<ul>
<li><p>Faster than face detection on TI’s DM642 DSP (600MHz VLIW)</p>
<center><img src="../img/ZYBO/day05/OpenCV/TI_DSP.jpg" width="480px"/></center>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Prototype Board</p>
<center><img src="../img/ZYBO/day05/OpenCV/Virtex-II.jpg" width="420px"/></center>

<ul>
<li>Xilinx XUP Virtex-II Pro Development System </li>
<li>Processor: PPC 405</li>
<li>Processor clock frequency: 300MHz</li>
<li>Bus clock frequency: 100MHz</li>
<li>BRAM Memory :  about 200KBytes</li>
</ul>
</li>
<li><p>Technology Roadmap</p>
<ul>
<li>Embedded Solution(Done 2007.07)<ul>
<li>Powerpc405+coreConnect</li>
<li>Integrate Video Port to PLB  Bus</li>
<li>XUP V2Pro Prototype</li>
</ul>
</li>
<li>Full Hardware Solution(Done 2007.09)<ul>
<li>State Machine based </li>
<li>XUP V2Pro Prototype</li>
</ul>
</li>
<li>Commercial Product(2007.11)<ul>
<li>Based on full hardware Solution</li>
<li>Spartan-DSP(SA1800)</li>
<li>Substitute IS’VISION’s TI DSP based solutions</li>
</ul>
</li>
<li>Multi-Channel Product(CY08)<ul>
<li>4-Channel </li>
<li>D1 </li>
</ul>
</li>
</ul>
</li>
<li><p>Solution Evaluation</p>
<ul>
<li>Start from OpenCV (Intel PC)</li>
<li>Porting to ucLinux (Embedded SW)</li>
<li>MicroBlaze(FSL) + HA (SW/HW)</li>
<li>PowerPC(PLB/OPB) + HA (SW/HW)</li>
<li>State Machine + XtremeDSP<ul>
<li>System C level modeling</li>
<li>C Modeling and profiling</li>
<li>VerilogHDL Coding</li>
</ul>
</li>
</ul>
</li>
<li><p>Performance Criteria</p>
<ul>
<li>Detection rate</li>
<li>False positive detection rate</li>
<li>Detection speed</li>
<li>Real-time detection</li>
</ul>
</li>
<li><p>Goal</p>
<ul>
<li>Faster<ul>
<li>Pipeline</li>
<li>Parallelism</li>
</ul>
</li>
<li>Reasonable hardware cost<ul>
<li>Sub-window based</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="GNU-Radio-Case-Study"><a href="#GNU-Radio-Case-Study" class="headerlink" title="GNU Radio Case Study"></a>GNU Radio Case Study</h4><ul>
<li><p>What is GNU Radio?</p>
<center><img src="../img/ZYBO/day05/GNU_Radio/GNU_Radio_Components.png" width="720px"/></center>

<ul>
<li>Software toolkit for signal  processing<ul>
<li>Software radio construction</li>
<li>Rapid development</li>
</ul>
</li>
<li>USRP (Universal Software Radio Peripheral)<ul>
<li>Hardware frontend for sending and receiving waveforms</li>
</ul>
</li>
</ul>
</li>
<li><p>GNU Radio Software</p>
<ul>
<li>Opensource software (GPL)<ul>
<li>Don’t know how something works? Take a look!</li>
<li>Existing examples: 802.11b(Wi-Fi), ATSC (HDTV), OFDM, DBPSK, DQPSK</li>
</ul>
</li>
<li>Features<ul>
<li>Extensive library of signal processing blocks(C++/ and assembly)</li>
<li>Python environment for composing blocks (flow graph)</li>
</ul>
</li>
</ul>
</li>
<li><p>GNU Radio Hardware</p>
<center><img src="../img/ZYBO/day05/GNU_Radio/GNU_Radio_HardwareSchematic.png" width="720px"/></center>

<ul>
<li>Sends/receives waveforms</li>
<li>USRP Features<ul>
<li>USB 2.0 interface (480Mbps)</li>
<li>FPGA (customizable)</li>
<li>64Msps Digital to Analog converters</li>
<li>128Msps Analog to Digital converteres</li>
<li>Daughterboards for different frequency ranges</li>
</ul>
</li>
<li>Available Daughterboard（子插件）<ul>
<li>400-500Mhz, 800-1000Mhz, 1150-1450Mhz, 1.5-2.1Ghz, 2.3-2.9Ghz</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Software-Defined-Network"><a href="#Software-Defined-Network" class="headerlink" title="Software Defined Network"></a>Software Defined Network</h4><center><img src="../img/ZYBO/day05/SDN/NetworkSystem.png" width="720px"/></center>

<ul>
<li><p>Convergence（汇合） of Processing (Compute) and programmable logic</p>
<ul>
<li>Convergence of control and management traffic</li>
<li>Customized features, functions &amp; processing</li>
<li>TCP, Security, compression/de-compression, Application Offload processing</li>
<li>Programmable networking</li>
<li>Network Analytics &amp; I/O management</li>
</ul>
</li>
<li><p>Integrated Carrier Ethernet Solutions – NIDs</p>
<center><img src="../img/ZYBO/day05/SDN/NIDs.png" width="800px"/></center>

<ul>
<li>Fully Integrated Carrier Ethernet NID Solution in a single chip<ul>
<li>Xilinx &amp; Partner IP Delivering unparalleled integration</li>
</ul>
</li>
</ul>
</li>
<li><p>Future Networks: a Programmable Network ?</p>
<center><img src="../img/ZYBO/day05/SDN/Flow_table_entry.png" width="720px"/></center>

<ul>
<li><p>Several  solutions and Terminologies</p>
<center><img src="../img/ZYBO/day05/SDN/SDN_overal_architecture.png" width="600px"/></center>

<ul>
<li>SDN: Software-Defined Networking <ul>
<li>Introduced by the New initiative ONF and recently by ITU-T SG 13 Future Networks</li>
<li>Under discussion at IETF as Network Programmability (or Software-Driven Networks )</li>
</ul>
</li>
<li>Self Organizing  &amp; Autonomic Networks </li>
<li>Network resources and policy controller</li>
<li>Network Virtualization &amp; slicing</li>
<li>Cloud Network  &amp;  Network as a Services </li>
<li>…. Smart Ubiquitous &amp; Distributed Services, Information-Centric Networks….</li>
</ul>
</li>
<li><p>Opportunity for telecom operators: </p>
<ul>
<li>To hide network complexity by abstraction layer</li>
<li>Improve “Dynamically” network Management ‘Programmability’ &amp; performance</li>
<li>Ability to deliver “On demand” network resources</li>
</ul>
</li>
<li><p>…And some use cases: Bandwidth On Demand, Network virtualization , Policy control, Chained Business services , Cloud Network, NaaS, Traffic Offload…</p>
</li>
</ul>
</li>
<li><p>OpenFlow Switching : how it works?</p>
<center><img src="../img/ZYBO/day05/SDN/OpenFlowSwitching.png" width="420px"/></center>

<ul>
<li>OpenFlow is based on an <strong>L2-L4 switch</strong>, with an internal flow-table, and a “standardized” interface to add and remove flow entries.</li>
<li>New actions can be done on packet.<ul>
<li>Large modifications of fields.</li>
<li>Routing on new criteria : L4, mix</li>
<li>Define network slice on flow criteria …</li>
<li>New routing protocol : multipath, load-balancing</li>
</ul>
</li>
</ul>
</li>
<li><p>Xilinx Zynq-7000</p>
<ul>
<li>Processors and Programmable<ul>
<li>Processors (single- and multi-core) are invaluable<ul>
<li>And in any case, are a much harder ossification to address</li>
</ul>
</li>
<li>But one shouldn’t ignore everything else<ul>
<li>If they have better characteristics, e.g., faster, lower power, deterministic</li>
</ul>
</li>
<li>Integration of technologies and of programming is the key, e.g.:<ul>
<li>Software deceleration: Processor helps the programmable logic</li>
<li>Hardware acceleration: Programmable logic helps the processor</li>
</ul>
</li>
</ul>
</li>
<li>Wide Breadth of Applications Addressed<ul>
<li>Carrier Ethernet Based Access Devices </li>
<li>Mobile backhaul </li>
<li>SDN (Software defined networking)</li>
<li>BMC (base board management controller)</li>
<li>Client security</li>
<li>Appliance / Gateways</li>
<li>SSD controllers</li>
<li>Low powered servers</li>
<li>NIDs</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="LAB5"><a href="#LAB5" class="headerlink" title="LAB5"></a>LAB5</h4><h5 id="Lab5-1-Interesting-Self-evaluation-using-Github"><a href="#Lab5-1-Interesting-Self-evaluation-using-Github" class="headerlink" title="Lab5-1 Interesting Self-evaluation using Github"></a>Lab5-1 Interesting Self-evaluation using Github</h5><ul>
<li><p>Group collaboration</p>
<ul>
<li>Git clone <a href="https://github.com/Durant35/Self-evaluation.git">https://github.com/Durant35/Self-evaluation.git</a></li>
</ul>
</li>
</ul>
<ul>
<li><p>Each group in charge of one directory</p>
</li>
<li><p>Concurrent coding </p>
<ul>
<li>Add your information in group_score<group-number>.c</li>
<li>Unit test</li>
<li>Git commit</li>
<li>Git push</li>
<li>Integrated test</li>
</ul>
</li>
<li><p>Unit test</p>
<ul>
<li><p>Test in group local directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cd hust_group?</div><div class="line">$ make</div><div class="line">./group?_score</div><div class="line"># Shoud print all group member name and scores</div></pre></td></tr></table></figure>
</li>
<li><p>Git commit</p>
</li>
<li><p>Git push </p>
</li>
</ul>
</li>
<li><p>Integrated test</p>
<ul>
<li><p>Git pull </p>
</li>
<li><p>Make clean</p>
</li>
<li><p>Make </p>
</li>
<li><p>Make test</p>
</li>
<li><p>Open the score_record.txt in <code>MS Excel</code>/<code>LibreOffice Calc</code></p>
<center><img src="../img/ZYBO/day05/Self-evaluation_Calc.png" width="540px"/></center>
</li>
</ul>
</li>
</ul>

      
    </div>
    
  </div>
  
    


  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#涉及的内容"><span class="toc-number">1.</span> <span class="toc-text">涉及的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Course-Objectives"><span class="toc-number">2.</span> <span class="toc-text">Course Objectives</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Course-outline"><span class="toc-number">3.</span> <span class="toc-text">Course outline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Day01"><span class="toc-number">4.</span> <span class="toc-text">Day01</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FPGA-and-ZYNQ-Overview"><span class="toc-number">4.1.</span> <span class="toc-text">FPGA and ZYNQ Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GNU-Tool-Chain"><span class="toc-number">4.2.</span> <span class="toc-text">GNU Tool Chain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB1"><span class="toc-number">4.3.</span> <span class="toc-text">LAB1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#LAB1-1-Ubuntu-setup-and-ZyboRobot"><span class="toc-number">4.3.1.</span> <span class="toc-text">LAB1-1 Ubuntu setup and ZyboRobot</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LAB1-2-hello-world-and-GNU-Tool-Chain"><span class="toc-number">4.3.2.</span> <span class="toc-text">LAB1-2 hello world and GNU Tool Chain</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LAB1-3-Explore-Embedded-Linux"><span class="toc-number">4.3.3.</span> <span class="toc-text">LAB1-3 Explore Embedded Linux</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LAB1-4-Cross-Compile"><span class="toc-number">4.3.4.</span> <span class="toc-text">LAB1-4 Cross Compile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LAB1-5-Kernel-Compile"><span class="toc-number">4.3.5.</span> <span class="toc-text">LAB1-5 Kernel Compile</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Day02"><span class="toc-number">5.</span> <span class="toc-text">Day02</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Process-and-User-Space"><span class="toc-number">5.1.</span> <span class="toc-text">Process and User Space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Introduction-to-Embedded-System-Design-using-Zynq"><span class="toc-number">5.2.</span> <span class="toc-text">Introduction to Embedded System Design using Zynq</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zynq-Architecture"><span class="toc-number">5.3.</span> <span class="toc-text">Zynq Architecture</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB2"><span class="toc-number">5.4.</span> <span class="toc-text">LAB2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-1Create-an-Embedded-System"><span class="toc-number">5.4.1.</span> <span class="toc-text">Lab2-1Create an Embedded System</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-2-Bootloader"><span class="toc-number">5.4.2.</span> <span class="toc-text">Lab2-2 Bootloader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-3-Using-device-driver"><span class="toc-number">5.4.3.</span> <span class="toc-text">Lab2-3 Using device driver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-4-Make-SD-Card"><span class="toc-number">5.4.4.</span> <span class="toc-text">Lab2-4 Make SD Card</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-5-Hack-CGI-Scripts"><span class="toc-number">5.4.5.</span> <span class="toc-text">Lab2-5 Hack CGI Scripts</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab2-6-Mmap-Control-Wheels"><span class="toc-number">5.4.6.</span> <span class="toc-text">Lab2-6 Mmap Control Wheels</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Day03"><span class="toc-number">6.</span> <span class="toc-text">Day03</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Device-Driver-Overview"><span class="toc-number">6.1.</span> <span class="toc-text">Device Driver Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sysfs-Virtual-File-System"><span class="toc-number">6.2.</span> <span class="toc-text">Sysfs Virtual File System</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB3"><span class="toc-number">6.3.</span> <span class="toc-text">LAB3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab3-1-Character-Device-Driver"><span class="toc-number">6.3.1.</span> <span class="toc-text">Lab3-1 Character Device Driver</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab3-2-Create-PWM-IP"><span class="toc-number">6.3.2.</span> <span class="toc-text">Lab3-2 Create PWM IP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab3-3-PWM-IP-Modify"><span class="toc-number">6.3.3.</span> <span class="toc-text">Lab3-3 PWM IP Modify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab3-4-Sysfs-PWM-kernel-module"><span class="toc-number">6.3.4.</span> <span class="toc-text">Lab3-4 Sysfs PWM kernel module</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab3-5-I-O-Access"><span class="toc-number">6.3.5.</span> <span class="toc-text">Lab3-5 I/O Access</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Day04"><span class="toc-number">7.</span> <span class="toc-text">Day04</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Version-Control-with-Git"><span class="toc-number">7.1.</span> <span class="toc-text">Version Control with Git</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB4"><span class="toc-number">7.2.</span> <span class="toc-text">LAB4</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab4-1-PWM-ioctl-app"><span class="toc-number">7.2.1.</span> <span class="toc-text">Lab4-1 PWM ioctl app</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab4-2-V4L-Streaming"><span class="toc-number">7.2.2.</span> <span class="toc-text">Lab4-2 V4L Streaming</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Day05"><span class="toc-number">8.</span> <span class="toc-text">Day05</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Review-for-missing"><span class="toc-number">8.1.</span> <span class="toc-text">Review for missing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HW-SW-Co-design-Overview"><span class="toc-number">8.2.</span> <span class="toc-text">HW/SW Co-design Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Creative-Suggestion"><span class="toc-number">8.3.</span> <span class="toc-text">Creative Suggestion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenCV-Case-Study"><span class="toc-number">8.4.</span> <span class="toc-text">OpenCV Case Study</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GNU-Radio-Case-Study"><span class="toc-number">8.5.</span> <span class="toc-text">GNU Radio Case Study</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Software-Defined-Network"><span class="toc-number">8.6.</span> <span class="toc-text">Software Defined Network</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB5"><span class="toc-number">8.7.</span> <span class="toc-text">LAB5</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Lab5-1-Interesting-Self-evaluation-using-Github"><span class="toc-number">8.7.1.</span> <span class="toc-text">Lab5-1 Interesting Self-evaluation using Github</span></a></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"true"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
        <!--
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
        -->
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
        <!--
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
        -->
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"ZYBO　| Tarantula-7's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="ZYBO/index.html" data-title="ZYBO" data-url="http://durant35.github.io/ZYBO/index.html"></div>
    <script>
        var duoshuoQuery = {short_name:"durant35"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    





    <script>
        
    </script>



</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2014-2017 Tarantula-7
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
             post: ".article-entry a[href], .copyright a[href]", 
            
            
            
            
            
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>