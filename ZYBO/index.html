<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>README.md</title><link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css'><style type='text/css'>html, body {overflow-x: initial !important;}.CodeMirror { height: auto; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; }
.CodeMirror-lines { padding: 4px 0px; }
.CodeMirror pre { }
.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { background-color: white; }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); white-space: nowrap; background-color: rgb(247, 247, 247); }
.CodeMirror-linenumbers { }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.CodeMirror div.CodeMirror-cursor { border-left-width: 1px; border-left-style: solid; border-left-color: black; z-index: 3; }
.CodeMirror div.CodeMirror-secondarycursor { border-left-width: 1px; border-left-style: solid; border-left-color: silver; }
.CodeMirror.cm-keymap-fat-cursor div.CodeMirror-cursor { width: auto; border: 0px; z-index: 1; background: rgb(119, 238, 119); }
.CodeMirror div.CodeMirror-cursor.CodeMirror-overwrite { }
.cm-tab { display: inline-block; }
.cm-s-typora-default .cm-header, .cm-s-typora-default .cm-property { color: rgb(217, 79, 138); }
.cm-s-typora-default pre.cm-header1:not(.cm-atom) :not(.cm-overlay) { font-size: 2rem; line-height: 2rem; }
.cm-s-typora-default pre.cm-header2:not(.cm-atom) :not(.cm-overlay) { font-size: 1.4rem; line-height: 1.4rem; }
.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number { color: rgb(149, 132, 134); }
.cm-s-typora-default .cm-table-row, .cm-s-typora-default .cm-block-start { font-family: monospace; }
.cm-s-typora-default .cm-comment, .cm-s-typora-default .cm-code { color: rgb(74, 90, 159); font-family: monospace; }
.cm-s-typora-default .cm-tag { color: rgb(169, 68, 66); }
.cm-s-typora-default .cm-string { color: rgb(126, 134, 169); }
.cm-s-typora-default .cm-link { color: rgb(196, 122, 15); text-decoration: underline; }
.cm-s-typora-default .cm-variable-2, .cm-s-typora-default .cm-variable-1 { color: inherit; }
.cm-s-typora-default .cm-overlay { font-size: 1rem; font-family: monospace; }
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor { border-left-width: 3px; border-left-style: solid; border-left-color: rgb(228, 98, 154); }
.cm-s-typora-default .CodeMirror-activeline-background { left: -60px; right: -30px; background: rgba(204, 204, 204, 0.2); }
.cm-s-typora-default .CodeMirror-gutters { border-right-style: none; background-color: inherit; }
.cm-s-typora-default .cm-trailing-space-new-line::after, .cm-startspace::after, .cm-starttab .cm-tab::after { content: "•"; position: absolute; left: 0px; opacity: 0; font-family: LetterGothicStd, monospace; }
.os-windows .cm-startspace::after, .os-windows .cm-starttab .cm-tab::after { left: -0.1em; }
.cm-starttab .cm-tab::after { content: " "; }
.cm-startspace, .cm-tab, .cm-starttab, .cm-trailing-space-a, .cm-trailing-space-b, .cm-trailing-space-new-line { font-family: monospace; position: relative; }
.cm-s-typora-default .cm-trailing-space-new-line::after { content: "↓"; opacity: 0.3; }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: black; }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-property { color: black; }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: blue; }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: bold; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: rgb(255, 0, 0); }
.cm-invalidchar { color: rgb(255, 0, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { margin-bottom: -30px; margin-right: -30px; padding-bottom: 30px; padding-right: 30px; height: 100%; outline: none; position: relative; box-sizing: content-box; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow-x: hidden; overflow-y: scroll; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow-y: hidden; overflow-x: scroll; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background: transparent; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-widget { }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.CodeMirror-selected { background: rgb(217, 217, 217); }
.CodeMirror-focused .CodeMirror-selected { background: rgb(215, 212, 240); }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
.CodeMirror span { }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}
.CodeMirror-lint-markers { width: 16px; }
.CodeMirror-lint-tooltip { border: 1px solid black; border-radius: 4px; color: infotext; font-family: monospace; overflow: hidden; padding: 2px 5px; position: fixed; white-space: pre-wrap; z-index: 10000; max-width: 600px; opacity: 0; transition: opacity 0.4s; font-size: 0.8em; background-color: infobackground; }
.CodeMirror-lint-mark-error, .CodeMirror-lint-mark-warning { background-position: left bottom; background-repeat: repeat-x; }
.CodeMirror-lint-mark-error { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg=="); }
.CodeMirror-lint-marker-error, .CodeMirror-lint-marker-warning { cursor: pointer; display: inline-block; height: 16px; width: 16px; vertical-align: middle; position: relative; background-position: center center; background-repeat: no-repeat; }
.CodeMirror-lint-message-error, .CodeMirror-lint-message-warning { padding-left: 18px; background-position: left top; background-repeat: no-repeat; }
.CodeMirror-lint-marker-error, .CodeMirror-lint-message-error { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII="); }
.CodeMirror-lint-marker-warning, .CodeMirror-lint-message-warning { background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII="); }
.CodeMirror-lint-marker-multiple { width: 100%; height: 100%; background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC"); background-position: right bottom; background-repeat: no-repeat; }


html { font-size: 14px; color: rgb(51, 51, 51); background-color: rgb(255, 255, 255); }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: rgb(181, 214, 252); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; padding-bottom: 70px; white-space: pre-wrap; overflow-x: auto; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
.typora-export #write { margin: 0px auto; }
#write > p:first-child, #write > ul:first-child, #write > ol:first-child, #write > pre:first-child, #write > blockquote:first-child, #write > div:first-child, #write > table:first-child { margin-top: 30px; }
#write li > table:first-child { margin-top: -20px; }
img { max-width: 100%; }
input, button, select, textarea { color: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
::before, ::after, * { box-sizing: border-box; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write div, #write pre { width: inherit; }
#write p, #write h1, #write h2, #write h3, #write h4, #write h5, #write h6 { position: relative; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
p { -webkit-margin-before: 1rem; -webkit-margin-after: 1rem; -webkit-margin-start: 0px; -webkit-margin-end: 0px; }
.mathjax-block { margin-top: 0px; margin-bottom: 0px; -webkit-margin-before: 0rem; -webkit-margin-after: 0rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: bold; font-style: italic; }
a { cursor: pointer; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; margin: 4px 0px 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 80px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
pre { white-space: pre-wrap; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; position: relative !important; background: inherit; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
.md-fences .CodeMirror.CodeMirror-wrap { top: -1.6em; margin-bottom: -1.6em; }
.md-fences.mock-cm { white-space: pre-wrap; }
.show-fences-line-number .md-fences { padding-left: 0px; }
.show-fences-line-number .md-fences.mock-cm { padding-left: 40px; }
.footnotes { opacity: 0.8; font-size: 0.9rem; padding-top: 1em; padding-bottom: 1em; }
.footnotes + .footnotes { margin-top: -1em; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: normal; text-align: left; box-sizing: content-box; direction: ltr; background: transparent; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li p, li .mathjax-block { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; }
@media print { 
  html, body { height: 100%; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  h1, h2, h3, h4, h5, h6 { break-after: avoid-page; orphans: 2; }
  p { orphans: 4; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 1cm; padding-right: 1cm; }
  .typora-export #write::after { height: 0px; }
  @page { margin: 20mm 0mm; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 2.86rem; white-space: pre-wrap; display: block; background: rgb(204, 204, 204); }
p .md-image:only-child, p img:only-child { display: inline-block; width: 100%; text-align: center; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.mathjax-block { white-space: pre; overflow: hidden; width: 100%; }
p + .mathjax-block { margin-top: -1.143rem; }
.mathjax-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: none; box-shadow: none; }
.task-list { list-style-type: none; }
.task-list-item { position: relative; padding-left: 1em; }
.task-list-item input { position: absolute; top: 0px; left: 0px; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc::after, .md-toc-content::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); text-decoration: none; }
.md-toc-inner:hover { }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: bold; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
.md-tag { opacity: 0.5; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: monospace; }
code { text-align: left; }
h1 .md-tag, h2 .md-tag, h3 .md-tag, h4 .md-tag, h5 .md-tag, h6 .md-tag { font-weight: initial; opacity: 0.35; }
a.md-header-anchor.md-print-anchor { border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: none !important; text-decoration: initial !important; text-shadow: initial !important; background: transparent !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.mathjax-block .MathJax_SVG_Display { text-align: center; margin: 1em 0em; position: relative; text-indent: 0px; max-width: none; max-height: none; min-width: 0px; min-height: 0px; width: 100%; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: monospace; }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: normal; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }


@font-face { font-family: "Open Sans"; font-style: normal; font-weight: normal; src: local("Open Sans Regular"), url("./github/400.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: italic; font-weight: normal; src: local("Open Sans Italic"), url("./github/400i.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: normal; font-weight: bold; src: local("Open Sans Bold"), url("./github/700.woff") format("woff"); }
@font-face { font-family: "Open Sans"; font-style: italic; font-weight: bold; src: local("Open Sans Bold Italic"), url("./github/700i.woff") format("woff"); }
html { font-size: 16px; }
body { font-family: "Open Sans", "Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; color: rgb(51, 51, 51); line-height: 1.6; }
#write { max-width: 860px; margin: 0px auto; padding: 20px 30px 100px; }
#write > ul:first-child, #write > ol:first-child { margin-top: 30px; }
body > :first-child { margin-top: 0px !important; }
body > :last-child { margin-bottom: 0px !important; }
a { color: rgb(65, 131, 196); }
h1, h2, h3, h4, h5, h6 { position: relative; margin-top: 1rem; margin-bottom: 1rem; font-weight: bold; line-height: 1.4; cursor: text; }
h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor { text-decoration: none; }
h1 tt, h1 code { font-size: inherit; }
h2 tt, h2 code { font-size: inherit; }
h3 tt, h3 code { font-size: inherit; }
h4 tt, h4 code { font-size: inherit; }
h5 tt, h5 code { font-size: inherit; }
h6 tt, h6 code { font-size: inherit; }
h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
h3 { font-size: 1.5em; line-height: 1.43; }
h4 { font-size: 1.25em; }
h5 { font-size: 1em; }
h6 { font-size: 1em; color: rgb(119, 119, 119); }
p, blockquote, ul, ol, dl, table { margin: 0.8em 0px; }
li > ol, li > ul { margin: 0px; }
hr { height: 4px; padding: 0px; margin: 16px 0px; border-width: 0px 0px 1px; border-style: none none solid; overflow: hidden; box-sizing: content-box; border-bottom-color: rgb(221, 221, 221); background-color: rgb(231, 231, 231); }
body > h2:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child { margin-top: 0px; padding-top: 0px; }
body > h1:first-child + h2 { margin-top: 0px; padding-top: 0px; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child { margin-top: 0px; padding-top: 0px; }
a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 { margin-top: 0px; padding-top: 0px; }
h1 p, h2 p, h3 p, h4 p, h5 p, h6 p { margin-top: 0px; }
li p.first { display: inline-block; }
ul, ol { padding-left: 30px; }
ul:first-child, ol:first-child { margin-top: 0px; }
ul:last-child, ol:last-child { margin-bottom: 0px; }
blockquote { border-left-width: 4px; border-left-style: solid; border-left-color: rgb(221, 221, 221); padding: 0px 15px; color: rgb(119, 119, 119); }
blockquote blockquote { padding-right: 0px; }
table { padding: 0px; word-break: initial; }
#write { overflow-x: auto; }
table tr { border-top-width: 1px; border-top-style: solid; border-top-color: rgb(204, 204, 204); margin: 0px; padding: 0px; background-color: white; }
table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
table tr th { font-weight: bold; border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr td { border: 1px solid rgb(204, 204, 204); text-align: left; margin: 0px; padding: 6px 13px; }
table tr th:first-child, table tr td:first-child { margin-top: 0px; }
table tr th:last-child, table tr td:last-child { margin-bottom: 0px; }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); }
.md-fences, code, tt { border: 1px solid rgb(221, 221, 221); border-radius: 3px; font-family: Consolas, "Liberation Mono", Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; background-color: rgb(248, 248, 248); }
.md-fences { margin-bottom: 15px; margin-top: 15px; padding: 8px 1em 6px; }
.task-list { padding-left: 0px; }
.task-list-item { padding-left: 32px; }
.task-list-item input { top: 3px; left: 8px; }
@media screen and (min-width: 914px) { 
}
@media print { 
  html { font-size: 13px; }
  table, pre { break-inside: avoid; }
  pre { word-wrap: break-word; }
}
.md-fences { background-color: rgb(248, 248, 248); }
#write pre.md-meta-block { padding: 1rem; font-size: 85%; line-height: 1.45; border: 0px; border-radius: 3px; color: rgb(119, 119, 119); margin-top: 0px !important; background-color: rgb(247, 247, 247); }
.mathjax-block > .code-tooltip { bottom: 0.375rem; }
#write > h3.md-focus::before { left: -1.5625rem; top: 0.375rem; }
#write > h4.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h5.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
#write > h6.md-focus::before { left: -1.5625rem; top: 0.285714rem; }
.md-image > .md-meta { border: 1px solid rgb(221, 221, 221); border-radius: 3px; font-family: Consolas, "Liberation Mono", Courier, monospace; padding: 2px 4px 0px; font-size: 0.9em; color: inherit; background-color: rgb(248, 248, 248); }
.md-tag { color: inherit; }
.md-toc { margin-top: 20px; padding-bottom: 20px; }
#typora-quick-open { border: 1px solid rgb(221, 221, 221); background-color: rgb(248, 248, 248); }
#typora-quick-open-item { border-color: rgb(254, 254, 254) rgb(229, 229, 229) rgb(229, 229, 229) rgb(238, 238, 238); border-style: solid; border-width: 1px; background-color: rgb(250, 250, 250); }
#md-notification::before { top: 10px; }
.on-focus-mode blockquote { border-left-color: rgba(85, 85, 85, 0.117647); }
header, .context-menu, .megamenu-content, footer { font-family: "Segoe UI", Arial, sans-serif; }






</style>
</head>
<body class='typora-export' >
<div  id='write'  class = 'is-node'><h2><a name='header-c1' class='md-header-anchor '></a>ZYBO</h2><p><center><img src="./img/day01/ZynqLinuxSoftwareStack.png" width="800px"/></center></p><h3><a name='header-c8' class='md-header-anchor '></a>涉及的内容</h3><ul><li>Presents the traditionally distinct fields of software and hardware design in a new unified approach（以新的统一方法呈现传统上不同的软硬件领域）</li><li>OS for embedded computing: Linux</li><li>“HW/SW bridges”: boot loader, device driver,  IP</li></ul><h3><a name='header-c20' class='md-header-anchor '></a>Course Objectives</h3><ul><li>After this course, you will be able to design an embedded system based on Xilinx ZYNQ</li><li>You will be able to <strong>add customized IP</strong> in ZYNQ</li><li>You will be able to <strong>develop device driver</strong> for customized IP</li><li>You will be able to <strong>develop boot loader</strong> for Linux</li><li>You will be able to <strong>develop applications on ZED board</strong></li><li>Understand <strong>SW/HW Co-design</strong> and <strong>HLS</strong></li></ul><h3><a name='header-c40' class='md-header-anchor '></a>Course outline</h3><ol start='' ><li><p>Overview and GNU Tool Chain</p><ul><li>Next Decade: All Programmable perspective</li><li>Course Overview</li><li>FPGA and ZYNQ Overview</li><li>GNU Tool Chain</li><li>Lab1-1 Ubuntu setup and ZED demo</li><li>Lab1-2 hello world and GNU Tool Chain</li><li>Lab1-3 Explore Zybo Linux</li><li>Lab1-4 Cross Compile </li></ul></li><li><p>User space topic</p><ul><li>Process and thread</li><li>Special files and Shell</li><li>Busybox and Package</li><li>Library and System Call</li><li>Cross compile</li><li>Lab2-1  UART read/write in two process</li><li>Lab2-2  multi thread ZED LED flashing</li><li>Lab2-3  Define your project </li></ul></li><li><p>Device driver</p><ul><li>Device driver overview</li><li>Sysfs </li><li>Interrupts</li><li>Lab3-1  ZedBoard LED hello world</li><li>Lab3-2  Cross compile xt.c then test it </li><li>Lab3-3  Recompile your own kernel</li><li>Lab3-4  Hack ZED LED device driver</li><li>Lab3-5  Insert PWM kernel module</li></ul></li><li><p>Drive the Customized  IP</p><ul><li>ZYNQ Architecture</li><li>EDK Overview</li><li>ARM Instruction Set Overview</li><li>ARM Instruction Set</li><li>Lab4-1  ZYNQ PS C Hello World </li><li>Lab4-2  ZYNQ IP and Stand alone C</li><li>Lab4-3  SDK Debug</li><li>Lab4-4  Assembly and BSP library</li></ul></li><li><p>Bootloader</p><ul><li>Bootloader Overview</li><li>U-boot and Ramfs</li><li>Linux Device Tree</li><li>ZYNQ Boot Sequence</li><li>Lab5-1  Build your U-boot </li><li>Lab5-2  Create your FSBL </li><li>Lab5-3  Ramfs for ZRobot</li><li>Lab5-4  Post init</li></ul></li><li><p>HW/SW Co-design &amp; Project Show</p><ul><li>HW/SW Co-design overview</li><li>OpenCV case study</li><li>GNU Radio case study</li><li>Software Defined Network </li><li>Final Examination </li><li>Lab6-1  Final project OpenHW.org submit</li><li>Lab6-2  Project presentation</li></ul></li></ol><h3><a name='header-c207' class='md-header-anchor '></a>Day01</h3><h4><a name='header-c208' class='md-header-anchor '></a>FPGA and ZYNQ Overview</h4><ul><li><p>Embedded system: any device that includes a programmable computer but is not itself a general-purpose computer.</p></li><li><p>嵌入式计算的三大技术特点：</p><ul><li><p>数字信号处理（Digital Signal Processing）</p><ul><li>Transforming data</li></ul></li><li><p>联网能力（Packet Processing）</p><ul><li>Transporting data</li></ul></li><li><p>不亚于桌面系统的CPU处理能力（Tera Computing）</p><ul><li>Analyzing data</li></ul></li></ul></li><li><p>双核ARM Cortex-A9 SOC + FPGA </p><p><center><img src="./img/day01/Zynq_PS&PL.png" width="800px"/></center></p><ul><li>处理系统PS（Processor System）</li><li>可编程逻辑PL（Programmable Logic）</li></ul><p><center><img src="./img/day01/Zynq7000.jpg" width="640px"/></center></p><blockquote><p>From：<a href='http://www.guyuehome.com/275'>古月居～ROS探索总结（十六）——HRMRP机器人的设计</a></p><p>Zynq 由处理系统（Processor System， PS）与可编程逻辑（Programmable Logic， PL）两部分组成。其中 PS 基于 ARM Cortex-A9 双核处理器构建，包含常用的外设接口，例如网络、 USB、内存控制器等。而 PL 由 Xilinx 的 7 系列 FPGA 构成，支持动 态重配置，可以使用 Verilog 语言编程使用。在HRMRP （Hybrid Real-time Mobile Robot Platform，混合实时移动机器人平台）中，PS通过操作系统控制所有功能正常有序的实现，而 PL作为协处理器一方面可以对复杂的运算并行加速处理， 另一方面可以进行 I/O 接口扩展，为多传感器和执行器设计统一的接口，提高系统硬 件配置的灵活性。</p></blockquote></li></ul><h4><a name='header-c257' class='md-header-anchor '></a>GNU Tool Chain</h4><ul><li><p>Which license I should use ? </p><blockquote><p><a href='http://www.ruanyifeng.com/blog/2011/05/how_to_choose_free_software_licenses.html?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io'>阮一峰的网络日志~如何选择开源许可证？</a></p></blockquote><p><center><img src="./img/day01/Which_license_should_I_use.png" width="720px"/></center></p></li><li><p>GCC Options</p><ul><li><p>-E: preprocessor output</p></li><li><p>-g: debug information</p></li><li><p>-O0~-O1: optimization level.</p><ul><li>default is -O1</li></ul></li><li><p>-x language: input file’s language.</p><ul><li>Ex: gcc -x java test.java</li></ul></li><li><p>-S: output assembly</p></li></ul></li><li><p>The <strong>GNU Compiler Collection (GCC)</strong> is the most important piece of open source software in the world. Virtually all other open software is based on it at some level or another. Even other languages, such as Perl and Python, are written in C, which is compiled by the GNU compiler.</p><p><center><img src="./img/day01/Structure4GCC.png" width="420px"/></center></p></li><li><p>Tool Chain</p><p><center><img src="./img/day01/GCC_execution.png" width="420px"/></center></p><ul><li><p>Compiler</p><ul><li><p>Convert source code to object modules</p></li><li><p>The Structure of Compiler</p><p><center><img src="./img/day01/Structure4Compiler.png" width="420px"/></center></p></li><li><p>.o: external references not yet resolved</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure">AخA</div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ nm</span> *.o</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ul></li><li><p>Linker</p><ul><li><p>Combine .o and .so into single a.out executable module</p></li><li><p>see “dl”</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ldd</span> a.out</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ul></li><li><p>Advanced Topic（<strong>Binutils</strong>）</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gcc</span> –o test.o test.c</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gcc</span> <span class="cm-attribute">-v</span> <span class="cm-attribute">-o</span> test.o test.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gcc</span> <span class="cm-attribute">-nostdlib</span> <span class="cm-attribute">-o</span> test.o test.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ldd</span> test.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Binutils</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Lists the symbols defined in an object file. </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ nm</span> test.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># The GNU debugger, which can be used to examine the values andactions inside a program while it is running</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gdb</span> test.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Displays several different kinds of information stored inside one or more object file. </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ objdump</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Displays information from an ELF formatted object file</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ readelf</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Removes the symbol table, along with any other information required for debugging</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ strip</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre><ul><li><p>GDB（GNU Project debugger）</p><ul><li><p>run command-line-arguments </p><p>Begin execution of your program with arguments</p></li><li><p>break place </p><p>place can be the name of a function or a line number</p><p>For example: break main will stop execution at the first instruction of your program </p></li><li><p>delete N 
Removes breakpoints, where N is the number of the breakpoint</p></li><li><p>step 
Executes current instruction and stops on the next one</p></li><li><p>next 
Same as step except this doesn’t step into functions</p></li><li><p>print E </p><p>Prints the value of any variable in your program when you are at a breakpoint, where E is the name of the variable you want to print</p></li><li><p>help command 
Gives you more information about any command or all if you leave out command</p></li><li><p>quit 
Exit gdb</p></li></ul></li><li><p>Core Dump</p><ul><li><p>A program dumps a core memory image into a file called “core” and then exits when it receives certain signals:</p><ul><li>Segmentation fault：accessed memory it does not own often due to a bad pointer  or dereferenced a 0 pointer</li><li>Bus error – when malformed instruction is interpreted (often due to a corrupted stack, bad variable alignment, etc.) </li></ul></li></ul></li></ul></li></ul></li><li><p>GNU Auto Tools</p><p><center><img src="./img/day01/GNU_auto_tool.png" width="580px"/></center></p><ul><li><p>GNU Auto Tools是上个世纪90年代开始发展起来的一系列辅助开发、打安装包的自动化工具</p></li><li><p>各种工具分别开发，但是协同工作的很好。比如autoconf, automake, libtool等等</p></li><li><p>autoconf</p><p><center><img src="./img/day01/autoconf.png" width="480px"/></center></p><ul><li><p>根据用户提供的configure.in文件，生成一个名为configure的脚本。该脚本可以搜集有关移植性的平台相关信息，这些信息被用来生成Makefiles，配置头文件和其它平台相关的文件。</p></li><li><p><strong>configure.in</strong></p><ul><li>是configure脚本的输入文件，为了解决在不同unix变种之间移植程序的问题：库名可能不同，应用程序名可能不同，结构和常量的定义可能不同</li><li>configure脚本完成autoconf与automake的初始化工作，为不同的平台定义相应的宏，检测并指定适当的程序名、库名、结构和常量名等等，指定要为哪些目录输出Makefile文件。总之，为编译程序做好一切准备工作。</li></ul></li></ul></li><li><p>automake</p><p><center><img src="./img/day01//automake.png" width="480px"/></center></p><ul><li><p>根据用户提供的一个高层次的生成规则Makefile.am，生成Makefile文件的模板Makefile.in。Automake生成的Makefiles符合GNU的Makefile标准，用户无需再手工编写Makefile文件。</p></li><li><p><strong>Makefile.am</strong></p><ul><li>一种比Makefile更高层次的规则。只指定要生成什么目标，它由什么源文件生成，要安装到什么目录。</li></ul></li><li><p>configure脚本生成的<strong>Makefile</strong>中已经带了很多常用的目标如：check, all, install, uninstall, clean, dist, distcheck, distclean, tags, maintainerclean.</p></li></ul></li><li><p>libtool</p><ul><li><p>生成各种程序库的方便工具。</p></li><li><p>提供一个统一的接口，程序员不用关心各种烦人的底层细节：不同的平台的库可能要求不同的后缀，不同平台对库的安装方法不同，有些平台不支持动态库等等。</p></li><li><p>生成高层次的库，称为libtool library，后缀是.la。用它连接时，默认产生动态连接库，也可以用-static参数指定生成静态连接库。</p></li><li><p>既可单独使用又可与automake和autoconf一起使用更加强大、方便。</p></li><li><p>在<strong>configure.in</strong>文件中加上AC_PROG_LIBTOOL宏，如果原来有AC_PROG_RANLIB宏，删去它。</p></li><li><p>在<strong>Makefile.am</strong>文件中：</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">lib_LTLIBRARIES <span class="cm-operator">=</span> libshell.la</span></pre></div><pre class=""><span style="padding-right: 0.1px;">libshell_la_SOURCES <span class="cm-operator">=</span> object.c subr.c symbol.c </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p>与原来的写法非常相似！</p></li><li><p>.la库只能连入.lo(使用libtool生成的目标文件)</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">libshell_la_LDADD <span class="cm-operator">=</span> xmalloc.lo @LTLIBOBJS@</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>传入库的版本号：</p><pre class="md-fences md-end-block" lang="sh"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">libshell_la_LDFLAGS <span class="cm-operator">=</span> <span class="cm-attribute">-version-info</span> <span class="cm-number">1</span>:0:1 </span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>与其它目标文件连接时用LDFLAGS指定连接的方式(默认是动态方式）：-static, --all-static指定静态连接。</p></li></ul></li><li><p>make</p><p><img src="./img/day01/make_variables.png" width="480px"/></p></li></ul></li></ul><h4><a name='header-c483' class='md-header-anchor '></a>LAB1</h4><h5><a name='header-c484' class='md-header-anchor '></a>LAB1-1 Ubuntu setup and ZyboRobot</h5><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ls</span> <span class="cm-attribute">-al</span> </span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ env</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ echo</span> <span class="cm-def">$PATH</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ which</span> <span class="cm-builtin">gcc</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ whereis</span>  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ find</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ps</span> <span class="cm-attribute">-ef</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cat</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><h5><a name='header-c486' class='md-header-anchor '></a>LAB1-2 hello world and GNU Tool Chain</h5><ul><li><p>Task-1</p><blockquote><ul><li><p>Write hello world</p></li><li><p>Compile and use all GNU tools you know to check</p></li><li><p>Where is crt0 ?</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ nm</span> /usr/lib/crt1.o</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>&quot;crt&quot; stands for &quot;C runtime&quot;, and the zero stands for &quot;the very beginning&quot;.</p></li><li><p>With 1 function call</p></li><li><p>Dived by 0 in order to create a core dump</p></li><li><p>Use GDB Trace back the call stack in core dump</p><p>From：<a href='http://www.cnblogs.com/hazir/p/linxu_core_dump.html'>菜鸟程序员的成长历程~Linux Core Dump</a></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 打开 core dump 功能</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">1</span>. 在终端中输入命令 ulimit <span class="cm-attribute">-c</span> ，输出的结果为 <span class="cm-number">0</span>，说明默认是关闭 core dump 的，即当程序异常终止时，也不会生成 core dump 文件</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">2</span>. 我们可以使用命令 ulimit <span class="cm-attribute">-c</span> unlimited 来开启 core dump 功能，并且不限制 core dump 文件的大小； 如果需要限制文件的大小，将 unlimited 改成你想生成 core 文件最大的大小，注意单位为 blocks（KB）</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 使用 gdb 调试 Core 文件</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gcc</span> core_demo.c <span class="cm-attribute">-o</span> core_demo <span class="cm-attribute">-g</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ </span>./core_demo</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gdb</span> core_demo core_demo.core.24816</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre></li></ul></blockquote></li><li><p>Task-2</p><blockquote><ul><li><p>Write Makefile</p></li><li><p>Hello1.c  Hello2.c<br/></p></li><li><p>Say two hello</p><p>Hello world 1 !</p><p>Hello world 2 ! </p></li></ul></blockquote><p>Solution: </p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Hello1.c</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">print_Hello1</span>(<span class="cm-variable-3">void</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"Hello world 1 !\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Hello2.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">print_Hello2</span>(<span class="cm-variable-3">void</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"Hello world 2 !\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// hello.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">argc</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">argv</span>[]){</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">print_Hello1</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">print_Hello2</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Makefile</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">TARGET</span> <span class="cm-operator">=</span> <span class="cm-variable">hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">all</span>: <span class="cm-variable">$</span>(<span class="cm-variable">TARGET</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">clean</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">rm</span> <span class="cm-operator">-</span><span class="cm-variable">f</span> <span class="cm-operator">*</span>.<span class="cm-variable">o</span> <span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">hello</span>.<span class="cm-variable">o</span>: <span class="cm-variable">hello</span>.<span class="cm-variable">c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">Hello1</span>.<span class="cm-variable">o</span>: <span class="cm-variable">Hello1</span>.<span class="cm-variable">c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">Hello2</span>.<span class="cm-variable">o</span>: <span class="cm-variable">Hello2</span>.<span class="cm-variable">c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">OBJ</span> <span class="cm-operator">=</span> <span class="cm-variable">hello</span>.<span class="cm-variable">o</span> <span class="cm-variable">Hello1</span>.<span class="cm-variable">o</span> <span class="cm-variable">Hello2</span>.<span class="cm-variable">o</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>): <span class="cm-variable">$</span>(<span class="cm-variable">OBJ</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">$</span>(<span class="cm-variable">CC</span>) <span class="cm-variable">$</span>(<span class="cm-variable">CFLAGS</span>) <span class="cm-variable">$</span>(<span class="cm-variable">LDFLAGS</span>) <span class="cm-operator">-</span><span class="cm-variable">o</span> <span class="cm-variable">$@</span> <span class="cm-def">$</span>(<span class="cm-variable">OBJ</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 789px;"></div></div></div></pre></li><li><p>Task-3：fopen</p><blockquote><ul><li><p>Open a file</p></li><li><p>Write into this file</p><p>Hello world 1 !</p><p>Hello world 2 ! </p></li></ul></blockquote><p>Solution: </p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// fopen.c</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdlib.h&gt;<span class="cm-tab"> </span></span><span class="cm-comment">// for exit()</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">argc</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">argv</span>[]){</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">FILE</span> <span class="cm-operator">*</span><span class="cm-variable">fp</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-keyword">if</span>((<span class="cm-variable">fp</span><span class="cm-operator">=</span><span class="cm-variable">fopen</span>(<span class="cm-string">"./result"</span>,<span class="cm-string">"w+"</span>)) <span class="cm-operator">==</span> <span class="cm-variable">NULL</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"Connot open file!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">exit</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">char</span> <span class="cm-variable">str1</span>[]<span class="cm-operator">=</span><span class="cm-string">"Hello world 1 !"</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">char</span> <span class="cm-variable">str2</span>[]<span class="cm-operator">=</span><span class="cm-string">"Hello world 2 !"</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// -1 for '\0'</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">fwrite</span>(<span class="cm-variable">str1</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">str1</span>)<span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-variable">fp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">fwrite</span>(<span class="cm-string">"\n"</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-variable">fp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">fwrite</span>(<span class="cm-variable">str2</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">str2</span>)<span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-variable">fp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">fwrite</span>(<span class="cm-string">"\n"</span>, <span class="cm-number">1</span>, <span class="cm-number">1</span>, <span class="cm-variable">fp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-variable">fclose</span>(<span class="cm-variable">fp</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Makefile</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">TARGET</span> <span class="cm-operator">=</span> <span class="cm-variable">fopen</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">all</span>: <span class="cm-variable">$</span>(<span class="cm-variable">TARGET</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">clean</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">rm</span> <span class="cm-operator">-</span><span class="cm-variable">f</span> <span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">OBJ</span> <span class="cm-operator">=</span> <span class="cm-variable">fopen</span>.<span class="cm-variable">c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>): <span class="cm-variable">$</span>(<span class="cm-variable">OBJ</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">$</span>(<span class="cm-variable">CC</span>) <span class="cm-variable">$</span>(<span class="cm-variable">CFLAGS</span>) <span class="cm-variable">$</span>(<span class="cm-variable">LDFLAGS</span>) <span class="cm-operator">-</span><span class="cm-variable">o</span> <span class="cm-variable">$@</span> <span class="cm-def">$</span>(<span class="cm-variable">OBJ</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 776px;"></div></div></div></pre></li></ul><h5><a name='header-c556' class='md-header-anchor '></a>LAB1-3 Explore Embedded Linux</h5><p><center><img src="./img/day01/ZYBO.png" width="720px"/></center></p><ul><li><p>SD卡文件系统：<strong>FAT32</strong></p></li><li><p>SD卡文件内容：<strong>./LAB1/ZYBO_SD/*</strong></p></li><li><p>通过串口putty到ZYBO</p><blockquote><ul><li><p>Win10（个人感觉体验更好）</p><ul><li>直接双击putty.exe</li><li>COM6</li><li>115200</li></ul></li><li><p>Ubuntu16.04</p><ul><li><p>安装并启动putty</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> apt-get install putty</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> putty</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p>check dmesg log to see the device node</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ dmesg</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">[11777.556719] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: new high-speed USB device number <span class="cm-number">13</span> using xhci_hcd</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.746450] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: New USB device found, <span class="cm-def">idVendor</span><span class="cm-operator">=</span><span class="cm-number">0403</span>, <span class="cm-def">idProduct</span><span class="cm-operator">=</span>6010</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.746459] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: New USB device strings: <span class="cm-def">Mfr</span><span class="cm-operator">=</span><span class="cm-number">1</span>, <span class="cm-def">Product</span><span class="cm-operator">=</span><span class="cm-number">2</span>, <span class="cm-def">SerialNumber</span><span class="cm-operator">=</span>3</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.746464] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: Product: Digilent Adept USB Device</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.746468] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: Manufacturer: Digilent</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.746472] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: SerialNumber: 210279572881</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.749891] ftdi_sio <span class="cm-number">1</span><span class="cm-attribute">-2</span>:1.0: FTDI USB Serial Device converter detected</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.750002] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: Detected FT2232H</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.750223] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: FTDI USB Serial Device converter now attached to ttyUSB0</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.753247] ftdi_sio <span class="cm-number">1</span><span class="cm-attribute">-2</span>:1.1: FTDI USB Serial Device converter detected</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.753371] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: Detected FT2232H</span></pre><pre class=""><span style="padding-right: 0.1px;">[11777.753616] usb <span class="cm-number">1</span><span class="cm-attribute">-2</span>: FTDI USB Serial Device converter now attached to ttyUSB1</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 299px;"></div></div></div></pre></li><li><p>ttyUSB1</p></li><li><p>115200</p></li></ul></li></ul></blockquote></li><li><p>挂载/解挂SD卡</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ fdisk</span> <span class="cm-attribute">-l</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> ~ &amp;&amp; <span class="cm-builtin">mkdir</span> sd</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> sd</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ mount</span> /dev/mmcblk0p1 sd/</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ umount</span> <span class="cm-attribute">-l</span> sd/</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li></ul><h5><a name='header-c606' class='md-header-anchor '></a>LAB1-4 Cross Compile</h5><ul><li><p>How to install?</p><blockquote><p>Reference：</p><ul><li><a href='http://www.voidcn.com/blog/flyingforever_wl/article/p-2845212.html'>zynq交叉编译环境搭建</a></li><li><a href='http://xilinx.wikidot.com/zynq-tools'>Xilinx~ARM GNU Tools</a></li></ul></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># From my xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ chmod</span> a<span class="cm-operator">+</span>x xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 此步就是将dash改成bash，安装交叉编译工具链的时候，需要改成bash才行</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Select &lt;No&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> dpkg-reconfigure <span class="cm-attribute">-plow</span> dash</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ </span>./xilinx-2011.09-50-arm-xilinx-linux-gnueabi.bin</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">PATH</span><span class="cm-operator">=</span>~/CodeSourcery/Sourcery_CodeBench_Lite_for_Xilinx_GNU_Linux/bin:<span class="cm-def">$PATH</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Directly from SDK：https://www.xilinx.com/support/download.html</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># installing in ~/Xilinx </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ </span>./Xilinx_SDK_2016.4_0124_1_Lin64.bin</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">PATH</span><span class="cm-operator">=</span>~/Xilinx/SDK/2016.4/gnu/arm/lin/bin:<span class="cm-def">$PATH</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre></li><li><p>Task-4：</p><ul><li><p>native-compile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ gcc</span> <span class="cm-attribute">-o</span> helloworld helloworld.c</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ </span>./helloworld</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p>cross-compile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ${CROSS_COMPILE}</span><span class="cm-builtin">gcc</span> <span class="cm-attribute">-o</span> helloworld helloworld.c</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ </span>./helloworld</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">bash</span>: ./helloworld: cannot execute binary file: Exec format error</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Makefile</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">TARGET</span> <span class="cm-operator">=</span> <span class="cm-variable">helloworld</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">all</span>: <span class="cm-variable">$</span>(<span class="cm-variable">TARGET</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">clean</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">rm</span> <span class="cm-operator">-</span><span class="cm-variable">f</span> <span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">OBJ</span> <span class="cm-operator">=</span> <span class="cm-variable">helloworld</span>.<span class="cm-variable">c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$</span>(<span class="cm-variable">TARGET</span>): <span class="cm-variable">$</span>(<span class="cm-variable">OBJ</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">$</span>{<span class="cm-variable">CROSS_COMPILE</span>}<span class="cm-variable">gcc</span> <span class="cm-operator">-</span><span class="cm-variable">o</span> <span class="cm-variable">$@</span> <span class="cm-def">$</span>(<span class="cm-variable">OBJ</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 209px;"></div></div></div></pre></li><li><p>Run on Zybo</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Copy helloworld to SD card</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Putty</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~<span class="cm-comment"># cd ~ &amp;&amp; mkdir sd</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># root@zynq:~# fdisk -l</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~<span class="cm-comment"># mount /dev/mmcblk0p1 sd/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~<span class="cm-comment"># cd sd/Task-4</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~/sd/Task-4<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile &nbsp; &nbsp;  helloworld &nbsp;  helloworld.c</span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~/sd/Task-4<span class="cm-comment"># ./helloworld</span></span></pre><pre class=""><span style="padding-right: 0.1px;">hello world!</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre></li></ul></li></ul><h5><a name='header-c639' class='md-header-anchor '></a>LAB1-5 Kernel Compile</h5><ul><li><p>Task-5</p><blockquote><ol start='' ><li><p>extract kernel zip, linux-xlnx-xilinx-v2013.4.zip</p></li><li><p>cross compile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># kernel_compile.sh</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-def">PATH</span><span class="cm-operator">=</span>~/Xilinx/SDK/2016.4/gnu/arm/lin/bin:<span class="cm-def">$PATH</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> linux-xlnx-xilinx-v2013.4</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># make config</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm xilinx_zynq_defconfig</span></pre><pre class=""><span style="padding-right: 0.1px;">  HOSTCC  scripts/basic/fixdep</span></pre><pre class=""><span style="padding-right: 0.1px;">  HOSTCC  scripts/kconfig/conf.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  HOSTCC  scripts/kconfig/zconf.tab.o</span></pre><pre class=""><span style="padding-right: 0.1px;">In file included from scripts/kconfig/zconf.tab.c:2537:0:</span></pre><pre class=""><span style="padding-right: 0.1px;">scripts/kconfig/menu.c: In <span class="cm-keyword">function</span> ‘get_symbol_str’:</span></pre><pre class=""><span style="padding-right: 0.1px;">scripts/kconfig/menu.c:586:18: warning: ‘jump’ may be used uninitialized <span class="cm-keyword">in</span> this <span class="cm-keyword">function</span> [-Wmaybe-uninitialized]</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; jump-&gt;offset <span class="cm-operator">=</span> r-&gt;len <span class="cm-attribute">-</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ^</span></pre><pre class=""><span style="padding-right: 0.1px;">scripts/kconfig/menu.c:547:19: note: ‘jump’ was declared here</span></pre><pre class=""><span style="padding-right: 0.1px;">  struct jump_key *jump;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</span></pre><pre class=""><span style="padding-right: 0.1px;">  HOSTLD  scripts/kconfig/conf</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># configuration written to .config</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># make, about 10 minutes</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm <span class="cm-def">UIMAGE_LOADADDR</span><span class="cm-operator">=</span>0x8000 uImage</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-string">"mkimage"</span> command not found <span class="cm-attribute">-</span> U-Boot images will not be built</span></pre><pre class=""><span style="padding-right: 0.1px;">/home/gary/Workspace/git_ws/Courses/ZYBO/LAB1/Task-5/linux-xlnx-xilinx-v2013.4/arch/arm/boot/Makefile:79: recipe <span class="cm-keyword">for</span> target <span class="cm-string">'arch/arm/boot/uImage'</span> failed</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: *** [arch/arm/boot/uImage] Error 1</span></pre><pre class=""><span style="padding-right: 0.1px;">/home/gary/Workspace/git_ws/Courses/ZYBO/LAB1/Task-5/linux-xlnx-xilinx-v2013.4/arch/arm/Makefile:305: recipe <span class="cm-keyword">for</span> target <span class="cm-string">'uImage'</span> failed</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>: *** [uImage] Error 2</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> apt install u-boot-tools</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm <span class="cm-def">UIMAGE_LOADADDR</span><span class="cm-operator">=</span>0x8000 uImage</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/config/kernel.release</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/uapi/linux/version.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/utsrelease.h</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: <span class="cm-string">'include/generated/mach-types.h'</span> is up to date.</span></pre><pre class=""><span style="padding-right: 0.1px;">  CALL &nbsp;  scripts/checksyscalls.sh</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/compile.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; kernel/config_data.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  Kernel: arch/arm/boot/Image is ready</span></pre><pre class=""><span style="padding-right: 0.1px;">  Kernel: arch/arm/boot/zImage is ready</span></pre><pre class=""><span style="padding-right: 0.1px;">  UIMAGE  arch/arm/boot/uImage</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Name: &nbsp; Linux-3.12.0-xilinx</span></pre><pre class=""><span style="padding-right: 0.1px;">Created: &nbsp; &nbsp;  Tue Feb  <span class="cm-number">7</span> <span class="cm-number">11</span>:52:16 2017</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Type: &nbsp; ARM Linux Kernel Image (uncompressed)</span></pre><pre class=""><span style="padding-right: 0.1px;">Data Size: &nbsp;  <span class="cm-number">3055152</span> Bytes <span class="cm-operator">=</span> <span class="cm-number">2983</span>.55 kB <span class="cm-operator">=</span> <span class="cm-number">2</span>.91 MB</span></pre><pre class=""><span style="padding-right: 0.1px;">Load Address: 00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">Entry Point:  00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">  Image arch/arm/boot/uImage is ready</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># hack the kernel</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sublime_text_3</span> ./arch/arm/kernel/setup.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># The first sentence is “Booting Linux on physical CPU“</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Find the first sentence in setup.c, add your name in.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm <span class="cm-def">UIMAGE_LOADADDR</span><span class="cm-operator">=</span>0x8000 uImage</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/config/kernel.release</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/uapi/linux/version.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/utsrelease.h</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: <span class="cm-string">'include/generated/mach-types.h'</span> is up to date.</span></pre><pre class=""><span style="padding-right: 0.1px;">  CALL &nbsp;  scripts/checksyscalls.sh</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/compile.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  CC &nbsp; &nbsp;  arch/arm/kernel/setup.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD &nbsp; &nbsp;  arch/arm/kernel/built-in.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; kernel/config_data.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  LINK &nbsp;  vmlinux</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD &nbsp; &nbsp;  vmlinux.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  MODPOST vmlinux.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  GEN &nbsp; &nbsp; .version</span></pre><pre class=""><span style="padding-right: 0.1px;">  CHK &nbsp; &nbsp; include/generated/compile.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  UPD &nbsp; &nbsp; include/generated/compile.h</span></pre><pre class=""><span style="padding-right: 0.1px;">  CC &nbsp; &nbsp;  init/version.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD &nbsp; &nbsp;  init/built-in.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  KSYM &nbsp;  .tmp_kallsyms1.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  KSYM &nbsp;  .tmp_kallsyms2.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD &nbsp; &nbsp;  vmlinux</span></pre><pre class=""><span style="padding-right: 0.1px;">  SORTEX  vmlinux</span></pre><pre class=""><span style="padding-right: 0.1px;">  SYSMAP  System.map</span></pre><pre class=""><span style="padding-right: 0.1px;">  OBJCOPY arch/arm/boot/Image</span></pre><pre class=""><span style="padding-right: 0.1px;">  Kernel: arch/arm/boot/Image is ready</span></pre><pre class=""><span style="padding-right: 0.1px;">  GZIP &nbsp;  arch/arm/boot/compressed/piggy.gzip</span></pre><pre class=""><span style="padding-right: 0.1px;">  AS &nbsp; &nbsp;  arch/arm/boot/compressed/piggy.gzip.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD &nbsp; &nbsp;  arch/arm/boot/compressed/vmlinux</span></pre><pre class=""><span style="padding-right: 0.1px;">  OBJCOPY arch/arm/boot/zImage</span></pre><pre class=""><span style="padding-right: 0.1px;">  Kernel: arch/arm/boot/zImage is ready</span></pre><pre class=""><span style="padding-right: 0.1px;">  UIMAGE  arch/arm/boot/uImage</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Name: &nbsp; Linux-3.12.0-xilinx</span></pre><pre class=""><span style="padding-right: 0.1px;">Created: &nbsp; &nbsp;  Tue Feb  <span class="cm-number">7</span> <span class="cm-number">11</span>:54:49 2017</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Type: &nbsp; ARM Linux Kernel Image (uncompressed)</span></pre><pre class=""><span style="padding-right: 0.1px;">Data Size: &nbsp;  <span class="cm-number">3055088</span> Bytes <span class="cm-operator">=</span> <span class="cm-number">2983</span>.48 kB <span class="cm-operator">=</span> <span class="cm-number">2</span>.91 MB</span></pre><pre class=""><span style="padding-right: 0.1px;">Load Address: 00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">Entry Point:  00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">  Image arch/arm/boot/uImage is ready</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2277px;"></div></div></div></pre></li><li><p>test on zybo</p><ul><li><p>Copy uImage to SD card</p></li><li><p>Find hacked print info</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@zynq:~<span class="cm-comment"># dmesg | head -n 20</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">Durant35: Booting Linux on physical CPU 0x0</span></pre><pre class=""><span style="padding-right: 0.1px;">Linux version <span class="cm-number">3</span>.12.0-xilinx (gary@gary-ThinkPad-T460) (gcc version <span class="cm-number">4</span>.9.2 (Sourcery CodeBench Lite <span class="cm-number">2015</span>.05-17) ) <span class="cm-comment">#2 SMP PREEMPT Tue Feb 7 11:54:46 CST 2017</span></span></pre><pre class=""><span style="padding-right: 0.1px;">CPU: ARMv7 Processor [413fc090] revision <span class="cm-number">0</span> (ARMv7), <span class="cm-def">cr</span><span class="cm-operator">=</span>18c5387d</span></pre><pre class=""><span style="padding-right: 0.1px;">CPU: PIPT / VIPT nonaliasing data cache, VIPT aliasing instruction cache</span></pre><pre class=""><span style="padding-right: 0.1px;">Machine: Xilinx Zynq Platform, model: Xilinx Zynq Platform</span></pre><pre class=""><span style="padding-right: 0.1px;">bootconsole [earlycon0] enabled</span></pre><pre class=""><span style="padding-right: 0.1px;">Memory policy: Data cache writealloc</span></pre><pre class=""><span style="padding-right: 0.1px;">On <span class="cm-builtin">node</span> <span class="cm-number">0</span> totalpages: 131072</span></pre><pre class=""><span style="padding-right: 0.1px;">free_area_init_node: <span class="cm-builtin">node</span> <span class="cm-number">0</span>, pgdat c05c3e40, node_mem_map c05fb000</span></pre><pre class=""><span style="padding-right: 0.1px;">  Normal zone: <span class="cm-number">1024</span> pages used <span class="cm-keyword">for</span> memmap</span></pre><pre class=""><span style="padding-right: 0.1px;">  Normal zone: <span class="cm-number">0</span> pages reserved</span></pre><pre class=""><span style="padding-right: 0.1px;">  Normal zone: <span class="cm-number">131072</span> pages, LIFO batch:31</span></pre><pre class=""><span style="padding-right: 0.1px;">PERCPU: Embedded <span class="cm-number">8</span> pages/cpu @c0a02000 s8384 r8192 d16192 u32768</span></pre><pre class=""><span style="padding-right: 0.1px;">pcpu-alloc: s8384 r8192 d16192 u32768 <span class="cm-def">alloc</span><span class="cm-operator">=</span><span class="cm-number">8</span>*4096</span></pre><pre class=""><span style="padding-right: 0.1px;">pcpu-alloc: [0] <span class="cm-number">0</span> [0] 1</span></pre><pre class=""><span style="padding-right: 0.1px;">Built <span class="cm-number">1</span> zonelists <span class="cm-keyword">in</span> Zone order, mobility grouping on.  Total pages: 130048</span></pre><pre class=""><span style="padding-right: 0.1px;">Kernel command line: <span class="cm-def">console</span><span class="cm-operator">=</span>ttyPS0,115200 <span class="cm-def">root</span><span class="cm-operator">=</span>/dev/ram rw earlyprintk</span></pre><pre class=""><span style="padding-right: 0.1px;">PID hash table entries: <span class="cm-number">2048</span> (order: <span class="cm-number">1</span>, <span class="cm-number">8192</span> bytes)</span></pre><pre class=""><span style="padding-right: 0.1px;">Dentry cache hash table entries: <span class="cm-number">65536</span> (order: <span class="cm-number">6</span>, <span class="cm-number">262144</span> bytes)</span></pre><pre class=""><span style="padding-right: 0.1px;">Inode-cache hash table entries: <span class="cm-number">32768</span> (order: <span class="cm-number">5</span>, <span class="cm-number">131072</span> bytes)</span></pre><pre class=""><span style="padding-right: 0.1px;">root@zynq:~<span class="cm-comment">#</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 529px;"></div></div></div></pre></li></ul></li></ol></blockquote></li></ul><h3><a name='header-c664' class='md-header-anchor '></a>Day02</h3><h4><a name='header-c665' class='md-header-anchor '></a>Process and User Space</h4><ul><li><p>Object File Format</p><ul><li><p>a.out Object File Format</p></li><li><p>elf Object File Format</p><ul><li>Linux &quot;Executable&quot; ELF files</li><li>​</li></ul></li></ul></li><li><p>Static Library &amp; Dynamic Shared Library</p><ul><li>Static Library</li><li>Dynamic Shared Library<br/></li></ul></li><li><p>Inter Process Communication</p></li><li><p>Shells</p><ul><li><p>Bourne shell (sh)</p></li><li><p>C Shell (csh)</p></li><li><p>Korn shell (ksh)</p></li><li><p>Bash Shell (bash)</p></li><li><p>Other Shells</p><ul><li>rc – replacement for sh on Plan 9</li><li>ash, Almquist shell, A Shell – clone for BSD of much of Bourne shell</li><li>dash – Debian Almquist shell, faster then bash, but no extensions (no “bashisms”)</li><li>esh – Easy Shell, Lisp based</li><li>scsh – Scheme shell</li><li>sash – Standalone shell, no reliance on external libraries</li><li>zsh – Z Shell extension of Bourne shell</li></ul></li></ul></li><li><p>The Common Gateway Interface </p></li><li><p>Linux发行版的派系</p><ul><li>​</li></ul></li><li><p>/proc</p><ul><li>​</li></ul></li><li><p>strace  显示任何由用户空间发出的系统调用</p></li><li><p>POSIX API</p><ul><li><p>Frequently needed functions</p><ul><li>int open( char *fname, int flags, … )</li><li>int read( int fd, char *buf, int count ) </li><li>Serial Port Programming</li><li>Unix Serial Devices and Communication</li></ul></li></ul></li></ul><h4><a name='header-c778' class='md-header-anchor '></a>Introduction to Embedded System Design using Zynq</h4><ul><li><p>Objectives</p><ul><li>Define a Zynq All Programmable SoC (AP SoC) processor component</li><li>Enumerate（列举） the key aspects of the Zynq AP SoC processing system</li><li>Describe the embedded design flow</li><li>Understand the function of the IP Integrator tool（IP集成器工具）</li><li>Indicate（指出） how the hardware design is linked to the software development environment</li></ul></li></ul><ul><li><p>Embedded Processor Component</p><ul><li><p>Embedded design with Zynq is based on:</p><ul><li><p>Processor and peripherals</p><ul><li>Dual ARM® Cortex™ -A9 processors of Zynq-7000 AP SoC</li><li>AXI interconnect（互联总线）</li><li>AXI component peripherals（外设组件）</li><li>Reset, clocking, debug ports</li></ul></li><li><p>Software platform for processing system</p><ul><li>Bare Metal Applications or OS’s (e.g. Linux, FreeRTOS) （裸机应用程序/操作系统）</li><li>C language support</li><li>Processor services</li><li>C drivers for hardware</li></ul></li><li><p>User application</p><ul><li>Interrupt service routines (optional)（中断服务程序）</li></ul></li></ul><p><center><img src="./img/day02/Zynq_block_diagram.jpg" width="720px"/></center></p></li><li><p>The Zynq-7000 AP SoC architecture consists of two major sections</p><ul><li><p>PS: Processing System</p><ul><li>Dual ARM Cortex-A9 processor based</li><li>Multiple peripherals</li><li>Hard silicon core</li></ul><p><center><img src="./img/day02/Zynq_PS.png" width="720px"/></center></p><ul><li><p>The Zynq AP SoC processing system consists of the following blocks：</p><ul><li><p>Application processing unit (APU)</p></li><li><p>I/O peripherals (IOP)</p><ul><li>Multiplexed I/O (MIO), extended multiplexed I/O (EMIO)</li></ul></li><li><p>Memory interfaces</p></li><li><p>PS interconnect</p></li><li><p>DMA</p></li><li><p>Timers</p><ul><li>Public and private</li></ul></li><li><p>General interrupt controller (GIC)</p></li><li><p>On-chip memory (OCM): ROM and RAM</p></li><li><p>Debug controller: CoreSight</p></li></ul></li></ul></li><li><p>PL: Programmable Logic</p><ul><li><p>Uses the same 7 series programmable logic：</p><ul><li>Artix™-based devices: Z-7010, Z-7015 and Z-7020 (high-range I/O banks only)</li><li>Kintex™-based devices: Z-7030, Z-7045, and Z-7100 (mix of high-range and high-performance I/O banks)</li></ul></li></ul></li></ul></li></ul></li><li><p>Overview of Vivado for Embedded Design</p><p><center><img src="./img/day02/Vivado.png" width="800px"/></center></p><ul><li><p>What are Vivado, IP Integrator and SDK?</p><ul><li><p>Vivado is the tool suite for Xilinx FPGA design and includes capability for embedded system design</p></li><li><p>IP Integrator, is part of Vivado and allows block level design of the hardware part of an Embedded system</p><ul><li>Integrated into Vivado</li></ul></li><li><p>Vivado includes all the tools, IP, and documentation that are required for designing systems with the Zynq-7000 AP SoC hard core and/or Xilinx MicroBlaze soft core processor</p></li><li><p><strong>Vivado+IPI</strong> replaces <strong>ISE/EDK</strong></p></li><li><p>SDK is an Eclipse-based software design environment</p><ul><li>Enables the integration of hardware and software components</li><li>Links from Vivado</li></ul></li></ul></li><li><p>Hardware Design</p><p><center><img src="./img/day02/hardware_software_co-design.png" width="640px"/></center></p><ul><li><p>Hardware development tools</p><ul><li><p>IP Integrator</p></li><li><p>IP Packager </p></li><li><p>Hardware netlist generation </p></li><li><p>Simulation model generation</p></li><li><p>Xilinx Microprocessor Debugger (XMD)</p></li><li><p>Hardware debugging using Vivado analyzer </p></li><li><p>Vivado/IP Integrator</p><ul><li>Design environment for configuration of PS, and hardware design for PL</li><li>Hardware Platform (xml)</li><li>Platform, software, and peripheral simulation</li><li>Vivado logic analyzer integration</li></ul></li></ul></li></ul></li><li><p>Software Design</p><ul><li><p>Software Development Kit (SDK)</p><ul><li>Project workspace </li><li>Hardware platform definition</li><li>Board Support Package (BSP)</li><li>Software application</li><li>Software debugging</li></ul></li><li><p>Eclipse IDE-based Software Development Kit (SDK)</p><ul><li>Board support package creation </li><li>GNU software development tools</li><li>C/C++ compiler for the MicroBlaze and ARM Cortex-A9 processors (gcc)</li><li>Debugger for the MicroBlaze and ARM Cortex-A9 processors (gdb)</li><li>TCF framework – multicore debug</li></ul></li><li><p>Board support packages (BSPs)</p><ul><li><p>Stand-alone BSP</p><ul><li>Free basic device drivers and utilities from Xilinx</li><li>NOT an RTOS</li></ul></li></ul></li></ul></li></ul></li><li><p>Embedded System Development Flow</p><p><center><img src="./img/day02/DesignFlow.png" width="720px"/></center></p><p><center><img src="./img/day02/SystemDesign_Vivado.png" width="640px"/></center></p></li></ul><ul><li><p>Add IP Integrator Block Diagram</p></li><li><p>Configuring Hardware in IP Integrator </p><ul><li>Exporting to SDK</li><li>Software Development Flow</li><li>Configuring FPGA and Downloading Application</li></ul></li><li><p>Hardware Platform Creation</p><ul><li><p>Provides a graphical view of the PS to configure</p><ul><li>ARM cores</li><li>I/O peripherals</li><li>DDR controller</li><li>Memory systems</li></ul></li><li><p>Clock Configuration</p><ul><li><p>Input frequency can be set</p><ul><li>Processor, DDR</li></ul></li><li><p>All IOP clock frequencies can be set</p></li><li><p>Clock  to PL configuration</p></li><li><p>Set Timers</p></li></ul></li></ul></li><li><p>SDK Software Platform</p><pre class='md-fences mock-cm' style='display:block;position:relative'>  &lt;center&gt;&lt;img src=&quot;./img/day02/SDK_Workbench.png&quot; width=&quot;640px&quot;/&gt;&lt;/center&gt;</pre></li><li><p>Summary</p><ul><li>Vivado includes all the tools, documentation, and IP necessary for building embedded systems</li><li><strong>IPI</strong> is a System Level design tool that increases productivity, allowing designs to be completed faster</li><li>An embedded processing system component is built with IP provided in the IP Catalog. Designers can also add their own custom IP to this catalog</li><li>The PS Configuration wizard permits access to several configurable features of PS</li><li>The <strong>Software Development Kit (SDK)</strong> is a comprehensive software development environment for software applications</li></ul></li></ul><h4><a name='header-c1145' class='md-header-anchor '></a>Zynq Architecture</h4><ul><li><p>Objectives</p><ul><li>Identify the basic building blocks of the Zynq™ architecture processing system (PS) </li><li>Describe the usage of the Cortex-A9 processor memory space</li><li>Connect the PS to the programmable logic (PL) through the AXI ports</li><li>Generate clocking sources for the PL peripherals（<strong>PL</strong>外设）</li><li>List the various AXI-based system architectural models（基于<strong>AXI</strong>）</li><li>Name the five AXI channels（<strong>AXI</strong>通道）</li><li>Describe the operation of the AXI streaming protocol（<strong>AXI</strong>流协议）</li></ul></li></ul><ul><li><p>Zynq All Programmable SoC (AP SoC)</p><p><center><img src="./img/day02/Zynq7000_BlockDiagram.png" width="720px"/></center></p></li><li><p>Zynq AP SoC Processing System (PS)</p><ul><li><p>ARM Cortex-A9 Processor Micro-Architecture</p><p><center><img src="./img/day02/Cortex-A9_Processor.png" width="640px"/></center></p></li><li><p>PS Components</p><ul><li><p>Application processing unit (APU)</p></li><li><p>I/O peripherals (IOP)</p><ul><li>Multiplexed I/O (MIO), extended multiplexed I/O (EMIO)</li></ul></li><li><p>Memory interfaces</p></li><li><p>PS interconnect</p></li><li><p>DMA</p></li><li><p>Timers </p><ul><li>Public and private</li></ul></li><li><p>General interrupt controller (GIC)</p></li><li><p>On-chip memory (OCM): RAM</p></li><li><p>Debug controller: CoreSight</p></li></ul></li><li><p>Processing System Interconnect</p><p><center><img src="./img/day02/ProcessingSystem_Interconnect.png" width="540px"/></center></p><ul><li><p><strong>Programmable Logic</strong> to memory</p><ul><li>Two ports to DDR</li><li>One port to OCM SRAM</li></ul></li><li><p>Central interconnect</p><ul><li>Enables other interconnects to communicate</li></ul></li><li><p>Peripheral master</p><ul><li>USB, GigE, SDIO connects to DDR and PL via the central interconnect</li></ul></li><li><p>Peripheral slave</p><ul><li>CPU, DMA, and PL access to IOP peripherals</li></ul></li><li><p>Processing System master</p><ul><li>Two ports from the Processing System to Programmable Logic</li><li>Connects the CPU block  to common peripherals through the central interconnect</li></ul></li><li><p>Processing System slave</p><ul><li>Two ports from Programmable Logic to the Processing System</li></ul></li></ul></li><li><p>Memory Map</p><p><center><img src="./img/day02/MemoryMap.png" width="420px"/></center></p><ul><li>The Cortex-A9 processor uses 32-bit addressing</li><li>All PS peripherals and PL peripherals are memory mapped to the Cortex-A9 processor cores</li><li>All slave PL peripherals will be located between <strong>4000_0000</strong> and <strong>7FFF_FFFF</strong> (connected to GP0) and <strong>8000_0000</strong> and <strong>BFFF_FFFF</strong> (connected to GP1)</li></ul></li><li><p>Memory Resources</p><ul><li><p>On-chip memory (OCM)</p><ul><li>RAM</li><li>Boot ROM</li></ul></li><li><p>DDRx dynamic memory controller</p><ul><li>Supports LPDDR2, DDR2, DDR3</li></ul></li><li><p>Flash/static, memory controller</p><ul><li>Supports SRAM, QSPI, NAND/NOR FLASH</li></ul></li></ul></li><li><p>PS Boots First</p><ul><li><p>CPU0 boots from OCM ROM; CPU1 goes into a sleep state</p></li><li><p>On-chip boot loader in OCM ROM (Stage 0 boot)</p></li><li><p>Processor loads <strong>First Stage Boot Loader (FSBL)</strong> from external flash memory</p><ul><li>NOR</li><li>NAND</li><li>Quad-SPI</li><li><strong>SD Card</strong></li><li>JTAG; not a memory device—used for development/debug only</li><li>Boot source selected via package bootstrapping pins</li></ul></li><li><p>Optional secure boot mode allows the loading of encrypted software from the flash boot memory</p></li></ul></li><li><p>Configuring the PL</p><ul><li><p>The <strong>Programmable Logic</strong> is configured after the PS boots</p></li><li><p>Performed by application software accessing the hardware device configuration unit</p><ul><li>Bitstream image transferred</li><li>100-MHz, 32-bit PCAP stream interface</li><li>Decryption/authentication hardware option for encrypted bitstreams</li><li>In secure boot mode, this option can be used for software memory load</li><li>Built-in DMA allows simultaneous PL configuration and OS memory loading</li></ul></li></ul></li></ul></li><li><p>Processor Peripherals</p><ul><li><p>Input/Output Peripherals</p><p><center><img src="./img/day02/IO_Peripherals.png" width="640px"/></center></p><ul><li><p>Two GigE</p></li><li><p>Two USB</p></li><li><p>Two SPI</p></li><li><p>Two SD/SDIO</p></li><li><p>Two CAN</p></li><li><p>Two I2C</p></li><li><p>Two UART</p></li><li><p>Four 32-bit GPIOs</p></li><li><p>Static memories</p><ul><li>NAND, NOR/SRAM, Quad SPI</li></ul></li><li><p>Trace ports</p></li></ul></li><li><p>Multiplexed I/O (MIO)</p><p><center><img src="./img/day02/MIO.png" width="240px"/></center></p><ul><li><p>54 dedicated package pins available</p></li><li><p>Software configurable</p><ul><li>Automatically added to bootloader by tools</li></ul></li><li><p>Not available for all peripheral ports</p><ul><li>Some ports can only use EMIO</li></ul></li></ul></li><li><p>Extended Multiplexed I/O (EMIO)</p><p><center><img src="./img/day02/EMIO.png" width="200px"/></center></p><ul><li><p>EMIO: Peripheral port to Programmable Logic</p></li><li><p>Alternative to using MIO</p></li><li><p>Mandatory（必需） for some peripheral ports</p></li><li><p>Facilitates（便利）</p><ul><li>Connection to peripheral in programmable logic</li><li>Use of general I/O pins to supplement MIO pin usage</li><li>Alleviates competition（缓解竞争） for MIO pin usage</li></ul></li></ul></li><li><p>PS-PL Interfaces</p><p><center><img src="./img/day02/PS-PL_Interfaces.png" width="480px"/></center></p><ul><li><p>AXI high-performance slave ports (HP0-HP3)</p><ul><li>Configurable 32-bit or 64-bit data width</li><li>Access to OCM and DDR only</li><li>Conversion to processing system clock domain</li><li>AXI FIFO Interface (AFI) are FIFOs (1KB) to smooth large data transfers</li></ul></li><li><p>AXI general-purpose ports (GP0-GP1)</p><ul><li>Two masters from PS to PL</li><li>Two slaves from PL to PS</li><li>32-bit data width</li><li>Conversation and sync to processing system clock domain</li></ul></li></ul></li></ul></li><li><p>Clock, Reset, and Debug Features</p><p><center><img src="./img/day02/Clocking_the_PL.png" width="640px"/></center></p></li><li><p>AXI Interfaces</p><ul><li><p>AXI is Part of ARM’s AMBA</p><p><center><img src="./img/day02/AMBA.png" width="640px"/></center></p><p><center><img src="./img/day02/AMBA_family.png" width="640px"/></center></p></li><li><p>AXI</p><ul><li>Basic AXI Signaling – 5 Channels</li></ul><p><center><img src="./img/day02/AXI5channels.png" width="640px"/></center></p><ul><li>The AXI Interface—AX4-Lite </li><li>The AXI Interface—AXI4</li><li>The AXI Interface—AXI4-Stream</li></ul></li></ul></li></ul><h4><a name='header-c1552' class='md-header-anchor '></a>LAB2</h4><h5><a name='header-c1553' class='md-header-anchor '></a>Lab2-1Create an Embedded System</h5><ul><li><p>How to install <strong>Xilinx Vivado with SDK</strong>？</p><ul><li><p>写在前头的总结</p><ul><li>下面几个步骤是在Ubuntu16.04上搭建开发环境，过程还算简单，不过会出现设备识别不了的问题。<code>2016.4</code>更是因为安装包本身的bug，在<strong>SDK</strong>中无法<strong>Run on Hardware</strong>；即使是换成<code>2016.1</code>（目前还没发现<code>2016.4</code>的bug），也会出现串口无法正常操作，导致<strong>helloworld</strong>范例无法正常运行（应该是安装包对Linux兼容不好，没有考虑有关串口的权限问题）。</li><li>最后，建议直接在Windows上搭建开发环境，从<a href='https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vivado-design-tools/2016-1.html'>官网</a>下载<code>Xilinx_Vivado_SDK_2016.1_0409_1_Win64.exe</code> ，双击即可安装（最新的<code>2016.4</code>的Windows版本同样有bug，后来发现，<code>2014.4</code>就行了，太新很多源码都不支持了）。</li><li>我的开发环境：Vmware装了Win10虚拟机，host是Ubuntu16.04，配置了交叉编译环境</li></ul></li><li><p>从<a href='https://www.xilinx.com/support/download.html'>官网下载</a>，获取到 <code>Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</code>，下载前需要注册账号。</p></li><li><p>安装（这一步比较耗时，差不多一个钟）</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ chmod</span> a<span class="cm-operator">+</span>x Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 建议通过sudo方式安装，安装默认路径是/opt/Xilinx</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> ./Xilinx_Vivado_SDK_2016.4_0124_1_Lin64.bin</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li><li><p>You may need to install the digilent cable drivers</p><blockquote><p>From：<a href='http://www.googoolia.com/wp/2016/05/27/vivado-2016-1-on-ubuntu-16-04-64bits/'>Vivado 2016.1 and 2016.2 on Ubuntu 16.04 64Bits</a></p></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 确保已经拔掉ZYBO</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> /opt/Xilinx/Vivado/2016.4/data/xicom/cable_drivers/lin64/install_script/install_drivers</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> ./install_drivers</span></pre><pre class=""><span style="padding-right: 0.1px;">reboot</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre></li><li><p>启动</p><blockquote><p>Reference: <a href='http://mboers.github.io/zynq-notes/3-running-vivado/'>Running Vivado on Linux (Ubuntu)</a></p></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 通过echo "source /opt/Xilinx/Vivado/2016.4/settings64.sh" &gt;&gt; ~/.bashrc，将变成bash默认环境</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ source</span> /opt/Xilinx/Vivado/2016.4/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ vivado</span> &amp;</span></pre><pre class=""><span style="padding-right: 0.1px;">****** Vivado v2016.4 (64-bit)</span></pre><pre class=""><span style="padding-right: 0.1px;">  **** SW Build <span class="cm-number">1756540</span> on Mon Jan <span class="cm-number">23</span> <span class="cm-number">19</span>:11:19 MST 2017</span></pre><pre class=""><span style="padding-right: 0.1px;">  **** IP Build <span class="cm-number">1755317</span> on Mon Jan <span class="cm-number">23</span> <span class="cm-number">20</span>:30:07 MST 2017</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  ** Copyright <span class="cm-number">1986</span><span class="cm-attribute">-2016</span> Xilinx, Inc. All Rights Reserved.</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">start_gui</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre></li></ul></li><li><p>Step by step（Hardware）</p><p><center><img src="./img/Lab2_1/Vivado_SystemDesign.png" width="720px"/></center></p><ul><li><p>Create New Project</p><ul><li>Click next ……     6 times</li></ul><p><center><img src="./img/Lab2_1/CreateNewProject.png" width="720px"/></center></p></li><li><p>Select  Zynq-7000</p><ul><li>Click next, then … finish</li></ul><p><center><img src="./img/Lab2_1/SelectZynqXC7Z010.png" width="640px"/></center></p></li><li><p>Create Block Diagram <strong>design_1</strong></p><p><center><img src="./img/Lab2_1/CreateBlockDiagram.png" width="480px"/></center></p></li><li><p>Add IP： <strong>ZYNQ7 Processing System</strong></p><p><center><img src="./img/Lab2_1/AddZYNQProcessingSystem.png" width="640px"/></center></p></li><li><p>Zybo config（双击<strong>processing_system7_0</strong>）</p><p><center><img src="./img/Lab2_1/Zybo_config.png" width="720px"/></center></p></li><li><p>Import XPS settings，<strong>./LAB2/Task-1/ZYBO_zynq_def.xml</strong>，OK</p><p><center><img src="./img/Lab2_1/ImportXPS_settings.png" width="640px"/></center></p></li><li><p>Run Block Automation 完成PS接口</p></li><li><p>Add IP:  AXI_GPIO</p><p><center><img src="./img/Lab2_1/Add_AXI_GPIO.png" width="720px"/></center></p></li><li><p>GPIO as Dual Channel, 4 bit</p><ul><li><p>双击 <strong>axi_gpio_0</strong></p><ul><li>Enable Dual Channel</li><li>GPIO Width：4</li></ul><p><center><img src="./img/Lab2_1/GPIO_DualChannel.png" width="540px"/></center></p></li></ul></li><li><p>Run Connection Automation for all，然后通过<strong>Regenerate Layout</strong>自动调整模块布局，通过<strong>Validate Design</strong>进行初步验证。</p><p><center><img src="./img/Lab2_1/RunAutomation.png" width="720px"/></center></p></li><li><p>Add constrain，<strong>./LAB2/Task-1/ZYBO_Master.xdc</strong>，Finish</p><ul><li>Add Sources-&gt;Add or create constraints</li></ul><p><center><img src="./img/Lab2_1/Add_constrain.png" width="640px"/></center></p></li><li><p>Create HDL Wrapper</p><p><center><img src="./img/Lab2_1/CreateWrapper.png" width="640px"/></center></p></li><li><p>Generate Bitstream，</p><p><center><img src="./img/Lab2_1/GenerateBitstream.png" width="480px"/></center></p><ul><li><p>10 minutes later ……</p></li><li><p><code>&lt;project-name&gt;/&lt;project-name&gt;.runs/impl_1</code></p><ul><li><strong>design_1_wrapper.bit</strong></li></ul></li></ul></li></ul></li><li><p>Step by step（Software）</p><ul><li><p>How to Install Xilinx SDK</p><ul><li><p>没错，Linux下还需要额外配置才能正常启动<strong>SDK</strong>，Windows则一步自动到位。</p></li><li><p>Install JRE for eclipse</p><blockquote><p>From: <a href='https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-get-on-ubuntu-16-04'>How To Install Java with Apt-Get on Ubuntu 16.04</a></p></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> apt-get install default-jre</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>配置环境</p><blockquote><p>From: <a href='http://coldnew.github.io/zybo-board/xilinx_sdk_note/'>Xilinx SDK 在 Linux 的一些注意事項</a></p></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># echo "source /opt/Xilinx/SDK/2016.4/settings64.sh" &gt;&gt; ~/.bashrc</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ source</span> /opt/Xilinx/SDK/2016.4/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># echo "export SWT_GTK3=0" &gt;&gt; ~/.bashrc</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 没有这一步，无法在Vivado中Launch SDK</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">SWT_GTK3</span><span class="cm-operator">=</span>0</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li></ul></li><li><p>Export to SDK</p><ul><li>启动 <strong>Vivado</strong>，在其中 <strong>File-&gt;Launch SDK</strong></li></ul><p><center><img src="./img/Lab2_1/Export2SDK.png" width="800px"/></center></p></li><li><p>New application project</p><ul><li><p>File-&gt;Application Project-&gt;Next-&gt;Hello World</p><ul><li>Hardware platform：从Vivado导出的hw_platform（default）</li><li>Processor platform：ps7_contexa9_0（default）</li><li>OS platform：standalone</li></ul></li></ul><p><center><img src="./img/Lab2_1/NewAppsProject.png" width="800px"/></center></p></li><li><p>Modify helloworld.c , add your name</p><p>   <center><img src="./img/Lab2_1/modify_helloworld.png" width="720px"/></center></p></li><li><p>How to connect？</p><p>   <center><img src="./img/Lab2_1/ZYBO_pin.png" width="640px"/></center></p><p>   <center><img src="./img/Lab2_1/ZYBO_pin_description.png" width="640px"/></center></p></li></ul></li></ul><pre class='md-fences mock-cm' style='display:block;position:relative'> + 21 Programming Mode Jumper：FPGA模式
 + 18 板上电源指示灯
 + 19 PL配置完成指示灯，Program FPGA正常的话，指示灯会亮
 + Vivado-&gt;Flow-&gt;Hardware Manager验证设备成功连接
   + Detect **xc_7z010**</pre><ul><li><p>配置FPGA：<code>Xilinx Tools</code>-&gt;<code>Program FPGA</code></p><p><center><img src="./img/Lab2_1/ProgramFPGA.png" width="720px"/></center></p></li><li><p>Run it</p><pre class='md-fences mock-cm' style='display:block;position:relative'>     &lt;center&gt;&lt;img src=&quot;./img/Lab2_1/run_it.png&quot; width=&quot;480px&quot;/&gt;&lt;/center&gt;</pre></li></ul><ul><li><p>下面是我使用的<code>helloworld.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/*</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* helloworld.c: simple test application</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">*</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* This application configures UART 16550 to baud rate 9600.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* PS7 UART (Zynq) is not initialized by this application, since</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* bootrom/bsp configures it to baud rate 115200</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">*</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* ------------------------------------------------</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* | UART TYPE &nbsp; BAUD RATE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  |</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* ------------------------------------------------</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* &nbsp; uartns550 &nbsp; 9600</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* &nbsp; uartlite &nbsp;  Configurable only in HW design</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* &nbsp; ps7_uart &nbsp;  115200 (configured by bootrom/bsp)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">*/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "platform.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "xil_printf.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">init_platform</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">while</span>(<span class="cm-number">1</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">print</span>(<span class="cm-string">"Hello World\n\r"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">cleanup_platform</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 645px;"></div></div></div></pre><ul><li>正常使用的应该是USB转串口，即<code>PS7 UART (Zynq)</code>，应该是在硬件设计过程中通过<code>Import XPS Settings</code>对PS上的串口进行了配置。</li></ul><p> <center><img src="./img/Lab2_1/STDIO_Connection.png" width="540px"/></center></p><ul><li>一切正常，SDK的Console会一直打印<code>Hello World</code>，<code>ZYBO</code>板上的串口状态指示灯<code>Rx</code>会常亮。</li></ul></li><li><p>Read IP document </p><ul><li><p>IP documentation</p><p><center><img src="./img/Lab2_1/RegisterSpace.png" width="640px"/></center></p></li><li><p>Programming</p><p><center><img src="./img/Lab2_1/ProgrammingSequence.png" width="580px"/></center></p></li><li><p>Figure out the address，<code>axi_gpio_0</code> 基地址为：<strong>0x41200000</strong></p><p><center><img src="./img/Lab2_1/AddressEditor.png" width="720px"/></center></p></li><li><p>GPIO programing without BSP</p><ul><li><p><code>ZYBO</code>LED和Switch管脚原理图如下。</p><p><center><img src="./img/Lab2_1/zybo_led.png" width="640px"/></center></p></li><li><p>关于LED和Switch的管脚设计及约束文件如下图。</p><p><center><img src="./img/Lab2_1/pin_constraints.png" width="720px"/></center></p></li><li><p>Switches control LEDs lighting up</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "platform.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include "xil_printf.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define DELAY 1000000</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">init_platform</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-comment">// Switches</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">int*</span>)<span class="cm-number">0x41200000</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn0_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-comment">// LEDs</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn1_base_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn1_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">3</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-comment">// Switches as input ports</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-operator">*</span><span class="cm-variable">gpio_chn0_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-number">0xF</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-comment">// LEDs as output ports</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-operator">*</span><span class="cm-variable">gpio_chn1_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-number">0x0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">printf</span>(<span class="cm-string">"Switches Control LEDs Lighting Up\n\r"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">int</span> <span class="cm-variable">val</span>, <span class="cm-variable">delay</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">while</span>(<span class="cm-number">1</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span><span class="cm-variable">gpio_chn0_base_ptr</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printf</span>(<span class="cm-string">"Switch is %x\n"</span>, <span class="cm-variable">val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-operator">*</span><span class="cm-variable">gpio_chn1_base_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">val</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printf</span>(<span class="cm-string">"LED is %x\n"</span>,<span class="cm-variable">val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">delay</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">delay</span><span class="cm-operator">&lt;</span><span class="cm-variable">DELAY</span>;<span class="cm-variable">delay</span><span class="cm-operator">++</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">cleanup_platform</span>();</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 851px;"></div></div></div></pre></li></ul></li><li><p><code>Xilinx Tools</code>-&gt;<code>Program FPGA</code> </p></li><li><p><code>Run As</code>-&gt;<code>Launch on Hardware(GDB)</code></p></li></ul></li><li><p>强烈建议在Windows下进行上述开发（本人在Ubuntu16.04下面弄了4天，连个hello world都出现许多问题，最终选择放弃）</p><ul><li><p>直接开发 FPGA（PL）：<a href='http://coldnew.github.io/zybo-board/pl_led/'>zybo board 開發記錄: 透過可程式邏輯控制 LED 閃爍</a></p><ul><li>Vivado开发生成 <strong>.bit</strong> FPGA配置文件</li><li>Hardware Manager -&gt; Program device</li></ul></li><li><p>软硬件协同开发（配置 PL 后，PS 通过 AXI 控制 PL）：<a href='http://coldnew.github.io/zybo-board/zynq_led_flash/'>zybo board 開發記錄: Zynq 與 LED 閃爍控制</a></p><ul><li>Vivado开发生成 <strong>.bit</strong> FPGA配置文件</li><li>Export Hardware <strong>.bit</strong> to SDK</li><li>Launch SDK，基于上述开发的硬件平台开发Application</li><li>Program FPGA（<strong>.bit</strong>）</li><li>Run Application（<strong>.elf</strong>）on Hardware</li></ul></li></ul></li></ul><h5><a name='header-c1863' class='md-header-anchor '></a>Lab2-2 Bootloader</h5><ul><li><p>Create Boot Image</p><p><center><img src="./img/Lab2_2/CreateZynqBootImage.png" width="540px"/></center></p><ul><li><p>What files needed？</p><ul><li><p><code>Output BIF file path</code> &amp; <code>Output path</code> for <strong>BOOT.bin</strong></p></li><li><p><code>Boot image partitions</code>-&gt;<code>Add</code></p><ul><li><p>Add <strong>./LAB2/Task-2/fsbl.elf</strong> as <code>bootloader</code></p><p><center><img src="./img/Lab2_2/fsbl_as_bootloader.png" width="640px"/></center></p></li><li><p>Add bitstream <strong>*.bit</strong>（generated in Lab2_1） as datafile</p><p><center><img src="./img/Lab2_2/bitstream_as_datafile.png" width="640px"/></center></p></li><li><p>Add U-boot（<strong>./LAB2/Task-2/u-boot.elf</strong>） as data file</p><p><center><img src="./img/Lab2_2/Uboot_as_datafile.png" width="540px"/></center></p></li></ul></li></ul></li><li><p>Create Image</p><p><center><img src="./img/Lab2_2/CreateImage.png" width="540px"/></center></p></li><li><p>Copy BOOT.bin to SD card</p><ul><li>Programming Mode Jumper：SD卡模式</li><li>格式化你的SD卡</li><li>将创建的<strong>BOOT.bin</strong>拷贝到SD卡</li></ul></li><li><p>Test the GPIO bitstream works</p><ul><li><p>putty</p></li><li><p>help for <strong>u-boot command</strong></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; help</span></pre></div><pre class=""><span style="padding-right: 0.1px;">? &nbsp; &nbsp; &nbsp; <span class="cm-attribute">-</span> alias <span class="cm-keyword">for</span> <span class="cm-string">'help'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">base &nbsp;  <span class="cm-attribute">-</span> print or <span class="cm-keyword">set</span> address offset</span></pre><pre class=""><span style="padding-right: 0.1px;">bdinfo  <span class="cm-attribute">-</span> print Board Info structure</span></pre><pre class=""><span style="padding-right: 0.1px;">boot &nbsp;  <span class="cm-attribute">-</span> boot default, i.e., run <span class="cm-string">'bootcmd'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">bootd &nbsp; <span class="cm-attribute">-</span> boot default, i.e., run <span class="cm-string">'bootcmd'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">bootelf <span class="cm-attribute">-</span> Boot from an ELF image <span class="cm-keyword">in</span> memory</span></pre><pre class=""><span style="padding-right: 0.1px;">bootm &nbsp; <span class="cm-attribute">-</span> boot application image from memory</span></pre><pre class=""><span style="padding-right: 0.1px;">bootp &nbsp; <span class="cm-attribute">-</span> boot image via network using BOOTP/TFTP protocol</span></pre><pre class=""><span style="padding-right: 0.1px;">bootvx  <span class="cm-attribute">-</span> Boot vxWorks from an ELF image</span></pre><pre class=""><span style="padding-right: 0.1px;">bootz &nbsp; <span class="cm-attribute">-</span> boot Linux zImage image from memory</span></pre><pre class=""><span style="padding-right: 0.1px;">clk &nbsp; &nbsp; <span class="cm-attribute">-</span> CLK sub-system</span></pre><pre class=""><span style="padding-right: 0.1px;">cmp &nbsp; &nbsp; <span class="cm-attribute">-</span> memory compare</span></pre><pre class=""><span style="padding-right: 0.1px;">coninfo <span class="cm-attribute">-</span> print console devices and information</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> &nbsp; &nbsp;  <span class="cm-attribute">-</span> memory copy</span></pre><pre class=""><span style="padding-right: 0.1px;">crc32 &nbsp; <span class="cm-attribute">-</span> checksum calculation</span></pre><pre class=""><span style="padding-right: 0.1px;">dcache  <span class="cm-attribute">-</span> enable or disable data cache</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> &nbsp;  <span class="cm-attribute">-</span> <span class="cm-builtin">echo</span> args to console</span></pre><pre class=""><span style="padding-right: 0.1px;">editenv <span class="cm-attribute">-</span> edit environment variable</span></pre><pre class=""><span style="padding-right: 0.1px;">env &nbsp; &nbsp; <span class="cm-attribute">-</span> environment handling commands</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">exit</span> &nbsp;  <span class="cm-attribute">-</span> <span class="cm-keyword">exit</span> script</span></pre><pre class=""><span style="padding-right: 0.1px;">ext2load- load binary file from a Ext2 filesystem</span></pre><pre class=""><span style="padding-right: 0.1px;">ext2ls  <span class="cm-attribute">-</span> list files <span class="cm-keyword">in</span> a directory (default /)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-atom">false</span> &nbsp; <span class="cm-attribute">-</span> <span class="cm-keyword">do</span> nothing, unsuccessfully</span></pre><pre class=""><span style="padding-right: 0.1px;">fatinfo <span class="cm-attribute">-</span> print information about filesystem</span></pre><pre class=""><span style="padding-right: 0.1px;">fatload <span class="cm-attribute">-</span> load binary file from a dos filesystem</span></pre><pre class=""><span style="padding-right: 0.1px;">fatls &nbsp; <span class="cm-attribute">-</span> list files <span class="cm-keyword">in</span> a directory (default /)</span></pre><pre class=""><span style="padding-right: 0.1px;">fdt &nbsp; &nbsp; <span class="cm-attribute">-</span> flattened device tree utility commands</span></pre><pre class=""><span style="padding-right: 0.1px;">fpga &nbsp;  <span class="cm-attribute">-</span> loadable FPGA image support</span></pre><pre class=""><span style="padding-right: 0.1px;">go &nbsp; &nbsp;  <span class="cm-attribute">-</span> <span class="cm-builtin">start</span> application at address <span class="cm-string">'addr'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">help &nbsp;  <span class="cm-attribute">-</span> print command description/usage</span></pre><pre class=""><span style="padding-right: 0.1px;">icache  <span class="cm-attribute">-</span> enable or disable instruction cache</span></pre><pre class=""><span style="padding-right: 0.1px;">iminfo  <span class="cm-attribute">-</span> print header information <span class="cm-keyword">for</span> application image</span></pre><pre class=""><span style="padding-right: 0.1px;">imxtract- extract a part of a multi-image</span></pre><pre class=""><span style="padding-right: 0.1px;">itest &nbsp; <span class="cm-attribute">-</span> return <span class="cm-atom">true</span>/false on integer compare</span></pre><pre class=""><span style="padding-right: 0.1px;">loadb &nbsp; <span class="cm-attribute">-</span> load binary file over serial line (kermit mode)</span></pre><pre class=""><span style="padding-right: 0.1px;">loads &nbsp; <span class="cm-attribute">-</span> load S-Record file over serial line</span></pre><pre class=""><span style="padding-right: 0.1px;">loadx &nbsp; <span class="cm-attribute">-</span> load binary file over serial line (xmodem mode)</span></pre><pre class=""><span style="padding-right: 0.1px;">loady &nbsp; <span class="cm-attribute">-</span> load binary file over serial line (ymodem mode)</span></pre><pre class=""><span style="padding-right: 0.1px;">loop &nbsp;  <span class="cm-attribute">-</span> infinite loop on address range</span></pre><pre class=""><span style="padding-right: 0.1px;">md &nbsp; &nbsp;  <span class="cm-attribute">-</span> memory display</span></pre><pre class=""><span style="padding-right: 0.1px;">mdio &nbsp;  <span class="cm-attribute">-</span> MDIO utility commands</span></pre><pre class=""><span style="padding-right: 0.1px;">mii &nbsp; &nbsp; <span class="cm-attribute">-</span> MII utility commands</span></pre><pre class=""><span style="padding-right: 0.1px;">mm &nbsp; &nbsp;  <span class="cm-attribute">-</span> memory modify (auto-incrementing address)</span></pre><pre class=""><span style="padding-right: 0.1px;">mmc &nbsp; &nbsp; <span class="cm-attribute">-</span> MMC sub system</span></pre><pre class=""><span style="padding-right: 0.1px;">mmcinfo <span class="cm-attribute">-</span> display MMC info</span></pre><pre class=""><span style="padding-right: 0.1px;">mw &nbsp; &nbsp;  <span class="cm-attribute">-</span> memory <span class="cm-builtin">write</span> (fill)</span></pre><pre class=""><span style="padding-right: 0.1px;">nfs &nbsp; &nbsp; <span class="cm-attribute">-</span> boot image via network using NFS protocol</span></pre><pre class=""><span style="padding-right: 0.1px;">nm &nbsp; &nbsp;  <span class="cm-attribute">-</span> memory modify (constant address)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">ping</span> &nbsp;  <span class="cm-attribute">-</span> send ICMP ECHO_REQUEST to network host</span></pre><pre class=""><span style="padding-right: 0.1px;">printenv- print environment variables</span></pre><pre class=""><span style="padding-right: 0.1px;">reset &nbsp; <span class="cm-attribute">-</span> Perform RESET of the CPU</span></pre><pre class=""><span style="padding-right: 0.1px;">run &nbsp; &nbsp; <span class="cm-attribute">-</span> run commands <span class="cm-keyword">in</span> an environment variable</span></pre><pre class=""><span style="padding-right: 0.1px;">saveenv <span class="cm-attribute">-</span> save environment variables to persistent storage</span></pre><pre class=""><span style="padding-right: 0.1px;">setenv  <span class="cm-attribute">-</span> <span class="cm-keyword">set</span> environment variables</span></pre><pre class=""><span style="padding-right: 0.1px;">sf &nbsp; &nbsp;  <span class="cm-attribute">-</span> SPI flash sub-system</span></pre><pre class=""><span style="padding-right: 0.1px;">showvar <span class="cm-attribute">-</span> print local hushshell variables</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">sleep</span> &nbsp; <span class="cm-attribute">-</span> delay execution <span class="cm-keyword">for</span> some time</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">source</span>  <span class="cm-attribute">-</span> run script from memory</span></pre><pre class=""><span style="padding-right: 0.1px;">sspi &nbsp;  <span class="cm-attribute">-</span> SPI utility command</span></pre><pre class=""><span style="padding-right: 0.1px;">test &nbsp;  <span class="cm-attribute">-</span> minimal test like /bin/sh</span></pre><pre class=""><span style="padding-right: 0.1px;">tftpboot- boot image via network using TFTP protocol</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-atom">true</span> &nbsp;  <span class="cm-attribute">-</span> <span class="cm-keyword">do</span> nothing, successfully</span></pre><pre class=""><span style="padding-right: 0.1px;">version <span class="cm-attribute">-</span> print monitor, compiler and linker version</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1495px;"></div></div></div></pre></li><li><p>LED test</p><ul><li><p>Switches address：0x41200000</p><p>LEDs address：0x41200008</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; md 41200000</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># switches_base_ptr switches_tri_mode_ptr leds_base_ptr leds_tri_mode_ptr</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># <span class="cm-tab">  </span><span class="cm-tab">    </span>41200000 <span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-tab">    </span>41200004 <span class="cm-tab">   </span><span class="cm-tab">    </span>41200008 <span class="cm-tab">   </span><span class="cm-tab">    </span>4120000c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200000</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200010</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200020</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200030</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200040</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200050</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200060</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200070</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200080</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200090</span>: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000a0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000b0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000c0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000d0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000e0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">412000f0: <span class="cm-number">00000008</span> 0000000f <span class="cm-number">00000008</span> 0000000f &nbsp;  ................</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 461px;"></div></div></div></pre><ul><li>从上面可以看出，所有gpio默认都是输入</li></ul></li></ul></li><li><p>通过指令点亮LED</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; nm 4120000c</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 将led对应的gpio设置为输出</span></span></pre><pre class=""><span style="padding-right: 0.1px;">4120000c: 0000000f ? 0</span></pre><pre class=""><span style="padding-right: 0.1px;">4120000c: <span class="cm-number">00000000</span> ? q</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 操作值寄存器，控制leds</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; nm 41200008</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000000</span> ? 1</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000001</span> ? 2</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000002</span> ? 3</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000003</span> ? 4</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000004</span> ? 5</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: <span class="cm-number">00000005</span> ? f</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">41200008</span>: 0000000f ? q</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre><ul><li>地址4个字节对齐，<strong>nm</strong>指令地址不符合对齐条件，系统会自动重启</li></ul></li></ul></li></ul></li></ul><ul><li><p>Build your U-boot</p><ul><li><p>Step by step</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ source</span> /opt/Xilinx/SDK/2016.1/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Extract ./LAB2/Task-3/u-boot-Digilent-Dev-master.zip</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ unzip</span> u-boot-Digilent-Dev-master.zip <span class="cm-attribute">-d</span> .</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> u-boot-Digilent-Dev-master/</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> zynq_zybo_config</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># modify common/main.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Modify printf(“Hit any key to YOU NAME stop autoboot: %2d”, bootdelay);</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ vim</span> common/main.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># just rename operation</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cp</span> ./u-boot u-boot.elf</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre></li><li><p>Create Zynq Boot Image</p><ul><li>Use the above <strong>u-boot.elf</strong> with your name</li></ul></li><li><p>Copy BOOT.bin to SD card</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; zynq-uboot&gt; nm 1</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-number">00000001</span>:data abort</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; MAYBE you should read doc/README.arm-unaligned-accesses</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; pc : [&lt;1ff7c684&gt;] &nbsp; &nbsp; &nbsp; &nbsp;  lr : [&lt;1ff7c674&gt;]</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; sp : 1fb54e18  ip : <span class="cm-number">00000030</span> &nbsp; &nbsp; fp : 1fb59fb8</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; r10: <span class="cm-number">00000000</span>  r9 : 1ffaf464 &nbsp; &nbsp; r8 : 1fb54f48</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; r7 : 1ffaf468  r6 : <span class="cm-number">00000000</span> &nbsp; &nbsp; r5 : <span class="cm-number">00000004</span>  r4 : 00000001</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; r3 : e0001000  r2 : <span class="cm-number">00000802</span> &nbsp; &nbsp; r1 : <span class="cm-number">00000001</span>  r0 : 1ffa6767</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Flags: nZCv  IRQs off  FIQs off  Mode SVC_32</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Resetting CPU ...</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; resetting ...</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; U-Boot <span class="cm-number">2013</span>.10 (Feb <span class="cm-number">10</span> <span class="cm-number">2017</span> <span class="cm-attribute">-</span> <span class="cm-number">15</span>:36:21)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Memory: ECC disabled</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; DRAM:  <span class="cm-number">512</span> MiB</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; MMC: &nbsp; zynq_sdhci: 0</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; SF: Detected S25FL128S_64K with page size <span class="cm-number">256</span> Bytes, erase size <span class="cm-number">64</span> KiB, total <span class="cm-number">16</span> MiB</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; *** Warning <span class="cm-attribute">-</span> bad CRC, using default environment</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; In: &nbsp;  serial</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Out: &nbsp; serial</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Err: &nbsp; serial</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Net: &nbsp; Gem.e000b000</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Warning: failed to <span class="cm-keyword">set</span> MAC address</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment"># Here!!!!</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Hit any key to Durant35 <span class="cm-builtin">stop</span> autoboot:  0</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Device: zynq_sdhci</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Manufacturer ID: 3</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; OEM: 5344</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Name: SL08G</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Tran Speed: 50000000</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Rd Block Len: 512</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; SD version <span class="cm-number">3</span>.0</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; High Capacity: Yes</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Capacity: <span class="cm-number">7</span>.4 GiB</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Bus Width: <span class="cm-number">4</span><span class="cm-attribute">-bit</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; reading uEnv.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; ** Unable to read file uEnv.txt **</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Copying Linux from SD to RAM...</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; reading uImage</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; ** Unable to read file uImage **</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; zynq-uboot&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1012px;"></div></div></div></pre></li></ul></li></ul><ul><li><p>Hack U-boot</p><ul><li><p>Hack <code>./common/cmd_fpga.c</code>, add case 1: </p><p><center><img src="./img/Lab2_2/Add_case1.png" width="480px"/></center></p></li><li><p>GPIO programing without BSP</p><ul><li><p>Initialization</p></li><li><p>Config  in and out</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">do_fpga</span>(<span class="cm-variable">cmd_tbl_t</span> <span class="cm-operator">*</span><span class="cm-variable">cmdtp</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">flag</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">argc</span>, <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-keyword">const</span> <span class="cm-variable">argv</span>[])</span></pre></div><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">op</span>, <span class="cm-variable">dev</span> <span class="cm-operator">=</span> <span class="cm-variable">FPGA_INVALID_DEVICE</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">size_t</span> <span class="cm-variable">data_size</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">fpga_data</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">devstr</span> <span class="cm-operator">=</span> <span class="cm-variable">getenv</span>(<span class="cm-string">"fpga"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">datastr</span> <span class="cm-operator">=</span> <span class="cm-variable">getenv</span>(<span class="cm-string">"fpgadata"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">rc</span> <span class="cm-operator">=</span> <span class="cm-variable">FPGA_FAIL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">wrong_parms</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#if defined(CONFIG_FIT)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">const</span> <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">fit_uname</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">ulong</span> <span class="cm-variable">fit_addr</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#endif</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">/* initialization */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-meta">#define DELAY 100000000</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// Switches</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">int*</span>)<span class="cm-number">0x41200000</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn0_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// LEDs</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn1_base_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">2</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int*</span> <span class="cm-variable">gpio_chn1_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">gpio_chn0_base_ptr</span> <span class="cm-operator">+</span> <span class="cm-number">3</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">/* Config in and out */</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// Switches as input ports</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-operator">*</span><span class="cm-variable">gpio_chn0_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-number">0xF</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// LEDs as output ports</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-operator">*</span><span class="cm-variable">gpio_chn1_tri_mode_ptr</span> <span class="cm-operator">=</span> <span class="cm-number">0x0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">val</span>, <span class="cm-variable">delay</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">devstr</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  ......</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 714px;"></div></div></div></pre></li><li><p>Read 8 switchs </p></li><li><p>LED light up</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">case</span> <span class="cm-number">2</span>:<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-comment">/* fpga &lt;op&gt; */</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">op</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">int</span>)<span class="cm-variable">fpga_get_op</span>(<span class="cm-variable">argv</span>[<span class="cm-number">1</span>]);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-keyword">break</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">case</span> <span class="cm-number">1</span>:<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-comment">/* hack U-boot */</span> </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"hacked U-boot\n\r"</span>);  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-comment">/* Read switches */</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span><span class="cm-variable">gpio_chn0_base_ptr</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-variable">printf</span>(<span class="cm-string">"switch is %x\n"</span>, <span class="cm-variable">val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">delay</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">delay</span><span class="cm-operator">&lt;</span><span class="cm-variable">DELAY</span>;<span class="cm-variable">delay</span><span class="cm-operator">++</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-comment">/* LEDs light up */</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-number">0x55</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-operator">*</span><span class="cm-variable">gpio_chn1_base_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">val</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-variable">printf</span>(<span class="cm-string">"LED is %x\n"</span>, <span class="cm-variable">val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">delay</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">delay</span><span class="cm-operator">&lt;</span><span class="cm-variable">DELAY</span>;<span class="cm-variable">delay</span><span class="cm-operator">++</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-number">0xaa</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-operator">*</span><span class="cm-variable">gpio_chn1_base_ptr</span> <span class="cm-operator">=</span> <span class="cm-variable">val</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-variable">printf</span>(<span class="cm-string">"LED is %x\n"</span>, <span class="cm-variable">val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">delay</span><span class="cm-operator">=</span><span class="cm-number">0</span>;<span class="cm-variable">delay</span><span class="cm-operator">&lt;</span><span class="cm-variable">DELAY</span>;<span class="cm-variable">delay</span><span class="cm-operator">++</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-keyword">break</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">default</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">debug</span>(<span class="cm-string">"%s: Too many or too few args (%d)\n"</span>, <span class="cm-variable">__func__</span>, <span class="cm-variable">argc</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">op</span> <span class="cm-operator">=</span> <span class="cm-variable">FPGA_NONE</span>;<span class="cm-tab"> </span><span class="cm-comment">/* force usage display */</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-keyword">break</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span>}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 714px;"></div></div></div></pre></li></ul></li><li><p>Make</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cp</span> ./u-boot u-boot.elf</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p>Create Zynq Boot Image</p></li><li><p>Copy <code>./LAB2/Task-4/BOOT.bin</code> to SD card</p></li><li><p>Test it by type in fpga</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; fpga</span></pre></div><pre class=""><span style="padding-right: 0.1px;">hacked U-boot</span></pre><pre class=""><span style="padding-right: 0.1px;">switch is f</span></pre><pre class=""><span style="padding-right: 0.1px;">LED is 55</span></pre><pre class=""><span style="padding-right: 0.1px;">LED is aa</span></pre><pre class=""><span style="padding-right: 0.1px;">FPGA device not specified</span></pre><pre class=""><span style="padding-right: 0.1px;">fpga <span class="cm-attribute">-</span> loadable FPGA image support</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Usage:</span></pre><pre class=""><span style="padding-right: 0.1px;">fpga [operation type] [device number] [image address] [image size]</span></pre><pre class=""><span style="padding-right: 0.1px;">fpga operations:</span></pre><pre class=""><span style="padding-right: 0.1px;">  dump  [dev] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Load device to memory buffer</span></pre><pre class=""><span style="padding-right: 0.1px;">  info  [dev] &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list known device information</span></pre><pre class=""><span style="padding-right: 0.1px;">  load  [dev] [address] [size]  Load device from memory buffer</span></pre><pre class=""><span style="padding-right: 0.1px;">  loadb [dev] [address] [size]  Load device from bitstream buffer (Xilinx only)</span></pre><pre class=""><span style="padding-right: 0.1px;">  loadmk [dev] [address] &nbsp; &nbsp; &nbsp;  Load device generated with mkimage</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  For loadmk operating on FIT format uImage address must include</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  subimage unit name <span class="cm-keyword">in</span> the form of addr:&lt;subimg_uname&gt;</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre></li></ul></li></ul><h5><a name='header-c2010' class='md-header-anchor '></a>Lab2-3 Using device driver</h5><ul><li><p>Copy <code>/LAB2/Task-5/*</code> to SD card</p><ul><li>SD image with AXI_GPIO，4 LED，4 Switch</li></ul></li><li><p>LED device test</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">cd</span> sys/class/gpio</span></pre></div><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">export</span> &nbsp; &nbsp; &nbsp; gpiochip0 &nbsp;  gpiochip248  gpiochip252  unexport</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> <span class="cm-number">252</span> &gt; <span class="cm-keyword">export</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">export</span> &nbsp; &nbsp; &nbsp; gpio252 &nbsp; &nbsp;  gpiochip0 &nbsp;  gpiochip248  gpiochip252  unexport</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># LED-0为输出管脚</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> out &gt; gpio252/direction</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 点亮LED-0</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> <span class="cm-number">1</span> &gt; gpio252/value</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 灭掉LED-0</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> <span class="cm-number">0</span> &gt; gpio252/value</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 253~255对应于LED-1~LED-3</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 299px;"></div></div></div></pre></li><li><p>Switch test</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> <span class="cm-number">248</span> &gt; <span class="cm-keyword">export</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">echo</span> <span class="cm-keyword">in</span> &gt; gpio248/direction</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># SW-0上拨</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">cat</span>  ./gpio248/value</span></pre><pre class=""><span style="padding-right: 0.1px;">1</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># SW-0下拨</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-builtin">cat</span>  ./gpio248/value</span></pre><pre class=""><span style="padding-right: 0.1px;">0</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 249~251对应于SW-1~SW-3</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre></li><li><p>使用脚本实现跑马灯</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-keyword">for</span> io_num <span class="cm-keyword">in</span> <span class="cm-quote">$(seq 252 255)</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-builtin">echo</span> <span class="cm-def">$io_num</span> &gt; <span class="cm-keyword">export</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-builtin">echo</span> out &gt; gpio<span class="cm-def">$io_num</span>/direction</span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">done</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq&gt; <span class="cm-keyword">for</span> k <span class="cm-keyword">in</span> <span class="cm-quote">$(seq 1 1000)</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">for</span> io_num <span class="cm-keyword">in</span> <span class="cm-quote">$(seq 252 255)</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">do</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-builtin">echo</span> <span class="cm-number">1</span> &gt; gpio<span class="cm-def">$io_num</span>/value</span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-builtin">sleep</span> 10ms</span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-builtin">echo</span> <span class="cm-number">0</span> &gt; gpio<span class="cm-def">$io_num</span>/value</span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">done</span></span></pre><pre class=""><span style="padding-right: 0.1px;">&gt; <span class="cm-keyword">done</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre></li></ul><h5><a name='header-c2031' class='md-header-anchor '></a>Lab2-4 Make SD Card</h5><ul><li><p>Refer to <a href='https://github.com/Durant35/Courses/tree/master/ZYBO/BootingLinux'>Booting Linux on the ZYBO</a></p></li><li><p>新建分区与格式化</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ mkfs</span> <span class="cm-attribute">-t</span> vfat /dev/sdb1</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> dosfslabel /dev/sdb1 boot</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ mkfs</span>.ext4 /dev/sdb2</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ e2label</span> /dev/sdb2 fs</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li><li><p>Copy image to partitions</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ tar</span> <span class="cm-attribute">-zxf</span> ./LAB2/Task-6/zr_boot.8_11.tar.gz</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ rsync</span> <span class="cm-attribute">-a</span> zr_boot/* /media/gary/boot</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sync</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> tar <span class="cm-attribute">-zxf</span> ./LAB2/Task-6/zr_fs.8_11.tar.gz</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> rsync <span class="cm-attribute">-a</span> zr_fs/* /media/gary/fs</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sync</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre></li><li><p>可能需要设置U-boot环境参数，让 U-boot 完成 Kernel 初始化后去加载SD卡中第二个分区（<code>fs</code>）中的文件系统</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 虽然host将SD卡识别为/dev/sdb，但是在ZYBO仍使用/dev/mmcblk0</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; setenv bootargs <span class="cm-string">'console=ttyPS0,115200 root=/dev/mmcblk0p2 rw earlyprintk rootfstype=ext4 rootwait devtmpfs.mount=0'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; setenv sdboot <span class="cm-string">'echo Copying Linux from SD to RAM... &amp;&amp; mmcinfo &amp;&amp; fatload mmc 0 0x3000000 ${kernel_image} &amp;&amp; fatload mmc 0 0x2A00000 ${devicetree_image} &amp;&amp; bootm 0x3000000 - 0x2A00000'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; saveenv</span></pre><pre class=""><span style="padding-right: 0.1px;">Saving Environment to SPI Flash...</span></pre><pre class=""><span style="padding-right: 0.1px;">SF: Detected S25FL128S_64K with page size <span class="cm-number">256</span> Bytes, erase size <span class="cm-number">64</span> KiB, total <span class="cm-number">16</span> MiB</span></pre><pre class=""><span style="padding-right: 0.1px;">Erasing SPI flash...Writing to SPI flash...done</span></pre><pre class=""><span style="padding-right: 0.1px;">zynq-uboot&gt; boot</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre></li></ul><h5><a name='header-c2048' class='md-header-anchor '></a>Lab2-5 Hack CGI Scripts</h5><ul><li><p>Test Smart Car</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/<span class="cm-comment"># cd /root/boa-master/src</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/boa-master/src<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile &nbsp; &nbsp; &nbsp; cgi.c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  defines.h &nbsp;  log.c &nbsp; &nbsp; &nbsp; &nbsp; select.c</span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile.in &nbsp;  cgi.o &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  escape.c &nbsp; &nbsp; log.o &nbsp; &nbsp; &nbsp; &nbsp; select.o</span></pre><pre class=""><span style="padding-right: 0.1px;">acconfig.h &nbsp; &nbsp; cgi_header.c &nbsp; &nbsp; &nbsp; &nbsp; escape.h &nbsp; &nbsp; mmap_cache.c  signals.c</span></pre><pre class=""><span style="padding-right: 0.1px;">aclocal.m4 &nbsp; &nbsp; cgi_header.o &nbsp; &nbsp; &nbsp; &nbsp; escape.o &nbsp; &nbsp; mmap_cache.o  signals.o</span></pre><pre class=""><span style="padding-right: 0.1px;">alias.c &nbsp; &nbsp; &nbsp;  check_struct_for.m4  <span class="cm-builtin">get</span>.c &nbsp; &nbsp; &nbsp;  parse.h &nbsp; &nbsp; &nbsp; sublog.c</span></pre><pre class=""><span style="padding-right: 0.1px;">alias.o &nbsp; &nbsp; &nbsp;  compat.h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">get</span>.o &nbsp; &nbsp; &nbsp;  pipe.c &nbsp; &nbsp; &nbsp;  sublog.o</span></pre><pre class=""><span style="padding-right: 0.1px;">boa &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  config.c &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; globals.h &nbsp;  pipe.o &nbsp; &nbsp; &nbsp;  test.c</span></pre><pre class=""><span style="padding-right: 0.1px;">boa.c &nbsp; &nbsp; &nbsp; &nbsp;  config.cache &nbsp; &nbsp; &nbsp; &nbsp; hash.c &nbsp; &nbsp; &nbsp; queue.c &nbsp; &nbsp; &nbsp; timestamp.c</span></pre><pre class=""><span style="padding-right: 0.1px;">boa.h &nbsp; &nbsp; &nbsp; &nbsp;  config.h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hash.o &nbsp; &nbsp; &nbsp; queue.o &nbsp; &nbsp; &nbsp; timestamp.o</span></pre><pre class=""><span style="padding-right: 0.1px;">boa.o &nbsp; &nbsp; &nbsp; &nbsp;  config.h.in &nbsp; &nbsp; &nbsp; &nbsp;  index_dir.c  read.c &nbsp; &nbsp; &nbsp;  util.c</span></pre><pre class=""><span style="padding-right: 0.1px;">boa_grammar.y  config.log &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index_dir.o  read.o &nbsp; &nbsp; &nbsp;  util.o</span></pre><pre class=""><span style="padding-right: 0.1px;">boa_indexer &nbsp;  config.o &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ip.c &nbsp; &nbsp; &nbsp; &nbsp; request.c &nbsp; &nbsp; webindex.pl</span></pre><pre class=""><span style="padding-right: 0.1px;">boa_lexer.l &nbsp;  config.status &nbsp; &nbsp; &nbsp;  ip.o &nbsp; &nbsp; &nbsp; &nbsp; request.o &nbsp; &nbsp; y.tab.c</span></pre><pre class=""><span style="padding-right: 0.1px;">buffer.c &nbsp; &nbsp; &nbsp; configure &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  lex.yy.c &nbsp; &nbsp; response.c &nbsp;  y.tab.h</span></pre><pre class=""><span style="padding-right: 0.1px;">buffer.o &nbsp; &nbsp; &nbsp; configure.in &nbsp; &nbsp; &nbsp; &nbsp; lex.yy.o &nbsp; &nbsp; response.o &nbsp;  y.tab.o</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/boa-master/src<span class="cm-comment"># ./boa</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/boa-master/src<span class="cm-comment"># ifconfig</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre><ul><li><p>Default ip for ZYBO board is <code>192.168.1.99</code></p></li><li><p>用网线直连 <em>host</em> 和 <em>ZYBO board</em>，手动设置 <em>host</em> 的ip到同一个网段，比如<code>192.168.1.110</code></p></li><li><p>浏览网页</p><p><center><img src="./img/Lab2_5/ZRobot_webpage.png" width="640px"/></center></p></li><li><p><a href='https://github.com/xupsh/boa'>Boa Webserver</a></p></li></ul></li><li><p>Modify CGI Scripts</p><ul><li><p>源码位于<code>/var/www/cgi-bin/smart_car_CGI</code></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /var/www/cgi-bin/smart_car_CGI</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/var/www/cgi-bin/smart_car_CGI<span class="cm-comment"># vim smart_car_left.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;fcntl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;unistd.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;sys/time.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;sys/types.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include &lt;sys/stat.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#include "smart_car_move.h"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">static int fd;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">int main(void)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  smart_car_set(-90,60 );</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  return <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 414px;"></div></div></div></pre></li></ul></li></ul><h5><a name='header-c2077' class='md-header-anchor '></a>Lab2-6 Mmap Control Wheels</h5><blockquote><p>查看 <em>Lab2-5</em> 中远程控制小车的 <em>cgi</em> 程序（<strong>.cgi</strong>）对应的源码（<strong>.c</strong>），其实现就是通过内存映射（memory map）的方式，借助<strong>AXI</strong>，从 PS 端控制 PL 端的 PWM模块</p></blockquote><ul><li><p>Power On Smart Car</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># ls</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">bak &nbsp; &nbsp; &nbsp; &nbsp; boa-pzl &nbsp; &nbsp; mjpeg_face_leaf_detection  openhwcar</span></pre><pre class=""><span style="padding-right: 0.1px;">boa-master  go_wlan.sh  opencv-2.4.9 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pwm_app</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># mkdir pwm_xil_io</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd pwm_xil_io/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/pwm_xil_io<span class="cm-comment">#</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre></li><li><p>Add <em>xil_io.h</em></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">root@xup</span><span class="cm-operator">-</span><span class="cm-variable">VirtualBox</span>:<span class="cm-variable">~</span><span class="cm-operator">/</span><span class="cm-variable">pwm_xil_io#</span> <span class="cm-variable">vim</span> <span class="cm-variable">xil_io</span>.<span class="cm-variable">h</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdlib.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdint.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;string.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/types.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/stat.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/mman.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;unistd.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;fcntl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define PAGE_SIZE  ((size_t)getpagesize())</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define PAGE_MASK ((uint64_t) (long)~(PAGE_SIZE - 1))</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">Xil_Out32</span>(<span class="cm-variable-3">uint64_t</span> <span class="cm-variable">phyaddr</span>, <span class="cm-variable-3">uint32_t</span> <span class="cm-variable">val</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">volatile</span> <span class="cm-variable-3">uint8_t</span> <span class="cm-variable-3">*</span><span class="cm-variable">map_base</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">uint64_t</span> <span class="cm-variable">base</span> <span class="cm-operator">=</span> <span class="cm-variable">phyaddr</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">PAGE_MASK</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">uint64_t</span> <span class="cm-variable">pgoffset</span> <span class="cm-operator">=</span> <span class="cm-variable">phyaddr</span> <span class="cm-operator">&amp;</span> (<span class="cm-variable">~PAGE_MASK</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>((<span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/mem"</span>, <span class="cm-variable">O_RDWR</span> <span class="cm-operator">|</span> <span class="cm-variable">O_SYNC</span>)) <span class="cm-operator">==</span> <span class="cm-operator">-</span><span class="cm-number">1</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">perror</span>(<span class="cm-string">"open /dev/mem:"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">map_base</span> <span class="cm-operator">=</span> <span class="cm-variable">mmap</span>(<span class="cm-variable">NULL</span>, <span class="cm-variable">PAGE_SIZE</span>, <span class="cm-variable">PROT_READ</span> <span class="cm-operator">|</span> <span class="cm-variable">PROT_WRITE</span>, <span class="cm-variable">MAP_SHARED</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">fd</span>, <span class="cm-variable">base</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">map_base</span> <span class="cm-operator">==</span> <span class="cm-variable">MAP_FAILED</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">perror</span>(<span class="cm-string">"mmap:"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-operator">*</span>(<span class="cm-keyword">volatile</span> <span class="cm-variable-3">uint32_t</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">map_base</span> <span class="cm-operator">+</span> <span class="cm-variable">pgoffset</span>) <span class="cm-operator">=</span> <span class="cm-variable">val</span>; </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">munmap</span>((<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)<span class="cm-variable">map_base</span>, <span class="cm-variable">PAGE_SIZE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">Xil_In32</span>(<span class="cm-variable-3">uint64_t</span> <span class="cm-variable">phyaddr</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">uint32_t</span> <span class="cm-variable">val</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">volatile</span> <span class="cm-variable-3">uint8_t</span> <span class="cm-variable-3">*</span><span class="cm-variable">map_base</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">uint64_t</span> <span class="cm-variable">base</span> <span class="cm-operator">=</span> <span class="cm-variable">phyaddr</span> <span class="cm-operator">&amp;</span> <span class="cm-variable">PAGE_MASK</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">uint64_t</span> <span class="cm-variable">pgoffset</span> <span class="cm-operator">=</span> <span class="cm-variable">phyaddr</span> <span class="cm-operator">&amp;</span> (<span class="cm-variable">~PAGE_MASK</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">//open /dev/mem</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>((<span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/mem"</span>, <span class="cm-variable">O_RDWR</span> <span class="cm-operator">|</span> <span class="cm-variable">O_SYNC</span>)) <span class="cm-operator">==</span> <span class="cm-operator">-</span><span class="cm-number">1</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">perror</span>(<span class="cm-string">"open /dev/mem:"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">//mmap</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">map_base</span> <span class="cm-operator">=</span> <span class="cm-variable">mmap</span>(<span class="cm-variable">NULL</span>, <span class="cm-variable">PAGE_SIZE</span>, <span class="cm-variable">PROT_READ</span> <span class="cm-operator">|</span> <span class="cm-variable">PROT_WRITE</span>, <span class="cm-variable">MAP_SHARED</span>, <span class="cm-variable">fd</span>, <span class="cm-variable">base</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">map_base</span> <span class="cm-operator">==</span> <span class="cm-variable">MAP_FAILED</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">perror</span>(<span class="cm-string">"mmap:"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">val</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-keyword">volatile</span> <span class="cm-variable-3">uint32_t</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">map_base</span> <span class="cm-operator">+</span> <span class="cm-variable">pgoffset</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">munmap</span>((<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)<span class="cm-variable">map_base</span>, <span class="cm-variable">PAGE_SIZE</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-variable">val</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1321px;"></div></div></div></pre></li><li><p>Add <em>pwm_app.c</em></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">root@xup</span><span class="cm-operator">-</span><span class="cm-variable">VirtualBox</span>:<span class="cm-variable">~</span><span class="cm-operator">/</span><span class="cm-variable">pwm_xil_io#</span> <span class="cm-variable">vim</span> <span class="cm-variable">pwm_app</span>.<span class="cm-variable">c</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdlib.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;unistd.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/ioctl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/types.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/stat.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;fcntl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/select.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/time.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">pwm_fd</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">int</span> <span class="cm-variable">i</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-comment">// open device</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">pwm_fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/pwm_mod"</span>, <span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">pwm_fd</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">perror</span>(<span class="cm-string">"open device pwm_mod error!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">exit</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">while</span>(<span class="cm-number">1</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">5</span>,<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">5</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">4</span>,<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">4</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1081px;"></div></div></div></pre></li><li><p>Add Makefile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/pwm_xil_io<span class="cm-comment"># vim Makefile</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">CC</span><span class="cm-operator">=</span><span class="cm-builtin">gcc</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">CFLAGS</span><span class="cm-operator">=</span><span class="cm-attribute">-o3</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">all:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-quote">$(CC)</span> <span class="cm-quote">$(CFLAGS)</span> pwm_app.c <span class="cm-attribute">-o</span> test_pwm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">clean:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">rm</span> *.o test_pwm</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 209px;"></div></div></div></pre></li><li><p>Make and test</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/pwm_xil_io<span class="cm-comment"># make</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">gcc</span> <span class="cm-attribute">-o3</span> pwm_app.c <span class="cm-attribute">-o</span> test_pwm</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/pwm_xil_io<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile  pwm_app.c  test_pwm  xil_io.h</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/pwm_xil_io<span class="cm-comment"># ./test_pwm</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li></ul><h3><a name='header-c2102' class='md-header-anchor '></a>Day03</h3><h4><a name='header-c2103' class='md-header-anchor '></a>Device Driver Overview</h4><ul><li><p>Classes of devices and modules</p><ul><li><p>Character devices</p><ul><li>Can accesses as stream of bytes</li><li><code>/dev/console</code>, <code>/dev/ttyS0</code></li><li>Accessed by means of filesystem nodes <code>tty1</code>, <code>lp0</code></li></ul></li><li><p>Block devices</p><ul><li>Something that can host a filesystem (e.g. disk)</li><li>Can accesses ONLY as multiples of a block (e.g. 1K)</li><li>Different with char device is transparent to user under Linux（在Linux下对用户是透明的）.</li><li><code>/dev/mmcblk0p1</code></li></ul></li><li><p>Network interfaces (<code>eth0</code>, <code>eth1</code>)</p></li><li><p>USB, Firewire, SCSI …</p></li></ul></li><li><p>Coding Etiquette（编码礼仪）</p><ul><li>Written with concurrency in mind</li><li>Must be reentrant（可重入）</li><li>Provide adequate controls for device operation that affect global resources or other users</li><li>Only functions exported by kernel can call（只有内核导出的函数才能调用） – there is no libraries to link to.</li><li>Avoid introducing security bugs </li><li>Avoid namespace pollution（命名空间污染） – many functions and global variables whose names aren’t distinguished </li></ul></li><li><p>LKM(Loadable Kernel Module) Utilities（实用程序） cmd</p><ul><li>insmod 
Insert an LKM into the kernel.</li><li>rmmod 
Remove an LKM from the kernel.</li><li>depmod 
Determine interdependencies（相互依赖） between LKMs.</li><li>kerneld 
Kerneld daemon program（守护程序）</li><li>ksyms 
Display symbols that are exported by the kernel for use by new LKMs.</li><li>lsmod 
List currently loaded LKMs.</li><li>modinfo 
Display contents of .modinfo section in an LKM object file.</li><li>modprobe 
Insert or remove an LKM or set of LKMs <strong>intelligently</strong>. For example, if you must load A before loading B, Modprobe will automatically load A when you tell it to load B. </li></ul></li></ul><ul><li><p>Linux Module Hello World</p><ul><li><p>Prepare the kernel（内核版本必须与 <em>Lab2-4 Make SD Card</em> 中使用的 <strong>uImage</strong> 版本一致，从<a href='https://github.com/Digilent/linux-digilent/releases/tag/v3.6-digilent-13.01'>这里</a>获取对应的内核版本源码）</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> ./LAB3/Task-1</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ unzip</span> linux-digilent-3.6-digilent-13.01.zip <span class="cm-attribute">-d</span> .</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> linux-digilent-3.6-digilent-13.01/</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ source</span> /opt/Xilinx/SDK/2016.1/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># build the kernel</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> digilent_zed_defconfig</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> <span class="cm-def">UIMAGE_LOADADDR</span><span class="cm-operator">=</span>0x8000 uImage</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Name: &nbsp; Linux-3.18.0-xilinx</span></pre><pre class=""><span style="padding-right: 0.1px;">Created: &nbsp; &nbsp;  Sat Feb <span class="cm-number">11</span> <span class="cm-number">17</span>:16:11 2017</span></pre><pre class=""><span style="padding-right: 0.1px;">Image Type: &nbsp; ARM Linux Kernel Image (uncompressed)</span></pre><pre class=""><span style="padding-right: 0.1px;">Data Size: &nbsp;  <span class="cm-number">3447976</span> Bytes <span class="cm-operator">=</span> <span class="cm-number">3367</span>.16 kB <span class="cm-operator">=</span> <span class="cm-number">3</span>.29 MB</span></pre><pre class=""><span style="padding-right: 0.1px;">Load Address: 00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">Entry Point:  00008000</span></pre><pre class=""><span style="padding-right: 0.1px;">  Image arch/arm/boot/uImage is ready</span></pre><pre class=""><span style="padding-right: 0.1px;"> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># prepare the "hello world" module files</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> ..</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ mkdir</span> drivers</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">drivers  linux-digilent-3.6-digilent-13.01  linux-digilent-3.6-digilent-13.01.zip</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> drivers/</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ touch</span> hello.c Makefile</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre><ul><li><p>由于上述源码比较久远（Jan 8,2013），内核编译时会出现下面的问题</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">Can<span class="cm-string">'t use '</span>defined(@array)<span class="cm-string">' (Maybe you should just omit the defined()?) at kernel/timeconst.pl line 373.</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/kernel/Makefile:133: recipe <span class="cm-keyword">for</span> target <span class="cm-string">'kernel/timeconst.h'</span> failed</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: *** [kernel/timeconst.h] Error 255</span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile:775: recipe <span class="cm-keyword">for</span> target <span class="cm-string">'kernel'</span> failed</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>: *** [kernel] Error 2</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p>这是跟 <strong>perl</strong> 版本有关系，<code>&gt;=5.22</code> 的 <strong>perl</strong> 会报这个错误，因此需要对<code>linux-digilent-3.6-digilent-13.01/kernel/timeconst.pl</code>做如下的修改：</p><pre class="md-fences md-end-block" lang="perl"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># line:365</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">} <span class="cm-keyword">else</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">$hz</span> <span class="cm-operator">+=</span> <span class="cm-number">0</span>;<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment"># Force to number</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">$hz</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">die</span> <span class="cm-string">"Usage: $0 HZ\n"</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">#@val = @{$canned_values{$hz}};</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">#if (!defined(@val)) {</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">#<span class="cm-tab">   </span>@val = compute_values($hz);</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">#}</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">$cv</span> <span class="cm-operator">=</span> <span class="cm-variable">$canned_values</span>{<span class="cm-variable">$hz</span>};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">@val</span> <span class="cm-operator">=</span> <span class="cm-keyword">defined</span>(<span class="cm-variable">$cv</span>) <span class="cm-operator">?</span> <span class="cm-variable">@$cv</span> <span class="cm-operator">:</span> <span class="cm-meta">compute_values</span>(<span class="cm-variable">$hz</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-meta">output</span>(<span class="cm-variable">$hz</span>, <span class="cm-variable">@val</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 357px;"></div></div></div></pre></li></ul></li><li><p>hello.c</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/module.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/init.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">__init</span> <span class="cm-def">hello_init</span>(<span class="cm-variable-3">void</span>) { </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">printk</span>(<span class="cm-string">"Hello world!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">return</span> <span class="cm-number">0</span>; </span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">__exit</span> <span class="cm-def">hello_cleanup</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">printk</span>(<span class="cm-string">"Cleaning up module.\n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">hello_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">hello_cleanup</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre></li><li><p>Makefile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">obj-m <span class="cm-operator">=</span> hello.o </span></pre></div><pre class=""><span style="padding-right: 0.1px;">all:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment"># make -C /your_kernel_directory M=/your_current_dirctory modules</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">make</span> <span class="cm-attribute">-C</span> ../linux-digilent-3.6-digilent-13.01 <span class="cm-def">M</span><span class="cm-operator">=</span><span class="cm-quote">$(PWD)</span> modules</span></pre><pre class=""><span style="padding-right: 0.1px;">clean:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">make</span> <span class="cm-attribute">-C</span> ../linux-digilent-3.6-digilent-13.01  <span class="cm-def">M</span><span class="cm-operator">=</span><span class="cm-quote">$(PWD)</span> clean</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">rm</span> <span class="cm-attribute">-f</span> *.o *.ko *.mod.c *.order *.symvers *~</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 165px;"></div></div></div></pre></li><li><p>What happened in the Makefile ? </p><ul><li><p>Building by Makefile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> clean</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span> –d [|more]</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p>The real compile</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ls</span> –al</span></pre></div><pre class=""><span style="padding-right: 0.1px;">total 84</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxrwxr-x <span class="cm-number">3</span> gary gary  <span class="cm-number">4096</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 .</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxrwxr-x <span class="cm-number">4</span> gary gary  <span class="cm-number">4096</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:06 ..</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp; <span class="cm-number">261</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:07 hello.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary  <span class="cm-number">3282</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 hello.ko</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp; <span class="cm-number">431</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 .hello.ko.cmd</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp; <span class="cm-number">786</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 hello.mod.c</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary  <span class="cm-number">1940</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 hello.mod.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary <span class="cm-number">20185</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 .hello.mod.o.cmd</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary  <span class="cm-number">1960</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 hello.o</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary <span class="cm-number">20082</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 .hello.o.cmd</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp; <span class="cm-number">259</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:10 Makefile</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp;  <span class="cm-number">92</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 modules.order</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-rw-rw-r--</span> <span class="cm-number">1</span> gary gary &nbsp; &nbsp; <span class="cm-number">0</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 Module.symvers</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxrwxr-x <span class="cm-number">2</span> gary gary  <span class="cm-number">4096</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">12</span>:13 .tmp_versions</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cat</span> .hello.o.cmd | more</span></pre><pre class=""><span style="padding-right: 0.1px;">cmd_/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.o :<span class="cm-operator">=</span> arm-</span></pre><pre class=""><span style="padding-right: 0.1px;">xilinx-linux-gnueabi-gcc <span class="cm-attribute">-Wp</span>,-MD,/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/T</span></pre><pre class=""><span style="padding-right: 0.1px;">ask-1/drivers/.hello.o.d  <span class="cm-attribute">-nostdinc</span> <span class="cm-attribute">-isystem</span> /opt/Xilinx/SDK/2016.1/gnu/arm/lin/</span></pre><pre class=""><span style="padding-right: 0.1px;">bin/../lib/gcc/arm-xilinx-linux-gnueabi/4.9.2/include <span class="cm-attribute">-I</span>/home/gary/Workspace/git</span></pre><pre class=""><span style="padding-right: 0.1px;">_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/arch/arm/include </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-Iarch</span>/arm/include/generated <span class="cm-attribute">-Iinclude</span>  <span class="cm-attribute">-include</span> /home/gary/Workspace/git_ws/Cou</span></pre><pre class=""><span style="padding-right: 0.1px;">rses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/include/linux/kconfig.h </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-D__KERNEL__</span> <span class="cm-attribute">-mlittle-endian</span> <span class="cm-attribute">-Iarch</span>/arm/mach-zynq/include <span class="cm-attribute">-Wall</span> <span class="cm-attribute">-Wundef</span> <span class="cm-attribute">-Wstrict</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-attribute">-prototypes</span> <span class="cm-attribute">-Wno-trigraphs</span> <span class="cm-attribute">-fno-strict-aliasing</span> <span class="cm-attribute">-fno-common</span> <span class="cm-attribute">-Werror-implicit-fun</span></span></pre><pre class=""><span style="padding-right: 0.1px;">ction-declaration <span class="cm-attribute">-Wno-format-security</span> <span class="cm-attribute">-fno-delete-null-pointer-checks</span> <span class="cm-attribute">-Os</span> <span class="cm-attribute">-marm</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-attribute">-fno-dwarf2-cfi-asm</span> <span class="cm-attribute">-mabi</span><span class="cm-operator">=</span>aapcs-linux <span class="cm-attribute">-mno-thumb-interwork</span> <span class="cm-attribute">-funwind-tables</span> <span class="cm-attribute">-D__</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">LINUX_ARM_ARCH__</span><span class="cm-operator">=</span><span class="cm-number">7</span> <span class="cm-attribute">-march</span><span class="cm-operator">=</span>armv7-a <span class="cm-attribute">-msoft-float</span> <span class="cm-attribute">-Uarm</span> <span class="cm-attribute">-Wframe-larger-than</span><span class="cm-operator">=</span><span class="cm-number">1024</span> <span class="cm-attribute">-f</span></span></pre><pre class=""><span style="padding-right: 0.1px;">no-stack-protector <span class="cm-attribute">-Wno-unused-but-set-variable</span> <span class="cm-attribute">-fomit-frame-pointer</span> <span class="cm-attribute">-Wdeclarati</span></span></pre><pre class=""><span style="padding-right: 0.1px;">on-after-statement <span class="cm-attribute">-Wno-pointer-sign</span> <span class="cm-attribute">-fno-strict-overflow</span> <span class="cm-attribute">-fconserve-stack</span> <span class="cm-attribute">-DCC_</span></span></pre><pre class=""><span style="padding-right: 0.1px;">HAVE_ASM_GOTO  <span class="cm-attribute">-DMODULE</span>  <span class="cm-attribute">-D</span><span class="cm-string">"KBUILD_STR(s)=\#s"</span> <span class="cm-attribute">-D</span><span class="cm-string">"KBUILD_BASENAME=KBUILD_STR(hel</span></span></pre><pre class=""><span style="padding-right: 0.1px;">lo)<span class="cm-string">"  -D"</span><span class="cm-def">KBUILD_MODNAME</span><span class="cm-operator">=</span>KBUILD_STR(hello)<span class="cm-string">" -c -o /home/gary/Workspace/git_ws/Cou</span></span></pre><pre class=""><span style="padding-right: 0.1px;">rses/ZYBO/LAB3/Task-1/drivers/.tmp_hello.o /home/gary/Workspace/git_ws/Courses/Z</span></pre><pre class=""><span style="padding-right: 0.1px;">YBO/LAB3/Task-1/drivers/hello.c</span></pre><pre class=""><span style="padding-right: 0.1px;">...</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 828px;"></div></div></div></pre></li><li><p>The real link</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cat</span> .hello.ko.cmd </span></pre></div><pre class=""><span style="padding-right: 0.1px;">cmd_/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko :<span class="cm-operator">=</span> arm-xilinx-linux-gnueabi-ld <span class="cm-attribute">-EL</span> <span class="cm-attribute">-r</span>  <span class="cm-attribute">-T</span> /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01/scripts/module-common.lds <span class="cm-attribute">--build-id</span>  <span class="cm-attribute">-o</span> /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.o /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.mod.o</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre></li></ul></li><li><p>Test</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># check module kernel version is 3.6.0-digilent-13.01</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ modinfo</span> ./LAB3/Task-1/drivers/hello.ko</span></pre><pre class=""><span style="padding-right: 0.1px;">filename: &nbsp; &nbsp; &nbsp; /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/drivers/hello.ko</span></pre><pre class=""><span style="padding-right: 0.1px;">depends: &nbsp; &nbsp; &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;">vermagic: &nbsp; &nbsp; &nbsp; <span class="cm-number">3</span>.6.0-digilent-13.01 SMP preempt mod_unload modversions ARMv7</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 1. Copy ./LAB3/Task-1/drivers/hello.ko to your SD card</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> <span class="cm-builtin">rm</span> /media/gary/root/hello.ko</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ sudo</span> <span class="cm-builtin">cp</span> ./LAB3/Task-1/drivers/hello.ko /media/gary/root/</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 2. Boot your ZED board</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 3. Mount SD card to /mnt</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># mount /dev/mmcblk0p2 /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Card_Recog  etc &nbsp; &nbsp; &nbsp; lost<span class="cm-operator">+</span>found  proc &nbsp; &nbsp; &nbsp; &nbsp;  sbin &nbsp; &nbsp; test &nbsp; &nbsp;  var</span></pre><pre class=""><span style="padding-right: 0.1px;">bin &nbsp; &nbsp; &nbsp; &nbsp; hello.ko  media &nbsp; &nbsp; &nbsp; pwmdriver.ko  selinux  test.jpg</span></pre><pre class=""><span style="padding-right: 0.1px;">boot &nbsp; &nbsp; &nbsp;  home &nbsp; &nbsp;  mnt &nbsp; &nbsp; &nbsp; &nbsp; root &nbsp; &nbsp; &nbsp; &nbsp;  srv &nbsp; &nbsp;  tmp</span></pre><pre class=""><span style="padding-right: 0.1px;">dev &nbsp; &nbsp; &nbsp; &nbsp; lib &nbsp; &nbsp; &nbsp; opt &nbsp; &nbsp; &nbsp; &nbsp; run &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sys &nbsp; &nbsp;  usr</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 4. Insert hello module and check some status information</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># insmod ./hello.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre><pre class=""><span style="padding-right: 0.1px;">hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">689</span>  0</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># cat /proc/modules</span></span></pre><pre class=""><span style="padding-right: 0.1px;">hello <span class="cm-number">689</span> <span class="cm-number">0</span> <span class="cm-attribute">-</span> Live 0xbf000000 (PO)</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># dmesg</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] hello: module license <span class="cm-string">'unspecified'</span> taints kernel.</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] Disabling lock debugging due to kernel taint</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] Hello world!</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 5. Remove hello module</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># rmmod ./hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># dmesg</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] hello: module license <span class="cm-string">'unspecified'</span> taints kernel.</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] Disabling lock debugging due to kernel taint</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">130</span>.320000] Hello world!</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">306</span>.810000] Cleaning up module.</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 920px;"></div></div></div></pre></li><li><p>编译模块的内核版本必须与系统内核版本一致，否则会出现以下错误：</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># insmod ./hello.ko</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">insmod: error inserting <span class="cm-string">'./hello.ko'</span>: <span class="cm-attribute">-1</span> Invalid module format</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># dmesg | grep hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp; <span class="cm-number">95</span>.770000] hello: disagrees about version of symbol module_layout</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p>查看 <em>hello world</em> 模块内核版本信息为<code>3.3.0-digilent-12.07-zed-beta</code></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># modinfo ./hello.ko</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">depends: &nbsp; &nbsp; &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;">vermagic: &nbsp; &nbsp; &nbsp; <span class="cm-number">3</span>.3.0-digilent-12.07-zed-beta SMP preempt mod_unload modversions ARMv7</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p>而 <strong>ZYBO</strong> 上的系统内核却是<code>3.6.0-digilent-13.01</code></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># uname -a</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">Linux xup-VirtualBox <span class="cm-number">3</span>.6.0-digilent-13.01-g06b3889 <span class="cm-comment">#45 SMP PREEMPT Wed Aug 6 12:39:14 CST 2014 armv7l armv7l armv7l GNU/Linux</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li><li><p>Linking a module to the kernel</p><p>从上面的<code>hello world</code>模块的例子，我们可以总结出以下的模块运行流程</p><p><center><img src="./img/Lab3_1/module_linked2kernel.png" width="540px"/></center></p></li></ul></li><li><p>Character Device Driver（字符设备驱动）</p><ul><li><p>Major and Minor Numbers</p><ul><li><p>Special files under <code>/dev</code> “c” for char &amp; “b” for block</p></li><li><p>Major number identifies driver use at open time</p><ul><li><p>Adding a new driver at module initialization</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/fs.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">register_chrdev</span>(</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span> <span class="cm-variable">major</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">name</span>, <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-operator">*</span><span class="cm-variable">fops</span>); </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li><li><p>If <strong>major</strong> is 0, the <code>register_chrdev</code> return a free number</p></li></ul></li><li><p>Minor number is used only by driver to control several devices</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ ls</span> <span class="cm-attribute">-l</span> /dev/</span></pre></div><pre class=""><span style="padding-right: 0.1px;">total 0</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">#<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span>Major number,Minor number<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span></span></span></pre><pre class=""><span style="padding-right: 0.1px;">crw-------  <span class="cm-number">1</span> root root &nbsp; &nbsp; <span class="cm-number">10</span>, <span class="cm-number">235</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 autofs</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxr-xr-x  <span class="cm-number">2</span> root root &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">600</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">16</span>:18 block</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxr-xr-x  <span class="cm-number">2</span> root root &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">60</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">16</span>:18 bsg</span></pre><pre class=""><span style="padding-right: 0.1px;">crw-------  <span class="cm-number">1</span> root root &nbsp; &nbsp; <span class="cm-number">10</span>, <span class="cm-number">234</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 btrfs-control</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxr-xr-x  <span class="cm-number">3</span> root root &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">60</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 bus</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxr-xr-x  <span class="cm-number">2</span> root root &nbsp; &nbsp; &nbsp;  <span class="cm-number">4180</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">16</span>:18 char</span></pre><pre class=""><span style="padding-right: 0.1px;">crw-------  <span class="cm-number">1</span> root root &nbsp; &nbsp;  <span class="cm-number">5</span>, &nbsp; <span class="cm-number">1</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:08 console</span></pre><pre class=""><span style="padding-right: 0.1px;">brw-rw----  <span class="cm-number">1</span> root disk &nbsp; &nbsp;  <span class="cm-number">8</span>, &nbsp; <span class="cm-number">0</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 sda</span></pre><pre class=""><span style="padding-right: 0.1px;">brw-rw----  <span class="cm-number">1</span> root disk &nbsp; &nbsp;  <span class="cm-number">8</span>, &nbsp; <span class="cm-number">1</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:08 sda1</span></pre><pre class=""><span style="padding-right: 0.1px;">brw-rw----  <span class="cm-number">1</span> root disk &nbsp; &nbsp;  <span class="cm-number">8</span>, &nbsp; <span class="cm-number">2</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 sda2</span></pre><pre class=""><span style="padding-right: 0.1px;">brw-rw----  <span class="cm-number">1</span> root disk &nbsp; &nbsp;  <span class="cm-number">8</span>, &nbsp; <span class="cm-number">3</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 sda3</span></pre><pre class=""><span style="padding-right: 0.1px;">crw-rw----  <span class="cm-number">1</span> root disk &nbsp; &nbsp; <span class="cm-number">21</span>, &nbsp; <span class="cm-number">0</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 sg0</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxrwxrwt  <span class="cm-number">2</span> root root &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">260</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">17</span>:10 shm</span></pre><pre class=""><span style="padding-right: 0.1px;">crw-------  <span class="cm-number">1</span> root root &nbsp; &nbsp; <span class="cm-number">10</span>, <span class="cm-number">231</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 snapshot</span></pre><pre class=""><span style="padding-right: 0.1px;">drwxr-xr-x  <span class="cm-number">3</span> root root &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">260</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:08 snd</span></pre><pre class=""><span style="padding-right: 0.1px;">lrwxrwxrwx  <span class="cm-number">1</span> root root &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">15</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 stderr <span class="cm-attribute">-</span>&gt; /proc/self/fd/2</span></pre><pre class=""><span style="padding-right: 0.1px;">lrwxrwxrwx  <span class="cm-number">1</span> root root &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">15</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 stdin <span class="cm-attribute">-</span>&gt; /proc/self/fd/0</span></pre><pre class=""><span style="padding-right: 0.1px;">lrwxrwxrwx  <span class="cm-number">1</span> root root &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">15</span> <span class="cm-number">2</span>月  <span class="cm-number">14</span> <span class="cm-number">10</span>:07 stdout <span class="cm-attribute">-</span>&gt; /proc/self/fd/1</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 484px;"></div></div></div></pre><p><code>sda1</code>，<code>sda2</code>，<code>sda3</code>都由<code>driver 8</code> 管理</p></li><li><p>通过 <code>mknod</code> 创建设备节点</p><ul><li><p>在<code>/dev</code>目录下创建相应的设备只是为应用程序去使用它提供了途径，它们之间可以通过设备号联系在一起。</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># mount /dev/mmcblk0p2 /mnt/</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Card_Recog  dev &nbsp; &nbsp; &nbsp; home &nbsp; &nbsp; &nbsp;  media  proc  sbin &nbsp; &nbsp; sys &nbsp; &nbsp; &nbsp; tmp</span></pre><pre class=""><span style="padding-right: 0.1px;">bin &nbsp; &nbsp; &nbsp; &nbsp; etc &nbsp; &nbsp; &nbsp; lib &nbsp; &nbsp; &nbsp; &nbsp; mnt &nbsp;  root  selinux  test &nbsp; &nbsp;  usr</span></pre><pre class=""><span style="padding-right: 0.1px;">boot &nbsp; &nbsp; &nbsp;  hello.ko  lost<span class="cm-operator">+</span>found  opt &nbsp;  run &nbsp; srv &nbsp; &nbsp;  test.jpg  var</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># insmod ./hello.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># ls -l /dev/ | grep hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># mknod /dev/hello c 38 0</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># ls -l /dev/ | grep hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">crw-r--r-- <span class="cm-number">1</span> root root  <span class="cm-number">38</span>, &nbsp; <span class="cm-number">0</span> Jan  <span class="cm-number">1</span> <span class="cm-number">00</span>:18 hello</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment">#</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 276px;"></div></div></div></pre></li></ul></li></ul></li><li><p>Device in ZYBO board</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># ls -al /dev/</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ul></li><li><p>From module to driver（将模块按照驱动定义的接口进行实现）</p><ul><li><p>Implementation（实现流程）</p><ul><li>Assuming that your device name is Xxx</li><li>Xxx_init()， initialize the device when OS is booted</li><li>Xxx_open()，open a device </li><li>Xxx_read()，read from kernel memory </li><li>Xxx_write()，write </li><li>Xxx_release() ，clean-up (close)</li><li>init_module()</li><li>cleanup_module()</li></ul><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">hello_fops</span> <span class="cm-operator">=</span> {</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">owner</span>:<span class="cm-tab">    </span><span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">read</span>:<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-variable">hello_read</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">write</span>:<span class="cm-tab">    </span><span class="cm-variable">hello_write</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">open</span>:<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-variable">hello_open</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">release</span>:<span class="cm-tab">  </span><span class="cm-variable">hello_release</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">storage</span>;<span class="cm-comment">//just for demo</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-def">hello_init</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">if</span> (<span class="cm-variable">register_chrdev</span>(<span class="cm-number">38</span>, <span class="cm-string">"hello"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">hello_fops</span>)) </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-variable">EBUSY</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">storage</span><span class="cm-operator">=</span><span class="cm-number">0</span>; &nbsp;  <span class="cm-comment">//just for demo</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-keyword">return</span>  <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">hello_exit</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-number">38</span>, <span class="cm-string">"hello"</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">} </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">hello_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">hello_exit</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 488px;"></div></div></div></pre></li><li><p>Read and Write</p><p><center><img src="./img/Lab3_1/module_read&write.png" width="640px"/></center></p><ul><li><p>Copying data from and to application code（API 接口）</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">ssize_t</span> <span class="cm-def">read</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span> <span class="cm-operator">*</span><span class="cm-variable">filp</span>, <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buff</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span> <span class="cm-operator">*</span><span class="cm-variable">offp</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">ssize_t</span> <span class="cm-def">write</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span> <span class="cm-operator">*</span><span class="cm-variable">filp</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span><span class="cm-variable">buff</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span> <span class="cm-operator">*</span><span class="cm-variable">offp</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p>In your module</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/uaccess.h&gt;<span class="cm-tab">    </span></span><span class="cm-comment">// for copy_to_user and copy_from_user</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_read</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">copy_to_user</span>(<span class="cm-variable">buf</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">storage</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">storage</span>));<span class="cm-tab">   </span><span class="cm-tab">    </span> &nbsp; </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_write</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>,<span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>,<span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>,<span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">copy_from_user</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">storage</span>, <span class="cm-variable">buf</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">storage</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 232px;"></div></div></div></pre></li></ul></li><li><p>User land <code>test.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">//test.c</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">test</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/hello"</span>, <span class="cm-variable">O_RDWR</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">read</span>(<span class="cm-variable">fd</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">test</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">test</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">printf</span>(<span class="cm-string">"%d test\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">test</span><span class="cm-operator">++</span>; </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">write</span>(<span class="cm-variable">fd</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">test</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">test</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre></li><li><p>Compile and test（详见 <code>Lab3-1 Character Device Driver</code>）</p></li></ul></li></ul><ul><li><p>Some kernel functions can be used</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// arch/arm/include/asm/io.h</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// /linux/kernel.h</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">add_timer</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Causes</span> <span class="cm-variable">a</span> <span class="cm-variable">function</span> <span class="cm-variable">to</span> <span class="cm-variable">be</span> <span class="cm-variable">executed</span> <span class="cm-variable">when</span> <span class="cm-variable">a</span> <span class="cm-variable">given</span> <span class="cm-variable">amount</span> <span class="cm-variable">of</span> <span class="cm-variable">time</span> <span class="cm-variable">has</span> <span class="cm-variable">passed</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">cli</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Prevents</span> <span class="cm-variable">interrupts</span> <span class="cm-variable">from</span> <span class="cm-variable">being</span> <span class="cm-variable">acknowledged</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">end_request</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Called</span> <span class="cm-variable">when</span> <span class="cm-variable">a</span> <span class="cm-variable">request</span> <span class="cm-variable">has</span> <span class="cm-variable">been</span> <span class="cm-variable">satisfied</span> <span class="cm-variable">or</span> <span class="cm-variable">aborted</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">free_irq</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Frees</span> <span class="cm-variable">an</span> <span class="cm-variable">IRQ</span> <span class="cm-variable">previously</span> <span class="cm-variable">acquired</span> <span class="cm-variable">with</span> <span class="cm-def">request_irq</span>() <span class="cm-variable">or</span> <span class="cm-def">irqaction</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">get_user</span><span class="cm-operator">*</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Allows</span> <span class="cm-variable">a</span> <span class="cm-variable">driver</span> <span class="cm-variable">to</span> <span class="cm-variable">access</span> <span class="cm-variable">data</span> <span class="cm-variable">in</span> <span class="cm-variable">user</span> <span class="cm-variable">space</span>, <span class="cm-variable">a</span> <span class="cm-variable">memory</span> <span class="cm-variable">area</span> <span class="cm-variable">distinct</span> <span class="cm-variable">from</span> <span class="cm-variable">the</span> <span class="cm-variable">kernel</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">inb</span>(), <span class="cm-variable">inb_p</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Reads</span> <span class="cm-variable">a</span> <span class="cm-variable">byte</span> <span class="cm-variable">from</span> <span class="cm-variable">a</span> <span class="cm-variable">port</span>. <span class="cm-variable">Here</span>, <span class="cm-variable">inb</span>() <span class="cm-variable">goes</span> <span class="cm-variable">as</span> <span class="cm-variable">fast</span> <span class="cm-variable">as</span> <span class="cm-variable">it</span> <span class="cm-variable">can</span>, <span class="cm-keyword">while</span> <span class="cm-variable">inb_p</span>() <span class="cm-variable">pauses</span> <span class="cm-variable">before</span> <span class="cm-variable">returning</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">irqaction</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Registers</span> <span class="cm-variable">an</span> <span class="cm-variable">interrupt</span> <span class="cm-variable">like</span> <span class="cm-variable">a</span> <span class="cm-variable">signal</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">IS_</span><span class="cm-operator">*</span>(<span class="cm-variable">inode</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Tests</span> <span class="cm-keyword">if</span> <span class="cm-variable">inode</span> <span class="cm-variable">is</span> <span class="cm-variable">on</span> <span class="cm-variable">a</span> <span class="cm-variable">file</span> <span class="cm-variable">system</span> <span class="cm-variable">mounted</span> <span class="cm-variable">with</span> <span class="cm-variable">the</span> <span class="cm-variable">corresponding</span> <span class="cm-variable">flag</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">kfree</span><span class="cm-operator">*</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Frees</span> <span class="cm-variable">memory</span> <span class="cm-variable">previously</span> <span class="cm-variable">allocated</span> <span class="cm-variable">with</span> <span class="cm-def">kmalloc</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">kmalloc</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Allocates</span> <span class="cm-variable">a</span> <span class="cm-variable">chu</span> <span class="cm-variable">nk</span> <span class="cm-variable">of</span> <span class="cm-variable">memory</span> <span class="cm-variable">no</span> <span class="cm-variable">larger</span> <span class="cm-variable">than</span> <span class="cm-number">4096</span> <span class="cm-variable">bytes</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MAJOR</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Reports</span> <span class="cm-variable">the</span> <span class="cm-variable">major</span> <span class="cm-variable">device</span> <span class="cm-variable">number</span> <span class="cm-keyword">for</span> <span class="cm-variable">a</span> <span class="cm-variable">device</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MINOR</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Reports</span> <span class="cm-variable">the</span> <span class="cm-variable">minor</span> <span class="cm-variable">device</span> <span class="cm-variable">number</span> <span class="cm-keyword">for</span> <span class="cm-variable">a</span> <span class="cm-variable">device</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">memcpy_</span><span class="cm-operator">*</span><span class="cm-def">fs</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Copies</span> <span class="cm-variable">chunks</span> <span class="cm-variable">of</span> <span class="cm-variable">memory</span> <span class="cm-variable">between</span> <span class="cm-variable">user</span> <span class="cm-variable">space</span> <span class="cm-variable">and</span> <span class="cm-variable">kernel</span> <span class="cm-variable">space</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">outb</span>(), <span class="cm-variable">outb_p</span>() , <span class="cm-variable">outl</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Writes</span> <span class="cm-variable">a</span> <span class="cm-variable">byte</span> <span class="cm-variable">to</span> <span class="cm-variable">a</span> <span class="cm-variable">port</span>. <span class="cm-variable">Here</span>, <span class="cm-variable">outb</span>() <span class="cm-variable">goes</span> <span class="cm-variable">as</span> <span class="cm-variable">fast</span> <span class="cm-variable">as</span> <span class="cm-variable">it</span> <span class="cm-variable">can</span>, <span class="cm-keyword">while</span> <span class="cm-variable">outb_p</span>() <span class="cm-variable">pauses</span> <span class="cm-variable">before</span> <span class="cm-variable">returning</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">printk</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">A</span> <span class="cm-variable">version</span> <span class="cm-variable">of</span> <span class="cm-def">printf</span>() <span class="cm-keyword">for</span> <span class="cm-variable">the</span> <span class="cm-variable">kernel</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">put_user</span><span class="cm-operator">*</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Allows</span> <span class="cm-variable">a</span> <span class="cm-variable">driver</span> <span class="cm-variable">to</span> <span class="cm-variable">write</span> <span class="cm-variable">data</span> <span class="cm-variable">in</span> <span class="cm-variable">user</span> <span class="cm-variable">space</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">register_</span><span class="cm-operator">*</span><span class="cm-def">dev</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Registers</span> <span class="cm-variable">a</span> <span class="cm-variable">device</span> <span class="cm-variable">with</span> <span class="cm-variable">the</span> <span class="cm-variable">kernel</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">request_irq</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Requests</span> <span class="cm-variable">an</span> <span class="cm-variable">IRQ</span> <span class="cm-variable">from</span> <span class="cm-variable">the</span> <span class="cm-variable">kernel</span>, <span class="cm-variable">and</span>, <span class="cm-keyword">if</span> <span class="cm-variable">successful</span>, <span class="cm-variable">installs</span> <span class="cm-variable">an</span> <span class="cm-variable">IRQ</span> <span class="cm-variable">interrupt</span> <span class="cm-variable">handler</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">select_wait</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Adds</span> <span class="cm-variable">a</span> <span class="cm-variable">process</span> <span class="cm-variable">to</span> <span class="cm-variable">the</span> <span class="cm-variable">proper</span> <span class="cm-variable">select_wait</span> <span class="cm-variable">queue</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">*</span><span class="cm-def">sleep_on</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Sleeps</span> <span class="cm-variable">on</span> <span class="cm-variable">an</span> <span class="cm-variable">event</span>, <span class="cm-variable">puts</span> <span class="cm-variable">a</span> <span class="cm-variable">wait_queue</span> <span class="cm-variable">entry</span> <span class="cm-variable">in</span> <span class="cm-variable">the</span> <span class="cm-variable">list</span> <span class="cm-variable">so</span> <span class="cm-variable">that</span> <span class="cm-variable">the</span> <span class="cm-variable">process</span> <span class="cm-variable">can</span> <span class="cm-variable">be</span> <span class="cm-variable">awakened</span> <span class="cm-variable">on</span> <span class="cm-variable">that</span> <span class="cm-variable">event</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">sti</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Allows</span> <span class="cm-variable">interrupts</span> <span class="cm-variable">to</span> <span class="cm-variable">be</span> <span class="cm-variable">acknowledged</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">sys_get</span><span class="cm-operator">*</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">System</span> <span class="cm-variable">calls</span> <span class="cm-variable">used</span> <span class="cm-variable">to</span> <span class="cm-variable">get</span> <span class="cm-variable">information</span> <span class="cm-variable">regarding</span> <span class="cm-variable">the</span> <span class="cm-variable">process</span>, <span class="cm-variable">user</span>, <span class="cm-variable">or</span> <span class="cm-variable">group</span>. </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">wake_up</span><span class="cm-operator">*</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">Wakes</span> <span class="cm-variable">up</span> <span class="cm-variable">a</span> <span class="cm-variable">process</span> <span class="cm-variable">that</span> <span class="cm-variable">has</span> <span class="cm-variable">been</span> <span class="cm-variable">put</span> <span class="cm-variable">to</span> <span class="cm-variable">sleep</span> <span class="cm-variable">by</span> <span class="cm-variable">the</span> <span class="cm-variable">matching</span> <span class="cm-operator">*</span><span class="cm-def">sleep_on</span>() <span class="cm-variable">function</span>. </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1196px;"></div></div></div></pre></li><li><p>Debugging Techniques</p><ul><li>printk</li><li>Using the /proc Filesystem</li><li>ioctl</li><li>Using gdb</li><li>The kdb Kernel Debugger</li></ul></li><li><p>其他考虑的地方</p><ul><li><p>Concurrency and race condition </p><ul><li>Semaphores and Mutexes</li></ul></li><li><p>Communicating  with hardware</p><ul><li>Using I/O Ports</li><li>Manipulating（操作） I/O ports</li></ul></li></ul></li></ul><h4><a name='header-c2403' class='md-header-anchor '></a>Sysfs Virtual File System</h4><ul><li><p>Unified Device Model（统一设备模型）</p><ul><li><p>Kernels previous to 2.5 had no single data structure to store information on how system is put together</p></li><li><p>Demands of newer systems with more complicated topologies and power management motivated construction of the Linux Unified Device Model</p></li><li><p>Device Model Functionality</p><ul><li><p>Power management and system shutdown</p><ul><li>Knowing the ordering of when to shut down components.</li><li>E.g., shut down USB mouse before USB controller</li></ul></li><li><p>Communication with user space</p><ul><li>Sysfs virtual file system tightly tied into device model and exposes structure and device tuning（设备调谐）</li></ul></li><li><p>Hotpluggable devices（设备热插拔）</p><ul><li>Used to handle and communicate the plugging and unplugging of devices</li></ul></li><li><p>Device classes</p><ul><li>Allows system to discover types of devices that are related</li></ul></li><li><p>Other</p><ul><li>Common facilities such as reference counting</li><li>Capability to enumerate all devices and status</li></ul></li></ul></li></ul></li><li><p>sysfs overview</p><ul><li><p>In-memory virtual file system</p></li><li><p>Provides view of the <strong>kobject</strong> hierarchy</p></li><li><p>Enables users to view device topology of system</p></li><li><p><strong>kobjects</strong> can export files that enable kernel variables to be read and written</p><ul><li>Sound a lot like /proc?</li></ul></li></ul></li><li><p>sysfs Directories</p><ul><li><p>类型</p><ul><li><p>block</p><ul><li>Contains one directory for each of the registered block devices on the system</li><li>Contains subdirectories for partitions on the device</li></ul></li><li><p>bus</p></li><li><p>class</p><ul><li>Organized by high-level function</li></ul></li><li><p>dev</p><ul><li>Registered device nodes</li></ul></li><li><p>devices</p><ul><li>Gives view of topology of devices in system</li></ul></li><li><p>firmware</p><ul><li>System-specific tree of low-level subsystems</li><li>ACPI, EDD, EFI</li></ul></li><li><p>fs</p></li><li><p>kernel</p><ul><li>Kernel configuration options and status info</li></ul></li><li><p>modules</p></li><li><p>power</p></li></ul></li><li><p>devices is most important directory – exports device model</p></li><li><p>Much of the data in other directories is alternative organization of data in devices </p></li><li><p>Neat to see interconnections（看出整齐的互联关系）</p><ul><li>High-level concepts in class</li><li>Low-level physical devices in devices </li><li>Actual drivers in bus</li></ul></li></ul></li><li><p>PWM Sysfs Example</p><ul><li><p>PWM driver overview</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">pwm_driver_module_init</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">pwm_driver_module_exit</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">pwm_driver_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">owner</span> <span class="cm-operator">=</span> <span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-comment">/* no read  write here  */</span></span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 163px;"></div></div></div></pre></li><li><p>pwm_driver_module_init</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">pwm_driver_major</span> <span class="cm-operator">=</span> <span class="cm-variable">register_chrdev</span>(<span class="cm-number">0</span>, <span class="cm-variable">DEVICE_NAME</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">pwm_driver_fops</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">pwm_driver_class</span> <span class="cm-operator">=</span> <span class="cm-variable">class_create</span>(<span class="cm-variable">THIS_MODULE</span>, <span class="cm-string">"pwm_driver"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">pwm_driver_device</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create</span>(<span class="cm-variable">pwm_driver_class</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">MKDEV</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-number">0</span>), <span class="cm-variable">NULL</span>, <span class="cm-string">"pwm_device"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>,<span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_frequency</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_duty</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">pwm_fre_addr</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span>)<span class="cm-variable">ioremap</span>(<span class="cm-variable">PWM_MOUDLE_PHY_ADDR</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">u32</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">pwm_duty_addr</span> <span class="cm-operator">=</span> <span class="cm-variable">pwm_fre_addr</span><span class="cm-operator">+</span><span class="cm-number">4</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p>其中，</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>,<span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_frequency</span>);</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_duty</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_frequency</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>,<span class="cm-variable">sys_pwm_frequency_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_duty</span>,<span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_duty_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_duty_set</span>(<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">// Covert ASCII to binary and frequency</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">count</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">value</span> <span class="cm-operator">*=</span> <span class="cm-number">10</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">value</span> <span class="cm-operator">+=</span> <span class="cm-variable">buf</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-string">'0'</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">value</span> <span class="cm-operator">&gt;</span> <span class="cm-number">100</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab">    </span><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">100000000</span><span class="cm-operator">/</span><span class="cm-variable">frequency</span><span class="cm-operator">*</span><span class="cm-variable">value</span><span class="cm-operator">/</span><span class="cm-number">100</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">pwm_duty_addr</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 466px;"></div></div></div></pre></li></ul></li></ul><h4><a name='header-c2582' class='md-header-anchor '></a>LAB3</h4><h5><a name='header-c2583' class='md-header-anchor '></a>Lab3-1 Character Device Driver</h5><ul><li><p><code>./LAB3/Task-2/hello.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/module.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/init.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/fs.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">//#include &lt;asm/uaccess.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">driver_major</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_read</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"read hello \n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">hello_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">owner</span>:<span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">read</span>:<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-variable">hello_read</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">//write:<span class="cm-tab">    </span><span class="cm-tab">    </span>hello_write,</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">//open:<span class="cm-tab"> </span><span class="cm-tab">    </span>hello_open,</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment">//release:<span class="cm-tab">  </span>hello_release,</span></span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">__init</span> <span class="cm-def">hello_init</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">driver_major</span> <span class="cm-operator">=</span> <span class="cm-variable">register_chrdev</span>(<span class="cm-number">0</span>, <span class="cm-string">"hello"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">hello_fops</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">driver_major</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to register device.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"init hello module v2 major is %d\n"</span>, <span class="cm-variable">driver_major</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">__exit</span> <span class="cm-def">hello_cleanup</span>(<span class="cm-variable-3">void</span>) { </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">driver_major</span>, <span class="cm-string">"hello"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"Cleaning up module %d\n"</span>, <span class="cm-variable">driver_major</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">hello_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">hello_cleanup</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 881px;"></div></div></div></pre></li><li><p><code>./LAB3/Task-2/Makefile</code></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">obj-m <span class="cm-operator">=</span> hello.o </span></pre></div><pre class=""><span style="padding-right: 0.1px;">all:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-comment"># make -C /your_kernel_directory M=/your_current_dirctory modules</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">make</span> <span class="cm-attribute">-C</span> ../Task-1/linux-digilent-3.6-digilent-13.01 <span class="cm-def">M</span><span class="cm-operator">=</span><span class="cm-quote">$(PWD)</span> modules</span></pre><pre class=""><span style="padding-right: 0.1px;">clean:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">make</span> <span class="cm-attribute">-C</span> ../Task-1/linux-digilent-3.6-digilent-13.01 <span class="cm-def">M</span><span class="cm-operator">=</span><span class="cm-quote">$(PWD)</span> clean</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-builtin">rm</span> <span class="cm-attribute">-f</span> *.o *.ko *.mod.c *.order *.symvers *~</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 165px;"></div></div></div></pre></li><li><p><code>./LAB3/Task-2/test.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;fcntl.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdlib.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>() {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">test</span><span class="cm-operator">=</span><span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable-3">int</span> <span class="cm-variable">fd</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/hello"</span>, <span class="cm-variable">O_RDWR</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span>(<span class="cm-variable">fd</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"open /dev/hello fail\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">exit</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">read</span>(<span class="cm-variable">fd</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">test</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">test</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printf</span>(<span class="cm-string">"%d test\n"</span>,<span class="cm-variable">test</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">test</span><span class="cm-operator">++</span>; </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">write</span>(<span class="cm-variable">fd</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">test</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">test</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">close</span>(<span class="cm-variable">fd</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 588px;"></div></div></div></pre></li><li><p>Cross-compile module on Host</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> ./LAB3/Task-2</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ source</span> /opt/Xilinx/SDK/2016.1/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># make -C /your_kernel_directory M=/your_current_dirctory modules</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span> <span class="cm-attribute">-C</span> ../Task-1/linux-digilent-3.6-digilent-13.01 <span class="cm-def">M</span><span class="cm-operator">=</span>/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2 modules</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: Entering directory <span class="cm-string">'/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01'</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  CC [M]  /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2/hello.o</span></pre><pre class=""><span style="padding-right: 0.1px;">  Building modules, stage <span class="cm-number">2</span>.</span></pre><pre class=""><span style="padding-right: 0.1px;">  MODPOST <span class="cm-number">1</span> modules</span></pre><pre class=""><span style="padding-right: 0.1px;">  LD [M]  /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-2/hello.ko</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">make</span>[1]: Leaving directory <span class="cm-string">'/home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-1/linux-digilent-3.6-digilent-13.01'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 391px;"></div></div></div></pre></li><li><p>Compile and Test on ZYBO board</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Copy to ZYBO using USB</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># lsblk</span></span></pre><pre class=""><span style="padding-right: 0.1px;">NAME &nbsp; &nbsp; &nbsp;  MAJ:MIN RM &nbsp; SIZE RO TYPE MOUNTPOINT</span></pre><pre class=""><span style="padding-right: 0.1px;">sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">8</span>:0 &nbsp;  <span class="cm-number">1</span> &nbsp; <span class="cm-number">7</span>.3G  <span class="cm-number">0</span> disk</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-quote">`-sda4 &nbsp; &nbsp; &nbsp;  8:4 &nbsp;  1 &nbsp; 7.3G  0 part</span></span></pre><pre class=""><span style="padding-right: 0.1px;">mmcblk0 &nbsp; &nbsp; <span class="cm-number">179</span>:0 &nbsp;  <span class="cm-number">0</span> &nbsp; <span class="cm-number">7</span>.4G  <span class="cm-number">0</span> disk</span></pre><pre class=""><span style="padding-right: 0.1px;">|-mmcblk0p1 <span class="cm-number">179</span>:1 &nbsp;  <span class="cm-number">0</span> &nbsp;  50M  <span class="cm-number">0</span> part</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-quote">`-mmcblk0p2 179:2 &nbsp;  0 &nbsp; 7.4G  0 part /</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># mount /dev/sda4 /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd Task-2/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># insmod ./hello.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># dmesg | tail</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">158</span>.000000] hello: module license <span class="cm-string">'unspecified'</span> taints kernel.</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">158</span>.000000] Disabling lock debugging due to kernel taint</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">158</span>.000000] init hello module v2 major is 249</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre><pre class=""><span style="padding-right: 0.1px;">hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1119</span>  0</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># gcc –o test test.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;">open /dev/hello fail</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Major number should be the same as above info, 249</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># mknod /dev/hello c 249 0</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># rmmod hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 782px;"></div></div></div></pre><ul><li>The number should  not increase since our driver don’t have memory</li></ul></li><li><p>Keep some memory in driver</p><ul><li><p>A modified <code>./LAB3/Task-2/hello.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/module.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/init.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/fs.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/uaccess.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">driver_major</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">storage</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_read</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"read hello \n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">copy_to_user</span>(<span class="cm-variable">buf</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">storage</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">storage</span>));<span class="cm-tab">   </span><span class="cm-tab">    </span> &nbsp; </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_write</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"write hello \n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">copy_from_user</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">storage</span>, <span class="cm-variable">buf</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">storage</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_open</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"open hello \n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">hello_release</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span><span class="cm-operator">*</span> <span class="cm-variable">file</span>, <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>, <span class="cm-variable">loff_t</span><span class="cm-operator">*</span> <span class="cm-variable">ppos</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"release hello \n"</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">hello_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">owner</span>:<span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">read</span>:<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-variable">hello_read</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">write</span>:<span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-variable">hello_write</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">open</span>:<span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-variable">hello_open</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">release</span>:<span class="cm-tab">    </span><span class="cm-variable">hello_release</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">__init</span> <span class="cm-def">hello_init</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">driver_major</span> <span class="cm-operator">=</span> <span class="cm-variable">register_chrdev</span>(<span class="cm-number">0</span>, <span class="cm-string">"hello"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">hello_fops</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">driver_major</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to register device.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"init hello module v3 major is %d\n"</span>, <span class="cm-variable">driver_major</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">__exit</span> <span class="cm-def">hello_cleanup</span>(<span class="cm-variable-3">void</span>) { </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">driver_major</span>, <span class="cm-string">"hello"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"Cleaning up module %d\n"</span>, <span class="cm-variable">driver_major</span>); </span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">hello_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">hello_cleanup</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1342px;"></div></div></div></pre></li></ul></li></ul><ul><li><p>Compile and Test</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># mount /dev/sda4 /mnt/</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt<span class="cm-comment"># cd Task-2_v2/</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># insmod ./hello.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre><pre class=""><span style="padding-right: 0.1px;">hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">1362</span>  0</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># dmesg | tail</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.140000] sd <span class="cm-number">0</span>:0:0:0: [sda] No Caching mode page present</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.140000] sd <span class="cm-number">0</span>:0:0:0: [sda] Assuming drive cache: <span class="cm-builtin">write</span> through</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.170000]  sda: sda4</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.180000] sd <span class="cm-number">0</span>:0:0:0: [sda] No Caching mode page present</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.180000] sd <span class="cm-number">0</span>:0:0:0: [sda] Assuming drive cache: <span class="cm-builtin">write</span> through</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.190000] sd <span class="cm-number">0</span>:0:0:0: [sda] Attached SCSI removable disk</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp; <span class="cm-number">13</span>.210000] init: plymouth-stop pre-start process (1371) terminated with status 1</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">290</span>.630000] hello: module license <span class="cm-string">'unspecified'</span> taints kernel.</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">290</span>.630000] Disabling lock debugging due to kernel taint</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">290</span>.640000] init hello module v3 major is 249</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Major number should be the same as above info, 249</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># mknod /dev/hello c 249 0</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># gcc -o test test.c</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">1</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">2</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2<span class="cm-comment"># rmmod hello</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># ./test</span></span></pre><pre class=""><span style="padding-right: 0.1px;">open /dev/hello fail</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span> test</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-2_v2<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 759px;"></div></div></div></pre><ul><li>The number should increase each time you run it</li></ul></li></ul><h5><a name='header-c2627' class='md-header-anchor '></a>Lab3-2 Create PWM IP</h5><blockquote><p><strong>IP</strong> 是 <strong>Intellectual Property</strong> 的缩写，在嵌入式 <strong>FPGA</strong> 设计中，指的是某些设计好的模块，分为软件模块和硬件模块。这些模块，一般都是已经测试好，所有功能完善的，由一些用户自己设计的。有些模块是免费的，也有收费的模块。所有用户都可以将这些 <strong>IP</strong> 核 <strong>(IP Core)</strong> 导入到自己的工程中，同样，所有用户也都可以定制自己的 <strong>IP</strong> 核。</p></blockquote><ul><li><p>Hardware design</p><ul><li><p>Open the <code>hello world</code> Vivado project</p></li><li><p>Click Tools Create and Package IP…</p><p><center><img src="./img/Lab3_3/CreateandPackageIP.png" width="480px"/></center></p></li><li><p>Next</p><p><center><img src="./img/Lab3_3/Welcome2CreateIP.png" width="540px"/></center></p></li><li><p>IP details</p><p><center><img src="./img/Lab3_3/PeripheralDetails.png" width="640px"/></center></p></li><li><p>IP settings</p><p><center><img src="./img/Lab3_3/AddInterfaces.png" width="540px"/></center></p></li><li><p>Create IP and open in another project</p><p><center><img src="./img/Lab3_3/CreatePeripheral.png" width="540px"/></center></p></li><li><p>Motor IP created</p><p><center><img src="./img/Lab3_3/Open&CreateIP.png" width="800px"/></center></p></li><li><p>Double click top module</p><p><center><img src="./img/Lab3_3/top_module.png" width="720px"/></center></p><ul><li><p>Add following lines</p><p><center><img src="./img/Lab3_3/top_module_modifying1.png" width="720px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Users to add ports here</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_dir1</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_dir2</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_pwm1</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_pwm2</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// User ports ends</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><center><img src="./img/Lab3_3/top_module_modifying2.png" width="640px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">) <span class="cm-variable">motor_v1_0_S00_AXI_inst</span> (</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_dir1</span>(<span class="cm-variable">motor_dir1</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_dir2</span>(<span class="cm-variable">motor_dir2</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_pwm1</span>(<span class="cm-variable">motor_pwm1</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_pwm2</span>(<span class="cm-variable">motor_pwm2</span>),</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre></li></ul></li><li><p>Double click motor_v1_0_...</p><p><center><img src="./img/Lab3_3/instModifying_top.png" width="480px"/></center></p><ul><li><p>Add following lines</p><p><center><img src="./img/Lab3_3/instModifying1.png" width="720px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Users to add ports here</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_dir1</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_dir2</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_pwm1</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">output</span> <span class="cm-keyword">wire</span> <span class="cm-variable">motor_pwm2</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// User ports ends</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre></li></ul></li><li><p>Click Add Sources</p><p><center><img src="./img/Lab3_3/AddSources.png" width="320px"/></center></p></li><li><p>Add design source</p><p><center><img src="./img/Lab3_3/AddDesignSource.png" width="640px"/></center></p></li><li><p>Choose Create File</p><p><center><img src="./img/Lab3_3/ChooseCreateFile.png" width="640px"/></center></p></li><li><p>Set name as motor，存放位置位于 IP的 <code>/ip_repo/motor_1.0/hdl</code>处</p><p><center><img src="./img/Lab3_3/Set_name_as_motor.png" width="480px"/></center></p></li><li><p>OK--&gt;Finish</p><p><center><img src="./img/Lab3_3/Finish.png" width="720px"/></center></p></li><li><p>IP IO Port Definitions</p><p><center><img src="./img/Lab3_3/IO_Port_Definitions.png" width="640px"/></center></p></li><li><p>Add following lines</p><p><center><img src="./img/Lab3_3/instModifying2.png" width="800px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// Add user logic here</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">motor</span> <span class="cm-variable">car_motor1</span>(</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">clk</span>(<span class="cm-variable">S_AXI_ACLK</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">rstn</span>(<span class="cm-variable">S_AXI_ARESEIN</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">dir</span>(<span class="cm-variable">slv_reg1</span>[<span class="cm-number">0</span>]),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">pwm_dutty</span>(<span class="cm-variable">slv_reg0</span>[<span class="cm-number">13</span>:<span class="cm-number">0</span>]),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_dir</span>(<span class="cm-variable">motor_dir1</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">pwm_out</span>(<span class="cm-variable">motor_pwm1</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">motor</span> <span class="cm-variable">car_motor2</span>(</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">clk</span>(<span class="cm-variable">S_AXI_ACLK</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">rstn</span>(<span class="cm-variable">S_AXI_ARESEIN</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">dir</span>(<span class="cm-variable">slv_reg3</span>[<span class="cm-number">0</span>]),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">pwm_dutty</span>(<span class="cm-variable">slv_reg2</span>[<span class="cm-number">13</span>:<span class="cm-number">0</span>]),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">motor_dir</span>(<span class="cm-variable">motor_dir2</span>),</span></pre><pre class=""><span style="padding-right: 0.1px;">  .<span class="cm-variable">pwm_out</span>(<span class="cm-variable">motor_pwm2</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// User logic ends</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 437px;"></div></div></div></pre></li><li><p>Modify <code>motor</code> IP module</p><p><center><img src="./img/Lab3_3/motor_v.png" width="800px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">module</span> <span class="cm-variable">motor</span>(</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> <span class="cm-variable">clk</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> <span class="cm-variable">rstn</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> <span class="cm-variable">dir</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> [<span class="cm-number">13</span>:<span class="cm-number">0</span>] <span class="cm-variable">pwm_dutty</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> <span class="cm-variable">motor_dir</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">input</span> <span class="cm-variable">pwm_out</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  );</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">reg</span> [<span class="cm-number">13</span>:<span class="cm-number">0</span>] <span class="cm-variable">pwm_cnt</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">always</span><span class="cm-operator">@(</span><span class="cm-keyword">posedge</span> <span class="cm-variable">clk</span>) <span class="cm-keyword">begin</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">if</span>((<span class="cm-variable">pwm_cnt</span> <span class="cm-operator">==</span> <span class="cm-number">9999</span>) <span class="cm-operator">||</span> <span class="cm-operator">~</span><span class="cm-variable">rstn</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">pwm_cnt</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">else</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">pwm_cnt</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">pwm_cnt</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">end</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">assign</span> <span class="cm-variable">pwm_out</span> <span class="cm-operator">=</span> <span class="cm-variable">pwm_dutty</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">pwm_cnt</span> <span class="cm-operator">?</span> <span class="cm-number">1'b1</span> : <span class="cm-number">1'b0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">assign</span> <span class="cm-variable">motor_dir</span> <span class="cm-operator">=</span> <span class="cm-variable">dir</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">endmodule</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 516px;"></div></div></div></pre></li><li><p>Change to Package IP tab-&gt;Click Merge changes</p><p><center><img src="./img/Lab3_3/MergeChanges_IPFiles.png" width="720px"/></center></p><p><center><img src="./img/Lab3_3/MergeChanges_IPPorts.png" width="720px"/></center></p></li><li><p>Check IP GUI</p><p><center><img src="./img/Lab3_3/Check_IPGUI.png" width="720px"/></center></p></li><li><p>Re-Package IP（用于编辑 IP 的临时工程会自动关闭）</p><p><center><img src="./img/Lab3_3/Re-Package_IP.png" width="720px"/></center></p></li></ul></li><li><p>Using designed PWM IP in <code>hello world</code> project</p><ul><li><p>In <code>hello world</code> project Block Design, Add pwm IP</p><p><center><img src="./img/Lab3_3/Add_IP.png" width="720px"/></center></p><ul><li><p>Search pwm</p><p><center><img src="./img/Lab3_3/Search_PWM_IP.png" width="720px"/></center></p></li><li><p>Auto connect</p><p><center><img src="./img/Lab3_3/AutoConnectwithPWM.png" width="720px"/></center></p></li><li><p>选中 PWM 模块的 4 个输出引脚，右键 <code>Make External</code>创建外部管脚</p><p><center><img src="./img/Lab3_3/MakeExternal.png" width="720px"/></center></p></li></ul></li><li><p>Modified constraints，添加以下管脚约束（引脚对应）</p><p><center><img src="./img/Lab3_3/Modifying_constraints.png" width="720px"/></center></p><pre class="md-fences md-end-block" lang="verilog"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">##******************************</span> <span class="cm-variable">Motor</span> <span class="cm-variable">on</span> <span class="cm-variable">JD</span> <span class="cm-operator">******************************</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">##</span> <span class="cm-variable">JD3_N</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">PACKAGE_PIN</span> <span class="cm-variable">U15</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_dir1</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">IOSTANDARD</span> <span class="cm-variable">LVCMOS33</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_dir1</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">##</span> <span class="cm-variable">JD1_N</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">PACKAGE_PIN</span> <span class="cm-variable">T15</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_pwm1</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">IOSTANDARD</span> <span class="cm-variable">LVCMOS33</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_pwm1</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">##</span> <span class="cm-variable">JD1_P</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">PACKAGE_PIN</span> <span class="cm-variable">T14</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_dir2</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">IOSTANDARD</span> <span class="cm-variable">LVCMOS33</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_dir2</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-operator">##</span> <span class="cm-variable">JD3_P</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">PACKAGE_PIN</span> <span class="cm-variable">U14</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_pwm2</span>}]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">set_property</span> <span class="cm-variable">IOSTANDARD</span> <span class="cm-variable">LVCMOS33</span> [<span class="cm-variable">get_ports</span> {<span class="cm-variable">motor_pwm2</span>}]</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 368px;"></div></div></div></pre></li><li><p>Recreate HDL wapper</p><p><center><img src="./img/Lab3_3/RecreateHDL_wrapper.png" width="480px"/></center></p></li><li><p>Regenerate Output Products</p><p><center><img src="./img/Lab3_3/RegenerateOutputProducts.png" width="480px"/></center></p></li><li><p>Generate Bitstream</p><p><center><img src="./img/Lab3_3/GenerateBitstream.png" width="360px"/></center></p></li></ul></li><li><p>Software Design</p></li></ul><h5><a name='header-c2804' class='md-header-anchor '></a>Lab3-3 PWM IP Modify</h5><ul><li><p>Using Vivado to open the hardware system（原始的教程是使用该工程，如果遇到问题，可以使用上面已经添加了<code>motor</code>模块的<code>hello world</code>工程）</p><blockquote><p>From：<a href='https://github.com/xupsh/zrobot_v1' target='_blank' >https://github.com/xupsh/zrobot_v1</a></p></blockquote><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 可惜人家是Vivado2014.4，我用Vivado2016.1搞不定</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 通过tcl恢复包含PWM的硬件工程</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 进入Vivado的TCL-console</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> <span class="cm-string">'your path'</span>/hardware_prj</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-builtin">source</span> ./system_pro.tcl</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 等待bit生成完毕</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre></li></ul><ul><li><p>Open PWM IP in IP Catalog</p><ul><li><p><code>Window</code>-&gt;<code>IP Catalog</code></p><p><center><img src="./img/Lab3_4/PWM_IP_in_IP_Catalog.png" width="800px"/></center></p></li></ul></li><li><p>Change Edition Number</p><p><center><img src="./img/Lab3_4/Edit_IP_Packager.png" width="480px"/></center></p></li><li><p>PWM IP Open</p><p><center><img src="./img/Lab3_4/PWM_IP_open.png" width="720px"/></center></p></li><li><p>Modify the code</p><p><center><img src="./img/Lab3_4/Modify_the_code.png" width="800px"/></center></p></li><li><p>In Package IP Tab, Merge Changes</p><p><center><img src="./img/Lab3_4/MergeChanges_Parameters.png" width="640px"/></center></p><p><center><img src="./img/Lab3_4/MergeChanges_Port.png" width="640px"/></center></p></li><li><p>Repackage IP</p><p><center><img src="./img/Lab3_4/RepackageIP.png" width="640px"/></center></p></li></ul><h5><a name='header-c2850' class='md-header-anchor '></a>Lab3-4 Sysfs PWM kernel module</h5><ul><li><p><code>./LAB3/Task-3/pwm_driver.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/module.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/kernel.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/fs.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/device.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/io.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/uaccess.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEVICE_NAME "pwm_device"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define MYPWM_PHY_ADDR 0x43c01000</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define MYGPIO_PHY_ADDR 0x41200000</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define WHEEL_OFFSET 0x1000</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_AUTHOR</span>(<span class="cm-string">"Durant35"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_DESCRIPTION</span>(<span class="cm-string">"pwm"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_VERSION</span>(<span class="cm-string">"v2.0"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_LICENSE</span>(<span class="cm-string">"GPL"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">pwm_major</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">class</span><span class="cm-operator">*</span> <span class="cm-variable">pwm_class</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">pwm_device</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">mypwm_addr</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">mygpio_addr</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* set the speed of pwn+x</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* if bit[31]=0 stop</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">* else go</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">*/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_left_speed_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-variable">u32</span> <span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"debug: at pwm left speed main!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">sscanf</span>(<span class="cm-variable">buf</span>, <span class="cm-string">"%d"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">num</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"debug: get num:%d\n"</span>, <span class="cm-variable">num</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"debug: addr = :0x%x\n"</span>, <span class="cm-variable">mypwm_addr</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-variable">iowrite32</span>(<span class="cm-variable">num</span> <span class="cm-operator">==</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-number">0</span> : (<span class="cm-variable">num</span> <span class="cm-operator">|</span> <span class="cm-number">0x80000000</span>), <span class="cm-variable">mypwm_addr</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_left_dir_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">u32</span> <span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">sscanf</span>(<span class="cm-variable">buf</span>, <span class="cm-string">"%d"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">num</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">iowrite32</span>(<span class="cm-variable">num</span>, <span class="cm-variable">mypwm_addr</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_right_speed_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">u32</span> <span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">sscanf</span>(<span class="cm-variable">buf</span>, <span class="cm-string">"%d"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">num</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">iowrite32</span>(<span class="cm-variable">num</span> <span class="cm-operator">==</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-number">0</span> : (<span class="cm-variable">num</span> <span class="cm-operator">|</span> <span class="cm-number">0x80000000</span>), <span class="cm-variable">mypwm_addr</span> <span class="cm-operator">+</span> <span class="cm-number">8</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_right_dir_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">u32</span> <span class="cm-variable">num</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">sscanf</span>(<span class="cm-variable">buf</span>, <span class="cm-string">"%d"</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">num</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">iowrite32</span>(<span class="cm-variable">num</span>, <span class="cm-variable">mypwm_addr</span> <span class="cm-operator">+</span> <span class="cm-number">12</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">//pwm speed</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_left_speed</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_left_speed_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_right_speed</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_right_speed_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">//pwm direction</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_left_dir</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_left_dir_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_right_dir</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_right_dir_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">pwm_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span>.<span class="cm-variable">owner</span> <span class="cm-operator">=</span> <span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">__init</span> <span class="cm-def">mydriver_module_init</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">int</span> <span class="cm-variable">ret</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">pwm_major</span> <span class="cm-operator">=</span> <span class="cm-variable">register_chrdev</span>(<span class="cm-number">0</span>, <span class="cm-variable">DEVICE_NAME</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">pwm_fops</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">pwm_major</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to register device.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">pwm_class</span> <span class="cm-operator">=</span> <span class="cm-variable">class_create</span>(<span class="cm-variable">THIS_MODULE</span>, <span class="cm-string">"pwm_class"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">IS_ERR</span>(<span class="cm-variable">pwm_class</span>)){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create device class.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">pwm_device</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create</span>(<span class="cm-variable">pwm_class</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">MKDEV</span>(<span class="cm-variable">pwm_major</span>, <span class="cm-number">0</span>), <span class="cm-variable">NULL</span>, <span class="cm-string">"pwm_device"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">IS_ERR</span>(<span class="cm-variable">pwm_device</span>)){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create device .\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-comment">//pwm</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_left_speed</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create /sys endpoint"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_right_speed</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create /sys endpoint"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_left_dir</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create /sys endpoint"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_right_dir</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create /sys endpoint"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">mypwm_addr</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span>)<span class="cm-variable">ioremap</span>(<span class="cm-variable">MYPWM_PHY_ADDR</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">u32</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"my pwm driver initial successfully!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">__exit</span> <span class="cm-def">mydriver_module_exit</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_left_speed</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_right_speed</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_left_dir</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_right_dir</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_destroy</span>(<span class="cm-variable">pwm_class</span>, <span class="cm-variable">MKDEV</span>(<span class="cm-variable">pwm_major</span>, <span class="cm-number">0</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">class_unregister</span>(<span class="cm-variable">pwm_class</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">class_destroy</span>(<span class="cm-variable">pwm_class</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"pwm module exit.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">mydriver_module_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">mydriver_module_exit</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3242px;"></div></div></div></pre></li><li><p><code>./LAB3/Task-3/Makefile</code></p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; ifneq (<span class="cm-quote">$(KERNELRELEASE)</span>,)</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; obj-m :<span class="cm-operator">=</span> pwm_driver.o</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">else</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment">#KERNEL_DIR := &lt;YOUR_DIR&gt;/ZedBoard/Kernel/Digilent-linux-3.3-digilent-7f8e908</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; KERNEL_DIR :<span class="cm-operator">=</span> ../Task-1/linux-digilent-3.6-digilent-13.01</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; PWD :<span class="cm-operator">=</span> <span class="cm-quote">$(shell pwd)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; all:</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-quote">$(MAKE)</span> <span class="cm-attribute">-C</span> <span class="cm-quote">$(KERNEL_DIR)</span> <span class="cm-def">SUBDIRS</span><span class="cm-operator">=</span><span class="cm-quote">$(PWD)</span> modules <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; clean:</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-builtin">rm</span> *.o *.ko *.mod.c</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; endif</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre></li><li><p>PWM driver as module </p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ cd</span> ./LAB3/Task-3</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment"># 配置交叉编译环境（最新的交叉编译环境都集成在Vivado SDK中）</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ export</span> <span class="cm-def">ARCH</span><span class="cm-operator">=</span>arm</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ export</span> <span class="cm-def">CROSS_COMPILE</span><span class="cm-operator">=</span>arm-xilinx-linux-gnueabi-</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ source</span> /opt/Xilinx/SDK/2016.1/settings64.sh</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ make</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-def">$ modinfo</span> ./pwm_driver.ko </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; filename: &nbsp; &nbsp; &nbsp; /home/gary/Workspace/git_ws/Courses/ZYBO/LAB3/Task-3/./pwm_driver.ko</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; license: &nbsp; &nbsp; &nbsp;  GPL</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; version: &nbsp; &nbsp; &nbsp;  v2.0</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; description: &nbsp;  pwm</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; author: &nbsp; &nbsp; &nbsp; &nbsp; Durant35</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; srcversion: &nbsp; &nbsp; 632D3D00D0727423CF51FB5</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; depends: &nbsp; &nbsp; &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; vermagic: &nbsp; &nbsp; &nbsp; <span class="cm-number">3</span>.6.0-digilent-13.01 SMP preempt mod_unload modversions ARMv7</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment"># Copy pwm_driver.ko to ZYBO using USB</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:~<span class="cm-comment"># mount /dev/sda4 /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:~<span class="cm-comment"># cd /mnt/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:~<span class="cm-comment"># cd Task-3/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt<span class="cm-comment"># cd Task-3/</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Makefile &nbsp; &nbsp; &nbsp;  modules.order  pwm_driver.ko &nbsp; &nbsp; pwm_driver.mod.o</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Module.symvers  pwm_driver.c &nbsp; pwm_driver.mod.c  pwm_driver.o</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># insmod ./pwm_driver.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># insmod ./pwm_driver.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; pwm_driver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">2477</span>  0</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># rmmod pwm_driver</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># dmesg | tail</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.280000] sd <span class="cm-number">0</span>:0:0:0: [sda] No Caching mode page present</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.280000] sd <span class="cm-number">0</span>:0:0:0: [sda] Assuming drive cache: <span class="cm-builtin">write</span> through</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.280000] sd <span class="cm-number">0</span>:0:0:0: [sda] Attached SCSI removable disk</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.650000] init: failsafe main process (1200) killed by TERM signal</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.720000] init: udev-fallback-graphics main process (1235) terminated with status 1</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.790000] init: plymouth main process (633) killed by SEGV signal</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.790000] init: plymouth-splash main process (1244) terminated with status 2</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp; <span class="cm-number">14</span>.810000] init: plymouth-stop pre-start process (1367) terminated with status 1</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp; <span class="cm-number">91</span>.250000] my pwm driver initial successfully!</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">120</span>.990000] pwm module <span class="cm-keyword">exit</span>.</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-3<span class="cm-comment"># cd /sys/class/pwm_class/pwm_device</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">dev &nbsp;  pwm_left_dir &nbsp;  pwm_right_dir &nbsp;  subsystem</span></pre><pre class=""><span style="padding-right: 0.1px;">power  pwm_left_speed  pwm_right_speed  uevent</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device<span class="cm-comment"># echo 1 &gt; pwm_left_dir</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/sys/class/pwm_class/pwm_device<span class="cm-comment"># echo 5000 &gt; pwm_left_speed</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Use scope to measure JA1 wave form</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Add your own printk in the course code to debug</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1104px;"></div></div></div></pre></li></ul><h5><a name='header-c2865' class='md-header-anchor '></a>Lab3-5 I/O Access</h5><ul><li><p>The {in,out}[bwl] macros are for emulating x86-style PCI/ISA IO space.</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/io.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">virtual_address</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">inl</span>(<span class="cm-variable">virtual_address</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li><li><p>Another version of <code>pwm_driver.c</code>（Using I/O Access to configure PWM IP&#39;s frequency and duty cycle）</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/module.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/kernel.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/fs.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;linux/device.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;asm/io.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define DEVICE_NAME "PWM_MOUDLE"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#define PWM_MOUDLE_PHY_ADDR 0x6CA00000<span class="cm-tab">  </span><span class="cm-tab">    </span></span><span class="cm-comment">//This Address is based XPS</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_AUTHOR</span>(<span class="cm-string">"Xilinx XUP"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_DESCRIPTION</span>(<span class="cm-string">"PWM moudle dirver"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_VERSION</span>(<span class="cm-string">"v1.0"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">MODULE_LICENSE</span>(<span class="cm-string">"GPL"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">pwm_driver_major</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">class</span><span class="cm-operator">*</span> <span class="cm-variable">pwm_driver_class</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">pwm_driver_device</span> <span class="cm-operator">=</span> <span class="cm-variable">NULL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment">// pwm_fre_addr&amp;pwm_duty_addr init in pwm_driver_module_init()</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">pwm_fre_addr</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//pwm moulde's frequency visual address</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">pwm_duty_addr</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;<span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//pwm moulde's duty visual address</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">long</span> <span class="cm-variable">frequency</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">pwm_driver_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span>.<span class="cm-variable">owner</span> <span class="cm-operator">=</span> <span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_frequency_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">long</span> <span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">int</span> <span class="cm-variable">i</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">frequency</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">pwm_fre_addr</span>);<span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//close pwm moudle before we modfiy the frequency</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">count</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">frequency</span> <span class="cm-operator">*=</span> <span class="cm-number">10</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">frequency</span> <span class="cm-operator">+=</span> <span class="cm-variable">buf</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-string">'0'</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span>(<span class="cm-variable">value</span> <span class="cm-operator">&gt;</span> <span class="cm-number">100000000</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">value</span><span class="cm-operator">=</span><span class="cm-number">100000000</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">100000000</span><span class="cm-operator">/</span><span class="cm-variable">frequency</span>;<span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">// 100Mhz/frequency 100Mhz is set by XPS</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">pwm_fre_addr</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">} </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">sys_pwm_duty_set</span> (<span class="cm-keyword">struct</span> <span class="cm-def">device</span><span class="cm-operator">*</span> <span class="cm-variable">dev</span>, <span class="cm-keyword">struct</span> <span class="cm-def">device_attribute</span><span class="cm-operator">*</span> <span class="cm-variable">attr</span>, <span class="cm-keyword">const</span> <span class="cm-variable-3">char*</span> <span class="cm-variable">buf</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">count</span>) <span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//duty cycle </span></span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">long</span> <span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">int</span> <span class="cm-variable">i</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-tab">   </span><span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">pwm_duty_addr</span>); <span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//close pwm moudle before we modfiy the duty cycle</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">for</span>(<span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">count</span><span class="cm-operator">-</span><span class="cm-number">1</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">value</span> <span class="cm-operator">*=</span> <span class="cm-number">10</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">value</span> <span class="cm-operator">+=</span> <span class="cm-variable">buf</span>[<span class="cm-variable">i</span>] <span class="cm-operator">-</span> <span class="cm-string">'0'</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-tab">   </span><span class="cm-keyword">if</span> (<span class="cm-variable">value</span><span class="cm-operator">&gt;</span><span class="cm-number">100</span>) </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-tab">   </span><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-number">100000000</span><span class="cm-operator">/</span><span class="cm-variable">frequency</span><span class="cm-operator">*</span><span class="cm-variable">value</span><span class="cm-operator">/</span><span class="cm-number">100</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  </span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span> (<span class="cm-variable">value</span> <span class="cm-operator">!=</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">value</span> <span class="cm-operator">|</span> <span class="cm-number">0x80000000</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">outl</span>(<span class="cm-variable">value</span>, <span class="cm-variable">pwm_duty_addr</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">} </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_frequency</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_frequency_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">DEVICE_ATTR</span>(<span class="cm-variable">pwm_duty</span>, <span class="cm-variable">S_IWUSR</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">sys_pwm_duty_set</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">__init</span> <span class="cm-def">pwm_driver_module_init</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable-3">int</span> <span class="cm-variable">ret</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">pwm_driver_major</span> <span class="cm-operator">=</span> <span class="cm-variable">register_chrdev</span>(<span class="cm-number">0</span>, <span class="cm-variable">DEVICE_NAME</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">pwm_driver_fops</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">if</span>(<span class="cm-variable">pwm_driver_major</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">printk</span>(<span class="cm-string">"failed to register device.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">pwm_driver_class</span> <span class="cm-operator">=</span> <span class="cm-variable">class_create</span>(<span class="cm-variable">THIS_MODULE</span>, <span class="cm-string">"pwm_driver"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">if</span>(<span class="cm-variable">IS_ERR</span>(<span class="cm-variable">pwm_driver_class</span>)) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"failed to create pwm moudle class.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">pwm_driver_device</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create</span>(<span class="cm-variable">pwm_driver_class</span>, <span class="cm-variable">NULL</span>, <span class="cm-variable">MKDEV</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-number">0</span>), <span class="cm-variable">NULL</span>, <span class="cm-string">"pwm_device"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span>(<span class="cm-variable">IS_ERR</span>(<span class="cm-variable">pwm_driver_device</span>)) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">printk</span>(<span class="cm-string">"failed to create device .\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_frequency</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">if</span>(<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">printk</span>(<span class="cm-string">"failed to create pwm_frequency endpoint\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">ret</span> <span class="cm-operator">=</span> <span class="cm-variable">device_create_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_duty</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-keyword">if</span>(<span class="cm-variable">ret</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-variable">printk</span>(<span class="cm-string">"failed to create pwm_duty endpoint\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; </span></pre><pre class=""><span style="padding-right: 0.1px;"> <span class="cm-tab">   </span><span class="cm-comment">//To get Custom IP--PWM moudle's virtual address</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">pwm_fre_addr</span> <span class="cm-operator">=</span> (<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span>)<span class="cm-variable">ioremap</span>(<span class="cm-variable">PWM_MOUDLE_PHY_ADDR</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable">u32</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-variable">pwm_duty_addr</span> <span class="cm-operator">=</span> <span class="cm-variable">pwm_fre_addr</span> <span class="cm-operator">+</span> <span class="cm-number">4</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; </span></pre><pre class=""><span style="padding-right: 0.1px;">  <span class="cm-tab">  </span><span class="cm-variable">printk</span>(<span class="cm-string">" pwm driver initial successfully!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab"> </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">__exit</span> <span class="cm-def">pwm_driver_module_exit</span>(<span class="cm-variable-3">void</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_frequency</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_remove_file</span>(<span class="cm-variable">pwm_driver_device</span>, <span class="cm-operator">&amp;</span><span class="cm-variable">dev_attr_pwm_duty</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">device_destroy</span>(<span class="cm-variable">pwm_driver_class</span>, <span class="cm-variable">MKDEV</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-number">0</span>));</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">class_unregister</span>(<span class="cm-variable">pwm_driver_class</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">class_destroy</span>(<span class="cm-variable">pwm_driver_class</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">unregister_chrdev</span>(<span class="cm-variable">pwm_driver_major</span>, <span class="cm-variable">DEVICE_NAME</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">printk</span>(<span class="cm-string">"pwm module exit.\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_init</span>(<span class="cm-variable">pwm_driver_module_init</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">module_exit</span>(<span class="cm-variable">pwm_driver_module_exit</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2939px;"></div></div></div></pre></li><li><p>Add <strong>I/O access</strong> to your <code>hello.c</code> driver</p><ul><li><p>对 <strong>Lab2-4 Make SD Card</strong> 中使用的系统进行 <strong>Lab2-2 Bootloader</strong> 中的<code>LED Test</code> 发现二者的 LED 和 SW 的硬件地址是一样的。</p><ul><li>Switches address：0x41200000</li><li>LEDs address：0x41200008</li></ul></li><li><p>Task-4：Try to access the LED address,  turn LED on and off in Open</p></li><li><p>Task-5：Turn LED on and off when read and write</p></li></ul></li></ul><h3><a name='header-c2895' class='md-header-anchor '></a>Day04</h3><h4><a name='header-c2896' class='md-header-anchor '></a>Version Control with Git</h4><ul><li><p>Basic Intro to Git</p><ul><li>Discuss how Git differs from Subversion</li><li>Discuss the basic Git model</li><li>Pull/clone files from a  repository on github</li><li>Edit files in your own local Git repo</li><li>Push files to a repo on github</li></ul></li><li><p>Git History</p><ul><li><p>Came out of Linux development community </p></li><li><p>Linus Torvalds, 2005</p></li><li><p>Initial goals:</p><ul><li>Speed</li><li>Support for <strong>non-linear development</strong> (thousands of parallel branches)</li><li>Fully <strong>distributed</strong></li><li>Able to handle large projects like Linux efficiently</li></ul></li></ul></li><li><p>Basic Git model</p><ul><li><p>Git uses a distributed model</p><p><center><img src="./img/day04/Git_distributed_model.png" width="540px"/></center></p></li><li><p>Git takes snapshots</p><p><center><img src="./img/day04/Git_snapshots.png" width="600px"/></center></p></li><li><p>Git uses checksums</p><ul><li><p>In <strong>Subversion</strong> each modification to the central repo <strong>incremented the  version #</strong> of the overall repo.</p></li><li><p>How will this numbering scheme work when each user has their own copy of the repo, and commits changes to their local copy of the repo before pushing to the central server?????</p></li><li><p>Instead,  <strong>Git</strong> generates a <strong>unique SHA-1 hash</strong> – 40 character string of hex digits, for every commit.  Refer to commits by this ID rather than a version number. <strong>Often we only see the first 7 characters</strong>:</p><ul><li><code>1677b2d</code> Edited first line of readme</li><li><code>258efa7</code> Added line to readme</li><li><code>0e52da7</code> Initial commit</li></ul></li></ul></li><li><p>A Local Git project has three areas（Staged Files：暂存文件）</p><p><center><img src="./img/day04/Git_three_areas.png" width="480px"/></center></p></li><li><p>Git file lifecycle</p><p><center><img src="./img/day04/Git_file_lifecycle.png" width="540px"/></center></p></li></ul></li><li><p>Basic Git Workflow</p><ul><li><p><strong>Modify</strong> files in your working directory.</p></li><li><p>Stage files, <strong>adding</strong> snapshots of them to your staging area（暂存区）.</p></li><li><p>Do  a <strong>commit</strong>, which takes the files as they are in the staging area and stores that snapshot permanently to your Git directory.</p></li><li><p>Notes:</p><ul><li>If a particular version of a file is in the git directory, it’s considered <strong>committed</strong>. </li><li>If it’s modified but has been added to the staging area, it is <strong>staged</strong>. </li><li>If it was changed since it was checked out but has not been staged, it is <strong>modified</strong>.</li></ul></li></ul></li><li><p>Aside（此外）: So what is github?</p><ul><li><p><code>GitHub.com</code> is a site for online storage of Git repositories.  </p></li><li><p>Many open source projects use it, such as the Linux kernel.  </p></li><li><p>You can get free space for open source projects or you can pay for private projects.</p></li><li><p><strong>Question</strong>: Do I have to use github to use Git?</p><p>Answer: No! </p><ul><li>you can use Git <strong>completely locally</strong> for your own purposes, or </li><li>you or someone else could <strong>set up a server</strong> to share files, or </li><li>you could share a repo with users on <strong>the same file system</strong> (as long everyone has the needed file permissions).</li></ul></li></ul></li><li><p>Get ready to use Git!</p><ul><li><p>Set the name and email for Git to use when you commit</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> config <span class="cm-attribute">--global</span> user.name “Bugs Bunny”</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> config <span class="cm-attribute">--global</span> user.email bugs@gmail.com</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><ul><li><p>You can call git config –list to verify these are set.</p></li><li><p>These will be set <strong>globally for all Git projects you work with</strong>.</p></li><li><p>You can also set variables on a project-only basis by not using the <code>--global</code> flag</p></li><li><p>You can also set the editor that is used for writing commit messages：</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> config <span class="cm-attribute">--global</span> core.editor emacs</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># (it is vim by default)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li></ul></li></ul></li></ul><ul><li><p>Create a local copy of a repo</p><p><strong>1.</strong>Two common scenarios (only do one of these):</p><ul><li><p>To clone an already existing repo to your current directory:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> clone &lt;url&gt; [local dir name]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>This will create a directory named <code>local dir name</code>, containing  a working copy of the files from the repo, and a <code>.git</code> directory (<strong>used to hold the staging area and your actual repo</strong>)</p></li><li><p>To create a Git repo in your current directory:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> init</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>This will create a <code>.git</code> directory in your current directory.</p></li></ul><p><strong>2.</strong>Then you can commit files in that directory into the repo:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> add file1.java</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> commit –m <span class="cm-string">"initial project version"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li></ul><ul><li><p>Git commands</p><p><center><img src="./img/day04/Git_commands.png" width="640px"/></center></p></li><li><p>Committing files</p><ul><li><p>The first time we ask a file to be tracked, and every time before we commit a file we must add it to the staging area:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> add README.txt hello.java</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p>This takes a snapshot of these files at this point in time and adds it to the staging area.</p></li><li><p>To move staged changes into the repo we commit:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"Fixing bug #22"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To unstage a change on a file before you have committed it:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> reset HEAD <span class="cm-attribute">--</span> filename</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To unmodify a modified file:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> checkout <span class="cm-attribute">--</span> filename</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><strong>Note！！！</strong>: These commands are just acting on your local version of repo.</p></li></ul></li><li><p>Status and Diff</p><ul><li><p>To view the status of your files in the working directory and staging area:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> status</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -s shows a short one line version similar to svn</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre></li><li><p>To see what is modified but unstaged:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> <span class="cm-builtin">diff</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To see staged changes:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> <span class="cm-builtin">diff</span> <span class="cm-attribute">--cached</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li></ul></li><li><p>After editing a file…</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ emacs</span> rea.txt</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> status</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># On branch master</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Changes not staged for commit:</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># &nbsp; (use "git add &lt;file&gt;..." to update what will be committed)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># &nbsp; (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># &nbsp; &nbsp; &nbsp; modified: &nbsp; rea.txt</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  no changes added to commit (use <span class="cm-string">"git add"</span> and/or <span class="cm-string">"git commit -a"</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  M rea.txt<span class="cm-tab"> </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: M is in second column = "working tree"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> <span class="cm-builtin">diff</span><span class="cm-tab">   </span><span class="cm-tab">    </span><span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: Shows modifications that have not been staged.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-builtin">diff</span> <span class="cm-attribute">--git</span> a/rea.txt b/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  index 66b293d..90b65fd 100644</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-attribute">---</span> a/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+++</span> b/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  @@ <span class="cm-attribute">-1</span>,2 <span class="cm-operator">+</span><span class="cm-number">1</span>,4 @@</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  Here is rea<span class="cm-string">'s file.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+</span>One new line added.</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> <span class="cm-builtin">diff</span> <span class="cm-attribute">--cached</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: Shows nothing, no modifications have been staged yet.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 579px;"></div></div></div></pre></li><li><p>After adding file to staging area…</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> add rea.txt</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> status</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># On branch master</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Changes to be committed:</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># &nbsp; (use "git reset HEAD &lt;file&gt;..." to unstage)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># &nbsp; &nbsp; &nbsp; modified: &nbsp; rea.txt</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment">#</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  M  rea.txt<span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: M is in first column = "staging area"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> <span class="cm-builtin">diff</span><span class="cm-tab">   </span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: Shows nothing, no modifications that have not been staged.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  [rea@attu1 superstar]<span class="cm-def">$ git</span> <span class="cm-builtin">diff</span> <span class="cm-attribute">--cached</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-tab">  </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">#Note: Shows staged modifications.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-builtin">diff</span> <span class="cm-attribute">--git</span> a/rea.txt b/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  index 66b293d..90b65fd 100644</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-attribute">---</span> a/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+++</span> b/rea.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  @@ <span class="cm-attribute">-1</span>,2 <span class="cm-operator">+</span><span class="cm-number">1</span>,4 @@</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  Here is rea<span class="cm-string">'s file.</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-operator">+</span>One new line added.</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 510px;"></div></div></div></pre></li><li><p>Viewing logs</p><ul><li><p>To see a log of all changes in your local repo:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> log</span></pre></div><pre class=""><span style="padding-right: 0.1px;">1677b2d Edited first line of readme</span></pre><pre class=""><span style="padding-right: 0.1px;">...</span></pre><pre class=""><span style="padding-right: 0.1px;">258efa7 Added line to readme</span></pre><pre class=""><span style="padding-right: 0.1px;">...</span></pre><pre class=""><span style="padding-right: 0.1px;">0e52da7 Initial commit</span></pre><pre class=""><span style="padding-right: 0.1px;">...</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># to show a shorter version</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> log <span class="cm-attribute">--oneline</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># to show only the 5 most recent updates</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> log <span class="cm-attribute">-5</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre></li><li><p><strong>Note！！！</strong>: </p><ul><li>changes will be listed by <code>commitID #</code>, (SHA-1 hash)</li><li>changes made to the remote repo before the last time you cloned/pulled from it will also be included here </li></ul></li></ul></li><li><p>Pulling and Pushing</p><ul><li><p>Good practice: </p><ul><li>Add and Commit your changes to your local repo</li><li>Pull from remote repo to get most recent changes (fix conflicts if necessary, add and commit them to your local repo)</li><li>Push your changes to the remote repo</li></ul></li><li><p>To fetch the most recent updates from the remote repo into your local repo, and put them into your working directory:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> pull origin master</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To push your changes from your local repo to the remote repo:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> push origin master</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p><strong>Note！！！</strong>: </p><ul><li><code>origin</code> = an alias for the URL you cloned from</li><li><code>master</code> = the remote branch you are pulling from/pushing to</li><li>the local branch you are pulling to/pushing from is your current branch</li></ul></li></ul></li><li><p>Branching</p><ul><li><p>To create a branch called experimental:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ git</span> branch experimental</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To list all branches: (<code>*</code> shows which one you are currently on)</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> branch</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>To switch to the experimental branch:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> checkout experimental</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre></li><li><p>Later on, changes between the two branches differ, to <strong>merge changes</strong> from experimental into the master:</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> checkout master</span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> merge experimental</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre></li><li><p><strong>Note！！！</strong>: <code>git log --graph</code> can be useful for showing branches.</p></li><li><p><strong>Note！！！</strong>: These branches are in your local repo!</p></li></ul></li><li><p><strong>SVN</strong> vs. <strong>Git</strong></p><ul><li><p>SVN:</p><ul><li><strong>central repository approach</strong> – the main repository is the only “true” source, <strong>only the main repository has the complete file history</strong></li><li>Users check out local copies of the current version</li></ul></li><li><p>Git:</p><ul><li><strong>Distributed repository approach</strong> – every checkout of the repository is a full fledged repository（完整的存储库）, complete with history</li><li>Greater redundancy and speed</li><li>Branching and merging repositories is more heavily used as a result</li></ul></li></ul></li><li><p>Do this（Github simple use）</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> config <span class="cm-attribute">--global</span> user.name <span class="cm-string">"Your Name"</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> config <span class="cm-attribute">--global</span> user.email youremail@whatever.com</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> clone https://github.com/rea2000/santalist.git</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Then try:</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> log</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> log <span class="cm-attribute">--oneline</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Create a file named userID.txt (e.g. rea.txt)</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Add the file: </span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> add userID.txt</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Commit the file to your local repo:</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> commit –m <span class="cm-string">"added rea.txt file"</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> status <span class="cm-attribute">-s</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> log <span class="cm-attribute">--oneline</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># *WAIT, DO NOT GO ON TO THE NEXT STEPS UNTIL YOU ARE TOLD TO!!</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Pull from remote repo: </span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> pull origin master</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-comment"># Push to remote repo: </span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-def">$ git</span> push origin master</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 529px;"></div></div></div></pre></li></ul><h4><a name='header-c3256' class='md-header-anchor '></a>LAB4</h4><h5><a name='header-c3257' class='md-header-anchor '></a>Lab4-1 PWM ioctl app</h5><ul><li><p><code>./LAB4/Task-1/pwm_driver.c</code>，insert following code:</p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable">ssize_t</span> <span class="cm-def">pwm_ioctl</span>(<span class="cm-keyword">struct</span> <span class="cm-def">file</span> <span class="cm-operator">*</span><span class="cm-variable">file</span>, <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span> <span class="cm-variable">cmd</span>, <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">arg</span>)</span></pre></div><pre class=""><span style="padding-right: 0.1px;">{</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">u32</span> <span class="cm-variable">status</span> <span class="cm-operator">=</span> <span class="cm-number">0xff</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable-3">int</span> <span class="cm-variable">ret</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"debug : in ioctl!!"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">switch</span>(<span class="cm-variable">cmd</span>){</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">case</span> <span class="cm-number">0</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-keyword">case</span> <span class="cm-number">1</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//1. pwm left speed</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"left speed\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">case</span> <span class="cm-number">5</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//2. pwm left direction</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"left dir\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">case</span> <span class="cm-number">3</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//3. pwm right speed</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"right speed\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">case</span> <span class="cm-number">4</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment">//4. pwm right direction</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"right dir\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-number">0</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">default</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">printk</span>(<span class="cm-string">"default cmd=%d\n"</span>,<span class="cm-variable">cmd</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">return</span> <span class="cm-operator">-</span><span class="cm-variable">EINVAL</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>}</span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">struct</span> <span class="cm-def">file_operations</span> <span class="cm-def">pwm_fops</span> <span class="cm-operator">=</span> {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  .<span class="cm-variable">owner</span> <span class="cm-operator">=</span> <span class="cm-variable">THIS_MODULE</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span>.<span class="cm-variable">unlocked_ioctl</span> <span class="cm-operator">=</span> <span class="cm-variable">pwm_ioctl</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">};</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 781px;"></div></div></div></pre></li><li><p>PWM driver as module</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Modify the Makefile, KENEL_DIR point to your Digilent_linux….</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Make </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Copy pwm_driver.ko to ZYBO board</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># ls</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Makefile &nbsp; &nbsp; &nbsp;  modules.order  pwm_driver.c &nbsp; pwm_driver.mod.c  pwm_driver.o</span></pre><pre class=""><span style="padding-right: 0.1px;">Module.symvers  pwm_app.c &nbsp; &nbsp;  pwm_driver.ko  pwm_driver.mod.o</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># insmod ./pwm_driver.ko</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># lsmod</span></span></pre><pre class=""><span style="padding-right: 0.1px;">Module &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Size  Used by</span></pre><pre class=""><span style="padding-right: 0.1px;">pwm_driver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  <span class="cm-number">2803</span>  0</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># rmmod pwm_driver</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># dmesg | tail</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.210000] sd <span class="cm-number">0</span>:0:0:0: [sda] No Caching mode page present</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.220000] sd <span class="cm-number">0</span>:0:0:0: [sda] Assuming drive cache: <span class="cm-builtin">write</span> through</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.240000] sd <span class="cm-number">0</span>:0:0:0: [sda] Attached SCSI removable disk</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.680000] init: udev-fallback-graphics main process (1217) terminated with status 1</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.740000] init: failsafe main process (1195) killed by TERM signal</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.780000] init: plymouth main process (632) killed by SEGV signal</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp;  <span class="cm-number">4</span>.780000] init: plymouth-splash main process (1227) terminated with status 2</span></pre><pre class=""><span style="padding-right: 0.1px;">[ &nbsp; <span class="cm-number">14</span>.490000] init: plymouth-stop pre-start process (1363) terminated with status 1</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">127</span>.000000] my pwm driver initial successfully!</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">208</span>.200000] pwm module <span class="cm-keyword">exit</span>.</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># insmod ./pwm_driver.ko</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 529px;"></div></div></div></pre></li><li><p>Create app，<code>./LAB4/Task-1/pwm_app.c</code></p><pre class="md-fences md-end-block" lang="c"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdio.h&gt;</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;stdlib.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;unistd.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/ioctl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/types.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/stat.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;fcntl.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/select.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-meta">#include &lt;sys/time.h&gt;</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-variable-3">int</span> <span class="cm-variable">pwm_fd</span>;</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-def">main</span>(<span class="cm-variable-3">void</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-comment">// open device</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-variable">pwm_fd</span> <span class="cm-operator">=</span> <span class="cm-variable">open</span>(<span class="cm-string">"/dev/pwm_device"</span>, <span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">if</span>(<span class="cm-variable">pwm_fd</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">perror</span>(<span class="cm-string">"open device pwm_device error!\n"</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  <span class="cm-variable">exit</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">while</span>(<span class="cm-number">1</span>) {</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">5</span>,<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">5</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">1</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">4</span>,<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">1</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">4</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">10000</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">sleep</span>(<span class="cm-number">10</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp; &nbsp;  <span class="cm-variable">ioctl</span>(<span class="cm-variable">pwm_fd</span>,<span class="cm-number">3</span>,<span class="cm-number">0</span>);</span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"> &nbsp;  <span class="cm-keyword">return</span> <span class="cm-number">0</span>; &nbsp; <span class="cm-tab">    </span></span></pre><pre class=""><span style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1059px;"></div></div></div></pre></li><li><p>Compile &amp; run app</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># gcc -o pwm_app pwm_app.c</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># ./pwm_app</span></span></pre><pre class=""><span style="padding-right: 0.1px;">^C</span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:/mnt/Task-1<span class="cm-comment"># dmesg | tail</span></span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">600</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right dir</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">600</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right speed</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">610</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right speed</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">611</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right dir</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">611</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right speed</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">621</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!right speed</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">621</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!left dir</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">621</span>.570000] debug : <span class="cm-keyword">in</span> ioctl!!left speed</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">668</span>.590000] debug : <span class="cm-keyword">in</span> ioctl!!left dir</span></pre><pre class=""><span style="padding-right: 0.1px;">[  <span class="cm-number">668</span>.590000] debug : <span class="cm-keyword">in</span> ioctl!!left speed</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre></li></ul><h5><a name='header-c3275' class='md-header-anchor '></a>Lab4-2 V4L Streaming</h5><ul><li><p>scripts（You need a USB camera）</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~<span class="cm-comment"># cd /root/mjpeg_face_leaf_detection/mjpg-streamer</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/mjpeg_face_leaf_detection/mjpg-streamer<span class="cm-comment"># export LD_LIBRARY_PATH=/root/mjpeg_face_leaf_detection/mjpg-streamer</span></span></pre><pre class=""><span style="padding-right: 0.1px;">root@xup-VirtualBox:~/mjpeg_face_leaf_detection/mjpg-streamer<span class="cm-comment"># ./mjpg_streamer -i "input_uvc.so -y -f 24 -r 640*480 -q 60" "output_http.so -p 8080 -w /var/www"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">MJPG Streamer Version: svn rev: exported</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: Using V4L2 device.: /dev/video0</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: Desired Resolution: <span class="cm-number">640</span> x 480</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: Frames Per Second.: 24</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: Format............: YUV</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: JPEG Quality......: 60</span></pre><pre class=""><span style="padding-right: 0.1px;">ERROR opening V4L interface: No such file or directory</span></pre><pre class=""><span style="padding-right: 0.1px;"> Init v4L2 failed !! <span class="cm-keyword">exit</span> fatal</span></pre><pre class=""><span style="padding-right: 0.1px;"> i: init_VideoIn failed</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre></li><li><p>Then，you can access the website to see the camera video</p></li></ul><h3><a name='header-c3284' class='md-header-anchor '></a>Day05</h3><h4><a name='header-c3285' class='md-header-anchor '></a>Review for missing</h4><ul><li><p>ZYBO Boot Process for Linux</p><p><center><img src="./img/day05/reviewing/BootProcess4Linux.png" width="720px"/></center></p></li></ul><ul><li><p>Vivado + SDK</p><p><center><img src="./img/day05/reviewing/Vivado+SDK.png" width="480px"/></center></p><ul><li><p>Xilinx Platform Studio (<strong>XPS</strong>)</p><ul><li>Design environment for processing system</li><li>Xilinx Microprocessor Project (<strong>XMP</strong>) file</li><li>Microprocessor Hardware Specification (<strong>MHS</strong>) file</li><li>Platform, software, and peripheral simulation</li><li>ChipScope Pro logic analyzer integration</li></ul></li><li><p>Software Development Kit (SDK)</p><ul><li>Project workspace </li><li>Hardware platform definition</li><li>Board Support Package (<strong>BSP</strong>)</li><li>Software application</li><li>Software debugging</li></ul></li></ul></li><li><p>Embedded System Design Flow for Zynq-7000 AP SoC</p><p><center><img src="./img/day05/reviewing/EmbeddedSystemDesignFlow.png" width="800px"/></center></p></li></ul><h4><a name='header-c3342' class='md-header-anchor '></a>HW/SW Co-design Overview</h4><p><center><img src="./img/day05/Co-design/SW_HW_Co-design_NOKIA.png" width="540px"/></center></p><ul><li><p>软硬件协同设计理论体系</p><ul><li>系统任务描述 (System Task Description )</li><li>软硬件划分 (Hardware/Software Partition)</li><li>软硬件协同综合 (Hardware/Software Co-synthesis )</li><li>软硬件协同仿真 (Hardware/Software Co-simulation )</li><li>设计空间探索  (Design space exploration )</li><li>与系统设计相关的低压低功耗设计，可测性设计等等。</li></ul></li><li><p>Implementation Alternatives（硬件平台的演变）</p><p><center><img src="./img/day05/Co-design/ImplementationAlternatives.png" width="540px"/></center></p><ul><li><p>Trade-off</p><p><center><img src="./img/day05/Co-design/platform_1.png" width="540px"/></center></p><p><center><img src="./img/day05/Co-design/platform_2.png" width="540px"/></center></p><p><center><img src="./img/day05/Co-design/platform_3.png" width="640px"/></center></p></li><li><p>FPGA Processing: Use Models</p><p><center><img src="./img/day05/Co-design/FPGA_Processing.png" width="720px"/></center></p></li><li><p>Integrated HW/SW platform for Embedded SOC</p><p><center><img src="./img/day05/Co-design/Intergrated_HWSW_platform.png" width="720px"/></center></p></li><li><p>Accelerating Processor Options</p><p><center><img src="./img/day05/Co-design/AcceleratingProcessor.png" width="720px"/></center></p></li><li><p>Xilinx puts ARM core into its FPGA（ssupper convergence）</p><p><center><img src="./img/day05/Co-design/platform_Xilinx.jpg" width="420px"/></center></p></li><li><p>System-on-Chip</p><ul><li><p>Algorithms in a GSM transmitter and receiver and their mapping on to conventional target technologies consisting of ASIC, FPGA and DSP</p><p> <center><img src="./img/day05/Co-design/GSM_systems.png" width="640px"/></center></p></li><li><p>A system-on-chip solution</p><p><center><img src="./img/day05/Co-design/GSM_SOC.png" width="480px"/></center></p></li></ul></li></ul></li></ul><ul><li><p>Project flow changing</p><ul><li><p>Traditional project flow</p><p><center><img src="./img/day05/Co-design/project_flow_traditional.png" width="640px"/></center></p><ul><li>Late integration and bug detection</li><li>Redesign cycle with possible re-spin（可能推倒重来）</li></ul></li><li><p>Verification at the Backend</p><p><center><img src="./img/day05/Co-design/Verification_backend.png" width="640px"/></center></p></li><li><p>Refined project timeline</p><p><center><img src="./img/day05/Co-design/project_timeline_Refined.png" width="800px"/></center></p><ul><li>Coordinated feature release</li><li>Iterative integration and debug</li><li>Reuse wherever feasible</li><li>Centralized version control</li></ul></li><li><p>Concurrent design（并行设计）</p><p><center><img src="./img/day05/Co-design/ConcurrentDesign.png" width="540px"/></center></p></li><li><p>Integrating software and hardware before the prototypes are built</p><p><center><img src="./img/day05/Co-design/HW&SW_Co-design_before_prototype.png" width="780px"/></center></p></li><li><p>Hardware &amp; Software Co-design</p><p><center><img src="./img/day05/Co-design/Hardware&Software_Co-design.png" width="780px"/></center></p><ul><li><p>System Design</p><p><center><img src="./img/day05/Co-design/SystemDesign.png" width="540px"/></center></p></li><li><p>System Level Language</p><p><center><img src="./img/day05/Co-design/SystemLevelLanguage.png" width="540px"/></center></p><p><center><img src="./img/day05/Co-design/SystemLevelLanguage_C&C++.png" width="480px"/></center></p><p><center><img src="./img/day05/Co-design/LanguageUse.png" width="480px"/></center></p></li><li><p>Design Space Exploration</p><p><center><img src="./img/day05/Co-design/DSE_overview.png" width="480px"/></center></p><ul><li><p>考虑的问题</p><ul><li>Area</li><li>Critical path delays</li><li>Testability</li><li>Power dissipation（功耗）</li></ul><p><center><img src="./img/day05/Co-design/DSE_mapping.png" width="480px"/></center></p></li><li><p>对人来说，太复杂了，交给机器做,   <strong>Vivado-HLS</strong> 工具，C转换为优化的硬件实现</p><p><center><img src="./img/day05/Co-design/DSE_Xilinx.png" width="600px"/></center></p><p><center><img src="./img/day05/Co-design/VivadoHLS.png" width="540px"/></center></p></li></ul></li></ul></li><li><p>High-Level Synthesis: HLS</p><p><center><img src="./img/day05/Co-design/VivadoHLS_overview.png" width="400px"/></center></p><ul><li><p>Overview</p><ul><li><p>High-Level Synthesis</p><ul><li>Creates an RTL implementation from C level source code（C转RTL）</li><li>Extracts control and dataflow from the source code（提取控制和数据流）</li><li>Implements the design based on defaults and user applied directives（不同优化的转化）</li></ul></li><li><p>Many implementation are possible from the same source description</p><ul><li>Smaller designs, faster designs, optimal designs</li><li>Enables design exploration</li></ul></li></ul></li><li><p>Introduction to High-Level Synthesis</p><ul><li><p>How is hardware extracted from C code?</p><ul><li><p>Control and datapath can be extracted from C code at the top level</p></li><li><p>The same principles used in the example can be applied to sub-functions</p><ul><li>At some point in the top-level control flow, control is passed to a sub-function</li><li>Sub-function may be implemented to execute concurrently with the top-level and or other sub-functions</li></ul></li></ul></li><li><p>How is this control and dataflow turned into a hardware design?</p></li><li><p>Vivado HLS maps this to hardware through scheduling and binding processes</p></li><li><p>How is my design created?</p><ul><li>How functions, loops, arrays and IO ports are mapped?</li></ul></li></ul></li><li><p>HLS: Control Extraction</p><p><center><img src="./img/day05/Co-design/ControlExtraction.png" width="800px"/></center></p></li><li><p>Vivado HLS Benefits</p><ul><li><p>Productivity（生产率）</p><ul><li>Verification</li><li>Functional</li><li>Architectural</li><li>Abstraction</li><li>Datatypes</li><li>Interface</li><li>Classes</li><li>Automation</li></ul><p>Block level specification AND verification significantly reduced</p></li><li><p>Permutability（可变性）</p><ul><li><p>Architecture Exploration</p></li><li><p>Timing</p><ul><li>Parallelization</li><li>Pipelining</li></ul></li><li><p>Resources</p><ul><li>Sharing</li></ul></li><li><p>Better QoR</p></li></ul><p>Rapid design exploration delivers QoR rivaling hand-coded RTL（QoR比人更高）</p></li></ul></li></ul></li></ul></li></ul><h4><a name='header-c3654' class='md-header-anchor '></a>Creative Suggestion</h4><ul><li><p>OpenCV 寻线 </p><ul><li>SD卡系统<code>/root/openhwcar</code></li></ul></li><li><p>小车加声音</p><ul><li><a href='https://github.com/xupsh/zrobot_v1'>zrobot_v1-master.zip</a>/sw/app/music_demo_arm</li></ul></li><li><p>闭环(读取小车实时速度，实现反馈）</p><ul><li><code>LAB5/close-loop/*</code></li></ul></li><li><p>超声波（循迹）</p><ul><li><a href='https://github.com/xupsh/zrobot_v1'>zrobot_v1-master.zip</a>/sw/driver/ultrasonic</li></ul></li><li><p>安卓应用(手机上视频展示和手柄控制）</p><ul><li><a href='https://github.com/xupsh/zrobot_v1'>zrobot_v1-master.zip</a>/Android</li></ul></li></ul><h4><a name='header-c3691' class='md-header-anchor '></a>OpenCV Case Study</h4><ul><li><p>人脸识别</p><ul><li>In 2001, P.Viola presented a new face detection algorithm using boosted cascade of HAAR features in his paper [1]. Afterwards, </li><li>Intel realized the Adaboost face detection algorithm in its OpenCV library [2]. </li><li>The optimized code for x86 architecture can detect accurately on an image of 384*288 at speed of 10fps with 2GHz P4 processor.<br/></li><li>However, performance of the algorithm is much poorer on embedded platform than on desktop platform. Under condition of the same image size and detection accuracy</li><li>it takes 5 seconds for a 200MHz ARM9 processor to finish the detection.</li><li>OpenCV: Open Source Computer Vision Library,  BSD license </li></ul></li><li><p>Accelerated face detection</p><ul><li><p>Start from software + XUP board</p></li><li><p>Implemented entirely in  hardware on a Xilinx Spartan 3A 1800 DSP</p></li><li><p>50MHz, 15~25 FPS</p><ul><li><p>Faster than face detection on TI’s DM642 DSP (600MHz VLIW)</p><p><center><img src="./img/day05/OpenCV/TI_DSP.jpg" width="480px"/></center></p></li></ul></li></ul></li><li><p>Prototype Board</p><p><center><img src="./img/day05/OpenCV/Virtex-II.jpg" width="420px"/></center></p><ul><li>Xilinx XUP Virtex-II Pro Development System </li><li>Processor: PPC 405</li><li>Processor clock frequency: 300MHz</li><li>Bus clock frequency: 100MHz</li><li>BRAM Memory :  about 200KBytes</li></ul></li><li><p>Technology Roadmap</p><ul><li><p>Embedded Solution(Done 2007.07)</p><ul><li>Powerpc405+coreConnect</li><li>Integrate Video Port to PLB  Bus</li><li>XUP V2Pro Prototype</li></ul></li><li><p>Full Hardware Solution(Done 2007.09)</p><ul><li>State Machine based </li><li>XUP V2Pro Prototype</li></ul></li><li><p>Commercial Product(2007.11)</p><ul><li>Based on full hardware Solution</li><li>Spartan-DSP(SA1800)</li><li>Substitute IS’VISION’s TI DSP based solutions</li></ul></li><li><p>Multi-Channel Product(CY08)</p><ul><li>4-Channel </li><li>D1 </li></ul></li></ul></li><li><p>Solution Evaluation</p><ul><li><p>Start from OpenCV (Intel PC)</p></li><li><p>Porting to ucLinux (Embedded SW)</p></li><li><p>MicroBlaze(FSL) + HA (SW/HW)</p></li><li><p>PowerPC(PLB/OPB) + HA (SW/HW)</p></li><li><p>State Machine + XtremeDSP</p><ul><li>System C level modeling</li><li>C Modeling and profiling</li><li>VerilogHDL Coding</li></ul></li></ul></li><li><p>Performance Criteria</p><ul><li>Detection rate</li><li>False positive detection rate</li><li>Detection speed</li><li>Real-time detection</li></ul></li><li><p>Goal</p><ul><li><p>Faster</p><ul><li>Pipeline</li><li>Parallelism</li></ul></li><li><p>Reasonable hardware cost</p><ul><li>Sub-window based</li></ul></li></ul></li></ul><h4><a name='header-c3871' class='md-header-anchor '></a>GNU Radio Case Study</h4><ul><li><p>What is GNU Radio?</p><p><center><img src="./img/day05/GNU_Radio/GNU_Radio_Components.png" width="720px"/></center></p><ul><li><p>Software toolkit for signal  processing</p><ul><li>Software radio construction</li><li>Rapid development</li></ul></li><li><p>USRP (Universal Software Radio Peripheral)</p><ul><li>Hardware frontend for sending and receiving waveforms</li></ul></li></ul></li><li><p>GNU Radio Software</p><ul><li><p>Opensource software (GPL)</p><ul><li>Don&#39;t know how something works? Take a look!</li><li>Existing examples: 802.11b(Wi-Fi), ATSC (HDTV), OFDM, DBPSK, DQPSK</li></ul></li><li><p>Features</p><ul><li>Extensive library of signal processing blocks(C++/ and assembly)</li><li>Python environment for composing blocks (flow graph)</li></ul></li></ul></li><li><p>GNU Radio Hardware</p><p><center><img src="./img/day05/GNU_Radio/GNU_Radio_HardwareSchematic.png" width="720px"/></center></p><ul><li><p>Sends/receives waveforms</p></li><li><p>USRP Features</p><ul><li>USB 2.0 interface (480Mbps)</li><li>FPGA (customizable)</li><li>64Msps Digital to Analog converters</li><li>128Msps Analog to Digital converteres</li><li>Daughterboards for different frequency ranges</li></ul></li><li><p>Available Daughterboard（子插件）</p><ul><li>400-500Mhz, 800-1000Mhz, 1150-1450Mhz, 1.5-2.1Ghz, 2.3-2.9Ghz</li></ul></li></ul></li></ul><h4><a name='header-c3955' class='md-header-anchor '></a>Software Defined Network</h4><p><center><img src="./img/day05/SDN/NetworkSystem.png" width="720px"/></center></p><ul><li><p>Convergence（汇合） of Processing (Compute) and programmable logic</p><ul><li>Convergence of control and management traffic</li><li>Customized features, functions &amp; processing</li><li>TCP, Security, compression/de-compression, Application Offload processing</li><li>Programmable networking</li><li>Network Analytics &amp; I/O management</li></ul></li><li><p>Integrated Carrier Ethernet Solutions -- NIDs</p><p><center><img src="./img/day05/SDN/NIDs.png" width="800px"/></center></p><ul><li><p>Fully Integrated Carrier Ethernet NID Solution in a single chip</p><ul><li>Xilinx &amp; Partner IP Delivering unparalleled integration</li></ul></li></ul></li><li><p>Future Networks: a Programmable Network ?</p><p><center><img src="./img/day05/SDN/Flow_table_entry.png" width="720px"/></center></p><ul><li><p>Several  solutions and Terminologies</p><p><center><img src="./img/day05/SDN/SDN_overal_architecture.png" width="600px"/></center></p><ul><li><p>SDN: Software-Defined Networking </p><ul><li>Introduced by the New initiative ONF and recently by ITU-T SG 13 Future Networks</li><li>Under discussion at IETF as Network Programmability (or Software-Driven Networks )</li></ul></li><li><p>Self Organizing  &amp; Autonomic Networks </p></li><li><p>Network resources and policy controller</p></li><li><p>Network Virtualization &amp; slicing</p></li><li><p>Cloud Network  &amp;  Network as a Services </p></li><li><p>…. Smart Ubiquitous &amp; Distributed Services, Information-Centric Networks….</p></li></ul></li><li><p>Opportunity for telecom operators: </p><ul><li>To hide network complexity by abstraction layer</li><li>Improve “Dynamically” network Management ‘Programmability’ &amp; performance</li><li>Ability to deliver “On demand” network resources</li></ul></li><li><p>…And some use cases: Bandwidth On Demand, Network virtualization , Policy control, Chained Business services , Cloud Network, NaaS, Traffic Offload…</p></li></ul></li><li><p>OpenFlow Switching : how it works?</p><p><center><img src="./img/day05/SDN/OpenFlowSwitching.png" width="420px"/></center></p><ul><li><p>OpenFlow is based on an <strong>L2-L4 switch</strong>, with an internal flow-table, and a &quot;standardized&quot; interface to add and remove flow entries.</p></li><li><p>New actions can be done on packet.</p><ul><li>Large modifications of fields.</li><li>Routing on new criteria : L4, mix</li><li>Define network slice on flow criteria …</li><li>New routing protocol : multipath, load-balancing</li></ul></li></ul></li><li><p>Xilinx Zynq-7000</p><ul><li><p>Processors and Programmable</p><ul><li><p>Processors (single- and multi-core) are invaluable</p><ul><li>And in any case, are a much harder ossification to address</li></ul></li><li><p>But one shouldn’t ignore everything else</p><ul><li>If they have better characteristics, e.g., faster, lower power, deterministic</li></ul></li><li><p>Integration of technologies and of programming is the key, e.g.:</p><ul><li>Software deceleration: Processor helps the programmable logic</li><li>Hardware acceleration: Programmable logic helps the processor</li></ul></li></ul></li><li><p>Wide Breadth of Applications Addressed</p><ul><li>Carrier Ethernet Based Access Devices </li><li>Mobile backhaul </li><li>SDN (Software defined networking)</li><li>BMC (base board management controller)</li><li>Client security</li><li>Appliance / Gateways</li><li>SSD controllers</li><li>Low powered servers</li><li>NIDs</li></ul></li></ul></li></ul><h4><a name='header-c4132' class='md-header-anchor '></a>LAB5</h4><h5><a name='header-c4133' class='md-header-anchor '></a>Lab5-1 Interesting Self-evaluation using Github</h5><ul><li><p>Group collaboration</p><ul><li>Git clone <a href='https://github.com/Durant35/Self-evaluation.git' target='_blank' >https://github.com/Durant35/Self-evaluation.git</a></li></ul></li></ul><ul><li><p>Each group in charge of one directory</p></li><li><p>Concurrent coding </p><ul><li>Add your information in group_score<group-number>.c</li><li>Unit test</li><li>Git commit</li><li>Git push</li><li>Integrated test</li></ul></li><li><p>Unit test</p><ul><li><p>Test in group local directory</p><pre class="md-fences md-end-block" lang="shell"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ cd</span> hust_group?</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-def">$ make</span></span></pre><pre class=""><span style="padding-right: 0.1px;">./group?_score</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># Shoud print all group member name and scores</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre></li><li><p>Git commit</p></li><li><p>Git push </p></li></ul></li><li><p>Integrated test</p><ul><li><p>Git pull </p></li><li><p>Make clean</p></li><li><p>Make </p></li><li><p>Make test</p></li><li><p>Open the score_record.txt in <code>MS Excel</code>/<code>LibreOffice Calc</code></p><p><center><img src="./img/day05/Self-evaluation_Calc.png" width="540px"/></center></p></li></ul></li></ul></div>
</body>
</html>